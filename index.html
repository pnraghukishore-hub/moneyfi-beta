<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ═══ PWA: MoneyFi ═══ -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="MoneyFi">
  <meta name="theme-color" content="#1E2A6E">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <!-- ══════════════════════ -->
  <!-- ═══ Firebase SDKs ═══ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- ═══════════════════ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MoneyFi – Personal Finance</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #FFF9E6;
      --bg-cream: #FFFBF0;
      --yellow: #F5C842;
      --yellow-light: #FFF0B0;
      --blue-circle: #3B4A9C;
      --text-dark: #2D3250;
      --text-med: #5A6070;
      --text-light: #9AA0B2;
      --white: #FFFFFF;
      --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
      --card-shadow-hover: 0 8px 30px rgba(0,0,0,0.13);
      --radius: 20px;
      --radius-sm: 12px;
      --food: #FF6B35;
      --transport: #4A9EFF;
      --housing: #FF8C42;
      --health: #4ECDC4;
      --shopping: #FF4757;
      --membership: #FFBE0B;
      --giving: #FF6B9D;
      --income: #10B981;
      --expenses: #EF4444;
      --debt: #8B5CF6;
      --gold: #C8900A;
      --silver: #6E7A8A;
      --platinum: #4A5C6E;
      --portfolio: #7C3AED;
      --portfolio-light: #F3EEFF;
      --primary: #1E2A6E;
      --primary-light: #F0F4FF;

      /* Theme background variables (overridable by themes) */
      --theme-bg-main: #FFF9E6;
      --theme-overlay: none;
      --theme-card-extra: none;
    }

    /* ══ THEMES ══ */
    body.theme-looney { 
      --bg: #FFF0F5; --bg-cream: #FFF8FB; 
      background: #FFF0F5 !important;
    }
    body.theme-jungle { 
      --bg: #E8F5E9; --bg-cream: #F1F8E9; 
      background: #E8F5E9 !important;
    }
    body.theme-space { 
      --bg: #0D0D1A; --bg-cream: #12122A;
      --text-dark: #E8E8FF; --text-med: #A0A8CC; --text-light: #6070A0;
      --white: #1A1A30;
      background: #0D0D1A !important;
    }
    body.theme-ocean { 
      --bg: #E0F4FF; --bg-cream: #ECF9FF;
      background: #E0F4FF !important;
    }


    body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text-dark); min-height: 100vh; position: relative; overflow-x: hidden; }

    /* Theme decorations */
    .theme-deco { position: fixed; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.5s; }
    body.theme-looney .theme-deco.looney-deco { opacity: 1; }
    body.theme-jungle .theme-deco.jungle-deco { opacity: 1; }
    body.theme-space .theme-deco.space-deco { opacity: 1; }
    body.theme-ocean .theme-deco.ocean-deco { opacity: 1; }

    /* ── TOP BAR ── */
    .topbar { background: var(--bg); padding: 16px 20px 0; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
    .topbar-title { font-size: 1.3em; font-weight: 900; color: var(--text-dark); }
    .topbar-badge { background: var(--yellow); color: var(--text-dark); font-weight: 800; font-size: 0.8em; padding: 4px 12px; border-radius: 20px; cursor: pointer; }
    /* Quick-access icon buttons in topbar - fixed positioning replaced with flex in topbar */
    .topbar-icons { display: flex; align-items: center; gap: 6px; }
    .topbar-icon-btn { background: var(--white); border: none; border-radius: 50%; width: 34px; height: 34px; font-size: 1em; cursor: pointer; box-shadow: var(--card-shadow); display: flex; align-items: center; justify-content: center; transition: transform 0.2s; flex-shrink: 0; }
    .topbar-icon-btn:hover { transform: scale(1.1); }

    /* ── BOTTOM NAV ── */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); display: flex; justify-content: space-around; align-items: center; padding: 10px 0 18px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-light); font-size: 0.68em; font-weight: 700; transition: color 0.2s; background: none; border: none; padding: 0 10px; }
    .nav-item .nav-icon { font-size: 1.4em; }
    .nav-item.active { color: var(--yellow); }
    .nav-item.active .nav-icon { background: var(--yellow); color: white; width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.05em; }
    /* Floating add button */
    /* Floating add button + launcher */
    .fab-add { position: fixed; bottom: 72px; right: 20px; width: 56px; height: 56px; background: var(--yellow); border-radius: 50%; border: none; font-size: 1.8em; font-weight: 900; cursor: pointer; box-shadow: 0 4px 20px rgba(245,200,66,0.55); z-index: 200; display: flex; align-items: center; justify-content: center; transition: transform 0.25s, box-shadow 0.2s; animation: fabPulse 2.8s ease-in-out infinite; color: var(--text-dark); line-height: 1; }
    .fab-add:hover { transform: scale(1.12); box-shadow: 0 8px 28px rgba(245,200,66,0.7); animation: none; }
    .fab-add.open { transform: rotate(45deg); animation: none; box-shadow: 0 8px 28px rgba(245,200,66,0.7); }
    @keyframes fabPulse { 0%,100%{box-shadow:0 4px 20px rgba(245,200,66,0.55)} 50%{box-shadow:0 4px 30px rgba(245,200,66,0.85),0 0 0 8px rgba(245,200,66,0.15)} }
    @keyframes goalsFabPulse { 0%,100%{box-shadow:0 4px 20px rgba(30,42,110,0.45)} 50%{box-shadow:0 6px 28px rgba(30,42,110,0.7),0 0 0 8px rgba(30,42,110,0.12)} }
    /* Launcher menu */
    .fab-menu { position: fixed; bottom: 138px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 199; pointer-events: none; }
    .fab-menu-item { display: flex; align-items: center; gap: 10px; justify-content: flex-end; opacity: 0; transform: translateY(16px) scale(0.9); transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
    .fab-menu-item.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .fab-menu-item:nth-child(1).visible { transition-delay: 0.05s; }
    .fab-menu-item:nth-child(2).visible { transition-delay: 0.02s; }
    .fab-menu-item:nth-child(3).visible { transition-delay: 0s; }
    .fab-menu-label { background: var(--white); color: var(--text-dark); font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.82em; padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); white-space: nowrap; }
    .fab-menu-btn { width: 44px; height: 44px; border-radius: 50%; border: none; font-size: 1.2em; cursor: pointer; box-shadow: 0 3px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    /* Backdrop */
    .fab-backdrop { position: fixed; inset: 0; z-index: 198; display: none; }
    .fab-backdrop.open { display: block; }

    /* ── SCREENS ── */
    .screen { display: none; padding: 16px 20px 100px; position: relative; z-index: 1; }
    .screen.active { display: block; }

    /* ── TIME PERIOD SELECTOR (innovative calendar strip) ── */
    .time-period-bar { display: flex; background: var(--white); border-radius: var(--radius); box-shadow: var(--card-shadow); margin: 12px 0 16px; overflow: hidden; }
    .period-tab { flex: 1; padding: 10px 4px; border: none; background: none; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.78em; color: var(--text-light); cursor: pointer; transition: all 0.2s; text-align: center; }
    .period-tab.active { background: var(--yellow); color: var(--text-dark); border-radius: var(--radius-sm); margin: 3px; }
    .period-nav { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; }
    .period-nav button { background: none; border: none; font-size: 1.3em; cursor: pointer; color: var(--text-med); padding: 4px 8px; border-radius: 8px; transition: background 0.15s; }
    .period-nav button:hover { background: rgba(0,0,0,0.06); }
    .period-nav .period-label { font-size: 1em; font-weight: 800; color: var(--text-dark); min-width: 180px; text-align: center; }

    /* Day/Week detail row - shows mini days */
    .period-detail { display: none; gap: 6px; overflow-x: auto; scrollbar-width: none; margin-bottom: 12px; padding: 0 2px; }
    .period-detail::-webkit-scrollbar { display: none; }
    .period-detail.show { display: flex; }
    .day-chip { flex-shrink: 0; background: var(--white); border-radius: 10px; padding: 8px 10px; text-align: center; min-width: 44px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .day-chip.today { border-color: var(--yellow); background: var(--yellow-light); }
    .day-chip.selected { background: var(--yellow); }
    .day-chip .dc-day { font-size: 0.65em; font-weight: 800; color: var(--text-light); text-transform: uppercase; }
    .day-chip .dc-num { font-size: 1em; font-weight: 900; color: var(--text-dark); }
    .day-chip.selected .dc-day, .day-chip.selected .dc-num { color: var(--text-dark); }

    /* ── HOME ── */
    .spending-hero { text-align: center; padding: 4px 0 16px; }
    .spending-label { color: var(--text-med); font-size: 0.9em; font-weight: 600; }
    .spending-amount { font-size: 2.8em; font-weight: 900; color: var(--text-dark); margin: 4px 0; }

    /* Income Section on Home */
    .home-income-section { background: var(--white); border-radius: var(--radius); padding: 16px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .home-income-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .home-income-title { font-weight: 900; font-size: 0.95em; color: var(--text-dark); }
    .home-income-total { font-size: 1.1em; font-weight: 900; color: var(--income); }
    .income-sub-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .income-sub-card { background: #F0FBF3; border-radius: var(--radius-sm); padding: 14px 10px; text-align: center; cursor: pointer; transition: transform 0.2s; }
    .income-sub-card:hover { transform: translateY(-2px); }
    .income-sub-card .isc-icon { font-size: 1.5em; margin-bottom: 6px; }
    .income-sub-card .isc-name { font-size: 0.72em; font-weight: 700; color: var(--text-med); margin-bottom: 4px; }
    .income-sub-card .isc-amount { font-size: 1em; font-weight: 900; color: var(--income); }

    .budget-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .budget-card { background: var(--white); border-radius: var(--radius); padding: 16px 12px 14px; text-align: center; box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
    .budget-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow-hover); }
    .budget-card .cat-icon { width: 48px; height: 48px; border-radius: 14px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4em; }
    .budget-card .cat-name { font-size: 0.72em; font-weight: 700; color: var(--text-med); margin-bottom: 4px; }
    .budget-card .cat-amount { font-size: 1.05em; font-weight: 900; color: var(--text-dark); }
    .budget-card .cat-bar { height: 3px; background: #F0F0F0; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .budget-card .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
    .budget-card.food { background: #FFF3EE; } .budget-card.food .cat-icon { background: #FFE0D3; }
    .budget-card.transport { background: #EEF5FF; } .budget-card.transport .cat-icon { background: #D6EAFF; }
    .budget-card.housing { background: #FFF5EE; } .budget-card.housing .cat-icon { background: #FFE5CC; }
    .budget-card.health { background: #F0FAFA; } .budget-card.health .cat-icon { background: #D0F0EE; }
    .budget-card.shopping { background: #FFF0F0; } .budget-card.shopping .cat-icon { background: #FFD6D6; }
    .budget-card.membership { background: #FFFBEE; } .budget-card.membership .cat-icon { background: #FFF0C0; }
    .budget-card.giving { background: #FFF0F7; } .budget-card.giving .cat-icon { background: #FFD6EA; }
    .budget-card.invest { background: #F0FBF3; } .budget-card.invest .cat-icon { background: #C6F0D0; }
    .budget-card.debt-cat { background: #F5F0FF; } .budget-card.debt-cat .cat-icon { background: #E0D5FF; }
    .budget-card.other-cat { background: #F5F8FF; } .budget-card.other-cat .cat-icon { background: #D8E5FF; }

    /* ── TRANSACTIONS ── */
    .search-bar { background: var(--white); border-radius: var(--radius-sm); padding: 12px 16px; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; box-shadow: var(--card-shadow); }
    .search-bar input { border: none; background: none; font-family: 'Nunito', sans-serif; font-size: 0.95em; color: var(--text-dark); flex: 1; outline: none; }
    .search-bar input::placeholder { color: var(--text-light); }

    .filter-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
    .filter-chip { background: var(--white); border: 2px solid transparent; border-radius: 20px; padding: 6px 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.78em; color: var(--text-med); cursor: pointer; box-shadow: var(--card-shadow); white-space: nowrap; transition: all 0.2s; }
    .filter-chip.active { border-color: var(--yellow); background: var(--yellow-light); color: var(--text-dark); }
    .date-filter-input { background: var(--white); border: 1.5px solid #EEE; border-radius: var(--radius-sm); padding: 7px 10px; font-family: 'Nunito', sans-serif; font-size: 0.8em; font-weight: 700; color: var(--text-dark); outline: none; }
    .date-filter-input:focus { border-color: var(--yellow); }

    .tx-date-group { margin-bottom: 16px; }
    .tx-date-label { font-size: 0.82em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding: 0 4px; display: flex; justify-content: space-between; }
    .tx-row { background: var(--white); border-radius: var(--radius-sm); padding: 12px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.15s; }
    .tx-row:hover { transform: translateX(4px); }
    .tx-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; flex-shrink: 0; }
    .tx-info { flex: 1; }
    .tx-cat { font-weight: 800; font-size: 0.9em; color: var(--text-dark); }
    .tx-sub { font-size: 0.78em; color: var(--text-light); font-weight: 600; margin-top: 2px; }
    .tx-amount { font-weight: 900; font-size: 1em; }
    .tx-amount.expense { color: var(--expenses); }
    .tx-amount.income-c { color: var(--income); }
    .tx-amount.invest-c { color: var(--portfolio); }
    .tx-time { font-size: 0.72em; color: var(--text-light); margin-top: 2px; text-align: right; }

    /* ── CATEGORY MANAGER ── */
    .cat-mgr-tabs { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px; }
    .cat-mgr-tab { background:#F0F0F0; border:none; border-radius:20px; padding:6px 14px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.78em; color:var(--text-med); cursor:pointer; transition:all 0.2s; }
    .cat-mgr-tab.active { background:var(--yellow); color:var(--text-dark); }
    .cat-pills-wrap { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; min-height:36px; }
    .cat-pill { display:flex; align-items:center; gap:5px; background:var(--bg-cream); border:1.5px solid #E8E8E8; border-radius:20px; padding:6px 10px 6px 12px; font-size:0.8em; font-weight:700; color:var(--text-dark); }
    .cat-pill-del { background:none; border:none; cursor:pointer; color:var(--text-light); font-size:0.85em; font-weight:900; line-height:1; padding:0; transition:color 0.15s; }
    .cat-pill-del:hover { color:var(--expenses); }
    .cat-add-row { display:flex; gap:8px; align-items:center; }
    .cat-add-input { flex:1; border:1.5px solid #E8E8E8; border-radius:10px; padding:9px 12px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.88em; color:var(--text-dark); outline:none; background:var(--white); }
    .cat-add-input:focus { border-color:var(--yellow); }
    .cat-add-btn { background:var(--yellow); border:none; border-radius:10px; padding:9px 16px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.88em; cursor:pointer; color:var(--text-dark); white-space:nowrap; }
    .cat-add-btn:hover { background:#e8b900; }
    /* Quick-add subcats with delete on hold */
    .qa-sub-pill { position:relative; }
    .qa-sub-pill .qa-pill-del { display:none; position:absolute; top:-6px; right:-6px; background:var(--expenses); color:white; border:none; border-radius:50%; width:16px; height:16px; font-size:0.6em; font-weight:900; cursor:pointer; align-items:center; justify-content:center; line-height:1; padding:0; }
    .qa-sub-pill.delete-mode .qa-pill-del { display:flex; }

    /* ── CALENDAR MODULE ── */
    .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .cal-month-title { font-size:1.25em; font-weight:900; color:var(--text-dark); }
    .cal-nav-btn { background:var(--white); border:none; border-radius:12px; width:38px; height:38px; font-size:1.4em; color:var(--text-dark); cursor:pointer; box-shadow:var(--card-shadow); display:flex; align-items:center; justify-content:center; font-weight:900; transition:background 0.15s; line-height:1; }
    .cal-nav-btn:hover { background:var(--yellow); }
    .cal-summary { display:flex; background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:14px 10px; margin-bottom:14px; align-items:center; justify-content:space-around; }
    .cal-sum-item { text-align:center; }
    .cal-sum-label { font-size:0.68em; font-weight:800; color:var(--text-light); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.4px; }
    .cal-sum-val { font-size:1.05em; font-weight:900; }
    .cal-sum-item.income .cal-sum-val { color:var(--income); }
    .cal-sum-item.expense .cal-sum-val { color:var(--expenses); }
    .cal-sum-item.savings .cal-sum-val { color:#7C3AED; }
    .cal-sum-item.net .cal-sum-val { color:var(--text-dark); }
    .cal-sum-divider { width:1px; height:32px; background:#F0F0F0; }
    .cal-grid-wrap { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); overflow:hidden; margin-bottom:14px; }
    .settings-accordion { background:white; border-radius:16px; box-shadow:0 1px 6px rgba(0,0,0,0.06); margin-bottom:10px; overflow:hidden; }
    .acc-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; cursor:pointer; font-size:0.82em; font-weight:900; color:var(--text-dark); user-select:none; }
    .acc-header:hover { background:#FAFAFA; }
    .acc-chev { font-size:1em; font-weight:900; color:var(--text-light); transition:transform 0.2s; flex-shrink:0; }
    .acc-body { padding:0 16px 16px; }
    .cal-dow-row { display:grid; grid-template-columns:repeat(7,1fr); padding:10px 0 8px; border-bottom:1px solid #F5F5F5; }
    .cal-dow { text-align:center; font-size:0.7em; font-weight:900; color:var(--text-light); letter-spacing:0.3px; }
    .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); }
    .cal-cell { border-right:1px solid #F5F5F5; border-bottom:1px solid #F5F5F5; padding:6px 3px 5px; min-height:70px; cursor:pointer; transition:background 0.15s; display:flex; flex-direction:column; align-items:center; }
    .cal-cell:nth-child(7n) { border-right:none; }
    .cal-cell:hover:not(.empty) { background:#FAFAFA; }
    .cal-cell.empty { cursor:default; }
    .cal-cell.today .cal-day-num { background:var(--yellow); color:var(--text-dark); }
    .cal-cell.selected { background:var(--yellow-light); }
    .cal-cell.selected .cal-day-num { background:var(--yellow); }
    .cal-day-num { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8em; font-weight:800; color:var(--text-dark); margin-bottom:4px; transition:background 0.15s; }
    .cal-dots { display:flex; gap:2px; flex-wrap:wrap; justify-content:center; margin-bottom:3px; min-height:8px; }
    .cal-dot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
    .cal-cell-amt { font-size:0.58em; font-weight:900; line-height:1.3; text-align:center; }
    .cal-detail-header { font-size:0.82em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px; padding:0 4px; display:flex; justify-content:space-between; align-items:center; }
    .author-filter-wrap { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .author-toggle-btn { flex-shrink:0; width:34px; height:34px; border-radius:50%; background:var(--white); border:1.5px solid #E8E8E8; display:flex; align-items:center; justify-content:center; font-size:1em; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,0.08); transition:all 0.2s; }
    .author-toggle-btn.active { background:var(--yellow); border-color:var(--yellow); }
    .author-chips-slide { display:flex; gap:6px; flex:1; overflow:hidden; max-width:0; transition:max-width 0.35s ease, opacity 0.25s ease; opacity:0; }
    .author-chips-slide.open { max-width:600px; opacity:1; }
    .author-chips-scroll { display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; }
    .author-chips-scroll::-webkit-scrollbar { display:none; }
    .author-chip { flex-shrink:0; padding:5px 12px; border-radius:20px; font-size:0.72em; font-weight:800; border:1.5px solid #E8E8E8; background:white; color:var(--text-med); cursor:pointer; transition:all 0.15s; font-family:Nunito,sans-serif; white-space:nowrap; }
    .author-chip.active { background:var(--yellow); border-color:var(--yellow); color:var(--text-dark); }
    .cal-detail-header .cal-det-right { display:flex; gap:8px; }
    .cal-empty-day { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:24px; text-align:center; color:var(--text-light); }

    /* ── HOME TABS (Spending / Investment) ── */
    .home-tab-bar { display:flex; background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); margin-bottom:16px; padding:4px; gap:4px; }
    .home-tab-btn { flex:1; padding:11px 8px; border:none; border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:900; font-size:0.88em; cursor:pointer; background:none; color:var(--text-light); transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .home-tab-btn.active { background:var(--yellow); color:var(--text-dark); box-shadow:0 2px 10px rgba(245,200,66,0.4); }
    .home-section { display:none; }
    .home-section.active { display:block; }

    /* ── INVESTMENT HOME GRID ── */
    .invest-home-hero { text-align:center; padding:4px 0 16px; }
    .invest-home-hero-label { font-size:0.88em; font-weight:700; color:var(--text-med); }
    .invest-home-hero-amt { font-size:2.6em; font-weight:900; color:var(--text-dark); margin:4px 0; }
    .invest-cat-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:16px; }
    .invest-cat-card { background:var(--white); border-radius:var(--radius); padding:16px; box-shadow:var(--card-shadow); cursor:pointer; transition:transform 0.2s,box-shadow 0.2s; }
    .invest-cat-card:hover { transform:translateY(-2px); box-shadow:var(--card-shadow-hover); }
    .inv-card-icon { width:46px; height:46px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.35em; margin-bottom:10px; }
    .inv-card-label { font-size:0.72em; font-weight:800; color:var(--text-med); margin-bottom:4px; text-transform:uppercase; letter-spacing:0.3px; }
    .inv-card-amt { font-size:1.08em; font-weight:900; color:var(--text-dark); }
    .inv-card-units { font-size:0.72em; color:var(--text-light); font-weight:600; margin-top:3px; }
    .inv-card-bar { height:3px; background:#F0F0F0; border-radius:4px; margin-top:10px; overflow:hidden; }
    .inv-card-bar-fill { height:100%; border-radius:4px; transition:width 0.6s; }

    /* ── INVESTMENT QUICK-ADD MODAL ── */
    .inv-type-tabs { display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; margin-bottom:16px; padding-bottom:2px; }
    .inv-type-tabs::-webkit-scrollbar { display:none; }
    .inv-type-chip { flex-shrink:0; border:none; border-radius:20px; padding:7px 14px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.78em; cursor:pointer; background:#F0F0F0; color:var(--text-med); transition:all 0.2s; }
    .inv-type-chip.active { color:white; }
    .inv-fields-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
    .inv-field-box { display:flex; flex-direction:column; gap:5px; }
    .inv-field-box.full { grid-column:span 2; }
    .inv-field-box label { font-size:0.7em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.4px; }
    .inv-field-input, .inv-field-select { border:1.5px solid #EEE; border-radius:10px; padding:9px 10px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.88em; color:var(--text-dark); outline:none; background:var(--white); width:100%; }
    .inv-field-input:focus, .inv-field-select:focus { border-color:#7C3AED; }
    .inv-total-pill { background:#F3EEFF; border-radius:12px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .inv-total-pill-label { font-size:0.75em; font-weight:900; color:#7C3AED; }
    .inv-total-pill-val { font-size:1.2em; font-weight:900; color:#7C3AED; }
    .inv-save-btn { width:100%; background:#7C3AED; border:none; border-radius:var(--radius-sm); padding:16px; font-family:'Nunito',sans-serif; font-weight:900; font-size:1em; color:white; cursor:pointer; transition:background 0.2s; }
    .inv-save-btn:hover { background:#6D28D9; }

    /* ── CURRENCY PICKER ── */
    .curr-search { width:100%; border:1.5px solid #EEE; border-radius:10px; padding:10px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.9em; color:var(--text-dark); outline:none; margin-bottom:8px; box-sizing:border-box; }
    .curr-search:focus { border-color:var(--yellow); }
    .curr-list { max-height:300px; overflow-y:auto; }
    .curr-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer; transition:background 0.15s; }
    .curr-item:hover { background:#F5F5F5; }
    .curr-item.active { background:var(--yellow-light); }
    .curr-flag { font-size:1.3em; width:28px; text-align:center; flex-shrink:0; }
    .curr-info { flex:1; }
    .curr-name { font-weight:800; font-size:0.88em; color:var(--text-dark); }
    .curr-country { font-size:0.72em; color:var(--text-light); font-weight:600; }
    .curr-code { font-weight:900; font-size:0.88em; color:var(--text-med); }
    .curr-symbol { font-size:1em; font-weight:900; color:var(--text-dark); min-width:20px; text-align:right; }

    /* ── HOME CARD MANAGER (Settings) ── */
    .home-card-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
    .home-card-item { display:flex; align-items:center; gap:8px; background:#F8F8F8; border-radius:10px; padding:8px 10px; }
    .home-card-item-icon { font-size:1.1em; }
    .home-card-item-label { flex:1; font-weight:800; font-size:0.82em; color:var(--text-dark); }
    .home-card-toggle { background:none; border:none; cursor:pointer; font-size:1em; padding:0; color:var(--text-light); transition:color 0.15s; font-weight:900; }
    .home-card-toggle.on { color:var(--income); }
    .home-card-add-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px; }
    .home-card-emoji-pick { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:8px; }
    .emoji-opt { font-size:1.2em; cursor:pointer; padding:4px; border-radius:6px; transition:background 0.15s; }
    .emoji-opt:hover, .emoji-opt.selected { background:var(--yellow-light); }

    /* ── STATS ── */
    .chart-card { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .chart-title { font-weight: 800; font-size: 0.9em; color: var(--text-med); margin-bottom: 14px; }
    .chart-container { position: relative; height: 200px; }
    .spending-tops { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .top-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .top-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .top-label { flex: 1; font-weight: 700; font-size: 0.9em; color: var(--text-dark); }
    .top-pct { font-weight: 800; font-size: 0.85em; color: var(--text-med); }

    /* ── ACCOUNT ── */
    .networth-card { background: var(--white); border-radius: var(--radius); padding: 24px; text-align: center; box-shadow: var(--card-shadow); margin-bottom: 20px; }
    .nw-label { color: var(--text-light); font-size: 0.85em; font-weight: 700; margin-bottom: 8px; }
    .nw-amount { font-size: 2.5em; font-weight: 900; color: var(--text-dark); }
    .nw-sub { display: flex; justify-content: center; gap: 24px; margin-top: 12px; flex-wrap: wrap; }
    .nw-sub-item { font-size: 0.82em; font-weight: 700; color: var(--text-med); }
    .nw-sub-item span { color: var(--text-dark); display: block; font-size: 1.15em; }
    .account-section-title { font-weight: 900; font-size: 0.9em; color: var(--text-med); margin-bottom: 12px; letter-spacing: 0.3px; }
    .account-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .account-card { background: var(--white); border-radius: var(--radius-sm); padding: 14px 10px; text-align: center; box-shadow: var(--card-shadow); cursor: pointer; }
    .account-card .acc-icon { font-size: 1.6em; margin-bottom: 6px; }
    .account-card .acc-name { font-size: 0.72em; font-weight: 700; color: var(--text-light); margin-bottom: 4px; }
    .account-card .acc-amount { font-size: 0.95em; font-weight: 900; color: var(--text-dark); }
    .account-card.credit .acc-amount { color: var(--expenses); }

    /* ── ADD SCREEN ── */
    .add-type-toggle { display: flex; background: var(--white); border-radius: var(--radius-sm); padding: 4px; gap: 4px; box-shadow: var(--card-shadow); margin-bottom: 16px; overflow-x: auto; }
    .add-type-btn { flex: 1; padding: 10px 8px; border: none; border-radius: 10px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.82em; cursor: pointer; background: none; color: var(--text-light); white-space: nowrap; transition: all 0.2s; }
    .add-type-btn.active { background: var(--yellow); color: var(--text-dark); box-shadow: 0 2px 8px rgba(245,200,66,0.4); }

    .amount-display { background: var(--white); border-radius: var(--radius); padding: 30px 20px; text-align: center; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .amount-display .amount-num { font-size: 3em; font-weight: 900; color: var(--text-dark); letter-spacing: -2px; }
    .amount-display .amount-cur { color: var(--text-light); font-size: 0.5em; vertical-align: super; }

    .sub-cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 16px; scrollbar-width: none; }
    .sub-cats::-webkit-scrollbar { display: none; }
    .sub-cat-pill { background: var(--white); border: 2px solid transparent; border-radius: 20px; padding: 6px 14px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.82em; color: var(--text-med); cursor: pointer; white-space: nowrap; transition: all 0.2s; }
    .sub-cat-pill.active { border-color: var(--yellow); background: var(--yellow-light); color: var(--text-dark); }

    .add-form { background: var(--white); border-radius: var(--radius); padding: 16px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .form-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #F5F5F5; }
    .form-row:last-child { border-bottom: none; }
    .form-icon { font-size: 1.2em; width: 28px; text-align: center; }
    .form-label { font-weight: 700; color: var(--text-med); font-size: 0.88em; min-width: 80px; }
    .form-input { flex: 1; border: none; background: none; font-family: 'Nunito', sans-serif; font-size: 0.92em; font-weight: 700; color: var(--text-dark); text-align: right; outline: none; }
    .form-input::placeholder { color: var(--text-light); }
    .form-select { border: none; background: none; font-family: 'Nunito', sans-serif; font-size: 0.92em; font-weight: 700; color: var(--text-dark); text-align: right; outline: none; cursor: pointer; flex: 1; direction: rtl; }

    .numpad { background: var(--white); border-radius: var(--radius); padding: 16px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .numpad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .num-btn { background: #F8F8F8; border: none; border-radius: 12px; padding: 16px 8px; font-family: 'Nunito', sans-serif; font-size: 1.1em; font-weight: 800; color: var(--text-dark); cursor: pointer; transition: background 0.15s; text-align: center; }
    .num-btn:hover { background: #F0F0F0; }
    .num-btn.special { color: var(--text-med); font-size: 0.9em; }
    .num-btn.save-btn { background: var(--yellow); color: var(--text-dark); font-weight: 900; font-size: 1em; }
    .num-btn.save-btn:hover { background: #E8B800; }

    /* ── DATA SCREEN ── */
    .data-controls { background: var(--white); border-radius: var(--radius); padding: 16px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .data-controls-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .data-controls-row:last-child { margin-bottom: 0; }
    .data-label { font-size: 0.82em; font-weight: 800; color: var(--text-med); }

    .data-section { background: var(--white); border-radius: var(--radius); box-shadow: var(--card-shadow); margin-bottom: 14px; overflow: hidden; }
    .data-section-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 18px; cursor: pointer; border-bottom: 1px solid #F5F5F5; gap: 10px; flex-wrap: wrap; }
    .data-section-title { display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 0.95em; color: var(--text-dark); }
    .data-section-total { font-size: 0.85em; font-weight: 700; }
    .data-section-actions { display: flex; gap: 6px; }
    .data-section-body { display: none; }
    .data-section-body.open { display: block; }

    .data-table-wrap { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 480px; }
    .data-table th { background: #F8F8F8; padding: 10px 10px; text-align: left; font-size: 0.78em; font-weight: 800; color: var(--text-med); text-transform: uppercase; letter-spacing: 0.4px; cursor: pointer; user-select: none; white-space: nowrap; }
    .data-table th:hover { background: var(--yellow-light); color: var(--text-dark); }
    .data-table td { padding: 10px 10px; border-bottom: 1px solid #F8F8F8; font-size: 0.88em; font-weight: 600; color: var(--text-dark); }
    .data-table td[contenteditable="true"]:hover { background: rgba(245,200,66,0.08); outline: 1px solid var(--yellow); cursor: text; }
    .data-table td[contenteditable="true"]:focus { background: var(--yellow-light); outline: 2px solid var(--yellow); }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: #FAFAFA; }
    .del-btn-sm { background: #FFF0F0; border: none; border-radius: 8px; padding: 4px 8px; font-size: 0.82em; color: var(--expenses); cursor: pointer; font-weight: 700; }
    .del-btn-sm:hover { background: var(--expenses); color: white; }
    .icon-btn { background: var(--white); border: 1.5px solid #EEE; border-radius: 8px; padding: 6px 10px; font-size: 0.78em; font-weight: 800; color: var(--text-med); cursor: pointer; }
    .icon-btn:hover { border-color: var(--yellow); background: var(--yellow-light); color: var(--text-dark); }
    .icon-btn.danger:hover { border-color: var(--expenses); background: #FFF0F0; color: var(--expenses); }

    .quick-add-row { display: flex; gap: 8px; padding: 14px 16px; border-top: 1px solid #F5F5F5; flex-wrap: wrap; align-items: center; background: #FAFAFA; }
    .qa-input { background: var(--white); border: 1.5px solid #EEE; border-radius: var(--radius-sm); padding: 8px 12px; font-family: 'Nunito', sans-serif; font-size: 0.85em; font-weight: 700; color: var(--text-dark); outline: none; flex: 1; min-width: 80px; }
    .qa-input:focus { border-color: var(--yellow); background: var(--yellow-light); }
    .qa-input::placeholder { color: var(--text-light); font-weight: 600; }
    .qa-btn { background: var(--yellow); border: none; border-radius: var(--radius-sm); padding: 8px 14px; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 0.85em; color: var(--text-dark); cursor: pointer; white-space: nowrap; }
    .qa-btn:hover { background: #E8B800; }

    .import-panel { padding: 14px 16px; border-top: 1px solid #F5F5F5; }
    .import-panel-title { font-size: 0.78em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 8px; }
    .paste-area { width: 100%; height: 90px; background: #F8F8F8; border: 1.5px solid #EEE; border-radius: var(--radius-sm); padding: 10px 12px; font-family: monospace; font-size: 0.82em; color: var(--text-dark); resize: vertical; outline: none; }
    .paste-area:focus { border-color: var(--yellow); }
    .import-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }

    /* ── METALS ── */
    .metals-portfolio-bar { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .metals-portfolio-title { font-size: 0.78em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px; }
    .metals-portfolio-total { font-size: 2.2em; font-weight: 900; color: var(--text-dark); margin-bottom: 16px; }
    .metals-mini-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .metals-mini-card { border-radius: var(--radius-sm); padding: 12px 10px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .metals-mini-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow-hover); }
    .metals-mini-card.active-metal { box-shadow: 0 0 0 2.5px var(--text-dark); }
    .metals-mini-card.gold-card { background: linear-gradient(145deg, #FFF3C4, #FFE580); }
    .metals-mini-card.silver-card { background: linear-gradient(145deg, #E8EDF2, #D0D8E0); }
    .metals-mini-card.platinum-card { background: linear-gradient(145deg, #DDE5EC, #C5D2DC); }
    .metals-mini-icon { font-size: 1.6em; margin-bottom: 6px; }
    .metals-mini-name { font-size: 0.72em; font-weight: 800; color: var(--text-med); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.4px; }
    .metals-mini-grams { font-size: 1em; font-weight: 900; color: var(--text-dark); }
    .metals-mini-usd { font-size: 0.72em; font-weight: 700; color: var(--text-med); margin-top: 2px; }

    .metal-detail-header { display: flex; align-items: center; gap: 14px; padding: 18px 20px; background: var(--white); border-radius: var(--radius); box-shadow: var(--card-shadow); margin-bottom: 14px; }
    .metal-detail-icon-wrap { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8em; flex-shrink: 0; }
    .metal-detail-icon-wrap.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
    .metal-detail-icon-wrap.silver { background: linear-gradient(135deg, #C0C0C0, #8A9BA8); }
    .metal-detail-icon-wrap.platinum { background: linear-gradient(135deg, #8FA4B2, #4A6070); }
    .metal-detail-info { flex: 1; }
    .metal-detail-name { font-size: 1.1em; font-weight: 900; color: var(--text-dark); }
    .metal-detail-grams { font-size: 0.82em; font-weight: 700; color: var(--text-med); margin-top: 3px; }
    .metal-detail-usd { font-size: 1.4em; font-weight: 900; margin-top: 2px; }
    .metal-detail-usd.gold { color: #C8900A; } .metal-detail-usd.silver { color: #6E7A8A; } .metal-detail-usd.platinum { color: #4A5C6E; }
    .metal-stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 14px; }
    .metal-stat-box { background: var(--white); border-radius: var(--radius-sm); padding: 12px; text-align: center; box-shadow: var(--card-shadow); }
    .metal-stat-box-val { font-size: 1em; font-weight: 900; color: var(--text-dark); }
    .metal-stat-box-lbl { font-size: 0.7em; font-weight: 700; color: var(--text-light); margin-top: 3px; text-transform: uppercase; }
    .metal-add-panel { background: var(--white); border-radius: var(--radius); box-shadow: var(--card-shadow); margin-bottom: 14px; overflow: hidden; }
    .metal-add-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; cursor: pointer; user-select: none; }
    .metal-add-panel-title { font-weight: 900; font-size: 0.95em; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
    .metal-add-panel-toggle { font-size: 1.2em; color: var(--text-light); transition: transform 0.2s; }
    .metal-add-panel-body { display: none; padding: 0 20px 20px; border-top: 1px solid #F0F0F0; }
    .metal-add-panel-body.open { display: block; }
    .metal-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 14px 0; }
    .metal-form-field { display: flex; flex-direction: column; gap: 5px; }
    .metal-form-field label { font-size: 0.72em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.4px; }
    .metal-form-field input, .metal-form-field select { background: #F8F8F8; border: 1.5px solid #EEE; border-radius: 10px; padding: 10px 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.88em; color: var(--text-dark); outline: none; width: 100%; }
    .metal-form-field input:focus, .metal-form-field select:focus { border-color: var(--yellow); background: var(--yellow-light); }
    .metal-form-field.full { grid-column: span 2; }
    .metal-save-btn { width: 100%; border: none; border-radius: var(--radius-sm); padding: 14px; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 0.95em; color: white; cursor: pointer; }
    .metal-save-btn.gold { background: linear-gradient(135deg, #C8900A, #F5C842); }
    .metal-save-btn.silver { background: linear-gradient(135deg, #6E7A8A, #9BA8B5); }
    .metal-save-btn.platinum { background: linear-gradient(135deg, #4A5C6E, #6B8FA6); }
    .metal-holdings-card { background: var(--white); border-radius: var(--radius); box-shadow: var(--card-shadow); overflow: hidden; margin-bottom: 16px; }
    .metal-holdings-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #F5F5F5; }
    .metal-holdings-title { font-weight: 900; font-size: 0.95em; color: var(--text-dark); }
    .metal-holdings-count { font-size: 0.78em; font-weight: 700; color: var(--text-light); background: #F5F5F5; padding: 4px 10px; border-radius: 20px; }
    .metal-holding-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-bottom: 1px solid #F8F8F8; }
    .metal-holding-item:last-child { border-bottom: none; }
    .metal-holding-badge { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; flex-shrink: 0; }
    .metal-holding-badge.gold { background: linear-gradient(135deg, #FFE080, #FFD700); }
    .metal-holding-badge.silver { background: linear-gradient(135deg, #D8E0E8, #B0BBC5); }
    .metal-holding-badge.platinum { background: linear-gradient(135deg, #C0CDD6, #8A9FAD); }
    .metal-holding-main { flex: 1; min-width: 0; }
    .metal-holding-top { display: flex; align-items: center; gap: 8px; }
    .metal-holding-name-text { font-weight: 800; font-size: 0.9em; color: var(--text-dark); }
    .metal-holding-form-chip { font-size: 0.68em; font-weight: 800; padding: 2px 7px; border-radius: 6px; background: #F0F0F0; color: var(--text-med); }
    .metal-holding-bottom { font-size: 0.76em; font-weight: 600; color: var(--text-light); margin-top: 3px; }
    .metal-holding-right { text-align: right; flex-shrink: 0; }
    .metal-holding-value { font-size: 1em; font-weight: 900; color: var(--text-dark); }
    .metal-holding-weight { font-size: 0.76em; font-weight: 700; color: var(--text-light); margin-top: 2px; }
    .metal-holding-del { background: none; border: none; color: #DDD; font-size: 1em; cursor: pointer; padding: 4px; border-radius: 6px; }
    .metal-holding-del:hover { color: var(--expenses); background: #FFF0F0; }
    .metal-empty { text-align: center; padding: 40px 20px; color: var(--text-light); }
    .metal-empty-icon { font-size: 2.5em; margin-bottom: 10px; opacity: 0.5; }
    .metal-empty-text { font-weight: 700; font-size: 0.9em; }

    /* ── INVESTMENTS ── */
    .invest-hero { background: linear-gradient(135deg, #7C3AED 0%, #A855F7 60%, #C084FC 100%); border-radius: var(--radius); padding: 24px; margin-bottom: 16px; position: relative; overflow: hidden; }
    .invest-hero-label { color: rgba(255,255,255,0.85); font-size: 0.85em; font-weight: 700; margin-bottom: 6px; }
    .invest-hero-value { color: #fff; font-size: 2.4em; font-weight: 900; }
    .invest-hero-stats { display: flex; gap: 12px; margin-top: 14px; flex-wrap: wrap; }
    .invest-hero-stat { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px 14px; }
    .invest-hero-stat-val { color: #fff; font-weight: 900; font-size: 1em; }
    .invest-hero-stat-lbl { color: rgba(255,255,255,0.75); font-size: 0.72em; font-weight: 700; margin-top: 2px; }
    .invest-deco { position: absolute; right: -10px; top: -10px; font-size: 5em; opacity: 0.1; }
    .invest-cat-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 16px; scrollbar-width: none; }
    .invest-cat-tabs::-webkit-scrollbar { display: none; }
    .invest-cat-tab { background: var(--white); border: 2px solid transparent; border-radius: 20px; padding: 8px 16px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.82em; color: var(--text-med); cursor: pointer; white-space: nowrap; box-shadow: var(--card-shadow); }
    .invest-cat-tab.active { border-color: var(--portfolio); background: var(--portfolio-light); color: var(--portfolio); }
    .invest-holding-row { background: var(--white); border-radius: var(--radius-sm); padding: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; box-shadow: var(--card-shadow); cursor: pointer; }
    .invest-holding-row:hover { transform: translateX(4px); }
    .invest-ticker-badge { background: var(--portfolio-light); color: var(--portfolio); border-radius: 10px; padding: 8px 10px; font-weight: 900; font-size: 0.85em; min-width: 56px; text-align: center; flex-shrink: 0; }
    .invest-info { flex: 1; }
    .invest-name { font-weight: 800; font-size: 0.9em; color: var(--text-dark); }
    .invest-detail { font-size: 0.78em; color: var(--text-light); font-weight: 600; margin-top: 2px; }
    .invest-values { text-align: right; }
    .invest-value { font-weight: 900; font-size: 1em; color: var(--text-dark); }
    .invest-gain { font-size: 0.78em; font-weight: 700; margin-top: 2px; }
    .invest-gain.up { color: var(--income); } .invest-gain.down { color: var(--expenses); }
    .invest-entry-card { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .invest-entry-title { font-weight: 900; font-size: 0.95em; color: var(--text-dark); margin-bottom: 14px; }
    .inv-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .inv-field { display: flex; flex-direction: column; gap: 5px; }
    .inv-field label { font-size: 0.72em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.4px; }
    .inv-field input, .inv-field select { background: #F8F8F8; border: 1.5px solid #EEE; border-radius: 10px; padding: 10px 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.88em; color: var(--text-dark); outline: none; width: 100%; }
    .inv-field input:focus, .inv-field select:focus { border-color: var(--portfolio); background: var(--portfolio-light); }
    .inv-field.full { grid-column: span 2; }
    .add-invest-btn { width: 100%; background: var(--portfolio); border: none; border-radius: var(--radius-sm); padding: 16px; font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 0.95em; color: white; cursor: pointer; margin-top: 4px; }

    /* ── MODAL (shared) ── */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 200; backdrop-filter: blur(4px); }
    .modal-overlay.open { display: flex; align-items: flex-end; justify-content: center; }
    .modal { background: var(--white); border-radius: 24px 24px 0 0; padding: 24px 20px; width: 100%; max-width: 480px; max-height: 92vh; overflow-y: auto; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 1.1em; font-weight: 900; color: var(--text-dark); }
    .modal-close { background: #F0F0F0; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1em; color: var(--text-med); display: flex; align-items: center; justify-content: center; }

    /* ── QUICK ADD POPUP ── */
    #quick-add-modal .modal { padding-bottom: 32px; }
    .qa-type-row { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; margin-bottom: 14px; }
    .qa-type-row::-webkit-scrollbar { display: none; }
    .qa-type-chip { flex-shrink: 0; padding: 8px 14px; border: 2px solid transparent; border-radius: 20px; font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.8em; background: #F5F5F5; color: var(--text-med); cursor: pointer; transition: all 0.2s; }
    .qa-type-chip.active { background: var(--yellow); color: var(--text-dark); border-color: var(--yellow); }

    .qa-amount-row { display: flex; align-items: center; background: #F8F8F8; border-radius: var(--radius-sm); padding: 12px 16px; margin-bottom: 14px; }
    .qa-currency-sym { font-size: 1.2em; font-weight: 900; color: var(--text-light); margin-right: 6px; }
    .qa-amount-input { flex: 1; border: none; background: none; font-family: 'Nunito', sans-serif; font-size: 2em; font-weight: 900; color: var(--text-dark); outline: none; width: 100%; }

    .qa-sub-cats { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; margin-bottom: 12px; padding-bottom: 2px; }
    .qa-sub-cats::-webkit-scrollbar { display: none; }
    .qa-sub-pill { flex-shrink: 0; padding: 6px 12px; border: 2px solid #EEE; border-radius: 20px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.78em; color: var(--text-med); cursor: pointer; background: var(--white); transition: all 0.15s; }
    .qa-sub-pill.active { border-color: var(--yellow); background: var(--yellow-light); color: var(--text-dark); }

    .qa-fields-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .qa-field { display: flex; flex-direction: column; gap: 4px; }
    .qa-field label { font-size: 0.7em; font-weight: 800; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.4px; }
    .qa-field input, .qa-field select { background: #F8F8F8; border: 1.5px solid #EEE; border-radius: 10px; padding: 10px 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 0.85em; color: var(--text-dark); outline: none; }
    .qa-field input:focus, .qa-field select:focus { border-color: var(--yellow); background: var(--yellow-light); }
    .qa-field.full { grid-column: span 2; }

    .qa-numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 14px; }
    .qa-key { background: #F5F5F5; border: none; border-radius: 12px; padding: 14px 8px; font-family: 'Nunito', sans-serif; font-size: 1.2em; font-weight: 800; color: var(--text-dark); cursor: pointer; transition: all 0.12s; text-align: center; -webkit-tap-highlight-color: transparent; }
    .qa-key:active { background: #E8E8E8; transform: scale(0.94); }
    .qa-key.qa-del { font-size: 1em; color: var(--text-med); }
    .qa-key.qa-dot { font-size: 1.3em; }
    .qa-key.qa-save { background: var(--yellow); color: var(--text-dark); font-size: 0.9em; font-weight: 900; }
    .qa-key.qa-save:active { background: #E8B800; }
    #qa-refund-toggle.active { background:#EF4444 !important;color:white !important;border-color:#EF4444 !important; }

    /* ══ SETTINGS ══ */
    .settings-card { background: var(--white); border-radius: var(--radius); padding: 24px; box-shadow: var(--card-shadow); margin-bottom: 16px; }
    .settings-title { font-weight: 900; font-size: 1.05em; color: var(--text-dark); margin-bottom: 16px; }

    /* Theme Selector */
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .theme-card { border-radius: var(--radius-sm); padding: 14px 12px; cursor: pointer; border: 2.5px solid transparent; transition: all 0.2s; position: relative; overflow: hidden; }
    .theme-card.active-theme { border-color: var(--text-dark); }
    .theme-card .tc-preview { font-size: 2em; margin-bottom: 6px; line-height: 1; }
    .theme-card .tc-name { font-size: 0.82em; font-weight: 800; color: var(--text-dark); }
    .theme-card .tc-desc { font-size: 0.7em; font-weight: 600; color: var(--text-med); margin-top: 2px; }
    .theme-card .tc-active-badge { position: absolute; top: 8px; right: 8px; background: var(--yellow); border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.65em; }
    .theme-card.active-theme .tc-active-badge { display: flex; }

    /* Theme: Looney Toons */
    .theme-card.looney { background: linear-gradient(135deg, #FFE8F0, #FFC8E8); }
    /* Theme: Jungle */
    .theme-card.jungle { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); }
    /* Theme: Space */
    .theme-card.space { background: linear-gradient(135deg, #1A1A40, #2D1B69); }
    .theme-card.space .tc-name, .theme-card.space .tc-desc { color: #C8C8FF; }
    /* Theme: Ocean */
    .theme-card.ocean { background: linear-gradient(135deg, #E0F4FF, #B3E5FC); }

    /* Theme: Default */
    .theme-card.default { background: linear-gradient(135deg, #FFF9E6, #FFF0B0); }

    /* ── FLOATING THEME ELEMENTS ── */
    /* Looney Tunes characters */
    .looney-char { position: fixed; pointer-events: none; font-size: 2.5em; animation: floatBounce 3s ease-in-out infinite; z-index: 0; opacity: 0; transition: opacity 0.5s; }
    body.theme-looney .looney-char { opacity: 0.35; }
    @keyframes floatBounce { 0%,100%{transform:translateY(0) rotate(-5deg)} 50%{transform:translateY(-12px) rotate(5deg)} }

    /* Jungle elements */
    .jungle-leaf { position: fixed; pointer-events: none; font-size: 2em; animation: leafSway 4s ease-in-out infinite; z-index: 0; opacity: 0; transition: opacity 0.5s; }
    body.theme-jungle .jungle-leaf { opacity: 0.3; }
    @keyframes leafSway { 0%,100%{transform:rotate(-8deg) scale(1)} 50%{transform:rotate(8deg) scale(1.05)} }

    /* Space elements */
    .space-star { position: fixed; pointer-events: none; font-size: 1.2em; animation: twinkle 2s ease-in-out infinite; z-index: 0; opacity: 0; transition: opacity 0.5s; }
    body.theme-space .space-star { opacity: 0.5; }
    @keyframes twinkle { 0%,100%{opacity:0.3;transform:scale(1)} 50%{opacity:0.8;transform:scale(1.2)} }

    /* Ocean elements */
    .ocean-wave { position: fixed; pointer-events: none; font-size: 2em; animation: waveFloat 5s ease-in-out infinite; z-index: 0; opacity: 0; transition: opacity 0.5s; }
    body.theme-ocean .ocean-wave { opacity: 0.25; }

    @keyframes waveFloat { 0%,100%{transform:translateX(0) rotate(0deg)} 50%{transform:translateX(15px) rotate(10deg)} }

    /* ── DECORATIVE ── */
    .deco-circle { position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; }
    .deco-yellow { background: var(--yellow); }
    .deco-blue { background: var(--blue-circle); }

    /* ── TOAST ── */
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--text-dark); color: white; padding: 12px 20px; border-radius: 30px; font-weight: 700; font-size: 0.85em; z-index: 999; opacity: 0; transition: all 0.3s; white-space: nowrap; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .positive { color: var(--income); } .negative { color: var(--expenses); }

    /* ══ BUDGET MODULE ══ */
    .budget-module-tabs { display:flex; gap:8px; margin-bottom:16px; }
    .bm-tab { flex:1; padding:10px 8px; border:none; background:var(--white); border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:800; font-size:0.82em; color:var(--text-light); cursor:pointer; box-shadow:var(--card-shadow); transition:all 0.2s; }
    .bm-tab.active { background:var(--yellow); color:var(--text-dark); }

    /* Overview Hero Card */
    .budget-hero-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:20px; margin-bottom:16px; position:relative; overflow:hidden; }
    .budget-hero-card::before { content:''; position:absolute; top:-30px; right:-30px; width:140px; height:140px; border-radius:50%; background:var(--yellow); opacity:0.12; pointer-events:none; }
    .bh-title { font-size:0.78em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
    .bh-amount { font-size:2.4em; font-weight:900; color:var(--text-dark); line-height:1.1; }
    .bh-sub { font-size:0.85em; font-weight:700; margin-top:2px; }
    .bh-dual-lines { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px; }
    .bh-line-block { background:var(--bg); border-radius:var(--radius-sm); padding:10px 12px; }
    .bh-line-label { font-size:0.68em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.4px; margin-bottom:4px; }
    .bh-line-val { font-size:1em; font-weight:900; }
    .bh-line-sub { font-size:0.72em; font-weight:700; margin-top:2px; }
    .bh-chart-wrap { height:80px; margin:14px 0 4px; position:relative; }
    .bh-view-toggle { display:inline-flex; background:#F0F0F0; border-radius:20px; padding:3px; margin-bottom:10px; }
    .bh-view-btn { border:none; background:none; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.75em; color:var(--text-light); padding:5px 14px; border-radius:16px; cursor:pointer; transition:all 0.2s; }
    .bh-view-btn.active { background:var(--white); color:var(--text-dark); box-shadow:0 1px 4px rgba(0,0,0,0.12); }
    .bh-year-badge { display:inline-block; background:var(--yellow-light); color:var(--text-dark); font-size:0.68em; font-weight:900; padding:2px 7px; border-radius:10px; margin-left:4px; vertical-align:middle; }

    /* Category Bubbles Group Labels */
    #budget-cats-wrapper { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:14px 16px 10px; margin-bottom:16px; }
    .bcat-group-label { display:flex; align-items:center; margin:0 0 8px 0; }
    .bcat-group-label:not(:first-child) { margin-top:14px; padding-top:14px; border-top:1px solid #F0F0F0; }
    .bcat-group-pill { display:inline-flex; align-items:center; gap:5px; font-size:0.72em; font-weight:900; padding:4px 12px; border-radius:20px; letter-spacing:0.3px; }
    .bcat-group-pill.exp { background:#EF444412; color:#EF4444; border:1px solid #EF444430; }
    .bcat-group-pill.sav { background:#10B98112; color:#10B981; border:1px solid #10B98130; }

    /* Category Bubbles Row */
    .budget-cats-scroll { display:flex; gap:12px; overflow-x:auto; scrollbar-width:none; margin-bottom:2px; padding:2px 0 8px 0; }
    .budget-cats-scroll::-webkit-scrollbar { display:none; }
    .bcat-bubble { flex-shrink:0; display:flex; flex-direction:column; align-items:center; gap:5px; cursor:pointer; transition:transform 0.15s; }
    .bcat-bubble:active { transform:scale(0.93); }
    .bcat-ring { width:72px; height:72px; border-radius:50%; position:relative; display:flex; align-items:center; justify-content:center; }
    .bcat-ring svg { position:absolute; top:0; left:0; width:100%; height:100%; transform:rotate(-90deg); }
    .bcat-icon-wrap { width:56px; height:56px; border-radius:50%; background:var(--white); display:flex; align-items:center; justify-content:center; font-size:1.5em; z-index:1; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .bcat-name { font-size:0.67em; font-weight:800; color:var(--text-med); text-align:center; max-width:72px; line-height:1.2; }
    .bcat-status { font-size:0.67em; font-weight:900; text-align:center; }

    /* Goals Table */
    .budget-goals-section { margin-bottom:20px; }
    .bgs-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .bgs-title { font-weight:900; font-size:0.95em; color:var(--text-dark); }
    .bgs-add-btn { background:var(--yellow); border:none; border-radius:10px; padding:7px 14px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.82em; cursor:pointer; transition:background 0.15s; }
    .bgs-add-btn:hover { background:#e8b900; }
    .budget-goal-row { background:var(--white); border-radius:var(--radius-sm); box-shadow:var(--card-shadow); padding:14px 16px; margin-bottom:8px; cursor:pointer; transition:transform 0.15s; }
    .budget-goal-row:hover { transform:translateX(3px); }
    .bgr-top { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .bgr-icon { width:38px; height:38px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:1.1em; flex-shrink:0; }
    .bgr-info { flex:1; }
    .bgr-name { font-weight:900; font-size:0.9em; color:var(--text-dark); }
    .bgr-type { font-size:0.68em; font-weight:700; color:var(--text-light); margin-top:1px; }
    .bgr-right { text-align:right; }
    .bgr-spent { font-weight:900; font-size:0.95em; }
    .bgr-budget { font-size:0.72em; font-weight:700; color:var(--text-light); margin-top:1px; }
    .bgr-bar { height:4px; background:#F0F0F0; border-radius:4px; overflow:hidden; }
    .bgr-bar-fill { height:100%; border-radius:4px; transition:width 0.6s ease; }
    .bgr-actions { display:flex; gap:6px; margin-top:8px; }
    .bgr-action-btn { flex:1; padding:6px 8px; border:none; border-radius:8px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.72em; cursor:pointer; transition:all 0.15s; }

    /* Category Detail View */
    .bcat-detail-view { display:none; }
    .bcat-detail-view.open { display:block; }
    .bcd-back-btn { background:var(--white); border:none; border-radius:var(--radius-sm); padding:8px 14px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.82em; cursor:pointer; box-shadow:var(--card-shadow); display:inline-flex; align-items:center; gap:6px; margin-bottom:14px; color:var(--text-dark); }
    .bcd-header { text-align:center; padding:8px 0 16px; }
    .bcd-icon { font-size:2.2em; margin-bottom:6px; }
    .bcd-name { font-size:1.4em; font-weight:900; color:var(--text-dark); }
    .bcd-spent { font-size:1.1em; font-weight:700; margin-top:4px; }
    .bcd-chart-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:16px; margin-bottom:16px; }
    .bcd-chart-title { font-size:0.78em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.4px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
    .bcd-chart-outer { position:relative; }
    .bcd-chart-wrap { height:180px; position:relative; }
    /* Floating budget chip — sits on the right end of the budget line */
    .bcd-budget-chip { position:absolute; right:0; top:50%; transform:translateY(-80%); display:flex; align-items:center; gap:5px; background:#1E2A6E; color:white; border-radius:20px; padding:5px 10px 5px 12px; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,0.25); transition:all 0.18s; z-index:10; user-select:none; }
    .bcd-budget-chip:hover { background:#2D3EA8; box-shadow:0 4px 16px rgba(0,0,0,0.3); }
    .bcd-budget-chip.editing { background:var(--white); padding:3px 3px 3px 10px; box-shadow:0 4px 20px rgba(0,0,0,0.18); border:2px solid var(--yellow); }
    .bcd-chip-label { font-size:0.88em; font-weight:900; letter-spacing:0.3px; white-space:nowrap; }
    .bcd-chip-pencil { font-size:0.7em; opacity:0.75; }
    .bcd-budget-chip.editing .bcd-chip-label { display:none; }
    .bcd-budget-chip.editing .bcd-chip-pencil { display:none; }
    .bcd-chip-input { display:none; width:80px; background:transparent; border:none; outline:none; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.92em; color:var(--text-dark); padding:4px 0; }
    .bcd-budget-chip.editing .bcd-chip-input { display:block; }
    .budget-line-indicator { position:absolute; right:0; top:0; bottom:0; display:flex; align-items:center; pointer-events:none; }
    .bcd-metrics { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
    .bcd-metric-card { background:var(--white); border-radius:var(--radius-sm); box-shadow:var(--card-shadow); padding:14px 12px; text-align:center; }
    .bcd-metric-label { font-size:0.68em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.4px; margin-bottom:4px; }
    .bcd-metric-val { font-size:1.15em; font-weight:900; color:var(--text-dark); }
    .bcd-txns-section { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:16px; }
    .bcd-txns-title { font-weight:900; font-size:0.9em; color:var(--text-dark); margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
    .bcd-tx-row { display:flex; align-items:center; gap:10px; padding:9px 0; border-bottom:1px solid #F5F5F5; }
    .bcd-tx-row:last-child { border-bottom:none; }
    .bcd-tx-icon { width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:0.9em; flex-shrink:0; }
    .bcd-tx-info { flex:1; min-width:0; }
    .bcd-tx-name { font-weight:800; font-size:0.85em; color:var(--text-dark); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bcd-tx-date { font-size:0.7em; color:var(--text-light); font-weight:600; margin-top:1px; }
    .bcd-tx-amt { font-weight:900; font-size:0.9em; color:var(--expenses); flex-shrink:0; }

    /* Edit Budget Popup */
    .edit-budget-popup { position:fixed; inset:0; z-index:500; display:flex; align-items:flex-end; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.25s; }
    .edit-budget-popup.open { opacity:1; pointer-events:all; }
    .edit-budget-popup .popup-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.35); }
    .edit-budget-sheet { background:var(--white); border-radius:24px 24px 0 0; padding:20px 20px 32px; position:relative; z-index:1; width:100%; max-width:480px; transform:translateY(30px); transition:transform 0.3s ease; box-shadow:0 -8px 40px rgba(0,0,0,0.15); }
    .edit-budget-popup.open .edit-budget-sheet { transform:translateY(0); }
    .ebp-handle { width:36px; height:4px; background:#E0E0E0; border-radius:4px; margin:0 auto 16px; }
    .ebp-title { font-size:1.1em; font-weight:900; color:var(--text-dark); margin-bottom:16px; }
    .ebp-field { margin-bottom:12px; }
    .ebp-field label { font-size:0.72em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.4px; display:block; margin-bottom:4px; }
    .ebp-field input, .ebp-field select { width:100%; background:var(--bg); border:1.5px solid #E8E8E8; border-radius:12px; padding:11px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.95em; color:var(--text-dark); outline:none; }
    .ebp-field input:focus, .ebp-field select:focus { border-color:var(--yellow); background:var(--yellow-light); }
    .ebp-emoji-row { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px; }
    .ebp-emoji-opt { width:36px; height:36px; border-radius:10px; border:2px solid transparent; background:var(--bg); display:flex; align-items:center; justify-content:center; font-size:1.1em; cursor:pointer; transition:all 0.15s; }
    .ebp-emoji-opt.picked { border-color:var(--yellow); background:var(--yellow-light); }
    .ebp-actions { display:flex; gap:8px; margin-top:6px; }
    .ebp-save-btn { flex:1; background:var(--yellow); border:none; border-radius:12px; padding:14px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.95em; cursor:pointer; color:var(--text-dark); }
    .ebp-del-btn { background:#FFF0F0; border:none; border-radius:12px; padding:14px 18px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.9em; cursor:pointer; color:var(--expenses); }

    /* ══ NET WORTH MODULE ══ */
    /* ══ NET WORTH — HERO ══ */
    .nw-hero { background:linear-gradient(155deg,#1B1F5E 0%,#2D1B69 50%,#3D1A6E 100%); border-radius:20px; padding:28px 22px 24px; margin-bottom:16px; color:white; position:relative; overflow:hidden; }
    .nw-hero::before { content:''; position:absolute; top:-60px; right:-60px; width:220px; height:220px; border-radius:50%; background:rgba(255,255,255,0.05); pointer-events:none; }
    .nw-hero::after  { content:''; position:absolute; bottom:-70px; left:-40px; width:190px; height:190px; border-radius:50%; background:rgba(100,80,200,0.12); pointer-events:none; }
    .nw-hero-label { font-size:0.72em; font-weight:800; opacity:0.65; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:6px; text-align:left; }
    .nw-hero-amount { font-size:3em; font-weight:900; line-height:1.05; letter-spacing:-1px; text-align:left; }
    .nw-hero-change { font-size:0.82em; font-weight:700; margin-top:6px; opacity:0.9; display:flex; align-items:center; gap:4px; }
    .nw-hero-bars { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:18px; }
    .nw-hero-bar-block { background:rgba(255,255,255,0.10); backdrop-filter:blur(4px); border-radius:14px; padding:12px 10px; border:1px solid rgba(255,255,255,0.08); }
    .nw-hero-bar-label { font-size:0.58em; font-weight:800; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
    .nw-hero-bar-val { font-size:0.92em; font-weight:900; }
    .nw-debt-badge { display:inline-block; font-size:0.62em; font-weight:900; padding:2px 7px; border-radius:10px; margin-top:4px; }
    /* ══ CTA BUTTONS ══ */
    .nw-cta-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
    .nw-btn-snapshot { background:var(--yellow); border:none; border-radius:14px; padding:14px 10px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.9em; cursor:pointer; color:var(--text-dark); display:flex; align-items:center; justify-content:center; gap:6px; transition:background 0.15s; }
    .nw-btn-snapshot:hover { background:#e8b900; }
    .nw-btn-add { background:transparent; border:2px solid var(--yellow); border-radius:14px; padding:14px 10px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.9em; cursor:pointer; color:var(--text-dark); display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.15s; }
    .nw-btn-add:hover { background:var(--yellow-light); }
    /* ══ INSIGHTS CARDS ══ */
    .nw-insight-card { background:var(--white); border-radius:14px; box-shadow:var(--card-shadow); padding:14px 16px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px; border-left:4px solid; }
    .nw-insight-icon-wrap { width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2em; flex-shrink:0; }
    .nw-insight-title { font-weight:900; font-size:0.88em; color:var(--text-dark); margin-bottom:3px; }
    .nw-insight-sub   { font-size:0.75em; font-weight:600; color:var(--text-med); line-height:1.4; }
    /* ══ TREND CARD ══ */
    .nw-trend-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:18px; margin-bottom:14px; }
    .nw-masked { filter:blur(8px); user-select:none; pointer-events:none; transition:filter 0.3s; }
    .nw-eye-btn { background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); border-radius:20px; padding:3px 10px; cursor:pointer; font-size:0.72em; font-weight:800; color:rgba(255,255,255,0.7); font-family:Nunito,sans-serif; letter-spacing:0.3px; display:flex; align-items:center; gap:4px; flex-shrink:0; transition:all 0.2s; }
    .nw-eye-btn:hover { background:rgba(255,255,255,0.2); }
    .nw-trend-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .nw-trend-title { font-size:0.72em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; }
    .nw-trend-badge { font-size:0.72em; font-weight:900; color:var(--text-light); background:#F5F5F5; padding:3px 10px; border-radius:20px; }
    .nw-chart-wrap { height:130px; margin-bottom:16px; }
    .nw-snaps-label { font-size:0.7em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px; }
    .nw-snap-row { display:flex; align-items:center; gap:10px; padding:7px 0; border-bottom:1px solid #F8F8F8; }
    .nw-snap-row:last-child { border-bottom:none; }
    .nw-snap-date { font-size:0.75em; font-weight:700; color:var(--text-light); width:76px; flex-shrink:0; }
    .nw-snap-bar-wrap { flex:1; height:8px; background:#F0F0F0; border-radius:6px; overflow:hidden; }
    .nw-snap-bar-fill { height:100%; border-radius:6px; background:linear-gradient(90deg,#3B4A9C,#7C3AED); transition:width 0.6s; }
    .nw-snap-val { font-size:0.82em; font-weight:900; color:var(--text-dark); width:72px; text-align:right; flex-shrink:0; }
    .nw-snap-del { background:none; border:none; font-size:0.85em; color:#CCC; cursor:pointer; padding:0 2px; flex-shrink:0; }
    .nw-snap-del:hover { color:#EF4444; }
    /* ══ ASSET ALLOCATION ══ */
    .nw-alloc-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:18px; margin-bottom:14px; }
    .nw-alloc-title { font-size:0.72em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:16px; }
    .nw-alloc-body { display:flex; align-items:flex-start; gap:18px; }
    .nw-alloc-donut { width:130px; height:130px; flex-shrink:0; }
    .nw-alloc-legend { flex:1; display:flex; flex-direction:column; gap:5px; max-height:140px; overflow-y:auto; }
    .nw-legend-row { display:flex; align-items:center; gap:8px; }
    .nw-legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .nw-legend-name { font-size:0.75em; font-weight:700; color:var(--text-med); flex:1; line-height:1.2; }
    .nw-legend-pct  { font-size:0.72em; font-weight:900; color:var(--text-dark); width:28px; text-align:right; flex-shrink:0; }
    .nw-legend-amt  { font-size:0.72em; font-weight:900; color:var(--text-dark); width:54px; text-align:right; flex-shrink:0; }
    /* ══ ACCOUNT SECTIONS ══ */
    .nw-group-header { display:flex; align-items:center; justify-content:space-between; margin:6px 0 10px; }
    .nw-group-label { font-size:0.72em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:6px; }
    .nw-group-total { font-size:0.82em; font-weight:900; }
    .nw-section { background:var(--white); border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); margin-bottom:10px; overflow:hidden; }
    .nw-section-header { display:flex; align-items:center; justify-content:space-between; padding:16px 16px; cursor:pointer; transition:background 0.1s; }
    .nw-section-header:active { background:#FAFAFA; }
    .nw-section-left { display:flex; align-items:center; gap:14px; }
    .nw-section-icon { width:50px; height:50px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.5em; flex-shrink:0; }
    .nw-section-name { font-weight:900; font-size:0.95em; color:var(--text-dark); }
    .nw-section-sub  { font-size:0.7em; font-weight:600; color:var(--text-light); margin-top:2px; }
    .nw-section-right { display:flex; align-items:center; gap:10px; }
    .nw-section-val  { font-weight:900; font-size:1.05em; }
    .nw-section-chevron { font-size:0.7em; color:var(--text-light); transition:transform 0.2s; }
    .nw-section-chevron.open { transform:rotate(180deg); }
    .nw-section-add  { background:var(--yellow); border:none; border-radius:8px; padding:5px 10px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.72em; cursor:pointer; color:var(--text-dark); white-space:nowrap; }
    .nw-section-body { padding:0 16px 14px; border-top:1px solid #F5F5F5; display:none; }
    .nw-section-body.open { display:block; }
    .nw-account-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #F8F8F8; gap:8px; }
    .nw-metal-grp-body { overflow:hidden; transition:max-height 0.25s ease; max-height:2000px; }
    .nw-metal-grp-body.collapsed { max-height:0; }
    .nw-account-row:last-child { border-bottom:none; }
    .nw-account-left { flex:1; min-width:0; }
    .nw-account-name { font-size:0.85em; font-weight:800; color:var(--text-dark); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nw-account-meta { font-size:0.68em; font-weight:600; color:var(--text-light); margin-top:2px; }
    .nw-account-bar-wrap { height:3px; background:#F0F0F0; border-radius:4px; margin-top:6px; width:100%; max-width:120px; }
    .nw-account-bar-fill { height:100%; border-radius:4px; }
    .nw-account-right { display:flex; align-items:center; gap:6px; flex-shrink:0; }
    .nw-account-val { font-weight:900; font-size:0.9em; text-align:right; }
    .nw-account-updated { font-size:0.62em; font-weight:600; color:var(--text-light); text-align:right; margin-top:1px; }
    .nw-account-actions { display:flex; gap:4px; }
    .nw-account-btn { background:#F5F5F5; border:none; border-radius:7px; padding:5px 7px; font-size:0.72em; cursor:pointer; color:var(--text-med); font-family:'Nunito',sans-serif; font-weight:800; }
    .nw-account-btn.del { background:#FFF0F0; color:var(--expenses); }
    .nw-snapshot-btn { background:var(--yellow); border:none; border-radius:var(--radius-sm); padding:10px 20px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.85em; cursor:pointer; width:100%; margin-bottom:12px; }
    /* Account add/edit bottom sheet */
    .nw-sheet-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1050; opacity:0; pointer-events:none; transition:opacity 0.25s; }
    /* Type picker grid */
    .nws-type-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:18px; }
    .nws-type-tile { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:16px 8px; background:#F8F8F8; border-radius:14px; border:2px solid transparent; cursor:pointer; transition:all 0.15s; min-height:90px; }
    .nws-type-tile:hover { background:var(--yellow-light); }
    .nws-type-tile.selected { background:var(--yellow-light); border-color:var(--yellow); }
    .nws-type-tile-icon { font-size:2em; line-height:1; }
    .nws-type-tile-name { font-size:0.74em; font-weight:900; color:var(--text-dark); text-align:center; line-height:1.2; }
    /* Last 2 tiles in an 11-item grid span to stay even */
    .nws-type-tile:nth-child(10) { grid-column: 1 / 2; }
    .nws-type-tile:nth-child(11) { grid-column: 2 / 3; }
    /* Selected type banner */
    .nws-selected-banner { display:flex; align-items:center; justify-content:space-between; background:#EEF4FF; border-radius:14px; padding:14px 16px; margin-bottom:20px; }
    .nws-selected-left { display:flex; align-items:center; gap:10px; }
    .nws-selected-icon { font-size:1.6em; }
    .nws-selected-name { font-weight:900; font-size:1em; color:var(--text-dark); }
    .nws-type-badge { font-size:0.7em; font-weight:900; padding:3px 10px; border-radius:8px; letter-spacing:0.4px; }
    .nws-type-badge.asset { background:#D1FAE5; color:#059669; }
    .nws-type-badge.liab  { background:#FFE4E4; color:#DC2626; }
    /* Form section label */
    .nws-section-label { font-size:0.68em; font-weight:900; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
    .nw-sheet-overlay.open { opacity:1; pointer-events:all; }
    .nw-sheet { position:fixed; bottom:0; left:0; right:0; background:var(--white); border-radius:24px 24px 0 0; z-index:1100; transform:translateY(100%); transition:transform 0.32s cubic-bezier(0.32,0,0.15,1); max-height:90vh; overflow-y:auto; padding:0 20px 80px; }
    .nw-sheet.open { transform:translateY(0); }
    .nw-sheet-handle { width:36px; height:4px; background:#E0E0E0; border-radius:4px; margin:12px auto 18px; }
    .nw-sheet-title { font-size:1.05em; font-weight:900; color:var(--text-dark); margin-bottom:16px; }
    .nw-sheet-field { margin-bottom:14px; }
    .nw-sheet-label { font-size:0.75em; font-weight:800; color:var(--text-med); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.3px; }
    .nw-sheet-input { width:100%; background:var(--bg); border:1.5px solid #E8E8E8; border-radius:var(--radius-sm); padding:11px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.9em; color:var(--text-dark); outline:none; }
    .nw-sheet-input:focus { border-color:var(--yellow); background:var(--white); }
    .nw-sheet-select { width:100%; background:var(--bg); border:1.5px solid #E8E8E8; border-radius:var(--radius-sm); padding:11px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.9em; color:var(--text-dark); outline:none; appearance:none; }
    .nw-sheet-select:focus { border-color:var(--yellow); }
    .nw-sheet-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* ── Goal Account Picker — redesigned ── */
    .gap-search { width:100%; border:1.5px solid #E8E8E8; border-radius:var(--radius-sm); padding:10px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.88em; color:var(--text-dark); outline:none; margin-bottom:10px; box-sizing:border-box; background:#FAFAFA; }
    .gap-search:focus { border-color:var(--yellow); background:var(--white); }
    .gap-group { margin-bottom:10px; }
    .gap-group-header { display:flex; align-items:center; justify-content:space-between; padding:7px 10px; background:#F5F5F5; border-radius:10px; cursor:pointer; user-select:none; margin-bottom:4px; }
    .gap-group-title { font-size:0.78em; font-weight:900; color:var(--text-dark); display:flex; align-items:center; gap:6px; }
    .gap-group-meta { font-size:0.72em; font-weight:700; color:var(--text-med); display:flex; align-items:center; gap:8px; }
    .gap-group-total { font-size:0.78em; font-weight:900; color:#10B981; }
    .gap-group-chevron { font-size:0.7em; color:var(--text-light); transition:transform 0.2s; }
    .gap-group-chevron.open { transform:rotate(90deg); }
    .gap-group-body { display:flex; flex-direction:column; gap:3px; padding:0 4px; }
    .gap-group-body.collapsed { display:none; }
    .gap-acc-row { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:9px; cursor:pointer; transition:background 0.15s; }
    .gap-acc-row:hover { background:#F8F8F8; }
    .gap-acc-row.selected { background:#F0F4FF; }
    .gap-acc-cb { width:18px; height:18px; border-radius:5px; border:2px solid #D0D0D0; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:0.7em; transition:all 0.15s; background:white; }
    .gap-acc-cb.checked { background:var(--primary); border-color:var(--primary); color:white; }
    .gap-acc-name { flex:1; font-size:0.82em; font-weight:700; color:var(--text-dark); line-height:1.3; }
    .gap-acc-sub { font-size:0.68em; color:var(--text-light); font-weight:600; }
    .gap-acc-val { text-align:right; flex-shrink:0; }
    .gap-acc-val-main { font-size:0.82em; font-weight:900; color:#10B981; }
    .gap-acc-val-sub { font-size:0.68em; font-weight:600; color:var(--text-light); }
    .gap-select-all { display:flex; align-items:center; gap:6px; padding:4px 10px; cursor:pointer; font-size:0.72em; font-weight:800; color:var(--primary); }
    .gap-select-all:hover { text-decoration:underline; }
    .gap-preview-bar { background:#F0F4FF; border-radius:12px; padding:12px 14px; margin:10px 0 0; }
    .gap-preview-label { font-size:0.72em; font-weight:800; color:var(--primary); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.3px; }
    .gap-preview-track { height:8px; background:#E0E8FF; border-radius:20px; overflow:hidden; margin-bottom:6px; }
    .gap-preview-fill { height:100%; border-radius:20px; background:var(--primary); transition:width 0.4s; }
    .gap-preview-nums { display:flex; justify-content:space-between; font-size:0.78em; font-weight:800; }
    .gap-empty { text-align:center; padding:20px; color:var(--text-light); font-size:0.82em; font-weight:600; }
    .nw-sheet-meta { font-size:0.75em; font-weight:700; color:var(--text-light); background:var(--bg); border-radius:10px; padding:8px 12px; margin-bottom:12px; line-height:1.5; }
    .nw-sheet-save { width:100%; background:var(--yellow); border:none; border-radius:var(--radius-sm); padding:15px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.95em; cursor:pointer; color:var(--text-dark); margin-top:6px; }
    .nw-asset-name { font-size:0.85em; font-weight:700; color:var(--text-dark); }
    .nw-asset-sub   { font-size:0.7em; font-weight:600; color:var(--text-light); }
    .nw-asset-val   { font-weight:900; font-size:0.9em; color:var(--text-dark); text-align:right; }

    /* ══ IMPORT HUB ══ */
    .import-tabs { display:flex; gap:6px; margin-bottom:16px; overflow-x:auto; scrollbar-width:none; padding:2px; }
    .import-tabs::-webkit-scrollbar { display:none; }
    .import-tab { flex-shrink:0; padding:8px 14px; border:none; background:var(--white); border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; font-weight:800; font-size:0.78em; color:var(--text-light); cursor:pointer; box-shadow:var(--card-shadow); transition:all 0.2s; white-space:nowrap; }
    .import-tab.active { background:var(--yellow); color:var(--text-dark); }
    .import-section { display:none; }
    .import-section.active { display:block; }
    .import-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); padding:20px; margin-bottom:14px; }
    .import-card-title { font-weight:900; font-size:0.95em; color:var(--text-dark); margin-bottom:6px; }
    .import-card-sub { font-size:0.78em; color:var(--text-light); font-weight:600; margin-bottom:16px; line-height:1.5; }
    .import-drop-zone { border:2.5px dashed #E0E0E0; border-radius:var(--radius-sm); padding:28px 20px; text-align:center; cursor:pointer; transition:all 0.2s; margin-bottom:14px; background:var(--bg); }
    .import-drop-zone:hover, .import-drop-zone.dragover { border-color:var(--yellow); background:var(--yellow-light); }
    .import-drop-icon { font-size:2.2em; margin-bottom:8px; }
    .import-drop-text { font-weight:800; font-size:0.9em; color:var(--text-dark); }
    .import-drop-sub  { font-size:0.75em; color:var(--text-light); font-weight:600; margin-top:3px; }
    .import-progress { background:#F0F0F0; border-radius:20px; height:8px; overflow:hidden; margin:10px 0; }
    .import-progress-fill { height:100%; background:var(--yellow); border-radius:20px; transition:width 0.4s ease; }
    .import-step { display:none; }
    .import-step.active { display:block; }
    .import-col-map { display:flex; flex-direction:column; gap:8px; margin-bottom:14px; }
    .import-col-row { display:flex; align-items:center; gap:10px; background:var(--bg); border-radius:var(--radius-sm); padding:10px 12px; }
    .import-col-field { font-size:0.8em; font-weight:800; color:var(--text-dark); min-width:100px; flex-shrink:0; }
    .import-col-select { flex:1; background:var(--white); border:1.5px solid #E8E8E8; border-radius:8px; padding:7px 10px; font-family:'Nunito',sans-serif; font-weight:700; font-size:0.82em; color:var(--text-dark); outline:none; }
    .import-col-select:focus { border-color:var(--yellow); }
    .import-preview-table { width:100%; border-collapse:collapse; font-size:0.75em; margin-bottom:14px; }
    .import-preview-table th { background:var(--yellow-light); font-weight:800; padding:6px 8px; text-align:left; border-bottom:2px solid var(--yellow); }
    .import-preview-table td { padding:5px 8px; border-bottom:1px solid #F0F0F0; color:var(--text-dark); font-weight:600; }
    .import-preview-table tr:nth-child(even) td { background:#FAFAFA; }
    .import-btn { width:100%; background:var(--yellow); border:none; border-radius:var(--radius-sm); padding:14px; font-family:'Nunito',sans-serif; font-weight:900; font-size:0.95em; cursor:pointer; color:var(--text-dark); margin-top:8px; transition:background 0.15s; }
    .import-btn:hover { background:#e8b900; }
    .import-btn.secondary { background:var(--bg); color:var(--text-med); }
    .import-btn.danger    { background:#FFF0F0; color:var(--expenses); }
    .cat-review-item { display:flex; align-items:center; gap:10px; background:var(--bg); border-radius:var(--radius-sm); padding:10px 12px; margin-bottom:8px; flex-wrap:wrap; }
    .cat-review-flag { font-size:0.7em; font-weight:800; padding:3px 8px; border-radius:10px; flex-shrink:0; }
    .cat-review-flag.dup  { background:#FFF0E0; color:#D97706; }
    .cat-review-flag.new  { background:#F0FBF3; color:#10B981; }
    .cat-review-names { flex:1; font-weight:800; font-size:0.85em; color:var(--text-dark); }
    .cat-review-action { display:flex; gap:6px; }
    .cat-merge-btn { background:var(--yellow-light); border:none; border-radius:8px; padding:5px 10px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.72em; cursor:pointer; }
    .cat-keep-btn  { background:#F5F5F5; border:none; border-radius:8px; padding:5px 10px; font-family:'Nunito',sans-serif; font-weight:800; font-size:0.72em; cursor:pointer; }
    .import-summary-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
    .import-summary-box { background:var(--bg); border-radius:var(--radius-sm); padding:12px 10px; text-align:center; }
    .import-summary-box .isb-num { font-size:1.4em; font-weight:900; color:var(--text-dark); }
    .import-summary-box .isb-label { font-size:0.65em; font-weight:800; color:var(--text-light); margin-top:2px; text-transform:uppercase; }
    .given-ledger-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #F5F5F5; }
    .given-ledger-row:last-child { border-bottom:none; }
    .given-person { font-weight:900; font-size:0.9em; color:var(--text-dark); }
    .given-total  { font-weight:900; font-size:0.95em; color:var(--expenses); }

    /* ══ HOME INSIGHTS CARD ══ */
    .insights-card { background:var(--white); border-radius:var(--radius); box-shadow:var(--card-shadow); margin-bottom:16px; overflow:hidden; }
    .insights-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px 14px; cursor:pointer; user-select:none; }
    .insights-header-left { display:flex; align-items:center; gap:8px; }
    .insights-title { font-weight:900; font-size:0.92em; color:var(--text-dark); }
    .insights-toggle { font-size:0.82em; color:var(--text-light); font-weight:700; transition:transform 0.25s; display:inline-block; }
    .insights-toggle.open { transform:rotate(180deg); }
    .insights-body { padding:0 16px 16px; display:none; }
    .insights-body.open { display:block; }
    /* KPI row at top — always visible */
    .insights-kpi-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:12px; }
    .insights-kpi { background:var(--bg); border-radius:var(--radius-sm); padding:11px 10px; text-align:center; }
    .ikpi-val  { font-size:1.1em; font-weight:900; color:var(--text-dark); line-height:1.1; }
    .ikpi-label{ font-size:0.62em; font-weight:800; color:var(--text-light); text-transform:uppercase; letter-spacing:0.3px; margin-top:3px; }
    /* Insight chips — the interesting findings */
    .insights-chips { display:flex; flex-direction:column; gap:8px; }
    .insight-chip { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border-radius:var(--radius-sm); border-left:3px solid transparent; }
    .insight-chip.good    { background:#F0FBF3; border-color:#10B981; }
    .insight-chip.warn    { background:#FFFBEE; border-color:#F59E0B; }
    .insight-chip.alert   { background:#FFF5F5; border-color:#EF4444; }
    .insight-chip.neutral { background:var(--bg); border-color:var(--text-light); }
    .insight-chip-icon { font-size:1.1em; flex-shrink:0; margin-top:1px; }
    .insight-chip-text { flex:1; }
    .insight-chip-title { font-size:0.82em; font-weight:900; color:var(--text-dark); }
    .insight-chip-sub   { font-size:0.72em; font-weight:600; color:var(--text-med); margin-top:2px; line-height:1.4; }

    /* ══ PIN LOCK SCREEN (COMMENTED OUT - RE-ENABLE SECTION START) ══
    === To re-enable PIN functionality:
    === 1. Uncomment the CSS block below (remove the slash-star markers)
    === 2. Uncomment the #lock-screen HTML block in the body
    === 3. Uncomment the PIN JavaScript section at the bottom
    === 4. Call initLockScreen() in the init section

    #lock-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: linear-gradient(160deg, #0f1229 0%, #1a1035 40%, #0d1f18 100%);
      display: flex; flex-direction: column; align-items: center;
      overflow: hidden;
      transition: opacity 0.45s cubic-bezier(.4,0,.2,1), transform 0.45s cubic-bezier(.4,0,.2,1);
    }
    ... (rest of lock screen CSS here when re-enabling)
    === RE-ENABLE SECTION END === */
    /* ══ ONBOARDING OVERLAY ══ */
    #onboarding-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: #1A1F3C;
      display: flex; flex-direction: column;
      font-family: 'Nunito', sans-serif;
      overflow: hidden;
    }
    #onboarding-overlay.hiding {
      animation: onboardFadeOut 0.6s ease forwards;
    }
    @keyframes onboardFadeOut {
      to { opacity: 0; transform: scale(1.04); }
    }
    .ob-slides-wrap {
      flex: 1; display: flex; overflow: hidden; position: relative;
    }
    .ob-slides-track {
      display: flex; height: 100%;
      transition: transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      will-change: transform;
    }
    .ob-slide {
      min-width: 100vw; height: 100%;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 32px 28px 12px;
      text-align: center;
      position: relative;
    }
    .ob-slide-art {
      font-size: 5.5em;
      margin-bottom: 18px;
      animation: obArtBounce 0.6s cubic-bezier(0.34,1.56,0.64,1) both;
      filter: drop-shadow(0 8px 24px rgba(0,0,0,0.35));
    }
    @keyframes obArtBounce {
      from { transform: scale(0.4) translateY(30px); opacity: 0; }
      to   { transform: scale(1) translateY(0);      opacity: 1; }
    }
    .ob-slide-tag {
      font-size: 0.68em; font-weight: 900; letter-spacing: 2px;
      text-transform: uppercase; margin-bottom: 10px;
      padding: 4px 14px; border-radius: 20px;
      background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.6);
    }
    .ob-slide-title {
      font-size: 1.75em; font-weight: 900; line-height: 1.15;
      color: #FFFFFF; margin-bottom: 12px;
      animation: obTextSlide 0.5s 0.15s ease both;
    }
    .ob-slide-desc {
      font-size: 0.9em; font-weight: 600; line-height: 1.6;
      color: rgba(255,255,255,0.65); max-width: 300px;
      animation: obTextSlide 0.5s 0.25s ease both;
    }
    @keyframes obTextSlide {
      from { transform: translateY(18px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .ob-highlight {
      color: #F5C842; font-weight: 900;
    }
    /* Slide-specific accent circles */
    .ob-bg-circle {
      position: absolute; border-radius: 50%; opacity: 0.07;
      pointer-events: none;
    }
    /* Bottom bar */
    .ob-bottom {
      padding: 16px 28px 36px;
      display: flex; flex-direction: column; align-items: center; gap: 14px;
    }
    .ob-dots {
      display: flex; gap: 7px; align-items: center;
    }
    .ob-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: rgba(255,255,255,0.25);
      transition: all 0.3s ease; cursor: pointer;
    }
    .ob-dot.active {
      background: #F5C842; width: 22px; border-radius: 4px;
    }
    .ob-btn-row {
      display: flex; gap: 10px; width: 100%;
    }
    .ob-skip-btn {
      flex: 0; padding: 14px 20px;
      background: rgba(255,255,255,0.1);
      border: none; border-radius: 14px;
      color: rgba(255,255,255,0.5); font-family: 'Nunito', sans-serif;
      font-weight: 800; font-size: 0.88em; cursor: pointer;
      transition: background 0.2s;
    }
    .ob-skip-btn:hover { background: rgba(255,255,255,0.18); }
    .ob-next-btn {
      flex: 1; padding: 14px;
      background: #F5C842;
      border: none; border-radius: 14px;
      color: #1A1F3C; font-family: 'Nunito', sans-serif;
      font-weight: 900; font-size: 1em; cursor: pointer;
      box-shadow: 0 4px 20px rgba(245,200,66,0.45);
      transition: transform 0.15s, box-shadow 0.15s;
    }

    /* ══ COACH MARKS ══ */
    #coach-overlay {
      position: fixed; inset: 0; z-index: 9998; pointer-events: none; display: none;
    }
    #coach-overlay.active {
      pointer-events: all;
    }
    #coach-svg {
      position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none;
    }
    #coach-tooltip {
      position: fixed; z-index: 9999;
      background: #1A1F3C; color: white;
      border-radius: 16px; padding: 14px 16px;
      max-width: 268px; min-width: 210px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      pointer-events: all;
    }
    .coach-tooltip-anim { animation: coachPop 0.3s cubic-bezier(0.34,1.56,0.64,1) both; }
    @keyframes coachPop {
      from { transform: scale(0.82); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }
    .coach-arrow {
      position: absolute; width: 0; height: 0;
    }
    .coach-arrow.down {
      border-left: 9px solid transparent; border-right: 9px solid transparent;
      border-top: 10px solid #1A1F3C;
      bottom: -10px; left: 50%; transform: translateX(-50%);
    }
    .coach-arrow.up {
      border-left: 9px solid transparent; border-right: 9px solid transparent;
      border-bottom: 10px solid #1A1F3C;
      top: -10px; left: 50%; transform: translateX(-50%);
    }
    .coach-arrow.right {
      border-top: 9px solid transparent; border-bottom: 9px solid transparent;
      border-left: 10px solid #1A1F3C;
      right: -10px; top: 50%; transform: translateY(-50%);
    }
    .coach-step-tag {
      font-size: 0.62em; font-weight: 900; letter-spacing: 1.5px;
      text-transform: uppercase; color: #F5C842; margin-bottom: 5px;
    }
    .coach-title {
      font-weight: 900; font-size: 0.95em; color: #fff; margin-bottom: 5px; line-height: 1.3;
    }
    .coach-desc {
      font-size: 0.78em; font-weight: 600; color: rgba(255,255,255,0.68); line-height: 1.55;
    }
    .coach-btn-row { display: flex; gap: 7px; margin-top: 11px; align-items: center; }
    .coach-prev-btn {
      padding: 7px 12px; background: rgba(255,255,255,0.1);
      border: none; border-radius: 9px; color: rgba(255,255,255,0.6);
      font-family: 'Nunito',sans-serif; font-weight: 800; font-size: 0.78em; cursor: pointer;
    }
    .coach-next-btn {
      flex: 1; padding: 8px 12px; background: #F5C842;
      border: none; border-radius: 9px; color: #1A1F3C;
      font-family: 'Nunito',sans-serif; font-weight: 900; font-size: 0.85em; cursor: pointer;
    }
    .coach-skip-btn {
      padding: 7px 8px; background: transparent; border: none;
      color: rgba(255,255,255,0.3); font-family: 'Nunito',sans-serif;
      font-weight: 800; font-size: 0.7em; cursor: pointer;
    }
    .coach-progress {
      font-size: 0.63em; font-weight: 800; color: rgba(255,255,255,0.25);
      text-align: right; margin-top: 5px;
    }
    #coach-pulse {
      position: fixed; border-radius: 12px;
      border: 2.5px solid #F5C842; pointer-events: none; z-index: 9999;
      animation: coachPulse 1.5s ease-in-out infinite;
    }
    @keyframes coachPulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(245,200,66,0.6); }
      50%      { box-shadow: 0 0 0 10px rgba(245,200,66,0); }
    }
  </style>
</head>
<body>

<!-- ══ COACH MARK OVERLAY ══ -->
<div id="coach-overlay">
  <svg id="coach-svg" xmlns="http://www.w3.org/2000/svg"></svg>
  <div id="coach-pulse" style="display:none;"></div>
  <div id="coach-tooltip" style="display:none;"></div>
</div>
<div id="onboarding-overlay" style="display:none;">
  <div class="ob-slides-wrap" id="ob-slides-wrap">
    <div class="ob-slides-track" id="ob-track">

      <!-- Slide 1: Privacy Promise -->
      <div class="ob-slide">
        <div class="ob-bg-circle" style="width:300px;height:300px;background:#1B1F5E;top:-80px;right:-80px;"></div>
        <div class="ob-bg-circle" style="width:200px;height:200px;background:#F5C842;bottom:-40px;left:-60px;"></div>
        <div class="ob-slide-art">🔒</div>
        <div class="ob-slide-tag">Your Privacy, First</div>
        <div class="ob-slide-title">Your data stays <span class="ob-highlight">with you</span></div>
        <div class="ob-slide-desc">MoneyFi stores everything on your device and your personal iCloud. No servers. No database. Nobody — not even us — can see your numbers.</div>
      </div>

      <!-- Slide 2: Family -->
      <div class="ob-slide">
        <div class="ob-bg-circle" style="width:260px;height:260px;background:#10B981;top:-60px;left:-60px;"></div>
        <div class="ob-bg-circle" style="width:200px;height:200px;background:#F5C842;bottom:-30px;right:-50px;"></div>
        <div class="ob-slide-art">👨‍👩‍👧</div>
        <div class="ob-slide-tag">Built for Families</div>
        <div class="ob-slide-title">One home, <span class="ob-highlight">one view</span></div>
        <div class="ob-slide-desc">Invite up to 6 family members. Everyone adds transactions, everyone sees the full picture. Filter by person, track together — no shared passwords needed.</div>
      </div>

      <!-- Slide 3: Track Everything -->
      <div class="ob-slide">
        <div class="ob-bg-circle" style="width:280px;height:280px;background:#7C3AED;top:-70px;right:-70px;"></div>
        <div class="ob-bg-circle" style="width:160px;height:160px;background:#F97316;bottom:-20px;left:-40px;"></div>
        <div class="ob-slide-art">📊</div>
        <div class="ob-slide-tag">Track</div>
        <div class="ob-slide-title">Every rupee, <span class="ob-highlight">every account</span></div>
        <div class="ob-slide-desc">Income, expenses, investments, gold, real estate — all in one place. Multi-currency with FX rates you control. Works across India, US, UAE and beyond.</div>
      </div>

      <!-- Slide 4: Net Worth Intelligence -->
      <div class="ob-slide">
        <div class="ob-bg-circle" style="width:260px;height:260px;background:#F5C842;top:-50px;left:-70px;"></div>
        <div class="ob-bg-circle" style="width:200px;height:200px;background:#1B1F5E;bottom:-50px;right:-50px;"></div>
        <div class="ob-slide-art">💎</div>
        <div class="ob-slide-tag">Net Worth</div>
        <div class="ob-slide-title">Watch your wealth <span class="ob-highlight">grow</span></div>
        <div class="ob-slide-desc">Live gold &amp; silver prices, real estate, budgets and monthly snapshots. MoneyFi builds your financial story month by month — automatically.</div>
      </div>

      <!-- Slide 5: Get Started -->
      <div class="ob-slide">
        <div class="ob-bg-circle" style="width:320px;height:320px;background:#F5C842;top:-100px;right:-100px;opacity:0.15;"></div>
        <div class="ob-bg-circle" style="width:220px;height:220px;background:#10B981;bottom:-60px;left:-60px;opacity:0.15;"></div>
        <div class="ob-slide-art">🚀</div>
        <div class="ob-slide-tag">You're all set</div>
        <div class="ob-slide-title">Your family's money, <span class="ob-highlight">your devices</span></div>
        <div class="ob-slide-desc">Add your first transaction in under a minute. Invite your family when you're ready. Your data never leaves your hands.</div>
      </div>

    </div>
  </div>

  <!-- Bottom controls -->
  <div class="ob-bottom">
    <div class="ob-dots" id="ob-dots">
      <div class="ob-dot active" onclick="obGoTo(0)"></div>
      <div class="ob-dot" onclick="obGoTo(1)"></div>
      <div class="ob-dot" onclick="obGoTo(2)"></div>
      <div class="ob-dot" onclick="obGoTo(3)"></div>
      <div class="ob-dot" onclick="obGoTo(4)"></div>
    </div>
    <div class="ob-btn-row">
      <button class="ob-skip-btn" id="ob-skip-btn" onclick="dismissOnboarding()">Skip</button>
      <button class="ob-next-btn" id="ob-next-btn" onclick="obNext()">Next →</button>
    </div>
  </div>
</div>

<!-- ══ THEME DECORATION ELEMENTS (always present, visible only when theme active) ══ -->
<!-- Looney -->
<div class="looney-char" style="bottom:160px;right:15px;animation-delay:0s;">🐰</div>
<div class="looney-char" style="bottom:320px;left:-20px;animation-delay:1.2s;font-size:2em;">🦆</div>
<div class="looney-char" style="top:120px;right:8px;animation-delay:0.6s;font-size:1.8em;">🐦</div>
<div class="looney-char" style="top:300px;left:-20px;animation-delay:1.8s;font-size:2.2em;">🐱</div>
<!-- Jungle -->
<div class="jungle-leaf" style="top:80px;right:5px;animation-delay:0s;">🍃</div>
<div class="jungle-leaf" style="bottom:200px;left:-20px;animation-delay:1s;font-size:2.5em;">🌿</div>
<div class="jungle-leaf" style="top:280px;right:12px;animation-delay:2s;font-size:1.8em;">🐒</div>
<div class="jungle-leaf" style="bottom:350px;left:-20px;animation-delay:0.5s;font-size:2.2em;">🦜</div>
<div class="jungle-leaf" style="top:180px;left:-15px;animation-delay:1.5s;">🌺</div>
<!-- Space -->
<div class="space-star" style="top:100px;right:20px;animation-delay:0s;">⭐</div>
<div class="space-star" style="top:200px;left:-15px;animation-delay:0.8s;">🌙</div>
<div class="space-star" style="bottom:250px;right:25px;animation-delay:0.4s;">✨</div>
<div class="space-star" style="top:350px;right:10px;animation-delay:1.2s;font-size:1.5em;">🚀</div>
<div class="space-star" style="bottom:300px;left:-15px;animation-delay:1.6s;">💫</div>
<!-- Ocean -->
<div class="ocean-wave" style="bottom:160px;right:8px;animation-delay:0s;">🐠</div>
<div class="ocean-wave" style="top:200px;left:-18px;animation-delay:1s;font-size:1.5em;">🌊</div>
<div class="ocean-wave" style="bottom:340px;right:12px;animation-delay:2s;font-size:1.8em;">🐚</div>
<div class="ocean-wave" style="top:320px;left:-18px;animation-delay:0.5s;">🐟</div>


<!-- ══ LOCK SCREEN — COMMENTED OUT (RE-ENABLE LATER) ══
=== To re-enable: uncomment this entire block and the JS PIN section below ===
<div id="lock-screen" style="display:none;">
  ... lock screen HTML ...
</div>
=== END COMMENTED PIN LOCK SCREEN === -->

<!-- Decorative -->
<div class="deco-circle deco-yellow" style="width:160px;height:160px;top:-60px;right:-50px;opacity:0.7;"></div>
<div class="deco-circle deco-blue" style="width:120px;height:120px;bottom:120px;left:-40px;opacity:0.8;"></div>
<div class="deco-circle deco-yellow" style="width:80px;height:80px;bottom:200px;right:20px;opacity:0.5;"></div>

<!-- TOP BAR — Clean layout with icons inside topbar -->
<div class="topbar">
  <div class="topbar-title">💰 MoneyFlow</div>
  <div style="display:flex;align-items:center;gap:8px;">
    <div class="topbar-badge" id="topbar-month" style="cursor:default;">Feb 2026</div>
    <div class="topbar-icons">
      <button class="topbar-icon-btn" onclick="goToScreen('metals')" title="Metals">🥇</button>
      <button class="topbar-icon-btn" onclick="goToScreen('networth')" title="Net Worth">💎</button>
      <button class="topbar-icon-btn" onclick="goToScreen('settings')" title="Settings">⚙️</button>
    </div>
  </div>
</div>

<!-- ══════════════ HOME ══════════════ -->
<div class="screen active" id="screen-home">
  <!-- Time Period Selector -->
  <div class="time-period-bar" id="time-period-bar">
    <button class="period-tab" onclick="setPeriod('day',this)">Day</button>
    <button class="period-tab active" onclick="setPeriod('month',this)">Month</button>
    <button class="period-tab" onclick="setPeriod('week',this)">Week</button>
    <button class="period-tab" onclick="setPeriod('year',this)">Year</button>
  </div>
  <!-- Day chips (shown in day/week mode) -->
  <div class="period-detail" id="period-detail"></div>
  <!-- Period navigation -->
  <div class="period-nav">
    <button onclick="changePeriod(-1)">‹</button>
    <div class="period-label" id="home-month-label">February 2026</div>
    <button onclick="changePeriod(1)">›</button>
  </div>

  <!-- Spending / Investment Tab Toggle -->
  <div class="home-tab-bar">
    <button class="home-tab-btn active" id="htab-spending" onclick="setHomeTab('spending')">💸 Spending</button>
    <button class="home-tab-btn" id="htab-invest" onclick="setHomeTab('invest')">📈 Investing</button>
  </div>

  <!-- ── SPENDING SECTION ── -->
  <div class="home-section active" id="hsec-spending">
    <div class="spending-hero">
      <div class="spending-label">💸 Total Spending</div>
      <div class="spending-amount" id="home-spending">$0</div>
    </div>
    <div class="budget-grid" id="budget-grid"></div>

    <!-- Insights Card -->
    <div class="insights-card" id="home-insights-card">
      <div class="insights-header" onclick="toggleInsights()">
        <div class="insights-header-left">
          <span style="font-size:1.2em;">💡</span>
          <span class="insights-title">Monthly Insights</span>
        </div>
        <span class="insights-toggle" id="insights-toggle-arrow">▾</span>
      </div>
      <!-- KPI strip — always visible inside the header area -->
      <div style="padding:0 16px 14px;" id="insights-kpi-strip"></div>
      <!-- Expandable body -->
      <div class="insights-body" id="insights-body">
        <div class="insights-chips" id="insights-chips"></div>
      </div>
    </div>

    <div class="home-income-section">
      <div class="home-income-header">
        <div class="home-income-title">💵 Income</div>
        <div class="home-income-total" id="home-income">$0</div>
      </div>
      <div class="income-sub-grid">
        <div class="income-sub-card" style="user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;"
          ontouchstart="homeCardTouchStart(event,'Salary','income','Salary')"
          ontouchend="homeCardTouchEnd(event)" ontouchmove="homeCardTouchMove(event)">
          <div class="isc-icon">💼</div><div class="isc-name">Salary</div>
          <div class="isc-amount" id="home-salary">$0</div>
        </div>
        <div class="income-sub-card" style="user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;"
          ontouchstart="homeCardTouchStart(event,'Gift','income','Gift')"
          ontouchend="homeCardTouchEnd(event)" ontouchmove="homeCardTouchMove(event)">
          <div class="isc-icon">🎁</div><div class="isc-name">Gifts</div>
          <div class="isc-amount" id="home-gifts">$0</div>
        </div>
        <div class="income-sub-card" style="user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;"
          ontouchstart="homeCardTouchStart(event,'Other','income','Other')"
          ontouchend="homeCardTouchEnd(event)" ontouchmove="homeCardTouchMove(event)">
          <div class="isc-icon">💰</div><div class="isc-name">Others</div>
          <div class="isc-amount" id="home-other-income">$0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── INVESTMENT SECTION ── -->
  <div class="home-section" id="hsec-invest">
    <div class="invest-home-hero">
      <div class="invest-home-hero-label">📈 Total Portfolio Value</div>
      <div class="invest-home-hero-amt" id="home-invest-total">$0</div>
    </div>
    <div class="invest-cat-grid" id="invest-cat-grid"></div>
  </div>
</div>

<!-- ══════════════ TRANSACTIONS / CALENDAR ══════════════ -->
<div class="screen" id="screen-tx">
  <!-- Month Navigation -->
  <div class="cal-header">
    <button class="cal-nav-btn" onclick="calChangeMonth(-1)">&#8249;</button>
    <div class="cal-month-title" id="cal-month-title"></div>
    <button class="cal-nav-btn" onclick="calChangeMonth(1)">&#8250;</button>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;">
    <button id="cal-view-btn-calendar" onclick="setCalView('calendar')" style="background:#1E2A6E;color:white;border:none;border-radius:8px;padding:5px 12px;font-size:0.78em;font-weight:800;cursor:pointer;">📅 Calendar</button>
    <button id="cal-view-btn-list" onclick="setCalView('list')" style="background:#F0F0F0;color:var(--text-med);border:none;border-radius:8px;padding:5px 12px;font-size:0.78em;font-weight:800;cursor:pointer;">📋 List</button>
  </div>
  <!-- Monthly Summary -->
  <div class="cal-summary">
    <div class="cal-sum-item income">
      <div class="cal-sum-label">Income</div>
      <div class="cal-sum-val" id="cal-total-income">$0</div>
    </div>
    <div class="cal-sum-divider"></div>
    <div class="cal-sum-item expense">
      <div class="cal-sum-label">Expenses</div>
      <div class="cal-sum-val" id="cal-total-expense">$0</div>
    </div>
    <div class="cal-sum-divider"></div>
    <div class="cal-sum-item savings">
      <div class="cal-sum-label">INVESTING</div>
      <div class="cal-sum-val" id="cal-total-savings">$0</div>
    </div>
    <div class="cal-sum-divider"></div>
    <div class="cal-sum-item net">
      <div class="cal-sum-label">Net</div>
      <div class="cal-sum-val" id="cal-total-net">$0</div>
    </div>
  </div>
  <!-- Search Bar -->
  <div style="position:relative;margin-bottom:10px;">
    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1em;pointer-events:none;">🔍</span>
    <input type="text" id="tx-search-input" placeholder="Search transactions..." autocomplete="off"
      oninput="onTxSearch(this.value)"
      style="width:100%;box-sizing:border-box;padding:10px 36px 10px 36px;border:1.5px solid #E8E8E8;
             border-radius:12px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.88em;
             background:var(--white);color:var(--text-dark);outline:none;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
    <button id="tx-search-clear" onclick="clearTxSearch()" style="
      display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);
      background:none;border:none;font-size:1em;cursor:pointer;color:var(--text-light);
      font-weight:900;padding:2px 6px;">✕</button>
  </div>
  <!-- Author filter — 👥 icon, tap to slide out member chips -->
  <div id="author-filter-strip" style="display:none;">
    <div class="author-filter-wrap">
      <div class="author-toggle-btn" id="author-toggle-btn" onclick="toggleAuthorChips()" title="Filter by family member">👥</div>
      <div class="author-chips-slide" id="author-chips-slide">
        <div class="author-chips-scroll" id="author-chips-row"></div>
      </div>
    </div>
  </div>
  <!-- Search Results (hidden when not searching) -->
  <div id="tx-search-results" style="display:none;"></div>

  <!-- Calendar Grid -->
  <div class="cal-grid-wrap" id="cal-grid-wrap"
    ontouchstart="calSwipeStart(event)"
    ontouchend="calSwipeEnd(event)">
    <div class="cal-dow-row" id="cal-dow-row">
      <div class="cal-dow">SUN</div><div class="cal-dow">MON</div><div class="cal-dow">TUE</div>
      <div class="cal-dow">WED</div><div class="cal-dow">THU</div><div class="cal-dow">FRI</div><div class="cal-dow">SAT</div>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  <!-- Month list view -->
  <div id="cal-list-view" style="display:none;"></div>
  </div>
  <!-- Day Detail -->
  <div id="cal-day-detail-wrap">
    <div id="cal-day-detail"></div>
  </div>
</div>

<!-- ══════════════ ADD ══════════════ -->
<div class="screen" id="screen-add">
  <div class="add-type-toggle">
    <button class="add-type-btn active" onclick="setAddType('expense',this)">Expense</button>
    <button class="add-type-btn" onclick="setAddType('income',this)">Income</button>
    <button class="add-type-btn" onclick="setAddType('investment',this)">Investment</button>
    <button class="add-type-btn" onclick="setAddType('debt',this)">Debt</button>
    <button class="add-type-btn" onclick="setAddType('given',this)">Given</button>
    <button class="add-type-btn" onclick="setAddType('additional',this)">Additional</button>
  </div>
  <div class="amount-display">
    <div class="amount-num"><span class="amount-cur">$</span><span id="add-amount-display">0</span></div>
  </div>
  <div class="sub-cats" id="sub-cats-row"></div>
  <div class="add-form">
    <div class="form-row">
      <span class="form-icon">📝</span><span class="form-label">Note</span>
      <input type="text" class="form-input" id="add-note" placeholder="Add note...">
    </div>
    <div class="form-row">
      <span class="form-icon">📅</span><span class="form-label">Date</span>
      <input type="date" class="form-input" id="add-date" style="text-align:right;">
    </div>
    <div class="form-row">
      <span class="form-icon">💳</span><span class="form-label">Account</span>
      <select class="form-select" id="add-account"><option>Cash</option><option>Paypal</option><option>Bank</option></select>
    </div>
  </div>
  <div class="numpad">
    <div class="numpad-grid" id="numpad-grid"></div>
  </div>
</div>

<!-- ══════════════ DATA ══════════════ -->
<div class="screen" id="screen-data">
  <div class="data-controls">
    <div class="data-controls-row">
      <span class="data-label">📅 Month:</span>
      <select id="data-month-select" onchange="renderDataScreen()" style="flex:1;background:#F8F8F8;border:1.5px solid #EEE;border-radius:10px;padding:8px 12px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.88em;color:var(--text-dark);outline:none;"></select>
    </div>
    <div class="data-controls-row">
      <span class="data-label">🗓 Range:</span>
      <input type="date" id="data-filter-start" onchange="renderDataScreen()" class="date-filter-input" style="flex:1;">
      <span class="data-label">to</span>
      <input type="date" id="data-filter-end" onchange="renderDataScreen()" class="date-filter-input" style="flex:1;">
      <button class="icon-btn" onclick="clearDataFilter()">Clear</button>
    </div>
    <div class="data-controls-row">
      <button class="icon-btn danger" onclick="deleteCurrentDataMonth()">🗑️ Month</button>
    </div>
  </div>
  <div id="data-sections"></div>
</div>

<!-- ══════════════ STATS ══════════════ -->
<div class="screen" id="screen-stats">
  <div class="chart-card">
    <div class="chart-title">Spending Trend (6 months)</div>
    <div class="chart-container"><canvas id="trendChart"></canvas></div>
    <div style="display:flex;gap:20px;margin-top:12px;justify-content:center;">
      <div style="display:flex;align-items:center;gap:6px;font-size:0.82em;font-weight:700;color:var(--expenses);"><div style="width:24px;height:3px;background:var(--expenses);border-radius:2px;"></div>Spending <span id="stat-spending-total">$0</span></div>
      <div style="display:flex;align-items:center;gap:6px;font-size:0.82em;font-weight:700;color:var(--income);"><div style="width:24px;height:3px;background:var(--income);border-radius:2px;"></div>Income <span id="stat-income-total">$0</span></div>
    </div>
  </div>
  <div class="spending-tops">
    <div class="chart-title">Top 5 Spending Categories</div>
    <div style="display:flex;gap:20px;align-items:center;">
      <div style="position:relative;width:120px;height:120px;flex-shrink:0;"><canvas id="donutChart"></canvas></div>
      <div id="top5-list" style="flex:1;"></div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Budget vs Spent</div>
    <div id="budget-bars"></div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Account Breakdown</div>
    <div style="display:flex;gap:20px;align-items:center;">
      <canvas id="accountChart" width="120" height="120" style="width:120px;height:120px;flex-shrink:0;"></canvas>
      <div id="account-breakdown" style="flex:1;"></div>
    </div>
  </div>
</div>

<!-- ══════════════ ACCOUNT ══════════════ -->
<div class="screen" id="screen-account">
  <div class="networth-card">
    <div class="nw-label">Net Worth</div>
    <div class="nw-amount" id="nw-amount">$0</div>
    <div class="nw-sub">
      <div class="nw-sub-item">Assets<span id="nw-assets">$0</span></div>
      <div class="nw-sub-item">Liabilities<span id="nw-liabilities" class="negative">$0</span></div>
    </div>
  </div>
  <div class="account-section-title">Assets</div>
  <div class="account-grid" id="account-assets-grid"></div>
  <div class="account-section-title">Liabilities</div>
  <div class="account-grid" id="account-debts-grid"></div>
  <button onclick="showAddAccountModal()" style="width:100%;background:var(--yellow);border:none;border-radius:var(--radius-sm);padding:16px;font-family:Nunito,sans-serif;font-weight:900;font-size:0.95em;color:var(--text-dark);cursor:pointer;box-shadow:0 4px 15px rgba(245,200,66,0.4);margin-top:8px;">+ Add Account</button>
</div>

<!-- ══════════════ METALS ══════════════ -->
<div class="screen" id="screen-metals">
  <div class="metals-portfolio-bar">
    <div class="metals-portfolio-title">Total Precious Metals Value</div>
    <div class="metals-portfolio-total" id="metals-grand-total">$0</div>
    <div class="metals-mini-cards">
      <div class="metals-mini-card gold-card active-metal" id="mini-gold" onclick="switchMetal('gold')">
        <div class="metals-mini-icon">🥇</div><div class="metals-mini-name">Gold</div>
        <div class="metals-mini-grams" id="mini-gold-grams">0 g</div><div class="metals-mini-usd" id="mini-gold-usd">$0</div>
      </div>
      <div class="metals-mini-card silver-card" id="mini-silver" onclick="switchMetal('silver')">
        <div class="metals-mini-icon">🥈</div><div class="metals-mini-name">Silver</div>
        <div class="metals-mini-grams" id="mini-silver-grams">0 g</div><div class="metals-mini-usd" id="mini-silver-usd">$0</div>
      </div>
      <div class="metals-mini-card platinum-card" id="mini-platinum" onclick="switchMetal('platinum')">
        <div class="metals-mini-icon">🔷</div><div class="metals-mini-name">Platinum</div>
        <div class="metals-mini-grams" id="mini-platinum-grams">0 g</div><div class="metals-mini-usd" id="mini-platinum-usd">$0</div>
      </div>
    </div>
  </div>
  <div class="metal-detail-header">
    <div class="metal-detail-icon-wrap gold" id="metal-detail-icon">🥇</div>
    <div class="metal-detail-info">
      <div class="metal-detail-name" id="metal-detail-name">Gold</div>
      <div class="metal-detail-grams" id="metal-detail-grams">0 g · 0.000 oz</div>
      <div class="metal-detail-usd gold" id="metal-detail-usd">$0</div>
    </div>
    <div style="background:#F8F8F8;border-radius:8px;padding:6px 10px;font-size:0.72em;font-weight:800;color:var(--text-med);text-align:center;flex-shrink:0;max-width:160px;min-width:0;">
      <div style="font-size:0.72em;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="metal-price-base-label">—/gram (24K pure)</div>
      <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;justify-content:center;">
        <span style="font-size:1.2em;font-weight:900;color:var(--text-dark);word-break:break-all;" id="metal-live-price">—</span>
        <button onclick="showMetalPriceEdit()" style="background:#F0F4FF;border:none;border-radius:7px;padding:3px 7px;font-size:0.7em;font-weight:800;color:var(--primary);cursor:pointer;white-space:nowrap;flex-shrink:0;">✏️ Set</button>
      </div>
      <div id="metal-price-override-panel" style="display:none;"><!-- moved to bottom sheet --></div>
    </div>
  </div>
  <div class="metal-stat-row">
    <div class="metal-stat-box"><div class="metal-stat-box-val" id="metal-stat-entries">0</div><div class="metal-stat-box-lbl">Entries</div></div>
    <div class="metal-stat-box"><div class="metal-stat-box-val" id="metal-stat-oz">0</div><div class="metal-stat-box-lbl">Troy Oz</div></div>
    <div class="metal-stat-box"><div class="metal-stat-box-val" id="metal-stat-avg">$0</div><div class="metal-stat-box-lbl">Avg Cost/g</div></div>
  </div>
  <!-- ROI Performance Card -->
  <div id="metal-roi-card" style="background:var(--white);border-radius:var(--radius);box-shadow:var(--card-shadow);margin-bottom:14px;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px 10px;">
      <div style="font-weight:900;font-size:0.92em;color:var(--text-dark);">📈 Portfolio Performance</div>
      <div id="metal-roi-gain-badge" style="font-size:0.78em;font-weight:800;padding:3px 10px;border-radius:20px;background:#D1FAE5;color:#10B981;">+0%</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;border-top:1px solid #F5F5F5;">
      <div style="text-align:center;padding:10px 6px;border-right:1px solid #F5F5F5;">
        <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;">Cost Basis</div>
        <div style="font-weight:900;font-size:0.95em;color:var(--text-dark);" id="metal-roi-cost">$0</div>
      </div>
      <div style="text-align:center;padding:10px 6px;border-right:1px solid #F5F5F5;">
        <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;">Market Value</div>
        <div style="font-weight:900;font-size:0.95em;color:#F59E0B;" id="metal-roi-value">$0</div>
      </div>
      <div style="text-align:center;padding:10px 6px;">
        <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;">Gain / Loss</div>
        <div style="font-weight:900;font-size:0.95em;" id="metal-roi-gain">$0</div>
      </div>
    </div>
    <!-- Cost vs Value bar -->
    <div style="padding:12px 16px 14px;">
      <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;margin-bottom:6px;">Cost vs Live Value</div>
      <div style="position:relative;height:20px;background:#F5F5F5;border-radius:10px;overflow:hidden;">
        <div id="metal-roi-bar-cost" style="position:absolute;left:0;top:0;height:100%;background:#94A3B8;border-radius:10px;transition:width 0.5s ease;"></div>
        <div id="metal-roi-bar-value" style="position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,#F59E0B,#FBBF24);border-radius:10px;opacity:0.85;transition:width 0.5s ease;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;">
        <div style="display:flex;align-items:center;gap:4px;"><div style="width:8px;height:8px;border-radius:2px;background:#94A3B8;"></div><div style="font-size:0.65em;font-weight:700;color:var(--text-light);">Cost</div></div>
        <div style="display:flex;align-items:center;gap:4px;"><div style="font-size:0.65em;font-weight:700;color:var(--text-light);">Live Value</div><div style="width:8px;height:8px;border-radius:2px;background:#F59E0B;"></div></div>
      </div>
      <!-- Cumulative acquisition chart by date -->
      <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;margin:12px 0 6px;">Acquisition Over Time</div>
      <canvas id="metal-roi-canvas" height="70" style="width:100%;display:block;border-radius:8px;"></canvas>
    </div>
  </div>

  <div class="metal-add-panel">
    <div class="metal-add-panel-header" onclick="toggleAddPanel()">
      <div class="metal-add-panel-title"><span id="metal-add-icon">🥇</span> Add <span id="metal-add-label">Gold</span> Entry</div>
      <div class="metal-add-panel-toggle" id="add-panel-toggle">+</div>
    </div>
    <div class="metal-add-panel-body" id="metal-add-panel-body">
      <div class="metal-form-grid">
        <div class="metal-form-field"><label>Source / Name</label><input type="text" id="metal-name" placeholder="e.g. Physical, Coin, Digital Gold"></div>
        <div class="metal-form-field"><label>Weight (grams)</label><input type="number" id="metal-grams" placeholder="0.00" step="0.001"></div>
        <div class="metal-form-field"><label>Purity</label><input type="text" id="metal-purity" placeholder="e.g. 22K, 999"></div>
        <div class="metal-form-field"><label>Occasion</label><input type="text" id="metal-occasion" placeholder="e.g. Purchase, Gift"></div>
        <div class="metal-form-field"><label id="metal-price-field-label">Purchase Price / gram</label><input type="number" id="metal-price" placeholder="Leave blank = current est." step="0.01"></div>
        <div class="metal-form-field"><label>Date</label><input type="date" id="metal-date"></div>
        <div class="metal-form-field"><label>Form</label><select id="metal-form"><option>Bar</option><option>Coin</option><option>Round</option><option>ETF / Digital</option><option>Jewelry</option><option>Other</option></select></div>
        <div class="metal-form-field"><label>Notes</label><input type="text" id="metal-notes" placeholder="Optional"></div>
      </div>
      <button class="metal-save-btn gold" id="metal-save-btn" onclick="addMetalEntry()">+ Add Gold Entry</button>
      <div style="font-size:0.73em;color:var(--text-light);font-weight:600;margin-top:10px;text-align:center;" id="metal-price-hint">💡 Est. gold ≈ $95.50/g · $2,970/oz</div>
    </div>
  </div>
  <div class="metal-holdings-card">
    <div class="metal-holdings-header">
      <div class="metal-holdings-title" id="holdings-list-title">🥇 Gold Holdings</div>
      <div class="metal-holdings-count" id="holdings-list-count">0 entries</div>
    </div>
    <div id="metals-holdings-list"><div class="metal-empty"><div class="metal-empty-icon">🥇</div><div class="metal-empty-text">No gold entries yet</div></div></div>
  </div>
</div>

<!-- ══════════════ INVESTMENTS ══════════════ -->
<div class="screen" id="screen-invest">
  <div class="invest-hero">
    <div class="invest-deco">📈</div>
    <div class="invest-hero-label">Total Portfolio Value</div>
    <div class="invest-hero-value" id="invest-total-value">$0</div>
    <div class="invest-hero-stats">
      <div class="invest-hero-stat"><div class="invest-hero-stat-val" id="invest-total-cost">$0</div><div class="invest-hero-stat-lbl">Total Cost</div></div>
      <div class="invest-hero-stat"><div class="invest-hero-stat-val" id="invest-total-gain">$0</div><div class="invest-hero-stat-lbl">Gain / Loss</div></div>
      <div class="invest-hero-stat"><div class="invest-hero-stat-val" id="invest-total-pct">0%</div><div class="invest-hero-stat-lbl">Return</div></div>
    </div>
  </div>
  <div class="invest-cat-tabs" id="invest-cat-tabs">
    <button class="invest-cat-tab active" onclick="filterInvest('All',this)">All</button>
    <button class="invest-cat-tab" onclick="filterInvest('Stocks',this)">📊 Stocks</button>
    <button class="invest-cat-tab" onclick="filterInvest('ETF',this)">🗂 ETF</button>
    <button class="invest-cat-tab" onclick="filterInvest('Crypto',this)">🪙 Crypto</button>
    <button class="invest-cat-tab" onclick="filterInvest('Retirement',this)">🏦 Retirement</button>
    <button class="invest-cat-tab" onclick="filterInvest('Real Estate',this)">🏡 Real Estate</button>
    <button class="invest-cat-tab" onclick="filterInvest('Other',this)">📦 Other</button>
  </div>
  <div id="invest-holdings-list" style="margin-bottom:16px;"></div>
  <div class="invest-entry-card">
    <div class="invest-entry-title">➕ Add Investment</div>
    <div class="inv-form-grid">
      <div class="inv-field"><label>Ticker / Name</label><input type="text" id="inv-ticker" placeholder="e.g. FXAIX, BTC"></div>
      <div class="inv-field"><label>Category</label><select id="inv-cat"><option>Stocks</option><option>ETF</option><option>Crypto</option><option>Retirement</option><option>Real Estate</option><option>Other</option></select></div>
      <div class="inv-field"><label>Shares / Units</label><input type="number" id="inv-shares" placeholder="0.00" step="0.0001"></div>
      <div class="inv-field"><label>Avg Cost / Share ($)</label><input type="number" id="inv-cost" placeholder="0.00" step="0.01"></div>
      <div class="inv-field"><label>Current Price ($)</label><input type="number" id="inv-price" placeholder="0.00" step="0.01"></div>
      <div class="inv-field"><label>Date Added</label><input type="date" id="inv-date"></div>
      <div class="inv-field full"><label>Account / Broker</label><input type="text" id="inv-broker" placeholder="e.g. Zerodha, Groww, Fidelity, Schwab"></div>
    </div>
    <button class="add-invest-btn" onclick="addInvestEntry()">+ Add to Portfolio</button>
  </div>
</div>

<!-- ══════════════ SETTINGS ══════════════ -->
<div class="screen" id="screen-settings">

  <!-- ═══ Cloud Sync — Always visible, no toggle ═══ -->
  <div style="background:white;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 1px 6px rgba(0,0,0,0.06);">
    <div style="font-size:0.7em;font-weight:800;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;">☁️ Cloud Sync Account</div>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      <img id="firebase-user-avatar" src="" style="display:none;width:40px;height:40px;border-radius:50%;border:2px solid #E8E8E8;">
      <div>
        <div id="firebase-user-display" style="font-weight:800;font-size:0.9em;color:#1E2A6E;">Loading...</div>
        <div style="font-size:0.72em;color:#10B981;font-weight:700;">✅ Synced across devices</div>
      </div>
    </div>
    <button onclick="signOut()" style="width:100%;padding:10px;background:#FFF0F0;border:1.5px solid #FFCDD2;border-radius:10px;color:#EF4444;font-weight:800;font-size:0.82em;cursor:pointer;">
      Sign Out
    </button>
  </div>

  <!-- ═══ Recurring Transactions — Open by default ═══ -->
  <div class="settings-accordion" id="acc-recurring">
    <div class="acc-header" onclick="toggleAccordion('acc-recurring')">
      <span>🔁 Recurring Transactions</span>
      <span class="acc-chev">▾</span>
    </div>
    <div class="acc-body">
      <div id="recurring-rules-list"></div>
    </div>
  </div>

  <!-- ═══ Currency & FX — Collapsible, closed ═══ -->
  <div class="settings-accordion collapsed" id="acc-currency">
    <div class="acc-header" onclick="toggleAccordion('acc-currency')">
      <span>💱 Currency & Exchange Rates</span>
      <span class="acc-chev">▸</span>
    </div>
    <div class="acc-body" style="display:none;">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:12px;">All amounts display in your chosen currency symbol.</p>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div>
          <div style="font-weight:900;font-size:1.1em;" id="settings-curr-display">🇺🇸 USD — $</div>
          <div style="font-size:0.78em;color:var(--text-light);margin-top:2px;" id="settings-curr-name">US Dollar</div>
        </div>
        <button onclick="openCurrencyPicker('settings')" style="background:var(--yellow);border:none;border-radius:10px;padding:10px 18px;font-family:Nunito,sans-serif;font-weight:900;font-size:0.88em;cursor:pointer;">Change</button>
      </div>
      <div style="border-top:1px solid #F0F0F0;padding-top:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <span style="font-size:0.78em;font-weight:800;color:var(--text-med);">FX OVERRIDE RATES <span id="fx-override-badge" style="display:none;background:#F0FFF4;color:#10B981;font-size:0.65em;border-radius:8px;padding:2px 8px;font-weight:800;margin-left:6px;">✏️ Custom</span></span>
          <button onclick="clearAllFXOverrides()" id="fx-clear-all-btn" style="display:none;background:#FFF0F0;border:1.5px solid #EF444430;border-radius:8px;padding:4px 10px;font-size:0.72em;font-weight:800;color:#EF4444;cursor:pointer;">🗑 Clear All</button>
        </div>
        <p style="font-size:0.78em;color:var(--text-light);font-weight:600;margin-bottom:10px;">Override any rate if the built-in estimate is off. Only currencies in your data appear here.</p>
        <div id="fx-rates-list"></div>
      </div>
    </div>
  </div>

  <!-- ═══ Home Spending Cards — Open by default ═══ -->
  <div class="settings-accordion" id="acc-homecards">
    <div class="acc-header" onclick="toggleAccordion('acc-homecards')">
      <span>🏠 Home Spending Cards</span>
      <span class="acc-chev">▾</span>
    </div>
    <div class="acc-body">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:12px;">Choose which category cards appear on your home screen. Toggle ✓ to show/hide, ✕ to permanently remove.</p>
      <div class="home-card-grid" id="home-card-grid"></div>
      <div style="margin-top:10px;">
        <div style="font-size:0.78em;font-weight:800;color:var(--text-med);margin-bottom:8px;">ADD CUSTOM CARD</div>
        <div class="home-card-emoji-pick" id="home-card-emoji-row"></div>
        <div class="home-card-add-row">
          <input type="text" class="cat-add-input" id="home-card-name-input" placeholder="Card name (e.g. Groceries)">
          <button class="cat-add-btn" onclick="addHomeCard()">+ Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ Home Investment Cards — Closed by default ═══ -->
  <div class="settings-accordion collapsed" id="acc-invcards">
    <div class="acc-header" onclick="toggleAccordion('acc-invcards')">
      <span>📈 Home Investment Cards</span>
      <span class="acc-chev">▸</span>
    </div>
    <div class="acc-body" style="display:none;">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:12px;">Choose which investment cards appear on the Investing tab. Toggle ✓ to show/hide, ✕ to remove.</p>
      <div class="home-card-grid" id="inv-card-grid"></div>
      <div style="margin-top:10px;">
        <div style="font-size:0.78em;font-weight:800;color:var(--text-med);margin-bottom:8px;">ADD CUSTOM INVESTMENT CARD</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-bottom:8px;">Pick an emoji, name your card, choose how it tracks</div>
        <div class="home-card-emoji-pick" id="inv-card-emoji-row"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
          <input type="text" class="cat-add-input" id="inv-card-name-input" placeholder="Card name (e.g. PF/VPF, NPS, FD)" style="flex:2;min-width:140px;">
          <select id="inv-card-template" class="cat-add-input" style="flex:1;min-width:110px;">
            <option value="General">💰 Contribution</option>
            <option value="ETF/MF">📊 Units × NAV</option>
            <option value="Stocks">📈 Shares × Price</option>
            <option value="Crypto">🪙 Coins × Price</option>
            <option value="Metals">🥇 Weight × Cost</option>
            <option value="Real Estate">🏡 Property</option>
          </select>
        </div>
        <button class="cat-add-btn" style="width:100%;" onclick="addInvCard()">+ Add Investment Card</button>
      </div>
    </div>
  </div>

  <!-- ═══ Manage Categories — Closed by default ═══ -->
  <div class="settings-accordion collapsed" id="acc-categories">
    <div class="acc-header" onclick="toggleAccordion('acc-categories')">
      <span>🏷️ Manage Categories</span>
      <span class="acc-chev">▸</span>
    </div>
    <div class="acc-body" style="display:none;">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:12px;">Customize subcategories used in Quick Add. Tap ✕ to remove, or add your own below.</p>
      <div class="cat-mgr-tabs" id="cat-mgr-tabs">
        <button class="cat-mgr-tab active" onclick="showCatMgrTab('expense',this)">💸 Expense</button>
        <button class="cat-mgr-tab" onclick="showCatMgrTab('income',this)">💵 Income</button>
        <button class="cat-mgr-tab" onclick="showCatMgrTab('investment',this)">📈 Invest</button>
        <button class="cat-mgr-tab" onclick="showCatMgrTab('debt',this)">📉 Debt</button>
        <button class="cat-mgr-tab" onclick="showCatMgrTab('given',this)">🤝 Given</button>
        <button class="cat-mgr-tab" onclick="showCatMgrTab('additional',this)">🎁 Additional</button>
      </div>
      <div class="cat-pills-wrap" id="cat-pills-wrap"></div>
      <div class="cat-add-row">
        <input type="text" class="cat-add-input" id="cat-add-input" placeholder="New category name..." onkeydown="if(event.key==='Enter')addCustomCat()">
        <button class="cat-add-btn" onclick="addCustomCat()">+ Add</button>
      </div>
    </div>
  </div>

  <!-- ═══ Net Worth Account Types — Closed by default ═══ -->
  <div class="settings-accordion collapsed" id="acc-nwtypes">
    <div class="acc-header" onclick="toggleAccordion('acc-nwtypes')">
      <span>💎 Net Worth Account Types</span>
      <span class="acc-chev">▸</span>
    </div>
    <div class="acc-body" style="display:none;">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:12px;">Choose which types appear in the Add Account picker. Toggle ✓ to show/hide, ✕ to remove custom types.</p>
      <div class="home-card-grid" id="nw-type-visibility-grid"></div>
      <div style="margin-top:12px;border-top:1px solid #F0F0F0;padding-top:12px;">
        <div style="font-size:0.78em;font-weight:800;color:var(--text-med);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">Add Custom Type</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <div id="nw-type-emoji-row" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <input type="text" id="nw-type-name-input" class="cat-add-input" placeholder="e.g. Auto Loan, Other Asset" style="flex:1;">
          <label style="display:flex;align-items:center;gap:4px;font-size:0.8em;font-weight:700;cursor:pointer;">
            <input type="checkbox" id="nw-type-is-liab"> Liability
          </label>
          <button class="cat-add-btn" onclick="addCustomNWType()">+ Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ App Theme — Open by default ═══ -->
  <div class="settings-accordion" id="acc-theme">
    <div class="acc-header" onclick="toggleAccordion('acc-theme')">
      <span>🎨 App Theme</span>
      <span class="acc-chev">▾</span>
    </div>
    <div class="acc-body">
      <p style="font-size:0.82em;color:var(--text-light);font-weight:600;margin-bottom:14px;">Pick a vibe! Each theme adds fun decorations and colors.</p>
      <div class="theme-grid">
        <div class="theme-card default active-theme" id="theme-default" onclick="setTheme('default')">
          <div class="tc-preview">☀️💰</div>
          <div class="tc-name">Classic MoneyFlow</div>
          <div class="tc-desc">The original warm & sunny look</div>
          <div class="tc-active-badge">✓</div>
        </div>
        <div class="theme-card looney" id="theme-looney" onclick="setTheme('looney')">
          <div class="tc-preview">🐰🦆😜</div>
          <div class="tc-name">Looney Tunes!</div>
          <div class="tc-desc">Wabbit season for your wallet</div>
          <div class="tc-active-badge">✓</div>
        </div>
        <div class="theme-card jungle" id="theme-jungle" onclick="setTheme('jungle')">
          <div class="tc-preview">🐒🌿🦜</div>
          <div class="tc-name">Jungle Vibes</div>
          <div class="tc-desc">Go bananas with your budget!</div>
          <div class="tc-active-badge">✓</div>
        </div>
        <div class="theme-card space" id="theme-space" onclick="setTheme('space')">
          <div class="tc-preview">🚀⭐🌙</div>
          <div class="tc-name">Space Explorer</div>
          <div class="tc-desc">Finance at warp speed</div>
          <div class="tc-active-badge">✓</div>
        </div>
        <div class="theme-card ocean" id="theme-ocean" onclick="setTheme('ocean')">
          <div class="tc-preview">🐠🌊🐚</div>
          <div class="tc-name">Deep Ocean</div>
          <div class="tc-desc">Dive deep into your finances</div>
          <div class="tc-active-badge">✓</div>
        </div>

      </div>
    </div>
  </div>

  <!-- ═══ Data Management — Closed by default ═══ -->
  <div class="settings-accordion collapsed" id="acc-data">
    <div class="acc-header" onclick="toggleAccordion('acc-data')" style="color:#EF4444;">
      <span>🗑 Data Management</span>
      <span class="acc-chev">▸</span>
    </div>
    <div class="acc-body" style="display:none;">
      <div class="settings-card" style="box-shadow:none;padding:0;margin-bottom:0;">
        <div class="form-row">
          <span class="form-icon">💾</span><span class="form-label">Backup</span>
          <button onclick="downloadBackup()" style="background:var(--yellow-light);border:none;border-radius:8px;padding:8px 14px;font-family:Nunito;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--text-dark);">⬇️ Download</button>
        </div>
        <div class="form-row">
          <span class="form-icon">📊</span><span class="form-label">Export</span>
          <button onclick="exportAllData()" style="background:var(--yellow-light);border:none;border-radius:8px;padding:8px 14px;font-family:Nunito;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--text-dark);">Export Excel</button>
        </div>
        <div class="form-row" style="border-bottom:none;">
          <span class="form-icon">📥</span><span class="form-label">Restore</span>
          <label for="restore-settings-file" style="background:var(--yellow-light);border:none;border-radius:8px;padding:8px 14px;font-family:Nunito;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--text-dark);">⬆️ Upload</label>
          <input type="file" id="restore-settings-file" accept=".json" style="display:none;" onchange="restoreBackup(this)">
        </div>
        <div class="form-row" style="border-bottom:none;margin-top:4px;">
          <span class="form-icon">🎬</span><span class="form-label">Intro Tour</span>
          <div style="display:flex;gap:6px;">
            <button onclick="showOnboarding()" style="background:var(--yellow-light);border:none;border-radius:8px;padding:8px 12px;font-family:Nunito;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--text-dark);">▶ Slides</button>
            <button onclick="startCoachTour()" style="background:var(--primary-light);border:none;border-radius:8px;padding:8px 12px;font-family:Nunito;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--primary);">🎯 Coach</button>
          </div>
        </div>
      </div>
      <div id="reset-data-summary" style="margin-top:12px;"></div>
    </div>
  </div>

</div>
<!-- FAB BACKDROP -->
<div class="fab-backdrop" id="fab-backdrop" onclick="closeFabMenu()"></div>

<!-- FAB LAUNCHER MENU -->
<div class="fab-menu" id="fab-menu">
  <div class="fab-menu-item" id="fmi-investment">
    <div class="fab-menu-label">📈 Investment</div>
    <button class="fab-menu-btn" style="background:#7C3AED;color:white;" onclick="closeFabMenu();openQuickAdd('investment',null)">📈</button>
  </div>
  <div class="fab-menu-item" id="fmi-income">
    <div class="fab-menu-label">💵 Income</div>
    <button class="fab-menu-btn" style="background:#10B981;color:white;" onclick="closeFabMenu();openQuickAdd('income',null)">💵</button>
  </div>
  <div class="fab-menu-item" id="fmi-expense">
    <div class="fab-menu-label">💸 Expense</div>
    <button class="fab-menu-btn" style="background:#EF4444;color:white;" onclick="closeFabMenu();openQuickAdd('expense',null)">💸</button>
  </div>
</div>

<!-- FLOATING ADD BUTTON -->
<button class="fab-add" id="fab-add-btn" onclick="toggleFabMenu()" title="Add Transaction">＋</button>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchScreen('home',this)"><div class="nav-icon">🏠</div><span>Home</span></button>
  <button class="nav-item" onclick="switchScreen('tx',this)"><div class="nav-icon">📋</div><span>Txns</span></button>
  <button class="nav-item" onclick="switchScreen('budget',this)"><div class="nav-icon">🎯</div><span>Budget</span></button>
  <button class="nav-item" onclick="switchScreen('networth',this)"><div class="nav-icon">💎</div><span>Net Worth</span></button>
  <button class="nav-item" onclick="switchScreen('import',this)"><div class="nav-icon">📥</div><span>Import</span></button>
</div>

<!-- ══════════════ BUDGET MODULE ══════════════ -->
<div class="screen" id="screen-budget">
  <!-- Module Tabs -->
  <div class="budget-module-tabs">
    <button class="bm-tab active" id="btab-overview" onclick="setBudgetTab('overview',this)">📊 Overview</button>
    <button class="bm-tab" id="btab-expenses" onclick="setBudgetTab('expenses',this)">💸 Expenses</button>
    <button class="bm-tab" id="btab-savings" onclick="setBudgetTab('savings',this)">💰 Savings</button>
    <button class="bm-tab" id="btab-goals" onclick="setBudgetTab('goals',this)">🎯 Goals</button>
  </div>

  <!-- Budget Month Nav -->
  <div class="period-nav" style="margin-bottom:12px;">
    <button onclick="budgetChangeMonth(-1)">‹</button>
    <div class="period-label" id="budget-month-label">February 2026</div>
    <button onclick="budgetChangeMonth(1)">›</button>
  </div>

  <!-- OVERVIEW TAB -->
  <div id="bsec-overview" class="budget-section"
    ontouchstart="budgetSwipeStart(event)"
    ontouchend="budgetSwipeEnd(event)">
    <!-- Hero card: Total left + dual line chart -->
    <div class="budget-hero-card" id="bh-card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:2px;">
        <div class="bh-title" id="bh-title">TOTAL BUDGETED</div>
        <div class="bh-view-toggle">
          <button class="bh-view-btn active" id="bh-btn-month" onclick="setBudgetViewMode('month')">Month</button>
          <button class="bh-view-btn" id="bh-btn-year" onclick="setBudgetViewMode('year')">Year</button>
        </div>
      </div>
      <div class="bh-amount" id="bh-amount">$0</div>
      <div class="bh-sub" id="bh-sub"></div>
      <div class="bh-chart-wrap"><canvas id="budget-overview-chart"></canvas></div>
      <div class="bh-dual-lines">
        <div class="bh-line-block">
          <div class="bh-line-label">Expenses</div>
          <div class="bh-line-val" id="bh-exp-val">$0</div>
          <div class="bh-line-sub" id="bh-exp-sub"></div>
        </div>
        <div class="bh-line-block">
          <div class="bh-line-label">Savings</div>
          <div class="bh-line-val" id="bh-sav-val">$0</div>
          <div class="bh-line-sub" id="bh-sav-sub"></div>
        </div>
      </div>
    </div>

    <!-- Category bubbles — split by type -->
    <div id="budget-cats-wrapper">
      <div class="bcat-group-label" id="bcat-label-exp" style="display:none;">
        <span class="bcat-group-pill exp">💸 Expenses</span>
      </div>
      <div class="budget-cats-scroll" id="budget-cats-bubbles-exp"></div>
      <div class="bcat-group-label" id="bcat-label-sav" style="display:none;">
        <span class="bcat-group-pill sav">💰 Savings</span>
      </div>
      <div class="budget-cats-scroll" id="budget-cats-bubbles-sav"></div>
    </div>
  </div>

  <!-- EXPENSES GOALS TAB -->
  <div id="bsec-expenses" class="budget-section" style="display:none;">
    <!-- Category detail view (shown when a category is clicked) -->
    <div class="bcat-detail-view" id="bcat-detail-expenses"
      ontouchstart="budgetSwipeStart(event)"
      ontouchend="budgetSwipeEnd(event)">
      <button class="bcd-back-btn" onclick="closeBudgetCatDetail('expenses')">← Back</button>
      <div class="bcd-header">
        <div class="bcd-icon" id="bcd-exp-icon"></div>
        <div class="bcd-name" id="bcd-exp-name"></div>
        <div class="bcd-spent" id="bcd-exp-spent"></div>
      </div>
      <div class="bcd-chart-card">
        <div class="bcd-chart-title"><span>Last 12 Months</span></div>
        <div class="bcd-chart-outer">
          <div class="bcd-chart-wrap"><canvas id="bcd-exp-chart"></canvas></div>
          <div class="bcd-budget-chip" id="bcd-exp-chip" onclick="activateBudgetChip('expense')">
            <span class="bcd-chip-label" id="bcd-exp-chip-label">$0</span>
            <span class="bcd-chip-pencil">✏️</span>
            <input class="bcd-chip-input" id="bcd-exp-chip-input" type="number" step="1"
              onblur="saveBudgetChip('expense')"
              onkeydown="if(event.key==='Enter')saveBudgetChip('expense');if(event.key==='Escape')cancelBudgetChip('expense');">
          </div>
        </div>
      </div>
      <div class="bcd-metrics" id="bcd-exp-metrics"></div>
      <div class="bcd-txns-section">
        <div class="bcd-txns-title"><span id="bcd-exp-txn-month">Transactions</span></div>
        <div id="bcd-exp-txns"></div>
      </div>
    </div>
    <!-- Goals list -->
    <div id="blist-expenses">
      <div class="budget-goals-section">
        <div class="bgs-header">
          <div class="bgs-title">💸 Expense Budgets</div>
          <button class="bgs-add-btn" onclick="openEditBudgetPopup(null,'expense')">+ Add</button>
        </div>
        <div id="budget-exp-goals"></div>
      </div>
    </div>
  </div>

  <!-- SAVINGS GOALS TAB -->
  <div id="bsec-savings" class="budget-section" style="display:none;">
    <div class="bcat-detail-view" id="bcat-detail-savings"
      ontouchstart="budgetSwipeStart(event)"
      ontouchend="budgetSwipeEnd(event)">
      <button class="bcd-back-btn" onclick="closeBudgetCatDetail('savings')">← Back</button>
      <div class="bcd-header">
        <div class="bcd-icon" id="bcd-sav-icon"></div>
        <div class="bcd-name" id="bcd-sav-name"></div>
        <div class="bcd-spent" id="bcd-sav-spent"></div>
      </div>
      <div class="bcd-chart-card">
        <div class="bcd-chart-title"><span>Last 12 Months</span></div>
        <div class="bcd-chart-outer">
          <div class="bcd-chart-wrap"><canvas id="bcd-sav-chart"></canvas></div>
          <div class="bcd-budget-chip" id="bcd-sav-chip" onclick="activateBudgetChip('savings')">
            <span class="bcd-chip-label" id="bcd-sav-chip-label">$0</span>
            <span class="bcd-chip-pencil">✏️</span>
            <input class="bcd-chip-input" id="bcd-sav-chip-input" type="number" step="1"
              onblur="saveBudgetChip('savings')"
              onkeydown="if(event.key==='Enter')saveBudgetChip('savings');if(event.key==='Escape')cancelBudgetChip('savings');">
          </div>
        </div>
      </div>
      <div class="bcd-metrics" id="bcd-sav-metrics"></div>
      <div class="bcd-txns-section">
        <div class="bcd-txns-title"><span id="bcd-sav-txn-month">Transactions</span></div>
        <div id="bcd-sav-txns"></div>
      </div>
    </div>
    <div id="blist-savings">
      <div class="budget-goals-section">
        <div class="bgs-header">
          <div class="bgs-title">💰 Savings Goals</div>
          <button class="bgs-add-btn" onclick="openEditBudgetPopup(null,'savings')">+ Add</button>
        </div>
        <div id="budget-sav-goals"></div>
      </div>
    </div>
  </div>
</div>

<!-- ── GOALS PANEL (outside all bsec, inside screen-budget via JS control) ── -->
<div id="blist-goals" style="display:none;position:fixed;top:0;left:0;right:0;bottom:60px;overflow-y:auto;background:#FAF8F5;z-index:50;padding:16px 16px 96px;">
  <!-- Top bar -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <button onclick="closeGoalsPanelBack()" style="background:#F0F0F0;border:none;border-radius:10px;padding:8px 14px;font-weight:800;font-size:0.85em;cursor:pointer;">← Back</button>
    <div style="font-weight:900;font-size:1.05em;color:var(--text-dark);">🎯 Goals</div>
    <div style="width:70px;"></div>
  </div>
  <!-- Active / Achieved tabs -->
  <div style="display:flex;gap:8px;margin-bottom:14px;" id="goals-tab-bar">
    <button id="gtab-active" onclick="setGoalsTab('active')"
      style="flex:1;padding:9px 0;border:none;border-radius:12px;background:var(--yellow);color:var(--text-dark);font-family:Nunito,sans-serif;font-weight:900;font-size:0.85em;cursor:pointer;">
      🎯 Active <span id="gtab-active-count" style="background:rgba(0,0,0,0.12);border-radius:20px;padding:1px 7px;font-size:0.85em;margin-left:4px;">0</span>
    </button>
    <button id="gtab-achieved" onclick="setGoalsTab('achieved')"
      style="flex:1;padding:9px 0;border:none;border-radius:12px;background:#F0F0F0;color:var(--text-med);font-family:Nunito,sans-serif;font-weight:900;font-size:0.85em;cursor:pointer;">
      🏆 Achieved <span id="gtab-achieved-count" style="background:rgba(0,0,0,0.10);border-radius:20px;padding:1px 7px;font-size:0.85em;margin-left:4px;">0</span>
    </button>
  </div>
  <div id="goals-list-grid"></div>
</div>
<!-- Goals FAB — yellow to match main FAB for visual consistency -->
<button id="goals-fab-btn" onclick="openGoalSheet(null)"
  style="display:none;position:fixed;bottom:80px;right:20px;width:56px;height:56px;
         border-radius:50%;background:var(--yellow);color:var(--text-dark);border:none;font-size:1.8em;
         font-weight:900;box-shadow:0 4px 20px rgba(245,200,66,0.55);cursor:pointer;z-index:300;
         align-items:center;justify-content:center;line-height:1;
         animation:fabPulse 2.8s ease-in-out infinite;">＋</button>

<!-- GOAL BOTTOM SHEET -->
<div id="goal-sheet-overlay" onclick="closeGoalSheet()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:299;"></div>
<div id="goal-sheet" style="display:none;position:fixed;bottom:0;left:0;right:0;background:white;border-radius:20px 20px 0 0;padding:20px 16px 36px;z-index:300;box-shadow:0 -4px 30px rgba(0,0,0,0.2);max-height:88vh;overflow-y:auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <div style="font-weight:900;font-size:1em;color:var(--text-dark);" id="goal-sheet-title">New Goal</div>
    <button onclick="closeGoalSheet()" style="background:#F0F0F0;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;">✕</button>
  </div>
  <div class="nw-sheet-row">
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Goal Type</div>
      <select class="nw-sheet-select" id="gs-goaltype" onchange="toggleGoalTypeFields()">
        <option value="grow">📈 Grow (build toward target)</option>
        <option value="reduce">📉 Reduce (pay down liability)</option>
      </select>
    </div>
  </div>
  <!-- Start Balance — only shown for reduce goals -->
  <div class="nw-sheet-row" id="gs-startbal-row" style="display:none;">
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Starting Balance (when you began tracking)</div>
      <input class="nw-sheet-input" id="gs-startbal" type="number" placeholder="e.g. 25000 (original loan balance)" step="any" oninput="updateGoalPreview()">
    </div>
  </div>
  <div class="nw-sheet-row">
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Goal Name</div>
      <input class="nw-sheet-input" id="gs-name" type="text" placeholder="e.g. Emergency Fund, Gold 1500g">
    </div>
  </div>
  <!-- Icon picker row (full width, below name) -->
  <div class="nw-sheet-field">
    <div class="nw-sheet-label">Icon <span style="font-weight:600;color:var(--text-light);text-transform:none;letter-spacing:0;">— tap to pick</span></div>
    <input type="hidden" id="gs-icon" value="🎯">
    <div id="gs-icon-grid" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
  </div>
  <div class="nw-sheet-row">
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Target Amount</div>
      <input class="nw-sheet-input" id="gs-target" type="number" placeholder="1000000" step="any" oninput="updateGoalPreview()">
    </div>
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Unit</div>
      <select class="nw-sheet-select" id="gs-unit">
        <option value="currency">$ (Currency)</option>
        <option value="grams">Grams (g)</option>
        <option value="kg">Kilograms (kg)</option>
        <option value="count">Count</option>
        <option value="sqft">Sq. Ft / Area (Real Estate)</option>
      </select>
    </div>
  </div>
  <div class="nw-sheet-row">
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Currency (if currency unit)</div>
      <select class="nw-sheet-select" id="gs-currency" onchange="updateGoalPreview()">
        <option value="USD">USD $</option>
        <option value="INR">INR ₹</option>
        <option value="EUR">EUR €</option>
        <option value="GBP">GBP £</option>
        <option value="AED">AED د.إ</option>
        <option value="SAR">SAR ﷼</option>
        <option value="CAD">CAD C$</option>
        <option value="AUD">AUD A$</option>
        <option value="SGD">SGD S$</option>
        <option value="JPY">JPY ¥</option>
        <option value="CNY">CNY ¥</option>
      </select>
    </div>
    <div class="nw-sheet-field" style="flex:1;">
      <div class="nw-sheet-label">Target Date (optional)</div>
      <input class="nw-sheet-input" id="gs-date" type="month">
    </div>
  </div>
  <div class="nw-sheet-field">
    <div class="nw-sheet-label">Description (optional)</div>
    <input class="nw-sheet-input" id="gs-desc" type="text" placeholder="e.g. Kids college fund">
  </div>
  <div class="nw-sheet-field">
    <div class="nw-sheet-label" id="gs-picker-label">Map NW Accounts to this Goal</div>
    <div style="font-size:0.72em;color:var(--text-light);font-weight:600;margin-bottom:8px;" id="gs-picker-hint">Search and select accounts — grouped by type. Combined value counts as current progress.</div>
    <input type="text" class="gap-search" id="gap-search-input" placeholder="🔍  Search accounts..." oninput="filterGoalPicker(this.value)">
    <div id="gs-account-picker" style="max-height:260px;overflow-y:auto;border:1.5px solid #EEE;border-radius:12px;padding:8px;background:white;"></div>
  </div>
  <!-- Live progress preview -->
  <div class="gap-preview-bar" id="gs-preview" style="display:none;">
    <div class="gap-preview-label">📊 Progress Preview</div>
    <div class="gap-preview-track"><div class="gap-preview-fill" id="gap-preview-fill" style="width:0%;"></div></div>
    <div class="gap-preview-nums">
      <span id="gap-preview-current" style="color:var(--primary);">—</span>
      <span id="gap-preview-pct" style="color:var(--primary);">0%</span>
      <span id="gap-preview-target" style="color:var(--text-med);">of —</span>
    </div>
  </div>
  <button id="gs-save-btn" onclick="saveGoal()" style="width:100%;background:var(--primary);color:white;border:none;border-radius:14px;padding:16px;font-weight:900;font-size:1.05em;cursor:pointer;margin-top:14px;box-shadow:0 4px 18px rgba(30,42,110,0.35);letter-spacing:0.2px;">🎯 Add Goal</button>
  <input type="hidden" id="gs-editing-id">
</div>

<!-- ══════════════ NET WORTH ══════════════ -->
<div class="screen" id="screen-networth">
  <!-- ── Hero ── -->
  <div class="nw-hero">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <div class="nw-hero-label" style="margin-bottom:0;">💎 Total Net Worth</div>
      <button class="nw-eye-btn" id="nw-eye-btn" onclick="toggleNWVisibility()" title="Hide/show balances">
        <span id="nw-eye-icon">🔓</span>
      </button>
    </div>
    <div class="nw-hero-amount" id="nw-total" style="text-align:left;">$0</div>
    <div class="nw-hero-change" id="nw-change"></div>
    <div class="nw-hero-bars">
      <div class="nw-hero-bar-block">
        <div class="nw-hero-bar-label">Assets</div>
        <div class="nw-hero-bar-val" id="nw-assets-hero">$0</div>
      </div>
      <div class="nw-hero-bar-block">
        <div class="nw-hero-bar-label">Liabilities</div>
        <div class="nw-hero-bar-val" id="nw-liab-hero">$0</div>
      </div>
      <div class="nw-hero-bar-block">
        <div class="nw-hero-bar-label">Debt Ratio</div>
        <div class="nw-hero-bar-val" id="nw-debt-ratio">0%</div>
        <div class="nw-debt-badge" id="nw-debt-badge"></div>
      </div>
    </div>
  </div>

  <!-- ── CTA Buttons ── -->
  <div class="nw-cta-row">
    <button class="nw-btn-snapshot" onclick="saveNWSnapshot()">📸 Snapshot Month</button>
    <button class="nw-btn-add" onclick="openNWSheet()">+ Add Account</button>
  </div>

  <!-- ── Insights Cards ── -->
  <div id="nw-insights-list"></div>

  <!-- ── Monthly Intelligence ── -->
  <div id="nw-intelligence-card" style="display:none;margin-bottom:14px;">

    <!-- NW Trend Chart -->
    <div class="nw-trend-card" id="nw-chart-card">
      <div class="nw-trend-header">
        <div class="nw-trend-title">📈 Net Worth Progression</div>
        <div class="nw-trend-badge" id="nw-snap-count">0 months</div>
      </div>
      <div class="nw-chart-wrap"><canvas id="nw-trend-chart"></canvas></div>
    </div>

    <!-- Month Comparison selector -->
    <div style="background:white;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div style="font-size:0.75em;font-weight:900;color:var(--text-light);text-transform:uppercase;letter-spacing:0.5px;">📊 Monthly Comparison</div>
        <div style="display:flex;gap:6px;">
          <select id="mi-month-a" onchange="renderMonthlyIntelligence()" style="font-family:Nunito,sans-serif;font-weight:800;font-size:0.75em;border:1.5px solid #E8E8E8;border-radius:8px;padding:4px 6px;background:white;"></select>
          <span style="font-weight:900;color:var(--text-light);align-self:center;">vs</span>
          <select id="mi-month-b" onchange="renderMonthlyIntelligence()" style="font-family:Nunito,sans-serif;font-weight:800;font-size:0.75em;border:1.5px solid #E8E8E8;border-radius:8px;padding:4px 6px;background:white;"></select>
        </div>
      </div>
      <!-- KPI comparison row -->
      <div id="mi-kpi-row" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:14px;"></div>
      <!-- Category breakdown -->
      <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">Top Spending Categories</div>
      <div id="mi-cat-bars"></div>
      <!-- Budget performance -->
      <div id="mi-budget-section" style="margin-top:12px;"></div>
      <!-- Savings trend -->
      <div style="margin-top:12px;">
        <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:6px;">Savings Rate Trend</div>
        <canvas id="mi-savings-chart" height="50" style="width:100%;display:block;"></canvas>
      </div>
    </div>

    <!-- Snapshot list -->
    <div style="background:white;border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px;">
      <div style="font-size:0.75em;font-weight:900;color:var(--text-light);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">📸 Saved Snapshots</div>
      <div id="nw-snapshots-list"></div>
    </div>

  </div>

  <!-- ── Asset Allocation ── -->
  <div class="nw-alloc-card" id="nw-alloc-card" style="display:none;">
    <div class="nw-alloc-title">Asset Allocation</div>
    <!-- Stacked bar -->
    <div id="nw-alloc-stacked-bar" style="display:flex;height:22px;border-radius:11px;overflow:hidden;margin-bottom:14px;gap:2px;"></div>
    <!-- Total -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div style="font-size:0.75em;font-weight:700;color:var(--text-light);">Total Assets</div>
      <div style="font-weight:900;font-size:1em;color:var(--text-dark);" id="nw-alloc-total">$0</div>
    </div>
    <!-- Allocation rows -->
    <div id="nw-donut-legend"></div>
  </div>

  <!-- ── ASSETS section ── -->
  <div class="nw-group-header">
    <div class="nw-group-label">💰 Assets</div>
    <div class="nw-group-total" id="nw-assets-total" style="color:#10B981;"></div>
  </div>

  <div class="nw-section" id="nw-sec-checking">
    <div class="nw-section-header" onclick="toggleNWSection('checking')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#EBF5FF;">🏦</div>
        <div><div class="nw-section-name">Checking</div><div class="nw-section-sub" id="nw-sub-checking">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-checking" style="color:#4A9EFF;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-checking">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-checking">
      <button class="nw-section-add" onclick="openNWSheet('checking')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-savings_acc">
    <div class="nw-section-header" onclick="toggleNWSection('savings_acc')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#E8FDF5;">💵</div>
        <div><div class="nw-section-name">Savings</div><div class="nw-section-sub" id="nw-sub-savings_acc">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-savings_acc" style="color:#10B981;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-savings_acc">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-savings_acc">
      <button class="nw-section-add" onclick="openNWSheet('savings_acc')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-brokerage">
    <div class="nw-section-header" onclick="toggleNWSection('brokerage')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#F0EBFF;">📈</div>
        <div><div class="nw-section-name">Investments &amp; Brokerage</div><div class="nw-section-sub" id="nw-sub-brokerage">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-brokerage" style="color:#7C3AED;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-brokerage">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-brokerage">
      <button class="nw-section-add" onclick="openNWSheet('brokerage')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-retirement">
    <div class="nw-section-header" onclick="toggleNWSection('retirement')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#FFFBE8;">🏛️</div>
        <div><div class="nw-section-name">Retirement</div><div class="nw-section-sub" id="nw-sub-retirement">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-retirement" style="color:#7C3AED;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-retirement">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-retirement">
      <button class="nw-section-add" onclick="openNWSheet('retirement')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-bonds_fd">
    <div class="nw-section-header" onclick="toggleNWSection('bonds_fd')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#FFF7E8;">📋</div>
        <div><div class="nw-section-name">Bonds &amp; Fixed Income</div><div class="nw-section-sub" id="nw-sub-bonds_fd">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-bonds_fd" style="color:#F59E0B;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-bonds_fd">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-bonds_fd">
      <button class="nw-section-add" onclick="openNWSheet('bonds_fd')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-metals">
    <div class="nw-section-header" onclick="toggleNWSection('metals')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#FFF8E1;">🥇</div>
        <div><div class="nw-section-name">Precious Metals</div><div class="nw-section-sub" id="nw-sub-metals">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-metals" style="color:#C8900A;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-metals">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-metals">
      <button class="nw-section-add" onclick="openNWSheet('metals')" style="margin-top:8px;">+ Add Entry</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-realestate">
    <div class="nw-section-header" onclick="toggleNWSection('realestate')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#E8F9EF;">🏡</div>
        <div><div class="nw-section-name">Real Estate</div><div class="nw-section-sub" id="nw-sub-realestate">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-realestate" style="color:#F97316;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-realestate">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-realestate">
      <button class="nw-section-add" onclick="openNWSheet('realestate')" style="margin-top:8px;">+ Add Property</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-cash">
    <div class="nw-section-header" onclick="toggleNWSection('cash')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#F0FFF0;">💴</div>
        <div><div class="nw-section-name">Cash &amp; Wallet</div><div class="nw-section-sub" id="nw-sub-cash">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-cash" style="color:#84CC16;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-cash">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-cash">
      <button class="nw-section-add" onclick="openNWSheet('cash')" style="margin-top:8px;">+ Add Account</button>
    </div>
  </div>

  <!-- ── CUSTOM ASSET TYPES (dynamically injected) ── -->
  <div id="nw-custom-sections-assets"></div>

  <!-- ── LIABILITIES ── -->
  <div class="nw-group-header" style="margin-top:8px;">
    <div class="nw-group-label">📉 Liabilities</div>
    <div class="nw-group-total" id="nw-liab-total" style="color:#EF4444;"></div>
  </div>

  <div class="nw-section" id="nw-sec-credit_card">
    <div class="nw-section-header" onclick="toggleNWSection('credit_card')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#FFF0F0;">💳</div>
        <div><div class="nw-section-name">Credit Cards</div><div class="nw-section-sub" id="nw-sub-credit_card">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-credit_card" style="color:#EF4444;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-credit_card">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-credit_card">
      <button class="nw-section-add" onclick="openNWSheet('credit_card')" style="margin-top:8px;">+ Add Card</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-loan">
    <div class="nw-section-header" onclick="toggleNWSection('loan')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#FFF4EE;">🏠</div>
        <div><div class="nw-section-name">Loans / Mortgage</div><div class="nw-section-sub" id="nw-sub-loan">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-loan" style="color:#F97316;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-loan">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-loan">
      <button class="nw-section-add" onclick="openNWSheet('loan')" style="margin-top:8px;">+ Add Loan</button>
    </div>
  </div>

  <div class="nw-section" id="nw-sec-other_liability">
    <div class="nw-section-header" onclick="toggleNWSection('other_liability')">
      <div class="nw-section-left">
        <div class="nw-section-icon" style="background:#F5F0FF;">📉</div>
        <div><div class="nw-section-name">Other Liabilities</div><div class="nw-section-sub" id="nw-sub-other_liability">—</div></div>
      </div>
      <div class="nw-section-right">
        <div class="nw-section-val" id="nw-val-other_liability" style="color:#8B5CF6;">$0</div>
        <span class="nw-section-chevron" id="nw-chev-other_liability">▼</span>
      </div>
    </div>
    <div class="nw-section-body" id="nw-body-other_liability">
      <button class="nw-section-add" onclick="openNWSheet('other_liability')" style="margin-top:8px;">+ Add Liability</button>
    </div>
  </div>

  <!-- ── CUSTOM LIABILITY TYPES (dynamically injected) ── -->
  <div id="nw-custom-sections-liab"></div>

<!-- ══ NW Account Sheet ══ -->
<div class="nw-sheet-overlay" id="nw-sheet-overlay" onclick="closeNWSheet()"></div>
<div class="nw-sheet" id="nw-sheet">
  <div class="nw-sheet-handle"></div>

  <!-- Phase 1: Type picker -->
  <div id="nws-phase-pick">
    <div class="nw-sheet-title">+ Add Account</div>
    <div class="nws-section-label">Account Type</div>
    <div class="nws-type-grid" id="nws-type-grid"></div>
  </div>

  <!-- Phase 2: Form (hidden until type chosen) -->
  <div id="nws-phase-form" style="display:none;">
    <!-- Selected type banner -->
    <div class="nws-selected-banner" id="nws-banner">
      <div class="nws-selected-left">
        <span class="nws-selected-icon" id="nws-banner-icon"></span>
        <span class="nws-selected-name" id="nws-banner-name"></span>
      </div>
      <span class="nws-type-badge" id="nws-banner-badge"></span>
    </div>

    <!-- Dynamic form fields -->
    <div id="nw-sheet-body"></div>

    <!-- Save + Cancel -->
    <button class="nw-sheet-save" onclick="saveNWAccount()" style="background:var(--yellow);border:none;border-radius:14px;padding:16px;width:100%;font-family:Nunito,sans-serif;font-weight:900;font-size:1em;cursor:pointer;margin-top:8px;">
      ✅ Save
    </button>
    <button onclick="closeNWSheet()" style="width:100%;background:none;border:none;font-family:Nunito,sans-serif;font-weight:800;font-size:0.88em;color:var(--text-light);cursor:pointer;padding:12px;margin-top:4px;">
      Cancel
    </button>
  </div>
</div>

</div><!-- /screen-networth -->

<!-- ══════════════ IMPORT HUB ══════════════ -->
<div class="screen" id="screen-import">
  <div style="margin-bottom:8px;">
    <div style="font-size:1.1em;font-weight:900;color:var(--text-dark);">📥 Import Hub</div>
    <div style="font-size:0.78em;color:var(--text-light);font-weight:600;margin-top:2px;">Bring your Excel history into MoneyFlow</div>
  </div>

  <!-- Tabs -->
  <div class="import-tabs">
    <button class="import-tab active" onclick="setImportTab('transactions',this)">💸 Transactions</button>
    <button class="import-tab" onclick="setImportTab('given',this)">🤝 Given to Others</button>
    <button class="import-tab" onclick="setImportTab('metals',this)">🥇 Metals</button>
    <button class="import-tab" onclick="setImportTab('realestate',this)">🏡 Real Estate</button>
    <button class="import-tab" onclick="setImportTab('reset',this)">🗑️ Reset</button>
  </div>

  <!-- ── TRANSACTIONS ── -->
  <div class="import-section active" id="isec-transactions">
    <!-- Step 1: Upload -->
    <div class="import-step active" id="itx-step1">
      <div class="import-card">
        <div class="import-card-title">Step 1 — Upload Your Excel</div>
        <div class="import-card-sub">Supports Expenses, Income, and Investments sheets. Upload one file at a time. Expected columns: Date, Category, Amount, and optionally Description/Store/Month.</div>
        <div class="import-drop-zone" id="itx-dropzone" onclick="document.getElementById('itx-file').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleImportDrop(event,'transactions')">
          <div class="import-drop-icon">📂</div>
          <div class="import-drop-text">Tap to choose file</div>
          <div class="import-drop-sub">Excel (.xlsx) or CSV — Expenses, Income, or Investments</div>
        </div>
        <input type="file" id="itx-file" accept=".xlsx,.csv" style="display:none;" onchange="handleImportFile(this,'transactions')">
        <!-- Type selector -->
        <div style="font-size:0.78em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">This file contains:</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:700;font-size:0.85em;"><input type="radio" name="itx-type" value="expense" checked> 💸 Expenses</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:700;font-size:0.85em;"><input type="radio" name="itx-type" value="income"> 💵 Income</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:700;font-size:0.85em;"><input type="radio" name="itx-type" value="investment"> 📈 Investments</label>
        </div>
      </div>
    </div>

    <!-- Step 2: Map columns -->
    <div class="import-step" id="itx-step2">
      <div class="import-card">
        <div class="import-card-title">Step 2 — Map Columns</div>
        <div class="import-card-sub" id="itx-map-sub">Match your Excel columns to the right fields.</div>
        <div class="import-col-map" id="itx-col-map"></div>
        <!-- Preview -->
        <div style="font-size:0.78em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">Preview (first 5 rows)</div>
        <div style="overflow-x:auto;"><table class="import-preview-table" id="itx-preview-table"></table></div>
        <div style="display:flex;gap:8px;">
          <button class="import-btn secondary" onclick="resetImportStep('transactions')">← Back</button>
          <button class="import-btn" onclick="goToImportStep('transactions','step3')">Review Categories →</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Category review -->
    <div class="import-step" id="itx-step3">
      <div class="import-card">
        <div class="import-card-title">Step 3 — Review Categories</div>
        <div class="import-card-sub">We found possible duplicates or inconsistencies. Review each and choose to merge or keep separate.</div>
        <div id="itx-cat-review"></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="import-btn secondary" onclick="goToImportStep('transactions','step2')">← Back</button>
          <button class="import-btn" onclick="goToImportStep('transactions','step4')">Preview Import →</button>
        </div>
      </div>
    </div>

    <!-- Step 4: Final preview + confirm -->
    <div class="import-step" id="itx-step4">
      <div class="import-card">
        <div class="import-card-title">Step 4 — Confirm Import</div>
        <div class="import-summary-grid" id="itx-summary-grid"></div>
        <div style="overflow-x:auto;max-height:300px;overflow-y:auto;"><table class="import-preview-table" id="itx-final-table"></table></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="import-btn secondary" onclick="goToImportStep('transactions','step3')">← Back</button>
          <button class="import-btn" onclick="confirmImport('transactions')" style="background:#10B981;color:white;">✅ Import Now</button>
        </div>
      </div>
    </div>

    <!-- Step 5: Done -->
    <div class="import-step" id="itx-step5">
      <div class="import-card" style="text-align:center;padding:32px 20px;">
        <div style="font-size:3em;margin-bottom:12px;">🎉</div>
        <div style="font-weight:900;font-size:1.1em;color:var(--text-dark);margin-bottom:6px;" id="itx-done-title">Import Complete!</div>
        <div style="font-size:0.85em;color:var(--text-light);font-weight:600;margin-bottom:20px;" id="itx-done-sub"></div>
        <button class="import-btn" onclick="resetImportStep('transactions')">Import Another File</button>
      </div>
    </div>
  </div>

  <!-- ── GIVEN TO OTHERS ── -->
  <div class="import-section" id="isec-given">
    <!-- Step 1: Upload -->
    <div class="import-step active" id="igiv-step1">
      <div class="import-card">
        <div class="import-card-title">🤝 Given to Others — Upload</div>
        <div class="import-card-sub">Expected columns: Date, Category (person name), Amount, Description.</div>
        <div class="import-drop-zone" onclick="document.getElementById('igiven-file').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleImportDrop(event,'given')">
          <div class="import-drop-icon">🤝</div>
          <div class="import-drop-text">Tap to choose file</div>
          <div class="import-drop-sub">Excel (.xlsx) or CSV</div>
        </div>
        <input type="file" id="igiven-file" accept=".xlsx,.csv" style="display:none;" onchange="handleImportFile(this,'given')">
      </div>
    </div>
    <!-- Step 2: Preview & Confirm -->
    <div class="import-step" id="igiv-step2">
      <div class="import-card">
        <div class="import-card-title">🤝 Preview & Confirm</div>
        <div id="igiven-preview-table-wrap" style="overflow-x:auto;margin-bottom:12px;"></div>
        <div id="igiven-summary" style="margin-bottom:12px;"></div>
        <div style="display:flex;gap:8px;">
          <button class="import-btn secondary" onclick="resetGivenImport()">← Back</button>
          <button class="import-btn" onclick="confirmGivenImport()" style="background:#10B981;color:white;">✅ Confirm Import</button>
        </div>
      </div>
    </div>
    <!-- Step 3: Done -->
    <div class="import-step" id="igiv-step3">
      <div class="import-card" style="text-align:center;padding:32px 20px;">
        <div style="font-size:3em;margin-bottom:12px;">🎉</div>
        <div style="font-weight:900;font-size:1.1em;color:var(--text-dark);margin-bottom:6px;" id="igiv-done-title">Imported!</div>
        <div style="font-size:0.85em;color:var(--text-light);font-weight:600;margin-bottom:20px;" id="igiv-done-sub"></div>
        <button class="import-btn" onclick="resetGivenImport()">Import Another File</button>
      </div>
    </div>

    <!-- Ledger view (always visible) -->
    <div class="import-card" id="given-ledger-card">
      <div class="import-card-title">Outstanding Balances</div>
      <div id="given-ledger-list"></div>
    </div>
  </div>

  <!-- ── METALS ── -->
  <div class="import-section" id="isec-metals">
    <!-- Step 1: Upload -->
    <div class="import-step active" id="imet-step1">
      <div class="import-card">
        <div class="import-card-title">🥇 Precious Metals — Upload</div>
        <div class="import-card-sub">Upload your metals file. Expected columns: Metal/Type, Purity, Occasion, Item/Name, Weight (grams or oz), Date.</div>
        <div class="import-drop-zone" onclick="document.getElementById('imetals-file').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleImportDrop(event,'metals')">
          <div class="import-drop-icon">🥇</div>
          <div class="import-drop-text">Tap to choose file</div>
          <div class="import-drop-sub">Excel (.xlsx) or CSV</div>
        </div>
        <input type="file" id="imetals-file" accept=".xlsx,.csv" style="display:none;" onchange="handleImportFile(this,'metals')">
      </div>
    </div>
    <!-- Step 2: Preview & Confirm -->
    <div class="import-step" id="imet-step2">
      <div class="import-card">
        <div class="import-card-title">🥇 Preview & Confirm</div>
        <div id="imetals-preview-table-wrap" style="overflow-x:auto;margin-bottom:12px;"></div>
        <div id="imetals-summary" style="margin-bottom:12px;"></div>
        <div style="display:flex;gap:8px;">
          <button class="import-btn secondary" onclick="resetMetalsImport()">← Back</button>
          <button class="import-btn" onclick="confirmMetalsImport()" style="background:#10B981;color:white;">✅ Confirm Import</button>
        </div>
      </div>
    </div>
    <!-- Step 3: Done -->
    <div class="import-step" id="imet-step3">
      <div class="import-card" style="text-align:center;padding:32px 20px;">
        <div style="font-size:3em;margin-bottom:12px;">🎉</div>
        <div style="font-weight:900;font-size:1.1em;color:var(--text-dark);margin-bottom:6px;" id="imet-done-title">Metals Imported!</div>
        <div style="font-size:0.85em;color:var(--text-light);font-weight:600;margin-bottom:20px;" id="imet-done-sub"></div>
        <button class="import-btn" onclick="resetMetalsImport()">Import Another File</button>
      </div>
    </div>
  </div>

  <!-- ── REAL ESTATE ── -->
  <div class="import-section" id="isec-realestate">
    <!-- Step 1: Upload -->
    <div class="import-step active" id="ire-step1">
      <div class="import-card">
        <div class="import-card-title">🏡 Real Estate — Upload</div>
        <div class="import-card-sub">Expected columns: Date, Country, Currency, Purchase Value, Description, Area, Current Value.</div>
        <div class="import-drop-zone" onclick="document.getElementById('ire-file').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleImportDrop(event,'realestate')">
          <div class="import-drop-icon">🏡</div>
          <div class="import-drop-text">Tap to choose file</div>
          <div class="import-drop-sub">Excel (.xlsx) or CSV</div>
        </div>
        <input type="file" id="ire-file" accept=".xlsx,.csv" style="display:none;" onchange="handleImportFile(this,'realestate')">
      </div>
    </div>
    <!-- Step 2: Preview & Confirm -->
    <div class="import-step" id="ire-step2">
      <div class="import-card">
        <div class="import-card-title">🏡 Preview & Confirm</div>
        <div id="ire-preview-table-wrap" style="overflow-x:auto;margin-bottom:12px;"></div>
        <div id="ire-summary" style="margin-bottom:12px;"></div>
        <div style="display:flex;gap:8px;">
          <button class="import-btn secondary" onclick="resetREImport()">← Back</button>
          <button class="import-btn" onclick="confirmREImport()" style="background:#10B981;color:white;">✅ Confirm Import</button>
        </div>
      </div>
    </div>
    <!-- Step 3: Done -->
    <div class="import-step" id="ire-step3">
      <div class="import-card" style="text-align:center;padding:32px 20px;">
        <div style="font-size:3em;margin-bottom:12px;">🎉</div>
        <div style="font-weight:900;font-size:1.1em;color:var(--text-dark);margin-bottom:6px;" id="ire-done-title">Properties Imported!</div>
        <div style="font-size:0.85em;color:var(--text-light);font-weight:600;margin-bottom:20px;" id="ire-done-sub"></div>
        <button class="import-btn" onclick="resetREImport()">Import Another File</button>
      </div>
    </div>
  </div>

  <!-- ── RESET ── -->
  <div class="import-section" id="isec-reset">

    <!-- Delete by month -->
    <div class="import-card">
      <div class="import-card-title">📅 Delete Month Data</div>
      <div class="import-card-sub">Remove all transactions for a specific month. Useful for clearing test data or a bad import — without wiping everything.</div>
      <div id="months-list" style="margin-top:4px;"></div>
    </div>

    <!-- What's stored summary -->
    <div class="import-card">
      <div class="import-card-title">📊 What's Currently Stored</div>
      <div id="reset-data-summary"></div>
    </div>

    <!-- Clear individual datasets -->
    <div class="import-card">
      <div class="import-card-title">🧹 Clear Specific Data</div>
      <div class="import-card-sub">Remove only one type of imported data — your transactions stay safe.</div>
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#F8F8F8;border-radius:12px;">
          <div>
            <div style="font-weight:800;font-size:0.88em;">🥇 Metals Holdings</div>
            <div style="font-size:0.75em;color:var(--text-light);font-weight:600;" id="reset-metals-count">—</div>
          </div>
          <button onclick="clearDataset('metals')" style="background:#FFF0F0;border:none;border-radius:9px;padding:7px 14px;font-weight:800;font-size:0.78em;color:var(--expenses);cursor:pointer;flex-shrink:0;">Clear All</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#F8F8F8;border-radius:12px;">
          <div>
            <div style="font-weight:800;font-size:0.88em;">🤝 Given to Others</div>
            <div style="font-size:0.75em;color:var(--text-light);font-weight:600;" id="reset-given-count">—</div>
          </div>
          <button onclick="clearDataset('given')" style="background:#FFF0F0;border:none;border-radius:9px;padding:7px 14px;font-weight:800;font-size:0.78em;color:var(--expenses);cursor:pointer;flex-shrink:0;">Clear All</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#F8F8F8;border-radius:12px;">
          <div>
            <div style="font-weight:800;font-size:0.88em;">🏡 Real Estate Assets</div>
            <div style="font-size:0.75em;color:var(--text-light);font-weight:600;" id="reset-re-count">—</div>
          </div>
          <button onclick="clearDataset('realestate')" style="background:#FFF0F0;border:none;border-radius:9px;padding:7px 14px;font-weight:800;font-size:0.78em;color:var(--expenses);cursor:pointer;flex-shrink:0;">Clear All</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#F8F8F8;border-radius:12px;">
          <div>
            <div style="font-weight:800;font-size:0.88em;">💎 Net Worth Accounts</div>
            <div style="font-size:0.75em;color:var(--text-light);font-weight:600;" id="reset-nw-count">—</div>
          </div>
          <button onclick="clearDataset('networth')" style="background:#FFF0F0;border:none;border-radius:9px;padding:7px 14px;font-weight:800;font-size:0.78em;color:var(--expenses);cursor:pointer;flex-shrink:0;">Clear All</button>
        </div>
      </div>
    </div>

    <!-- Nuclear option -->
    <div class="import-card" style="border:1.5px solid #FFDDDD;">
      <div class="import-card-title" style="color:var(--expenses);">⚠️ Reset All Data</div>
      <div class="import-card-sub">Permanently deletes ALL transactions, investments, metals, real estate, budgets and snapshots. Cannot be undone. Use only to start completely fresh.</div>
      <button class="import-btn danger" onclick="confirmResetAll()">🗑️ Delete Everything & Start Fresh</button>
    </div>

  </div>
</div>

<!-- EDIT BUDGET POPUP (bottom sheet) -->
<div class="edit-budget-popup" id="edit-budget-popup">
  <div class="popup-backdrop" onclick="closeEditBudgetPopup()"></div>
  <div class="edit-budget-sheet">
    <div class="ebp-handle"></div>
    <div class="ebp-title" id="ebp-title">📋 Budget Settings</div>
    <div class="ebp-emoji-row" id="ebp-emoji-row"></div>
    <div class="ebp-field">
      <label>Category Name</label>
      <input type="text" id="ebp-name" placeholder="e.g. Groceries, Pottery Class">
    </div>
    <div class="ebp-field">
      <label>Type</label>
      <select id="ebp-type">
        <option value="expense">💸 Expense Budget</option>
        <option value="savings">💰 Savings Goal</option>
      </select>
    </div>
    <div class="ebp-field">
      <label>Monthly Budget / Goal Amount ($)</label>
      <input type="number" id="ebp-amount" placeholder="0.00" step="0.01" min="0">
    </div>
    <div class="ebp-field" id="ebp-linked-cats-field">
      <label id="ebp-linked-cats-label">Linked Transaction Categories</label>
      <div id="ebp-linked-cats-hint" style="font-size:0.72em;color:var(--text-light);font-weight:600;margin-bottom:6px;"></div>
      <!-- Selected chips -->
      <div id="ebp-linked-chips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:0;"></div>
      <!-- Search input -->
      <div style="position:relative;">
        <input type="text" id="ebp-linked-search"
          placeholder="Type to search categories..."
          autocomplete="off"
          oninput="filterLinkedCatSuggestions(this.value)"
          onfocus="filterLinkedCatSuggestions(this.value)"
          style="width:100%;background:#F8F8F8;border:1.5px solid #EEE;border-radius:10px;padding:10px 12px;font-family:inherit;font-weight:700;font-size:0.88em;color:var(--text-dark);outline:none;box-sizing:border-box;">
        <!-- Suggestions dropdown -->
        <div id="ebp-linked-suggestions" style="
          display:none;position:absolute;top:100%;left:0;right:0;z-index:999;
          background:white;border:1.5px solid #EEE;border-radius:10px;
          box-shadow:0 8px 24px rgba(0,0,0,0.1);max-height:180px;overflow-y:auto;margin-top:4px;
        "></div>
      </div>
      <!-- Hidden input carries the actual comma-separated value for save logic -->
      <input type="hidden" id="ebp-linked-cats">
    </div>
    <div class="ebp-actions">
      <button class="ebp-save-btn" onclick="saveEditedBudget()">✅ Save</button>
      <button class="ebp-del-btn" id="ebp-del-btn" onclick="deleteEditedBudget()" style="display:none;">🗑️</button>
    </div>
  </div>
</div>

<!-- ══ MODALS ══ -->
<div class="modal-overlay" id="add-account-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Add Account</div>
      <button class="modal-close" onclick="closeModal('add-account-modal')">✕</button>
    </div>
    <div class="add-form">
      <div class="form-row"><span class="form-label">Name</span><input type="text" class="form-input" id="acc-name-input" placeholder="Account name"></div>
      <div class="form-row"><span class="form-label">Type</span><select class="form-select" id="acc-type-input"><option>Debit</option><option>Credit</option><option>Cash</option><option>Investment</option></select></div>
      <div class="form-row" style="border-bottom:none;"><span class="form-label">Balance</span><input type="number" class="form-input" id="acc-balance-input" placeholder="0"></div>
    </div>
    <button onclick="saveAccount()" style="width:100%;background:var(--yellow);border:none;border-radius:var(--radius-sm);padding:16px;font-family:Nunito;font-weight:900;color:var(--text-dark);cursor:pointer;margin-top:8px;">Save Account</button>
  </div>
</div>

<!-- ── Metal Price Bottom Sheet ─────────────────────────── -->
<div id="metal-price-sheet-backdrop" onclick="closeMetalPriceSheet()"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1100;opacity:0;transition:opacity 0.28s;"></div>

<div id="metal-price-sheet" style="
  display:none;
  position:fixed;
  left:0;right:0;bottom:0;
  transform:translateY(100%);
  max-height:85vh;
  background:white;
  border-radius:22px 22px 0 0;
  z-index:1101;
  box-shadow:0 -6px 32px rgba(0,0,0,0.16);
  transition:transform 0.32s cubic-bezier(0.32,0.72,0,1);
  overflow:hidden;
  flex-direction:column;
">
  <!-- Drag handle -->
  <div style="display:flex;justify-content:center;padding:12px 0 2px;flex-shrink:0;">
    <div style="width:40px;height:4px;background:#E0E0E0;border-radius:4px;"></div>
  </div>
  <!-- Header -->
  <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 20px 12px;flex-shrink:0;border-bottom:1px solid #F2F2F2;">
    <div style="font-weight:900;font-size:1em;color:var(--text-dark);" id="metal-sheet-title">⚙️ Set Gold Price</div>
    <button onclick="closeMetalPriceSheet()" style="background:#F2F2F2;border:none;border-radius:50%;width:32px;height:32px;font-size:1em;cursor:pointer;color:var(--text-med);font-weight:900;flex-shrink:0;display:flex;align-items:center;justify-content:center;">✕</button>
  </div>

  <!-- Scrollable body -->
  <div style="overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 18px 40px;flex:1;">

    <!-- Segmented unit toggle (g / oz) -->
    <div style="background:#EFEFEF;border-radius:12px;padding:3px;display:flex;gap:3px;margin-bottom:16px;">
      <button id="unit-btn-g" onclick="setMetalPriceUnit('g')"
        style="flex:1;border:none;border-radius:9px;padding:9px 0;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;cursor:pointer;background:white;color:var(--text-dark);box-shadow:0 1px 4px rgba(0,0,0,0.10);transition:all 0.15s;">
        Per gram (g)
      </button>
      <button id="unit-btn-oz" onclick="setMetalPriceUnit('oz')"
        style="flex:1;border:none;border-radius:9px;padding:9px 0;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;cursor:pointer;background:transparent;color:var(--text-med);transition:all 0.15s;">
        Per troy oz
      </button>
    </div>

    <!-- Base price input block -->
    <div style="background:#F8F8F8;border-radius:14px;padding:14px;margin-bottom:14px;">
      <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;" id="metal-price-override-label">Base price (24K pure) — ₹/g</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="position:relative;flex:1;">
          <span id="metal-price-sym-prefix" style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-weight:800;font-size:0.88em;color:#9AA0B2;pointer-events:none;"></span>
          <input type="number" id="metal-price-override-input" step="0.01" placeholder="0.00"
            style="width:100%;padding:11px 12px 11px 28px;border:1.5px solid #E0E0E0;border-radius:10px;font-size:1em;font-weight:800;font-family:Nunito,sans-serif;outline:none;box-sizing:border-box;background:white;"
            onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#E0E0E0'">
        </div>
        <button onclick="applyMetalPriceOverride()"
          style="background:var(--primary);color:white;border:none;border-radius:10px;padding:11px 20px;font-weight:900;font-size:0.9em;cursor:pointer;white-space:nowrap;flex-shrink:0;font-family:Nunito,sans-serif;">✓ Apply</button>
      </div>
      <button onclick="resetMetalPriceOverride(currentMetal)"
        style="margin-top:10px;background:transparent;color:#EF4444;border:none;font-family:Nunito,sans-serif;font-weight:800;font-size:0.75em;cursor:pointer;padding:0;">↺ Reset to live default</button>
    </div>

    <!-- Per-purity breakdown -->
    <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">💎 Price by Purity — tap Set to override</div>
    <div id="metal-purity-prices" style="background:#F8F8F8;border-radius:14px;overflow:hidden;"></div>

    <!-- Purity override inline sub-panel -->
    <div id="purity-override-inline" style="display:none;margin-top:12px;">
      <div style="background:#EEF4FF;border-radius:14px;padding:14px;">
        <div style="font-size:0.8em;font-weight:800;color:var(--text-dark);margin-bottom:10px;" id="poi-label">Set price for —</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="poi-input" step="0.01" placeholder="price/gram"
            style="flex:1;border:1.5px solid #C7D9FF;border-radius:10px;padding:10px 12px;font-size:0.9em;font-weight:700;font-family:Nunito,sans-serif;outline:none;min-width:0;background:white;"
            onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#C7D9FF'">
          <button onclick="applyPurityOverride()"
            style="background:#10B981;color:white;border:none;border-radius:10px;padding:10px 18px;font-weight:800;font-size:0.88em;cursor:pointer;flex-shrink:0;font-family:Nunito,sans-serif;">✓ Set</button>
          <button onclick="document.getElementById('purity-override-inline').style.display='none'"
            style="background:#E8E8E8;border:none;border-radius:10px;padding:10px 12px;font-weight:800;font-size:0.88em;cursor:pointer;color:var(--text-med);flex-shrink:0;font-family:Nunito,sans-serif;">✕</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RECURRING DELETE CHOICE MODAL -->
<div class="modal-overlay" id="rec-delete-modal" style="display:none;" onclick="if(event.target===this)closeRecDeleteModal()">
  <div class="modal" style="max-width:340px;">
    <div class="modal-header">
      <div class="modal-title">🗑 Delete Rule</div>
      <button class="modal-close" onclick="closeRecDeleteModal()">✕</button>
    </div>
    <div id="rec-delete-body" style="padding:0 4px 4px;"></div>
  </div>
</div>

<!-- RECURRING RULE POPUP — triggered by long press on transaction -->
<div class="modal-overlay" id="recurring-popup-modal" style="display:none;" onclick="if(event.target===this)closeRecurringPopup()">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">🔁 Make Recurring</div>
      <button class="modal-close" onclick="closeRecurringPopup()">✕</button>
    </div>
    <div id="recurring-popup-body" style="padding:0 4px 4px;"></div>
  </div>
</div>

<!-- QUICK ADD POPUP (for home screen category icons) -->
<div class="modal-overlay" id="quick-add-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="qa-modal-title">➕ Quick Add</div>
      <button class="modal-close" onclick="closeModal('quick-add-modal')">✕</button>
    </div>
    <!-- Type selector -->
    <div class="qa-type-row" id="qa-type-row">
      <div class="qa-type-chip active" onclick="qaSetType('expense',this)">💸 Expense</div>
      <div class="qa-type-chip" onclick="qaSetType('income',this)">💵 Income</div>
      <div class="qa-type-chip" onclick="qaSetType('investment',this)">📈 Investment</div>
      <div class="qa-type-chip" onclick="qaSetType('debt',this)">📉 Debt</div>
      <div class="qa-type-chip" onclick="qaSetType('given',this)">🤝 Given</div>
      <div class="qa-type-chip" onclick="qaSetType('additional',this)">🎁 Additional</div>
    </div>
    <!-- Refund toggle — shown only for Expense type -->
    <div id="qa-refund-wrap" style="display:none;margin-bottom:10px;">
      <button id="qa-refund-toggle" onclick="qaToggleRefund()" style="
        display:inline-flex;align-items:center;gap:6px;
        background:#FFF0F0;border:1.5px solid #EF444440;border-radius:20px;
        padding:7px 16px;font-family:Nunito,sans-serif;font-weight:800;
        font-size:0.82em;color:#EF4444;cursor:pointer;width:100%;justify-content:center;
      ">↩️ Mark as Refund / Return</button>
    </div>
    <!-- Amount display -->
    <div class="qa-amount-row">
      <span class="qa-currency-sym">$</span>
      <input type="text" class="qa-amount-input" id="qa-amount-display" value="0" readonly>
    </div>
    <!-- Sub-category pills -->
    <div class="qa-sub-cats" id="qa-sub-cats"></div>
    <!-- Fields -->
    <div class="qa-fields-row">
      <div class="qa-field">
        <label>Date</label>
        <input type="date" id="qa-date-input">
      </div>
      <div class="qa-field">
        <label>Note</label>
        <input type="text" id="qa-note-input" placeholder="Optional note...">
      </div>
    </div>
    <!-- Metal extra fields — only shown when investment category is a metal -->
    <div id="qa-metal-fields" style="display:none;">
      <div style="background:linear-gradient(135deg,#FFF8E1,#FFF3C4);border-radius:14px;padding:12px 14px;margin:0 0 10px;">
        <div style="font-size:0.72em;font-weight:900;color:#A07800;text-transform:uppercase;letter-spacing:0.4px;margin-bottom:10px;">🥇 Metal Purchase Details</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
          <div>
            <div style="font-size:0.68em;font-weight:800;color:var(--text-light);margin-bottom:4px;">WEIGHT</div>
            <input type="number" id="qa-metal-grams" placeholder="1.0" step="0.001" min="0"
              style="width:100%;background:var(--white);border:1.5px solid #E8E8E8;border-radius:9px;padding:8px 10px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.9em;outline:none;">
          </div>
          <div>
            <div style="font-size:0.68em;font-weight:800;color:var(--text-light);margin-bottom:4px;">UNIT</div>
            <select id="qa-metal-unit" style="width:100%;background:var(--white);border:1.5px solid #E8E8E8;border-radius:9px;padding:8px 6px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.9em;outline:none;">
              <option value="g">grams</option>
              <option value="oz">oz</option>
            </select>
          </div>
          <div>
            <div style="font-size:0.68em;font-weight:800;color:var(--text-light);margin-bottom:4px;">TYPE</div>
            <select id="qa-metal-type" style="width:100%;background:var(--white);border:1.5px solid #E8E8E8;border-radius:9px;padding:8px 6px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.9em;outline:none;">
              <option value="gold">Gold</option>
              <option value="silver">Silver</option>
              <option value="platinum">Platinum</option>
            </select>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div style="font-size:0.68em;font-weight:800;color:var(--text-light);margin-bottom:4px;">PURITY</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <input type="text" id="qa-metal-purity" placeholder="e.g. 22K, 24K, 999" 
              style="flex:1;background:var(--white);border:1.5px solid #E8E8E8;border-radius:9px;padding:8px 10px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.9em;outline:none;">
            <button onclick="document.getElementById('qa-metal-purity').value='24K'" style="background:white;border:1.5px solid #E8E8E8;border-radius:8px;padding:5px 8px;font-size:0.72em;font-weight:800;color:var(--text-dark);cursor:pointer;">24K</button>
            <button onclick="document.getElementById('qa-metal-purity').value='22K'" style="background:white;border:1.5px solid #E8E8E8;border-radius:8px;padding:5px 8px;font-size:0.72em;font-weight:800;color:var(--text-dark);cursor:pointer;">22K</button>
            <button onclick="document.getElementById('qa-metal-purity').value='18K'" style="background:white;border:1.5px solid #E8E8E8;border-radius:8px;padding:5px 8px;font-size:0.72em;font-weight:800;color:var(--text-dark);cursor:pointer;">18K</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Recurring toggle — only shown in edit mode, sits above numpad -->
    <div id="qa-recurring-wrap" style="display:none;margin-bottom:8px;">
      <div style="background:#F0F4FF;border-radius:12px;padding:10px 14px;">
        <label style="font-weight:900;font-size:0.85em;color:#1E2A6E;cursor:pointer;display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="qa-recurring-check" onchange="qaToggleRecurring()"
            style="width:16px;height:16px;accent-color:#1E2A6E;cursor:pointer;">
          🔁 Make this Recurring
        </label>
        <div id="qa-recurring-options" style="display:none;margin-top:10px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select id="qa-rec-frequency" style="flex:1;background:var(--white);border:1.5px solid #DDD;border-radius:8px;padding:6px 8px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.82em;">
              <option value="monthly">Monthly</option>
              <option value="biweekly">Bi-weekly (every 2 weeks)</option>
              <option value="weekly">Weekly</option>
              <option value="yearly">Yearly</option>
            </select>
            <div style="flex:1;display:flex;align-items:center;gap:6px;">
              <span style="font-size:0.78em;font-weight:800;color:var(--text-med);white-space:nowrap;">on day</span>
              <input type="number" id="qa-rec-day" min="1" max="31" placeholder="1"
                style="width:60px;background:var(--white);border:1.5px solid #DDD;border-radius:8px;padding:6px 8px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.82em;">
            </div>
          </div>
          <div style="font-size:0.72em;color:var(--text-light);font-weight:600;margin-top:6px;">
            Auto-posts every month on this day starting next month
          </div>
        </div>
      </div>
    </div>

    <!-- Numpad -->
    <div class="qa-numpad" id="qa-numpad"></div>
  </div>
</div>

<!-- ══ INVESTMENT QUICK-ADD MODAL ══ -->
<div class="modal-overlay" id="inv-quick-modal">
  <div class="modal" style="max-height:90vh;overflow-y:auto;">
    <div class="modal-header">
      <div class="modal-title" id="inv-modal-title">📈 Add Investment</div>
      <button class="modal-close" onclick="closeModal('inv-quick-modal')">✕</button>
    </div>
    <!-- Type tabs -->
    <div class="inv-type-tabs" id="inv-type-tabs">
      <button class="inv-type-chip active" style="background:#4A9EFF;color:white;" onclick="setInvModalType('Stocks','Stocks',this,'#4A9EFF')">📊 Stocks</button>
      <button class="inv-type-chip" onclick="setInvModalType('Crypto','Crypto',this,'#F59E0B')">🪙 Crypto</button>
      <button class="inv-type-chip" onclick="setInvModalType('Metals','Metals',this,'#C8900A')">🥇 Metals</button>
      <button class="inv-type-chip" onclick="setInvModalType('Real Estate','Real Estate',this,'#10B981')">🏡 Real Estate</button>
      <button class="inv-type-chip" onclick="setInvModalType('ETF/MF','ETF/MF',this,'#7C3AED')">🗂 ETF / MF</button>
    </div>
    <!-- Dynamic fields -->
    <div id="inv-modal-fields"></div>
    <!-- Auto-computed total -->
    <div class="inv-total-pill" id="inv-total-pill" style="display:none;">
      <span class="inv-total-pill-label" id="inv-total-pill-label">💰 Computed Total Value</span>
      <span class="inv-total-pill-val" id="inv-computed-total">$0</span>
    </div>
    <!-- Date + Currency row -->
    <div class="inv-fields-grid" style="margin-bottom:14px;">
      <div class="inv-field-box">
        <label>📅 Date</label>
        <input type="date" class="inv-field-input" id="inv-modal-date">
      </div>
      <div class="inv-field-box">
        <label>🌍 Currency</label>
        <button onclick="openCurrencyPicker('inv')" class="inv-field-input" style="text-align:left;cursor:pointer;display:flex;align-items:center;gap:6px;" id="inv-curr-btn">
          <span id="inv-curr-flag">🇺🇸</span><span id="inv-curr-label">USD — $</span>
        </button>
      </div>
    </div>
    <!-- Note -->
    <div class="inv-field-box full" style="margin-bottom:16px;">
      <label>📝 Notes</label>
      <input type="text" class="inv-field-input" id="inv-modal-note" placeholder="Optional notes...">
    </div>
    <button class="inv-save-btn" onclick="saveInvEntry()">✅ Save Investment</button>
  </div>
</div>

<!-- ══ CURRENCY PICKER MODAL ══ -->
<div class="modal-overlay" id="currency-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">🌍 Select Currency</div>
      <button class="modal-close" onclick="closeModal('currency-modal')">✕</button>
    </div>
    <input type="text" class="curr-search" id="curr-search-input" placeholder="Search country or currency..." oninput="filterCurrencies(this.value)">
    <div class="curr-list" id="curr-list"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Sync status bar -->
<div id="sync-status-bar" style="
  display:none;position:fixed;top:0;left:0;right:0;z-index:200;
  padding:4px 16px;font-size:0.72em;font-weight:700;
  text-align:center;transition:all 0.3s;
" id="sync-bar"></div>

<datalist id="catlist"></datalist>

<script>
// ══════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════
const STORAGE_KEY = 'financeData';
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
// Restore custom NW types into runtime NW_TYPES object
setTimeout(() => {
  (data._nwCustomTypes || []).forEach(c => {
    NW_TYPES[c.key] = { label: c.label, emoji: c.emoji || '🏦', color: '#6B7280', isLiab: c.isLiab || false };
  });
}, 0);
let currentAddType = 'expense';
let currentAmountStr = '';
let selectedSubCat = '';
let viewMonth = getCurrentMonthKey();
let currentPeriod = 'month';
let selectedDay = null;
let charts = {};
let currentMetal = 'gold';
let addPanelOpen = false;
let currentInvestFilter = 'All';
let txFilter = 'all';
let dataSortState = {};
let qaType = 'expense';
let qaAmountStr = '';
let qaSubCat = '';
// Edit mode state
let qaEditMode = false;
let qaEditMonthKey = null;
let qaEditType = null;
let qaEditIdx = null;
let qaPreselectType = null;
let qaPreselectSubCat = null;
let currentTheme = localStorage.getItem('mf_theme') || 'default';
// Home tab state
let homeTab = 'spending';
// Investment modal state
let invModalType = 'Stocks';
let invModalTemplate = 'Stocks';
let invCurrencyTarget = 'inv'; // which context opened currency picker
// Currency state — persisted separately for fast init
let currentCurrency = JSON.parse(localStorage.getItem('mf_currency') || 'null') || {code:'USD',symbol:'$',name:'US Dollar',flag:'🇺🇸',country:'United States'};

function saveCurrency(c) {
  currentCurrency = c;
  localStorage.setItem('mf_currency', JSON.stringify(c));
  // Persist currency preference in Firebase too
  if (window._fbUser && window._fbDb) {
    const uid = window._fbUser.uid;
    window._fbDb.collection('users').doc(uid)
      .set({ currency: c }, { merge: true })
      .catch(e => console.warn('Currency sync failed:', e));
  }
}
function sym() { return currentCurrency.symbol; }

// ── Approximate FX rates relative to USD (updated periodically by user via Settings if needed)
// Values = 1 USD → N units of that currency
const FX_USD_BASE = {
  // Rates as of Feb 2026 — override any in Settings → Currency for precision
  USD:1, EUR:0.96, GBP:0.80, INR:86.5, AED:3.67, SAR:3.75,
  CAD:1.43, AUD:1.60, JPY:151, CNY:7.28, SGD:1.35, CHF:0.91,
  MYR:4.45, HKD:7.78, NZD:1.77, KWD:0.31, QAR:3.64, OMR:0.38,
  PKR:279, BDT:110, LKR:310, NPR:133, MXN:20.4, BRL:5.85,
  ZAR:18.3, NGN:1600, KES:129, EGP:48.5, TRY:36.5, RUB:91,
  SEK:10.8, NOK:11.1, DKK:7.15, IDR:16200, PHP:58.5, THB:34,
  VND:25400, KRW:1450,
};

// Convert an amount from entryCurrency to displayCurrency
function convertAmt(amount, entryCurrencyCode) {
  if(!entryCurrencyCode || entryCurrencyCode === currentCurrency.code) return Number(amount||0);
  const overrides = data._fxOverrides || {};
  const fromRate = overrides[entryCurrencyCode] ?? FX_USD_BASE[entryCurrencyCode] ?? 1;   // 1 USD → N entry units
  const toRate   = overrides[currentCurrency.code] ?? FX_USD_BASE[currentCurrency.code] ?? 1; // 1 USD → N display units
  // amount / fromRate = USD value → * toRate = display value
  return (Number(amount||0) / fromRate) * toRate;
}

// Wrapper: format an amount respecting its stored currency

// ── Metal price currency helpers ──────────────────────────────────────────────
// Metal prices are ALWAYS stored internally as USD/gram
// Use these helpers for all metal price display and save operations
function metalPriceToDisplay(usdPerGram) {
  // Convert USD/gram → current display currency/gram
  const rate = (data._fxOverrides || {})[currentCurrency.code] ?? FX_USD_BASE[currentCurrency.code] ?? 1;
  return Number(usdPerGram || 0) * rate;
}
function metalPriceToUSD(displayPricePerGram) {
  // Convert display currency/gram → USD/gram for storage
  const rate = (data._fxOverrides || {})[currentCurrency.code] ?? FX_USD_BASE[currentCurrency.code] ?? 1;
  return Number(displayPricePerGram || 0) / (rate || 1);
}
function fmtConverted(amount, entryCurrencyCode) {
  return sym() + Math.abs(convertAmt(amount, entryCurrencyCode)).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
}
function fmtConvertedFull(amount, entryCurrencyCode) {
  return sym() + Math.abs(convertAmt(amount, entryCurrencyCode)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}

const commonCategories = [
  // 🍔 Food & Dining
  'Groceries','FastFood','Restaurant','Coffee','Breakfast','Lunch','Dinner','Snacks','Takeout','Swiggy','Zomato',
  // 🚌 Transport
  'Gas','Fuel','Uber','Ola','Auto','Transport','Metro','Bus','Parking','Toll',
  // 🏠 Housing & Utilities
  'Rent','Mortgage','Electricity','Water','Internet','WiFi','Gas Bill','Utility','Maintenance','Repair',
  // 💊 Health
  'Doctor','Medicine','Pharmacy','Dental','Hospital','Health Insurance','Gym','Lab Test',
  // 📱 Bills & Subscriptions
  'Phone','Mobile','Netflix','Spotify','Amazon Prime','Hotstar','YouTube Premium','Software',
  // 🛍️ Shopping
  'Clothing','Electronics','Cosmetics','Household','Furniture','Amazon','Flipkart',
  // 🎓 Education
  'School Fees','College','Course','Books','Tuition','Coaching',
  // ❤️ Family & Giving
  'Parents','Family','Kids','Spouse','Charity','Donation','Gift',
  // ✈️ Travel & Entertainment
  'Travel','Flight','Hotel','Vacation','Movies','Entertainment','Sports','Hobby',
  // 💼 Professional
  'Business','Office','Professional','Freelance Expense',
  // 🔄 Returns & Credits
  'Return','Refund','Credit','Reimbursement',
  // 💰 Income
  'Salary','Bonus','Freelance','Interest','Dividend','Rental Income','Side Income','Other Income',
  // 📈 Investments
  'Stocks','ETF','Mutual Fund','SIP','Crypto','Gold','Silver','NPS','PPF','EPF','VPF','FD','RD','Bonds',
  // 📋 Other
  'Insurance','EMI','Loan Payment','Tax','Miscellaneous','Other'
];
const catList = document.getElementById('catlist');
commonCategories.forEach(c => { const o = document.createElement('option'); o.value = c; catList.appendChild(o); });

// Spending categories on home (no Debt, no Investment)
const DEFAULT_SPEND_CARDS = [
  { key:'food',       label:'Food & Drink',    icon:'🍔', color:'#FF6B35', cls:'food',       subcats:['Breakfast','Lunch','Dinner','Snacks','Coffee','Groceries','FastFood'] },
  { key:'transport',  label:'Transportation',  icon:'🚌', color:'#4A9EFF', cls:'transport',  subcats:['Transport','Uber','Gas','Auto'] },
  { key:'housing',    label:'Housing',         icon:'🏠', color:'#FF8C42', cls:'housing',    subcats:['Electric','Internet','Utility','Rent','Mortgage'] },
  { key:'health',     label:'Health',          icon:'💊', color:'#4ECDC4', cls:'health',     subcats:['Health','Dental','Medicine','Doctor'] },
  { key:'shopping',   label:'Shopping',        icon:'🛍️', color:'#FF4757', cls:'shopping',   subcats:['Shopping','Clothing','Cosmetics','Electronics'] },
  { key:'groceries',  label:'Groceries',       icon:'🛒', color:'#10B981', cls:'invest',     subcats:['Groceries','Supermarket','Vegetables','Fruits'] },
  { key:'giving',     label:'Giving',          icon:'❤️', color:'#FF6B9D', cls:'giving',     subcats:['Parents','Family','Friend','Charity'] },
  { key:'other',      label:'Additional',      icon:'🎁', color:'#64B5F6', cls:'other-cat',  subcats:['Entertainment','Travel','Insurance','Other'] },
];

function getHomeSpendCards() {
  if(!data._homeSpendCards) return DEFAULT_SPEND_CARDS.map(c=>({...c,visible:true}));
  return data._homeSpendCards;
}
function saveHomeSpendCards(cards) { data._homeSpendCards=cards; save(); }

// Maintain backwards-compatible spendCatConfig
const spendCatConfig = DEFAULT_SPEND_CARDS;
const catConfig = [
  ...DEFAULT_SPEND_CARDS,
  { key:'invest', label:'Investment', icon:'📈', cls:'invest', color:'#7BDA8F' },
  { key:'debt',   label:'Debt',       icon:'📉', cls:'debt-cat', color:'#8B5CF6' },
];

const DEFAULT_CATS = {
  expense: [
    'Groceries','FastFood','Restaurant','Coffee','Breakfast','Lunch','Dinner','Snacks','Takeout',
    'Gas','Fuel','Transport','Uber','Ola','Auto','Metro','Parking','Toll',
    'Rent','Electricity','Water','Internet','Phone','Utility','Maintenance',
    'Doctor','Medicine','Pharmacy','Dental','Gym',
    'Shopping','Clothing','Electronics','Cosmetics','Household',
    'Netflix','Spotify','Amazon Prime','Hotstar','Subscription',
    'School Fees','Tuition','Books','Course',
    'Parents','Kids','Gift','Charity','Donation',
    'EMI','Insurance','Tax','Entertainment','Travel','Other'
  ],
  income: [
    'Salary','Bonus','Freelance','Side Income','Rental Income',
    'Interest','Dividend','Capital Gains',
    'Gift','Return','Refund','Reimbursement','Other'
  ],
  investment: [
    'Stocks','ETF','Mutual Fund','SIP','Index Fund',
    'NPS','PPF','EPF','VPF','401k','IRA','Pension',
    'Fixed Deposit','Recurring Deposit','Bonds',
    'Crypto','Gold','Silver','Real Estate',
    'Insurance Policy','Other'
  ],
  debt:       ['Credit Card','Personal Loan','Home Loan','Car Loan','Student Loan','Medical Debt','Other'],
  given:      ['Parents','Spouse','Kids','Sibling','Friend','Relative','Charity','Other'],
  additional: ['Entertainment','Travel','Hotel','Flight','Vacation','Sports','Hobby','Auto Service','Other']
};

function getCustomCats() {
  if (!data._customCats) data._customCats = {};
  return data._customCats;
}

function getCatsForType(type) {
  const cc = getCustomCats();
  // If user has ever customized this type, use their list; otherwise defaults
  return (cc[type] && cc[type].length > 0) ? cc[type] : (DEFAULT_CATS[type] || []);
}

const subCatsByType = new Proxy({}, {
  get(_, type) { return getCatsForType(type); }
});

// ── Category Manager state
let catMgrType = 'expense';

function showCatMgrTab(type, btn) {
  catMgrType = type;
  document.querySelectorAll('.cat-mgr-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCatPills();
}

function renderCatPills() {
  const cats = getCatsForType(catMgrType);
  const wrap = document.getElementById('cat-pills-wrap');
  if (!wrap) return;
  wrap.innerHTML = cats.map((c, i) => `
    <div class="cat-pill">
      <span>${c}</span>
      <button class="cat-pill-del" onclick="removeCustomCat(${i})" title="Remove">✕</button>
    </div>`).join('');
}

function addCustomCat() {
  const input = document.getElementById('cat-add-input');
  const name = (input.value || '').trim();
  if (!name) { showToast('Enter a category name ❌'); return; }
  const cc = getCustomCats();
  // Initialize from defaults if not yet customized
  if (!cc[catMgrType]) cc[catMgrType] = [...(DEFAULT_CATS[catMgrType] || [])];
  if (cc[catMgrType].includes(name)) { showToast('Category already exists ⚠️'); return; }
  cc[catMgrType].push(name);
  save();
  input.value = '';
  renderCatPills();
  showToast('✅ Category added!');
}

function removeCustomCat(idx) {
  const cc = getCustomCats();
  if (!cc[catMgrType]) cc[catMgrType] = [...(DEFAULT_CATS[catMgrType] || [])];
  const cat = cc[catMgrType][idx];
  if (!confirm(`Remove "${cat}" from ${catMgrType} categories?`)) return;
  cc[catMgrType].splice(idx, 1);
  save();
  renderCatPills();
  showToast('Category removed');
}

// Purity multipliers (fraction of pure metal)
const PURITY_MULT = {
  // Gold (Karat)
  '24K': 1.0, '23K': 0.9583, '22K': 0.9167, '21K': 0.875, '18K': 0.75,
  '14K': 0.5833, '10K': 0.4167, '9K': 0.375,
  // Fine / millesimal (gold, silver, platinum all use these)
  '999': 1.0, '999 FINE': 1.0, '999 Fine': 1.0,
  '995': 0.995, '990': 0.99, '975': 0.975,
  '950': 0.95, '925': 0.925, '900': 0.9, '850': 0.85, '800': 0.8,
  // Silver-specific aliases
  '999 Silver': 1.0, '925 Silver': 0.925, 'Sterling': 0.925,
  // Platinum-specific aliases
  'Pt999': 1.0, 'Pt950': 0.95, 'Pt900': 0.9, 'Pt850': 0.85,
  '950 Pt': 0.95, '900 Pt': 0.9,
};

// Normalize purity string so "22k" matches "22K", "PT950" matches "Pt950", etc.
function normalizePurity(purity) {
  if (!purity) return '';
  const s = String(purity).trim();
  // Karat: 22k → 22K
  const kMatch = s.match(/^(\d+)\s*[kK]$/);
  if (kMatch) return kMatch[1] + 'K';
  // Pt prefix: PT950, pt950, Pt950 → Pt950
  const ptMatch = s.match(/^[Pp][Tt]\s*(\d+)$/);
  if (ptMatch) return 'Pt' + ptMatch[1];
  // "950 PT" → "950 Pt"
  const ptSuffix = s.match(/^(\d+)\s*[Pp][Tt]$/);
  if (ptSuffix) return ptSuffix[1] + ' Pt';
  // Numeric only: 950 → '950'
  const numMatch = s.match(/^(\d+)$/);
  if (numMatch) return numMatch[1];
  // Try uppercase/title-case match
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function getPurityMult(purity) {
  if (!purity) return 1.0;
  const norm = normalizePurity(purity);
  // Direct match
  if (PURITY_MULT[norm] !== undefined) return PURITY_MULT[norm];
  // Case-insensitive fallback
  const upper = norm.toUpperCase();
  for (const k of Object.keys(PURITY_MULT)) {
    if (k.toUpperCase() === upper) return PURITY_MULT[k];
  }
  return null; // unknown purity
}

function getPriceForMetal(metalType, purity) {
  const overrides = data._metalPriceOverrides || {};
  const baseKey = metalType;
  // Check for a purity-specific override first
  const purityKey = purity ? (metalType + '|' + normalizePurity(purity)) : null;
  if (purityKey && overrides[purityKey] !== undefined) return overrides[purityKey];
  // Fall back to base (24K / Fine) price for this metal
  const base = overrides[baseKey] !== undefined ? overrides[baseKey] : (METAL_CONFIG[metalType]?.pricePerGram || 0);
  if (!purity) return base;
  const mult = getPurityMult(purity);
  return mult !== null ? base * mult : base; // unknown purity → use base (fine) price
}

const METAL_CONFIG = {
  gold:     { label:'Gold',     emoji:'🥇', pricePerGram: 96.50,  hint:'Use ✏️ Price to set your local gold price per gram. 22K = 91.7%, 18K = 75% of 24K price.' },
  silver:   { label:'Silver',   emoji:'🥈', pricePerGram: 1.03,   hint:'Use ✏️ Price to set your local silver price per gram. 925 Sterling = 92.5%, 900 = 90%.' },
  platinum: { label:'Platinum', emoji:'🔷', pricePerGram: 30.50,  hint:'Pt999 ≈ $30.50/g. Pt950 ≈ $28.98/g. Use ✏️ Edit to set current price — per-purity overrides supported.' },
};

function updateMetalPriceOverride(metalType, price, purity) {
  if (!data._metalPriceOverrides) data._metalPriceOverrides = {};
  const key = purity ? (metalType + '|' + normalizePurity(purity)) : metalType;
  const p = parseFloat(price);
  if (!p || p <= 0) { delete data._metalPriceOverrides[key]; }
  else { data._metalPriceOverrides[key] = p; }
  save();
  renderMetals();
  renderNetWorth();
  // Re-render purity prices in panel (if still open for per-purity Set buttons)
  const panel = document.getElementById('metal-price-override-panel');
  if (panel && panel.style.display !== 'none') renderPurityPrices(metalType);
  showToast('✅ Price updated — Net Worth recalculated!');
}

function resetMetalPriceOverride(metalType, purity) {
  if (!data._metalPriceOverrides) return;
  if (purity) {
    delete data._metalPriceOverrides[metalType + '|' + normalizePurity(purity)];
  } else {
    // Reset base AND all purity overrides for this metal
    const prefix = metalType + '|';
    Object.keys(data._metalPriceOverrides).forEach(k => {
      if (k === metalType || k.startsWith(prefix)) delete data._metalPriceOverrides[k];
    });
  }
  save(); renderMetals(); renderNetWorth();
  // Refresh the input in the sheet to show new default value
  const base = getMetalBasePrice(metalType);
  const baseDisp = metalPriceToDisplay(base);
  const inp = document.getElementById('metal-price-override-input');
  if (inp) inp.value = (metalPriceUnit === 'oz' ? baseDisp * 31.1035 : baseDisp).toFixed(2);
  renderPurityPrices(metalType);
  showToast('\u21BA Price reset to default');
}

function getMetalBasePrice(metalType) {
  return (data._metalPriceOverrides||{})[metalType] !== undefined
    ? (data._metalPriceOverrides||{})[metalType]
    : (METAL_CONFIG[metalType]?.pricePerGram || 0);
}

// ══════════════════════════════════════════════════════
// HELPERS
// ══════════════════════════════════════════════════════
function getCurrentMonthKey() { const n=new Date(); return `${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,'0')}`; }

// Always use local device date — never UTC (avoids IST +5:30 tomorrow bug)
function localDateStr(d) {
  const dt = d || new Date();
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}
function getMonthKey(dateStr) { if(!dateStr) return null; const dt=new Date(dateStr); if(isNaN(dt.getTime())) return null; return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; }
function getDisplayMonth(key) { if(!key) return ''; const[y,m]=key.split('-'); return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1]+' '+y; }
function getFullDisplayMonth(key) { if(!key) return ''; const[y,m]=key.split('-'); return ['January','February','March','April','May','June','July','August','September','October','November','December'][parseInt(m)-1]+' '+y; }
function normalizeDate(raw) {
  if (!raw) return todayStr();
  let str = String(raw).trim();
  // Excel serial date number
  if (typeof raw === 'number' && raw > 30000) {
    const d = Math.floor(raw - 25569);
    return parseDateSafe(new Date(d * 86400 * 1000).toISOString().split('T')[0]);
  }
  // Already YYYY-MM-DD — use as-is, no timezone conversion needed
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  return parseDateSafe(str);
}

// Safe local date parser — avoids UTC midnight shifting to previous day
function parseDateSafe(str) {
  if (!str) return todayStr();
  str = String(str).trim();
  // Already YYYY-MM-DD — return directly
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  // Try parsing — use local date parts to avoid UTC shift
  const d = new Date(str);
  if (isNaN(d.getTime())) return todayStr();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function ensureMonth(key) { if(!data[key]) data[key]={income:[],expenses:[],investments:[],additional:[],realEstate:[],metals:[],givenToOthers:[],debts:[]}; }
function save() {
  // Always keep localStorage as offline backup
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  // Sync to Firebase if logged in
  firebaseSave();
}
function fmt(n) { return sym()+Math.abs(Number(n)).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0}); }
function fmtFull(n) { return sym()+Math.abs(Number(n)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function getCurrencySymbol(currency='USD') { return {'USD':'$','INR':'₹','EUR':'€','GBP':'£','AED':'د.إ','CAD':'C$','AUD':'A$'}[(currency||'USD').toUpperCase()]||(currency||'USD')+' '; }
function getCompactNum(num) { if(!num)return'0'; if(num>=10000000)return(num/10000000).toFixed(2)+'Cr'; if(num>=100000)return(num/100000).toFixed(2)+'L'; if(num>=1000)return(num/1000).toFixed(1)+'k'; return num.toLocaleString(); }
function showToast(msg, dur=2500) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),dur); }

// ══════════════════════════════════════════════════════
// THEME SYSTEM
// ══════════════════════════════════════════════════════
function setTheme(theme) {
  // Remove all theme classes
  document.body.classList.remove('theme-looney','theme-jungle','theme-space','theme-ocean');
  if(theme !== 'default') document.body.classList.add('theme-'+theme);
  currentTheme = theme;
  localStorage.setItem('mf_theme', theme);
  // Update active badge in settings
  document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active-theme'));
  const tc = document.getElementById('theme-'+theme);
  if(tc) tc.classList.add('active-theme');
  showToast('🎨 Theme applied!');
}

function applyStoredTheme() {
  const t = localStorage.getItem('mf_theme') || 'default';
  setTheme(t);
}

// ══════════════════════════════════════════════════════
// TIME PERIOD NAVIGATION
// ══════════════════════════════════════════════════════
function setPeriod(period, btn) {
  currentPeriod = period;
  document.querySelectorAll('.period-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updatePeriodLabel();
  renderPeriodDetail();
  renderHome();
}

function changePeriod(dir) {
  if(currentPeriod === 'month') {
    const [y,m] = viewMonth.split('-').map(Number);
    const dt = new Date(y, m-1+dir, 1);
    viewMonth = `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}`;
  } else if(currentPeriod === 'year') {
    const [y,m] = viewMonth.split('-').map(Number);
    const dt = new Date(y+dir, m-1, 1);
    viewMonth = `${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}`;
  } else if(currentPeriod === 'week') {
    const d = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    d.setDate(d.getDate() + dir*7);
    selectedDay = localDateStr(d);
    viewMonth = getMonthKey(selectedDay);
  } else if(currentPeriod === 'day') {
    const d = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    d.setDate(d.getDate() + dir);
    selectedDay = localDateStr(d);
    viewMonth = getMonthKey(selectedDay);
  }
  updatePeriodLabel();
  renderPeriodDetail();
  document.getElementById('topbar-month').textContent = getDisplayMonth(viewMonth);
  renderHome();
  renderTransactions();
}

function updatePeriodLabel() {
  const lbl = document.getElementById('home-month-label');
  const topbadge = document.getElementById('topbar-month');
  if(currentPeriod === 'month') {
    lbl.textContent = getFullDisplayMonth(viewMonth);
    topbadge.textContent = getDisplayMonth(viewMonth);
  } else if(currentPeriod === 'year') {
    const [y] = viewMonth.split('-');
    lbl.textContent = 'Year ' + y;
    topbadge.textContent = y;
  } else if(currentPeriod === 'week') {
    const d = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    const start = new Date(d); start.setDate(d.getDate() - d.getDay());
    const end = new Date(start); end.setDate(start.getDate() + 6);
    const fmt2 = dt => dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    lbl.textContent = fmt2(start)+' – '+fmt2(end);
    topbadge.textContent = 'Week';
  } else if(currentPeriod === 'day') {
    const d = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    lbl.textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    topbadge.textContent = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  }
}

function renderPeriodDetail() {
  const detail = document.getElementById('period-detail');
  if(currentPeriod === 'week' || currentPeriod === 'day') {
    detail.classList.add('show');
    // Show 7 days of current week
    const anchor = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    const weekStart = new Date(anchor);
    weekStart.setDate(anchor.getDate() - anchor.getDay());
    const today = localDateStr();
    const dayNames = ['Su','Mo','Tu','We','Th','Fr','Sa'];
    detail.innerHTML = Array.from({length:7}).map((_,i) => {
      const d = new Date(weekStart); d.setDate(weekStart.getDate()+i);
      const ds = localDateStr(d);
      const isToday = ds === today;
      const isSel = ds === selectedDay;
      return `<div class="day-chip ${isToday?'today':''} ${isSel?'selected':''}" onclick="selectDay('${ds}')">
        <div class="dc-day">${dayNames[i]}</div>
        <div class="dc-num">${d.getDate()}</div>
      </div>`;
    }).join('');
  } else {
    detail.classList.remove('show');
  }
}

function selectDay(dateStr) {
  selectedDay = dateStr;
  viewMonth = getMonthKey(dateStr);
  renderPeriodDetail();
  updatePeriodLabel();
  renderHome();
}

function togglePeriodView() {
  // Clicking the badge cycles through periods
  const periods = ['month','week','day','year'];
  const next = periods[(periods.indexOf(currentPeriod)+1) % periods.length];
  const tabs = document.querySelectorAll('.period-tab');
  tabs.forEach(t => { if(t.textContent.toLowerCase() === next) setPeriod(next,t); });
}

// Get entries filtered by current period
function getPeriodEntries(monthData, type) {
  const entries = (monthData[type] || []);
  if(currentPeriod === 'month' || currentPeriod === 'year') return entries;
  if(currentPeriod === 'day') {
    const d = selectedDay || localDateStr();
    return entries.filter(e => e.date === d);
  }
  if(currentPeriod === 'week') {
    const anchor = selectedDay ? new Date(selectedDay+'T00:00:00') : new Date();
    const weekStart = new Date(anchor); weekStart.setDate(anchor.getDate()-anchor.getDay());
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
    const ws = localDateStr(weekStart);
    const we = localDateStr(weekEnd);
    return entries.filter(e => e.date >= ws && e.date <= we);
  }
  return entries;
}

function getYearEntries(type) {
  const [y] = viewMonth.split('-');
  let all = [];
  Object.keys(data).filter(k => k.startsWith(y+'-') && !k.startsWith('_')).forEach(k => {
    all = all.concat(data[k][type] || []);
  });
  return all;
}

// ══════════════════════════════════════════════════════
// HOME
// ══════════════════════════════════════════════════════
function setHomeTab(tab) {
  homeTab = tab;
  document.querySelectorAll('.home-tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('htab-'+tab).classList.add('active');
  document.querySelectorAll('.home-section').forEach(s=>s.classList.remove('active'));
  document.getElementById('hsec-'+tab).classList.add('active');
  renderHome();
}

function renderHome() {
  ensureMonth(viewMonth);
  const m = data[viewMonth];

  let expenses, income, investments, additional;
  if(currentPeriod === 'year') {
    expenses = getYearEntries('expenses');
    income = getYearEntries('income');
    investments = getYearEntries('investments');
    additional = getYearEntries('additional');
  } else {
    expenses = getPeriodEntries(m, 'expenses');
    income = getPeriodEntries(m, 'income');
    investments = getPeriodEntries(m, 'investments');
    additional = getPeriodEntries(m, 'additional');
  }

  if(homeTab === 'spending') {
    const totalExp = expenses.reduce((s,r)=>s+convertAmt(r.amount,r.currency),0);
    const totalAdd = additional.reduce((s,r)=>s+convertAmt(r.amount,r.currency),0);
    const totalInc = income.reduce((s,r)=>s+convertAmt(r.amount,r.currency),0);
    document.getElementById('home-spending').textContent = fmt(totalExp+totalAdd);
    document.getElementById('home-income').textContent = fmt(totalInc);

    const salary = income.filter(e=>['Salary','Freelance','Bonus'].includes(e.category)).reduce((s,e)=>s+convertAmt(e.amount,e.currency),0);
    const gifts  = income.filter(e=>['Gift','Gifts'].includes(e.category)).reduce((s,e)=>s+convertAmt(e.amount,e.currency),0);
    const otherInc = income.filter(e=>!['Salary','Freelance','Bonus','Gift','Gifts'].includes(e.category)).reduce((s,e)=>s+convertAmt(e.amount,e.currency),0);
    document.getElementById('home-salary').textContent = fmt(salary);
    document.getElementById('home-gifts').textContent  = fmt(gifts);
    document.getElementById('home-other-income').textContent = fmt(otherInc);

    // Dynamic home spend cards
    const cards = getHomeSpendCards().filter(c=>c.visible!==false);
    const allExp = totalExp + totalAdd;
    const catTotals = {};
    expenses.forEach(e=>{catTotals[e.category]=(catTotals[e.category]||0)+convertAmt(e.amount,e.currency);});
    additional.forEach(e=>{catTotals['Additional']=(catTotals['Additional']||0)+convertAmt(e.amount,e.currency);});

    const grid = document.getElementById('budget-grid');
    grid.innerHTML = cards.map(card=>{
      const subcats = card.subcats||[];
      // Use subcats if defined, else fall back to card.label — never add both (avoids double-count)
      const amt = subcats.length > 0
        ? subcats.reduce((s,sc)=>s+(catTotals[sc]||0),0)
        : (catTotals[card.label]||0);
      const pct = allExp>0 ? Math.min(amt/allExp*100,100) : 0;
      return `<div class="budget-card ${card.cls||'other-cat'}"
        ontouchstart="homeCardTouchStart(event,'${card.key||card.label}','expense','${subcats[0]||card.label}')"
        ontouchend="homeCardTouchEnd(event)"
        ontouchmove="homeCardTouchMove(event)"
        oncontextmenu="event.preventDefault();goToBudgetDetail('${card.key||card.label}')"
        title="Tap to add · Hold to view transactions">
        <div class="cat-icon" style="background:${card.color}22;">${card.icon}</div>
        <div class="cat-name">${card.label}</div>
        <div class="cat-amount">${fmt(amt)}</div>
        <div class="cat-bar"><div class="cat-bar-fill" style="width:${pct}%;background:${card.color};"></div></div>
      </div>`;
    }).join('');
  } else {
    renderInvestHome(investments);
  }
  renderHomeInsights(expenses, income, investments);
  renderSettings();
}

// ══════════════════════════════════════════════════════
// HOME INSIGHTS
// ══════════════════════════════════════════════════════
let insightsOpen = false;

function toggleInsights() {
  insightsOpen = !insightsOpen;
  document.getElementById('insights-body').classList.toggle('open', insightsOpen);
  document.getElementById('insights-toggle-arrow').classList.toggle('open', insightsOpen);
}

function renderHomeInsights(expenses, income, investments) {
  const kpiStrip = document.getElementById('insights-kpi-strip');
  const chipsEl  = document.getElementById('insights-chips');
  if (!kpiStrip || !chipsEl) return;

  const totalExp = expenses.reduce((s,e) => s + convertAmt(e.amount, e.currency), 0);
  const totalInc = income.reduce((s,e)   => s + convertAmt(e.amount, e.currency), 0);
  const totalInv = investments.reduce((s,e) => s + convertAmt(e.amount, e.currency), 0);
  const net = totalInc - totalExp;
  const savingsRate = totalInc > 0 ? ((totalInc - totalExp) / totalInc * 100) : 0;

  // ── KPI strip (3 always-visible numbers) ──
  const kpis = [
    { val: fmt(net),  label: net >= 0 ? 'Net Saved' : 'Net Deficit', color: net >= 0 ? 'var(--income)' : 'var(--expenses)' },
    { val: savingsRate.toFixed(0) + '%', label: 'Savings Rate', color: savingsRate >= 20 ? 'var(--income)' : savingsRate >= 10 ? '#F59E0B' : 'var(--expenses)' },
    { val: fmt(totalInv), label: 'Invested', color: '#7C3AED' },
  ];
  kpiStrip.innerHTML = `<div class="insights-kpi-row">${
    kpis.map(k => `<div class="insights-kpi">
      <div class="ikpi-val" style="color:${k.color};">${k.val}</div>
      <div class="ikpi-label">${k.label}</div>
    </div>`).join('')
  }</div>`;

  // ── Compute chips ──
  const chips = [];

  // 1. Top spending category
  const catTotals = {};
  expenses.forEach(e => { catTotals[e.category] = (catTotals[e.category]||0) + convertAmt(e.amount,e.currency); });
  const topCats = Object.entries(catTotals).sort((a,b) => b[1]-a[1]);
  if (topCats.length > 0) {
    const [topCat, topAmt] = topCats[0];
    const pct = totalExp > 0 ? (topAmt/totalExp*100).toFixed(0) : 0;
    chips.push({ type: pct > 30 ? 'warn' : 'neutral', icon: '🏆', title: `Biggest spend: ${topCat}`, sub: `${fmt(topAmt)} — ${pct}% of total spending this period` });
  }

  // 2. Savings rate verdict
  if (totalInc > 0) {
    if (savingsRate >= 20) chips.push({ type:'good',  icon:'🌟', title:'Great savings rate!', sub:`You're saving ${savingsRate.toFixed(0)}% of income — above the 20% benchmark` });
    else if (savingsRate >= 10) chips.push({ type:'warn',  icon:'💛', title:'Decent savings rate', sub:`${savingsRate.toFixed(0)}% saved — aim for 20% to build wealth faster` });
    else if (savingsRate > 0)   chips.push({ type:'alert', icon:'⚠️', title:'Low savings rate', sub:`Only ${savingsRate.toFixed(0)}% saved this period — review top spending categories` });
    else if (net < 0)           chips.push({ type:'alert', icon:'🚨', title:'Spending exceeds income', sub:`${fmt(Math.abs(net))} more spent than earned — review your budget` });
  }

  // 3. Investment discipline
  if (totalInc > 0) {
    const invRate = (totalInv / totalInc * 100);
    if (invRate >= 15) chips.push({ type:'good',   icon:'📈', title:'Strong investment habit', sub:`${invRate.toFixed(0)}% of income going to investments — excellent discipline` });
    else if (invRate > 0) chips.push({ type:'neutral', icon:'📊', title:`${invRate.toFixed(0)}% invested`, sub:`${fmt(totalInv)} invested this period — consider increasing to 15%+` });
    else chips.push({ type:'neutral', icon:'💡', title:'No investments this period', sub:'Consider allocating a portion of income to investments' });
  }

  // 4. Budget goal check — find most over-budget category
  const expGoals = getBudgetGoals('expense');
  if (expGoals.length > 0 && currentPeriod !== 'year') {
    const overBudget = expGoals.map(g => {
      const actual = getBudgetActual(g, viewMonth);
      const budget = g.currency && g.currency !== currentCurrency.code ? convertAmt(Number(g.amount||0), g.currency) : Number(g.amount || 0);
      return { name: g.name, over: actual - budget, pct: budget > 0 ? actual/budget*100 : 0 };
    }).filter(g => g.over > 0).sort((a,b) => b.pct - a.pct);
    if (overBudget.length > 0) {
      const worst = overBudget[0];
      chips.push({ type:'alert', icon:'🎯', title:`${worst.name} over budget`, sub:`${fmt(worst.over)} over limit — ${worst.pct.toFixed(0)}% of budget used` });
    } else if (expGoals.length > 0) {
      chips.push({ type:'good', icon:'✅', title:'All categories within budget', sub:'Great job staying on track this period!' });
    }
  }

  // 5. Biggest single day (month/week mode only)
  if (currentPeriod !== 'year') {
    const dayTotals = {};
    expenses.forEach(e => {
      const d = (e.date||'').substring(0,10);
      if (d) dayTotals[d] = (dayTotals[d]||0) + convertAmt(e.amount,e.currency);
    });
    const dayEntries = Object.entries(dayTotals).sort((a,b) => b[1]-a[1]);
    if (dayEntries.length > 0) {
      const [bigDay, bigAmt] = dayEntries[0];
      const d = new Date(bigDay+'T00:00:00');
      const label = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
      chips.push({ type: bigAmt > totalExp * 0.25 ? 'warn' : 'neutral', icon:'📅', title:`Biggest spend day: ${label}`, sub:`${fmt(bigAmt)} spent — ${totalExp>0?(bigAmt/totalExp*100).toFixed(0):0}% of monthly total in one day` });
    }
  }

  // 6. No-spend / low-spend encouragement
  if (totalExp === 0 && totalInc === 0) {
    chips.push({ type:'neutral', icon:'🌱', title:'No data yet for this period', sub:'Add transactions or import your Excel files from the Import tab' });
  }

  chipsEl.innerHTML = chips.map(c => `
    <div class="insight-chip ${c.type}">
      <div class="insight-chip-icon">${c.icon}</div>
      <div class="insight-chip-text">
        <div class="insight-chip-title">${c.title}</div>
        <div class="insight-chip-sub">${c.sub}</div>
      </div>
    </div>`).join('');
}
const DEFAULT_INV_CARDS = [
  // ── Visible by default — universal investment types ──
  { key:'Stocks',        label:'Stocks',           icon:'📊', color:'#4A9EFF', bg:'#EEF5FF', fieldTemplate:'Stocks',      visible:true  },
  { key:'ETF/MF',        label:'ETF / Mutual Fund',icon:'🗂',  color:'#7C3AED', bg:'#F3EEFF', fieldTemplate:'ETF/MF',      visible:true  },
  { key:'Crypto',        label:'Crypto',            icon:'🪙', color:'#F59E0B', bg:'#FFFBEE', fieldTemplate:'Crypto',      visible:true  },
  { key:'Metals',        label:'Gold & Metals',     icon:'🥇', color:'#C8900A', bg:'#FFF8E0', fieldTemplate:'Metals',      visible:true  },
  { key:'Real Estate',   label:'Real Estate',       icon:'🏡', color:'#10B981', bg:'#F0FBF3', fieldTemplate:'Real Estate', visible:true  },
  { key:'Retirement',    label:'Retirement',        icon:'🏛️', color:'#0EA5E9', bg:'#E0F2FE', fieldTemplate:'General',     visible:true  },
  // ── Hidden by default — enable in Settings → Investments ──
  { key:'Fixed Deposit', label:'Fixed Deposit',     icon:'🏦', color:'#D97706', bg:'#FFFBEB', fieldTemplate:'General',     visible:false },
  { key:'PPF/PF',        label:'PPF / PF / EPF',    icon:'📮', color:'#059669', bg:'#ECFDF5', fieldTemplate:'General',     visible:false },
  { key:'NPS',           label:'NPS / Pension',     icon:'🧓', color:'#8B5CF6', bg:'#F3EEFF', fieldTemplate:'General',     visible:false },
  { key:'Bonds',         label:'Bonds & T-Bills',   icon:'📜', color:'#64748B', bg:'#F1F5F9', fieldTemplate:'General',     visible:false },
  { key:'Insurance',     label:'Insurance Policy',  icon:'🛡️', color:'#DC2626', bg:'#FEF2F2', fieldTemplate:'General',     visible:false },
];

// INV_CATS kept as an alias for any legacy reads
const INV_CATS = DEFAULT_INV_CARDS;

// General field template for savings/contribution-style investments (PF, NPS, FD etc.)
const INV_FIELDS_GENERAL = [
  {id:'inv-scheme',   label:'Scheme / Account',  type:'text',   placeholder:'e.g. NPS Tier-1, PPF Account, 401k',  full:true},
  {id:'inv-contrib',  label:'Contribution',       type:'number', placeholder:'0.00',                  full:false, calc:true},
  {id:'inv-total-acc',label:'Total Accumulated',  type:'number', placeholder:'0.00 (optional)',        full:false},
  {id:'inv-rate',     label:'Interest / Return %',type:'number', placeholder:'e.g. 8.25',             full:false},
  {id:'inv-maturity', label:'Maturity / Target Date',type:'text',placeholder:'e.g. 2035',             full:false},
];

function getHomeInvCards() {
  if(!data._homeInvCards) return DEFAULT_INV_CARDS.map(c=>({...c}));
  return data._homeInvCards;
}
function saveHomeInvCards(cards) { data._homeInvCards = cards; save(); }

function renderInvestHome(investments) {
  // Home investment cards show ONLY monthly cash-flow transactions (what you invested this month).
  // data._metals and data._nwAccounts are Net Worth holdings — they NEVER appear here.
  let invAll = investments || [];

  const totals = {};
  invAll.forEach(inv=>{
    const type = inv.investType||inv.category||'Stocks';
    totals[type]=(totals[type]||0)+convertAmt(inv.amount, inv.currency);
  });
  // Note: data._investments (portfolio positions) also excluded from monthly total —
  // portfolio value ≠ amount invested this month.

  const grandTotal = Object.values(totals).reduce((s,v)=>s+v,0);
  document.getElementById('home-invest-total').textContent = fmt(grandTotal);

  // Use dynamic cards
  const cards = getHomeInvCards().filter(c=>c.visible!==false);
  const grid = document.getElementById('invest-cat-grid');
  grid.innerHTML = cards.map(card=>{
    const amt = totals[card.key]||0;
    const pct = grandTotal>0?Math.min(amt/grandTotal*100,100):0;
    return `<div class="invest-cat-card" style="background:${card.bg||'#F8F8F8'};user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;"
      ontouchstart="homeCardTouchStart(event,'${card.key}','investment','${card.key}')"
      ontouchend="homeCardTouchEnd(event)"
      ontouchmove="homeCardTouchMove(event)"
      oncontextmenu="event.preventDefault();goToInvestDetail('${card.key}')">
      <div class="inv-card-icon" style="background:${card.color}22;">${card.icon}</div>
      <div class="inv-card-label">${card.label||card.key}</div>
      <div class="inv-card-amt">${fmt(amt)}</div>
      <div class="inv-card-units">${amt>0?'Tap to add · Hold to view':'Tap to start tracking'}</div>
      <div class="inv-card-bar"><div class="inv-card-bar-fill" style="width:${pct}%;background:${card.color};"></div></div>
    </div>`;
  }).join('') +
  `<div style="grid-column:span 2;background:var(--white);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:14px;text-align:center;cursor:pointer;" onclick="switchScreen('networth',document.querySelector('.nav-item:nth-child(4)'))">
    <span style="font-weight:900;font-size:0.9em;color:var(--text-med);">💎 View Net Worth →</span>
  </div>`;
}

// ══════════════════════════════════════════════════════
// QUICK ADD POPUP (H requirement — popup instead of TXN page)
// ══════════════════════════════════════════════════════
function openQuickAdd(type, subCat) {
  qaType = type || 'expense';
  qaAmountStr = '';
  qaPreselectSubCat = subCat || null;

  // Set type chips
  document.querySelectorAll('.qa-type-chip').forEach(c => c.classList.remove('active'));
  const chip = [...document.querySelectorAll('.qa-type-chip')].find(c => c.textContent.toLowerCase().includes(type));
  if(chip) chip.classList.add('active');

  // Reset amount
  document.getElementById('qa-amount-display').value = '0';
  // Use local date (not UTC) to avoid timezone off-by-one for IST/+5:30 users
  const _now = new Date();
  const _localDate = `${_now.getFullYear()}-${String(_now.getMonth()+1).padStart(2,'0')}-${String(_now.getDate()).padStart(2,'0')}`;
  document.getElementById('qa-date-input').value = _localDate;
  document.getElementById('qa-note-input').value = '';
  const _mg = document.getElementById('qa-metal-grams'); if (_mg) _mg.value = '';
  const _mf = document.getElementById('qa-metal-fields'); if (_mf) _mf.style.display = 'none';

  qaRenderSubCats();
  qaRenderNumpad();

  // Set title
  const icons = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  document.getElementById('qa-modal-title').textContent = (icons[type]||'➕') + ' Quick Add ' + (type.charAt(0).toUpperCase()+type.slice(1));

  // Reset edit mode
  qaEditMode = false; qaEditMonthKey = null; qaEditType = null; qaEditIdx = null;
  const _rw = document.getElementById('qa-refund-wrap');
  const _rt = document.getElementById('qa-refund-toggle');
  // Show refund toggle immediately if opening as expense type
  if (_rw) _rw.style.display = (qaType === 'expense') ? 'block' : 'none';
  if (_rt) { _rt.classList.remove('active'); _rt.textContent = '↩️ Mark as Refund / Return'; }
  // Hide recurring in normal quick add
  const _recWrap = document.getElementById('qa-recurring-wrap');
  const _recCheck = document.getElementById('qa-recurring-check');
  const _recOpts = document.getElementById('qa-recurring-options');
  if (_recWrap) _recWrap.style.display = 'none';
  if (_recCheck) _recCheck.checked = false;
  if (_recOpts) _recOpts.style.display = 'none';
  document.getElementById('quick-add-modal').classList.add('open');
}

// ── Open Quick Add in EDIT mode pre-filled with existing transaction ───────
function openEditTx(monthKey, type, idx) {
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const tx = data[monthKey][typeMap[type]][idx];
  if (!tx) return;

  // Set edit state
  qaEditMode = true;
  qaEditMonthKey = monthKey;
  qaEditType = type;
  qaEditIdx = idx;

  // Open modal in correct type
  qaType = type;
  qaAmountStr = String(Math.abs(tx.amount || 0));
  qaPreselectSubCat = tx.category || null;

  // Set type chip
  document.querySelectorAll('.qa-type-chip').forEach(c => c.classList.remove('active'));
  const chip = [...document.querySelectorAll('.qa-type-chip')].find(c => c.textContent.toLowerCase().includes(type));
  if (chip) chip.classList.add('active');

  // Pre-fill fields
  document.getElementById('qa-amount-display').value = qaAmountStr;
  document.getElementById('qa-date-input').value = tx.date || localDateStr();
  document.getElementById('qa-note-input').value = tx.description || '';

  qaRenderSubCats();
  qaRenderNumpad();

  // Show refund toggle for expense — pre-tick if amount was negative
  const refundWrap = document.getElementById('qa-refund-wrap');
  const refundBtn = document.getElementById('qa-refund-toggle');
  if (type === 'expense') {
    if (refundWrap) refundWrap.style.display = 'block';
    if (Number(tx.amount) < 0) {
      refundBtn.classList.add('active');
      refundBtn.textContent = '↩️ Refund / Return (ON)';
    } else {
      refundBtn.classList.remove('active');
      refundBtn.textContent = '↩️ Mark as Refund / Return';
    }
  } else {
    if (refundWrap) refundWrap.style.display = 'none';
    if (refundBtn) refundBtn.classList.remove('active');
  }

  // Update title
  const icons = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  document.getElementById('qa-modal-title').textContent = (icons[type]||'✏️') + ' Edit ' + (type.charAt(0).toUpperCase()+type.slice(1));

  // Recurring is handled via long press — keep wrap hidden in edit modal
  const recWrap = document.getElementById('qa-recurring-wrap');
  if (recWrap) recWrap.style.display = 'none';

  document.getElementById('quick-add-modal').classList.add('open');
}

function qaSetType(type, el) {
  qaType = type;
  // Show refund toggle only for expense type
  const refundWrap = document.getElementById('qa-refund-wrap');
  const refundBtn  = document.getElementById('qa-refund-toggle');
  if (refundWrap) refundWrap.style.display = type === 'expense' ? 'block' : 'none';
  if (refundBtn)  { refundBtn.classList.remove('active'); refundBtn.textContent = '↩️ Mark as Refund / Return'; }
  document.querySelectorAll('.qa-type-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  qaPreselectSubCat = null;
  qaRenderSubCats();
  const icons = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  document.getElementById('qa-modal-title').textContent = (icons[type]||'➕') + ' Quick Add ' + (type.charAt(0).toUpperCase()+type.slice(1));
  _qaToggleMetalFields();
}

let qaDeleteMode = false;

function qaRenderSubCats() {
  qaDeleteMode = false;
  const cats = getCatsForType(qaType);
  if (qaPreselectSubCat) {
    // Case-insensitive match first
    const match = cats.find(c => c.toLowerCase() === qaPreselectSubCat.toLowerCase());
    if (match) {
      qaSubCat = match; // use exact casing from list
    } else {
      // Category not in list — insert it at front so it's selectable
      cats.unshift(qaPreselectSubCat);
      qaSubCat = qaPreselectSubCat;
    }
  } else {
    qaSubCat = cats[0] || '';
  }
  _renderQaPills(cats);
  _qaToggleMetalFields(); // Issue 3: auto-show metal fields if metal category preselected
}

function _renderQaPills(cats) {
  const container = document.getElementById('qa-sub-cats');
  // Regular pills
  const pillsHtml = cats.map((c,i) => {
    const isActive = c === qaSubCat;
    return `<div class="qa-sub-pill ${isActive?'active':''} ${qaDeleteMode?'delete-mode':''}"
      onclick="if(!qaDeleteMode)qaSelectSub('${c}',this)"
      oncontextmenu="event.preventDefault();qaToggleDeleteMode()"
      title="${qaDeleteMode?'tap ✕ to remove':'hold to manage'}">
      ${c}
      <button class="qa-pill-del" onclick="event.stopPropagation();qaRemoveCat(${i})">✕</button>
    </div>`;
  }).join('');
  // Add pill or done button
  const actionPill = qaDeleteMode
    ? `<div class="qa-sub-pill" style="background:#FFF0F0;color:var(--expenses);border-color:#FFCCCC;" onclick="qaToggleDeleteMode()">✔ Done</div>`
    : `<div class="qa-sub-pill" style="background:var(--yellow-light);border-color:var(--yellow);color:var(--text-dark);font-weight:900;" onclick="qaShowAddInput()">＋ Add</div>`;
  container.innerHTML = pillsHtml + actionPill;
}

function qaToggleDeleteMode() {
  qaDeleteMode = !qaDeleteMode;
  _renderQaPills(getCatsForType(qaType));
}

function qaRemoveCat(idx) {
  const cats = getCatsForType(qaType);
  const cat = cats[idx];
  if(!cat) return;
  // Initialize custom if needed
  const cc = getCustomCats();
  if(!cc[qaType]) cc[qaType] = [...(DEFAULT_CATS[qaType]||[])];
  cc[qaType].splice(idx, 1);
  if(qaSubCat === cat) qaSubCat = cc[qaType][0] || '';
  save();
  _renderQaPills(cc[qaType]);
  renderCatPills(); // sync settings view
  showToast(`"${cat}" removed`);
}

function qaShowAddInput() {
  const container = document.getElementById('qa-sub-cats');
  // Append inline input after existing pills
  const existing = container.querySelectorAll('.qa-sub-pill');
  existing.forEach(p => p.style.display = 'none');
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;gap:6px;width:100%;margin-top:4px;';
  row.innerHTML = `
    <input id="qa-new-cat-input" type="text" placeholder="Category name..."
      style="flex:1;border:1.5px solid var(--yellow);border-radius:10px;padding:7px 10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.85em;color:var(--text-dark);outline:none;"
      onkeydown="if(event.key==='Enter')qaConfirmAddCat()">
    <button onclick="qaConfirmAddCat()" style="background:var(--yellow);border:none;border-radius:10px;padding:7px 14px;font-family:Nunito,sans-serif;font-weight:900;font-size:0.85em;cursor:pointer;">Add</button>
    <button onclick="qaRenderSubCats()" style="background:#F0F0F0;border:none;border-radius:10px;padding:7px 12px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;cursor:pointer;color:var(--text-med);">Cancel</button>
  `;
  container.appendChild(row);
  setTimeout(()=>document.getElementById('qa-new-cat-input')?.focus(), 50);
}

function qaConfirmAddCat() {
  const input = document.getElementById('qa-new-cat-input');
  const name = (input?.value||'').trim();
  if(!name) { showToast('Enter a name ❌'); return; }
  const cc = getCustomCats();
  if(!cc[qaType]) cc[qaType] = [...(DEFAULT_CATS[qaType]||[])];
  if(cc[qaType].includes(name)) { showToast('Already exists ⚠️'); return; }
  cc[qaType].push(name);
  qaSubCat = name;
  save();
  qaRenderSubCats();
  renderCatPills();
  showToast(`✅ "${name}" added!`);
}

const _METAL_CATS = ['gold','silver','platinum','metals','precious'];
function _qaToggleMetalFields() {
  const el = document.getElementById('qa-metal-fields');
  if (!el) return;
  const show = qaType === 'investment' && _METAL_CATS.some(m => (qaSubCat||'').toLowerCase().includes(m));
  el.style.display = show ? 'block' : 'none';
  if (show) {
    // Auto-select metal type to match the chosen sub-category pill
    const mt = document.getElementById('qa-metal-type');
    if (mt) {
      const s = (qaSubCat||'').toLowerCase();
      mt.value = s.includes('silver') ? 'silver' : s.includes('platinum') ? 'platinum' : 'gold';
    }
  }
}

function qaSelectSub(cat, el) {
  qaSubCat = cat;
  document.querySelectorAll('.qa-sub-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  _qaToggleMetalFields();
}

function qaRenderNumpad() {
  const keys = ['1','2','3','4','5','6','7','8','9','.',  '0','⌫'];
  const cls   = ['','','','','','','','','','qa-dot','','qa-del'];
  document.getElementById('qa-numpad').innerHTML = keys.map((k,i) =>
    `<button class="qa-key ${cls[i]}" onclick="qaNumpress('${k}')">${k}</button>`
  ).join('') + `<button class="qa-key qa-save" style="grid-column:span 3;" onclick="qaSave()">✅ Save Entry</button>`;
}

function qaNumpress(key) {
  if(key === '⌫') {
    qaAmountStr = qaAmountStr.slice(0,-1);
  } else {
    if(qaAmountStr.includes('.') && key === '.') return;
    if(qaAmountStr.length >= 10) return;
    qaAmountStr += key;
  }
  document.getElementById('qa-amount-display').value = qaAmountStr || '0';
}

function qaToggleRefund() {
  const btn = document.getElementById('qa-refund-toggle');
  btn.classList.toggle('active');
  btn.textContent = btn.classList.contains('active') ? '↩️ Refund (ON)' : '↩️ Mark as Refund';
}

function qaToggleRecurring() {
  const checked = document.getElementById('qa-recurring-check')?.checked;
  const opts = document.getElementById('qa-recurring-options');
  if (opts) opts.style.display = checked ? 'block' : 'none';
}

function qaSave() {
  const amount = parseFloat(qaAmountStr);
  if(!amount || amount <= 0) { showToast('Enter an amount ❌'); return; }
  const date    = document.getElementById('qa-date-input').value || localDateStr();
  const note    = document.getElementById('qa-note-input').value.trim();
  const monthKey = getMonthKey(date) || getCurrentMonthKey();
  ensureMonth(monthKey);

  // Check refund toggle — negative amount reduces category spend
  const isRefund = document.getElementById('qa-refund-toggle').classList.contains('active');
  const finalAmt = isRefund ? -Math.abs(amount) : amount;

  // Tag who added this entry — used for family attribution filter
  const _currentUser = firebase.auth().currentUser;
  const _addedBy = _currentUser ? (_currentUser.displayName || _currentUser.email || 'You') : 'You';
  const entry = { date: normalizeDate(date), category: qaSubCat||'Other', amount: finalAmt, description: note, currency: currentCurrency.code, _addedBy };

  // If this is a metal purchase, attach grams so the transaction carries full context
  const isMetal = qaType === 'investment' && _METAL_CATS.some(m => (qaSubCat||'').toLowerCase().includes(m));
  if (isMetal) {
    const gramsEl = document.getElementById('qa-metal-grams');
    const unitEl  = document.getElementById('qa-metal-unit');
    const typeEl  = document.getElementById('qa-metal-type');
    const rawGrams = parseFloat(gramsEl?.value) || 0;
    const unit     = unitEl?.value || 'g';
    const grams    = unit === 'oz' ? rawGrams * 31.1035 : rawGrams;
    if (grams > 0) {
      entry.metalGrams = parseFloat(grams.toFixed(4));
      entry.metalType  = typeEl?.value || 'gold';
    }
  }

  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};

  if (qaEditMode && qaEditMonthKey && qaEditType !== null && qaEditIdx !== null) {
    // Edit mode — replace existing entry
    const oldMonthKey = qaEditMonthKey;
    const oldType = typeMap[qaEditType];
    // Remove old entry
    data[oldMonthKey][oldType].splice(qaEditIdx, 1);
    // Add updated entry (in new month if date changed)
    ensureMonth(monthKey);
    data[monthKey][typeMap[qaType]].push(entry);
    qaEditMode = false; qaEditMonthKey = null; qaEditType = null; qaEditIdx = null;
  } else {
    data[monthKey][typeMap[qaType]].push(entry);
  }
  save();

  // F: If metal investment — auto-create matching _metals portfolio entry
  if (isMetal && entry.metalGrams && entry.metalGrams > 0) {
    if (!data._metals) data._metals = [];
    // Stable link ID so both entries can find each other regardless of array shifts
    const _qaLinkId = 'qal_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
    // Tag the investment entry with the link ID
    const invArr = data[monthKey][typeMap[qaType]];
    if (invArr.length > 0) invArr[invArr.length - 1]._qaLinkId = _qaLinkId;
    const metalEntry = {
      metalType: entry.metalType || 'gold',
      name: entry.description || (entry.category && entry.category !== entry.metalType ? entry.category : null) || (METAL_CONFIG[entry.metalType||'gold']||{}).label || 'Gold',
      grams: entry.metalGrams,
      price: amount / entry.metalGrams,
      priceCurrency: currentCurrency.code,   // currency of m.price for correct ROI conversion
      purity: (document.getElementById('qa-metal-purity')||{}).value||'',
      date: entry.date,
      form: 'Purchase',
      notes: entry.description || '',
      _fromQA: true,
      _fromMonth: monthKey,
      _fromQAMonth: monthKey,
      _qaLinkId, // stable — survives array mutations
    };
    data._metals.push(metalEntry);
    save();
  }

  // Build toast message
  let toastMsg = '✅ Saved!';
  if (isMetal && entry.metalGrams) {
    const mc = METAL_CONFIG[entry.metalType] || METAL_CONFIG['gold'];
    toastMsg = `${mc.emoji} ${entry.metalGrams.toFixed(2)}g ${entry.metalType} · ${fmt(amount)} · added to Metals & NW ✅`;
  }

  // Handle recurring rule creation
  const recCheck = document.getElementById('qa-recurring-check');
  if (qaEditMode === false || (recCheck && recCheck.checked)) {
    // Only process recurring if in edit mode and checkbox is checked
  }
  if (recCheck && recCheck.checked) {
    const freq = document.getElementById('qa-rec-frequency')?.value || 'monthly';
    const dayRaw = parseInt(document.getElementById('qa-rec-day')?.value) || new Date(date+'T00:00:00').getDate();
    if (!data._recurring) data._recurring = [];
    // Remove any existing rule for this source transaction
    data._recurring = data._recurring.filter(r => !(r._sourceMonth === (qaEditMonthKey||monthKey) && r._sourceIdx === qaEditIdx));
    // Add new rule
    const ruleId = 'rec_' + Date.now();
    data._recurring.push({
      id: ruleId,
      type: qaType,
      category: qaSubCat || 'Other',
      amount: Math.abs(finalAmt),
      currency: currentCurrency.code,
      description: note,
      frequency: freq,
      dayOfMonth: dayRaw,
      startMonth: monthKey,
      startDate: monthKey + '-' + String(dayRaw).padStart(2,'0'),
      active: true,
      _sourceMonth: qaEditMonthKey || monthKey,
      _sourceIdx: qaEditIdx,
    });
    toastMsg = `✅ Saved + 🔁 Recurring rule created!`;
  }

  qaAmountStr = '';
  document.getElementById('qa-amount-display').value = '0';
  document.getElementById('qa-note-input').value = '';
  const _mg2 = document.getElementById('qa-metal-grams'); if (_mg2) _mg2.value = '';
  const _mp2 = document.getElementById('qa-metal-purity'); if (_mp2) _mp2.value = '';
  const _mf2 = document.getElementById('qa-metal-fields'); if (_mf2) _mf2.style.display = 'none';
  // Reset recurring UI
  const _rc = document.getElementById('qa-recurring-check'); if (_rc) _rc.checked = false;
  const _ro = document.getElementById('qa-recurring-options'); if (_ro) _ro.style.display = 'none';
  const _rrw = document.getElementById('qa-recurring-wrap'); if (_rrw) _rrw.style.display = 'none';
  showToast(toastMsg);
  if(monthKey === viewMonth) renderHome();
  renderTransactions();
  if (isMetal) { renderMetals(); renderNetWorth(); } // propagate to metals & NW immediately
}

// ══════════════════════════════════════════════════════
// INVESTMENT QUICK-ADD MODAL
// ══════════════════════════════════════════════════════
const INV_FIELDS = {
  'Stocks': [
    {id:'inv-ticker',  label:'Ticker / Name',    type:'text',   placeholder:'e.g. AAPL, FXAIX', full:false},
    {id:'inv-shares',  label:'Shares',            type:'number', placeholder:'0.00',              full:false, calc:true},
    {id:'inv-avgcost', label:'Avg Cost / Share',  type:'number', placeholder:'0.00',              full:false, calc:true},
    {id:'inv-curprice',label:'Current Price',     type:'number', placeholder:'0.00',              full:false},
    {id:'inv-broker',  label:'Broker / Platform', type:'text',   placeholder:'e.g. Zerodha, Groww, Fidelity',     full:true},
  ],
  'Crypto': [
    {id:'inv-coin',    label:'Coin / Token',      type:'text',   placeholder:'e.g. BTC, ETH',     full:false},
    {id:'inv-units',   label:'Units / Qty',       type:'number', placeholder:'0.000000',           full:false, calc:true},
    {id:'inv-buyprice',label:'Buy Price / Unit',  type:'number', placeholder:'0.00',              full:false, calc:true},
    {id:'inv-curprice',label:'Current Price',     type:'number', placeholder:'0.00',              full:false},
    {id:'inv-exchange',label:'Exchange',          type:'text',   placeholder:'e.g. Coinbase',      full:true},
  ],
  'Metals': [
    {id:'inv-metal',   label:'Metal Type',        type:'select', options:['Gold','Silver','Platinum','Palladium','Other'], full:false},
    {id:'inv-unit',    label:'Unit',              type:'select', options:['grams','oz','tola'],    full:false},
    {id:'inv-qty',     label:'Quantity',          type:'number', placeholder:'0.000',              full:false, calc:true},
    {id:'inv-avgcost', label:'Avg Cost / unit',   type:'number', placeholder:'0.00',              full:false, calc:true},
    {id:'inv-purity',  label:'Purity / Form',     type:'text',   placeholder:'e.g. 22K, 999, Coin',full:true},
  ],
  'Real Estate': [
    {id:'inv-propname',label:'Property Name',     type:'text',   placeholder:'e.g. Downtown Apt',  full:true},
    {id:'inv-country', label:'Country',           type:'text',   placeholder:'e.g. USA, India',    full:false},
    {id:'inv-purchase',label:'Purchase Value',    type:'number', placeholder:'0.00',               full:false, calc:true},
    {id:'inv-current', label:'Current Value',     type:'number', placeholder:'0.00',               full:false},
    {id:'inv-area',    label:'Area (sqft/sqm)',   type:'number', placeholder:'0',                  full:false},
  ],
  'ETF/MF': [
    {id:'inv-fund',    label:'Fund Name',         type:'text',   placeholder:'e.g. VTSAX, NIFTY50',full:true},
    {id:'inv-units',   label:'Units / Shares',    type:'number', placeholder:'0.00',               full:false, calc:true},
    {id:'inv-nav',     label:'Avg NAV / Buy',     type:'number', placeholder:'0.00',               full:false, calc:true},
    {id:'inv-curnav',  label:'Current NAV',       type:'number', placeholder:'0.00',               full:false},
    {id:'inv-platform',label:'Broker / Platform', type:'text',   placeholder:'e.g. Vanguard',      full:true},
  ],
  'General': [
    {id:'inv-scheme',   label:'Scheme / Account Name', type:'text',   placeholder:'e.g. VPF, NPS Tier-1, FD', full:true},
    {id:'inv-contrib',  label:'Amount Invested',        type:'number', placeholder:'0.00',                     full:false, calc:true},
    {id:'inv-total-acc',label:'Total Accumulated',      type:'number', placeholder:'0.00 (optional)',           full:false},
    {id:'inv-rate',     label:'Interest / Return %',    type:'number', placeholder:'e.g. 8.25',                full:false},
    {id:'inv-maturity', label:'Maturity / Target',      type:'text',   placeholder:'e.g. 2035 or 5 years',     full:false},
  ],
};

let invFieldCurrency = {...currentCurrency};

function openInvModal(type) {
  invModalType = type || 'Stocks';
  invFieldCurrency = {...currentCurrency};
  document.getElementById('inv-modal-date').value = localDateStr();
  document.getElementById('inv-modal-note').value = '';
  document.getElementById('inv-computed-total').textContent = sym()+'0';
  updateInvCurrBtn();
  // Rebuild tabs from live card list
  _rebuildInvModalTabs(type);
  renderInvFields();
  document.getElementById('inv-quick-modal').classList.add('open');
}

function _rebuildInvModalTabs(activeKey) {
  const cards = getHomeInvCards().filter(c=>c.visible!==false);
  const tabsEl = document.getElementById('inv-type-tabs');
  if(!tabsEl) return;
  tabsEl.innerHTML = cards.map(card=>{
    const isActive = card.key === activeKey;
    const template = card.fieldTemplate||'General';
    const bg = isActive ? card.color : '';
    const col = isActive ? 'white' : '';
    return `<button class="inv-type-chip ${isActive?'active':''}" 
      style="background:${bg};color:${col};"
      onclick="setInvModalType('${card.key}','${template}',this,'${card.color}')"
    >${card.icon} ${card.label||card.key}</button>`;
  }).join('');
}

function setInvModalType(key, template, btn, color) {
  invModalType = key;
  invModalTemplate = (typeof template === 'string' ? template : null) || 'General';
  document.querySelectorAll('.inv-type-chip').forEach(c=>{c.classList.remove('active');c.style.background='';c.style.color='';});
  if(btn && btn.classList) {
    btn.classList.add('active');
    btn.style.background = color||'#4A9EFF';
    btn.style.color = 'white';
  }
  renderInvFields();
}

function renderInvFields() {
  // Determine which field template to use
  const card = getHomeInvCards().find(c=>c.key===invModalType);
  const template = card?.fieldTemplate || invModalTemplate || (INV_FIELDS[invModalType] ? invModalType : 'General');
  const fields = INV_FIELDS[template] || INV_FIELDS['General'];
  const html = `<div class="inv-fields-grid">
    ${fields.map(f=>{
      const input = f.type==='select'
        ? `<select class="inv-field-select" id="${f.id}" onchange="calcInvTotal()">${(f.options||[]).map(o=>`<option>${o}</option>`).join('')}</select>`
        : `<input type="${f.type}" class="inv-field-input" id="${f.id}" placeholder="${f.placeholder||''}" step="any" oninput="calcInvTotal()">`;
      return `<div class="inv-field-box${f.full?' full':''}">`+
             `<label>${f.label}</label>${input}</div>`;
    }).join('')}
  </div>`;
  document.getElementById('inv-modal-fields').innerHTML = html;
  const hasCalc = fields.some(f=>f.calc);
  document.getElementById('inv-total-pill').style.display = hasCalc ? '' : 'none';
  calcInvTotal();
}

function calcInvTotal() {
  const card = getHomeInvCards().find(c=>c.key===invModalType);
  const template = card?.fieldTemplate || invModalTemplate || invModalType;
  let total = 0;
  let label = 'Computed Total Value';
  const g = id => parseFloat(document.getElementById(id)?.value||'0')||0;
  if(template==='Stocks')       { total = g('inv-shares')  * g('inv-avgcost'); }
  else if(template==='Crypto')  { total = g('inv-units')   * g('inv-buyprice'); }
  else if(template==='Metals')  { total = g('inv-qty')     * g('inv-avgcost'); }
  else if(template==='Real Estate') {
    const cur = g('inv-current'), pur = g('inv-purchase');
    if(cur > 0) { total = cur; label = '📈 Current Market Value'; }
    else        { total = pur; label = '🏷️ Purchase Value (no current given)'; }
  }
  else if(template==='ETF/MF')  { total = g('inv-units')   * g('inv-nav'); }
  else if(template==='General') { total = g('inv-contrib'); }
  document.getElementById('inv-total-pill-label').textContent = '💰 ' + label;
  document.getElementById('inv-computed-total').textContent = invFieldCurrency.symbol+total.toFixed(2);
}

function saveInvEntry() {
  const date = document.getElementById('inv-modal-date').value||localDateStr();
  const note = document.getElementById('inv-modal-note').value.trim();
  const g = id => parseFloat(document.getElementById(id)?.value||'0')||0;
  const s = id => (document.getElementById(id)?.value||'').trim();
  const card = getHomeInvCards().find(c=>c.key===invModalType);
  const template = card?.fieldTemplate || invModalTemplate || (INV_FIELDS[invModalType] ? invModalType : 'General');
  let amount=0, entry={};

  if(template==='Stocks') {
    const shares=g('inv-shares'),avgcost=g('inv-avgcost'),curprice=g('inv-curprice'),ticker=s('inv-ticker');
    if(!ticker||!shares||!avgcost){showToast('Fill Ticker, Shares & Cost ❌');return;}
    amount=shares*avgcost;
    entry={ticker,shares,avgCost:avgcost,currentPrice:curprice,broker:s('inv-broker')};
  } else if(template==='Crypto') {
    const units=g('inv-units'),buy=g('inv-buyprice'),coin=s('inv-coin');
    if(!coin||!units||!buy){showToast('Fill Coin, Units & Buy Price ❌');return;}
    amount=units*buy;
    entry={coin,units,buyPrice:buy,currentPrice:g('inv-curprice'),exchange:s('inv-exchange')};
  } else if(template==='Metals') {
    const qty=g('inv-qty'),cost=g('inv-avgcost');
    if(!qty||!cost){showToast('Fill Quantity & Avg Cost ❌');return;}
    amount=qty*cost;
    const metal=s('inv-metal')||'Gold', unit=s('inv-unit')||'grams';
    entry={metal,qty,unit,avgCostPerUnit:cost,purity:s('inv-purity')};
    if(!data._metals) data._metals=[];
    data._metals.push({metalType:metal.toLowerCase(),name:metal,grams:unit==='oz'?qty*31.1035:qty,price:cost,date,form:'Bar',notes:note,purity:s('inv-purity')});
  } else if(template==='Real Estate') {
    const pv=g('inv-purchase');
    if(!pv){showToast('Enter Purchase Value ❌');return;}
    const cv=g('inv-current');
    amount = cv > 0 ? cv : pv;   // prefer current market value, fallback to purchase
    entry={propertyName:s('inv-propname'),country:s('inv-country'),purchaseValue:pv,currentValue:cv||pv,area:g('inv-area')};
  } else if(template==='ETF/MF') {
    const units=g('inv-units'),nav=g('inv-nav');
    if(!units||!nav){showToast('Fill Units & NAV ❌');return;}
    amount=units*nav;
    entry={fundName:s('inv-fund'),units,avgNAV:nav,currentNAV:g('inv-curnav'),platform:s('inv-platform')};
  } else {
    // General template (PF/VPF, NPS, PPF, FD, Insurance, custom)
    const contrib=g('inv-contrib');
    if(!contrib){showToast('Enter the amount invested ❌');return;}
    amount=contrib;
    entry={scheme:s('inv-scheme'),totalAccumulated:g('inv-total-acc'),rate:g('inv-rate'),maturity:s('inv-maturity')};
  }

  const monthKey = getMonthKey(date)||getCurrentMonthKey();
  ensureMonth(monthKey);
  data[monthKey].investments.push({
    date:normalizeDate(date), category:invModalType, investType:invModalType,
    amount, description:note||s('inv-scheme')||s('inv-ticker')||s('inv-fund')||s('inv-coin')||'',
    currency:invFieldCurrency.code, ...entry
  });
  save(); closeModal('inv-quick-modal'); renderHome();
  showToast(`✅ ${card?.label||invModalType} entry saved!`);
}

function updateInvCurrBtn() {
  const btn = document.getElementById('inv-curr-btn');
  if(!btn) return;
  document.getElementById('inv-curr-flag').textContent = invFieldCurrency.flag||'🌍';
  document.getElementById('inv-curr-label').textContent = `${invFieldCurrency.code} — ${invFieldCurrency.symbol}`;
}

// ══════════════════════════════════════════════════════
// CURRENCY PICKER
// ══════════════════════════════════════════════════════
const CURRENCIES = [
  {code:'USD',symbol:'$',  name:'US Dollar',       flag:'🇺🇸',country:'United States'},
  {code:'EUR',symbol:'€',  name:'Euro',             flag:'🇪🇺',country:'Europe'},
  {code:'GBP',symbol:'£',  name:'British Pound',    flag:'🇬🇧',country:'United Kingdom'},
  {code:'INR',symbol:'₹',  name:'Indian Rupee',     flag:'🇮🇳',country:'India'},
  {code:'AED',symbol:'د.إ',name:'UAE Dirham',       flag:'🇦🇪',country:'UAE'},
  {code:'SAR',symbol:'﷼',  name:'Saudi Riyal',      flag:'🇸🇦',country:'Saudi Arabia'},
  {code:'CAD',symbol:'C$', name:'Canadian Dollar',  flag:'🇨🇦',country:'Canada'},
  {code:'AUD',symbol:'A$', name:'Australian Dollar',flag:'🇦🇺',country:'Australia'},
  {code:'JPY',symbol:'¥',  name:'Japanese Yen',     flag:'🇯🇵',country:'Japan'},
  {code:'CNY',symbol:'¥',  name:'Chinese Yuan',     flag:'🇨🇳',country:'China'},
  {code:'SGD',symbol:'S$', name:'Singapore Dollar', flag:'🇸🇬',country:'Singapore'},
  {code:'CHF',symbol:'Fr', name:'Swiss Franc',      flag:'🇨🇭',country:'Switzerland'},
  {code:'MYR',symbol:'RM', name:'Malaysian Ringgit',flag:'🇲🇾',country:'Malaysia'},
  {code:'HKD',symbol:'HK$',name:'Hong Kong Dollar', flag:'🇭🇰',country:'Hong Kong'},
  {code:'NZD',symbol:'NZ$',name:'New Zealand Dollar',flag:'🇳🇿',country:'New Zealand'},
  {code:'KWD',symbol:'KD', name:'Kuwaiti Dinar',    flag:'🇰🇼',country:'Kuwait'},
  {code:'QAR',symbol:'QR', name:'Qatari Riyal',     flag:'🇶🇦',country:'Qatar'},
  {code:'OMR',symbol:'ر.ع.',name:'Omani Rial',      flag:'🇴🇲',country:'Oman'},
  {code:'PKR',symbol:'₨',  name:'Pakistani Rupee',  flag:'🇵🇰',country:'Pakistan'},
  {code:'BDT',symbol:'৳',  name:'Bangladeshi Taka', flag:'🇧🇩',country:'Bangladesh'},
  {code:'LKR',symbol:'₨',  name:'Sri Lankan Rupee', flag:'🇱🇰',country:'Sri Lanka'},
  {code:'NPR',symbol:'₨',  name:'Nepalese Rupee',   flag:'🇳🇵',country:'Nepal'},
  {code:'MXN',symbol:'$',  name:'Mexican Peso',     flag:'🇲🇽',country:'Mexico'},
  {code:'BRL',symbol:'R$', name:'Brazilian Real',   flag:'🇧🇷',country:'Brazil'},
  {code:'ZAR',symbol:'R',  name:'South African Rand',flag:'🇿🇦',country:'South Africa'},
  {code:'NGN',symbol:'₦',  name:'Nigerian Naira',   flag:'🇳🇬',country:'Nigeria'},
  {code:'KES',symbol:'KSh',name:'Kenyan Shilling',  flag:'🇰🇪',country:'Kenya'},
  {code:'EGP',symbol:'E£', name:'Egyptian Pound',   flag:'🇪🇬',country:'Egypt'},
  {code:'TRY',symbol:'₺',  name:'Turkish Lira',     flag:'🇹🇷',country:'Turkey'},
  {code:'RUB',symbol:'₽',  name:'Russian Ruble',    flag:'🇷🇺',country:'Russia'},
  {code:'SEK',symbol:'kr', name:'Swedish Krona',    flag:'🇸🇪',country:'Sweden'},
  {code:'NOK',symbol:'kr', name:'Norwegian Krone',  flag:'🇳🇴',country:'Norway'},
  {code:'DKK',symbol:'kr', name:'Danish Krone',     flag:'🇩🇰',country:'Denmark'},
  {code:'IDR',symbol:'Rp', name:'Indonesian Rupiah',flag:'🇮🇩',country:'Indonesia'},
  {code:'PHP',symbol:'₱',  name:'Philippine Peso',  flag:'🇵🇭',country:'Philippines'},
  {code:'THB',symbol:'฿',  name:'Thai Baht',        flag:'🇹🇭',country:'Thailand'},
  {code:'VND',symbol:'₫',  name:'Vietnamese Dong',  flag:'🇻🇳',country:'Vietnam'},
  {code:'KRW',symbol:'₩',  name:'South Korean Won', flag:'🇰🇷',country:'South Korea'},
];

function openCurrencyPicker(context) {
  invCurrencyTarget = context;
  filterCurrencies('');
  document.getElementById('curr-search-input').value = '';
  document.getElementById('currency-modal').classList.add('open');
}

function filterCurrencies(query) {
  const q = query.toLowerCase();
  const filtered = q ? CURRENCIES.filter(c=>c.name.toLowerCase().includes(q)||c.code.toLowerCase().includes(q)||c.country.toLowerCase().includes(q)) : CURRENCIES;
  document.getElementById('curr-list').innerHTML = filtered.map(c=>`
    <div class="curr-item ${c.code===currentCurrency.code?'active':''}" onclick="selectCurrency('${c.code}')">
      <span class="curr-flag">${c.flag}</span>
      <div class="curr-info">
        <div class="curr-name">${c.name}</div>
        <div class="curr-country">${c.country}</div>
      </div>
      <span class="curr-code">${c.code}</span>
      <span class="curr-symbol">${c.symbol}</span>
    </div>`).join('');
}

function selectCurrency(code) {
  const c = CURRENCIES.find(x=>x.code===code);
  if(!c) return;
  if(invCurrencyTarget==='inv') {
    invFieldCurrency = c;
    updateInvCurrBtn();
    calcInvTotal();
  } else {
    // Stamp goals that lack stored currency with CURRENT (old) code before switching
    const _oldCurrCode = currentCurrency.code;
    ['_expenseGoals','_savingsGoals'].forEach(k => {
      (data[k] || []).forEach(g => { if (!g.currency) g.currency = _oldCurrCode; });
    });
    if (data._expenseGoals || data._savingsGoals) save();
    saveCurrency(c);
    renderHome();
    try { renderTransactions(); } catch(e) {}
    try { renderBudget(); } catch(e) {}
    try { renderNetWorth(); } catch(e) {}
    try { renderMetals(); } catch(e) {}
    try { renderSettings(); } catch(e) {}
  }
  closeModal('currency-modal');
  showToast(`${c.flag} Currency set to ${c.code} — all screens updated`);
}

// ══════════════════════════════════════════════════════
// FX RATE OVERRIDE MODULE
// ══════════════════════════════════════════════════════

// Scan all data to find every currency code actually in use
function getActiveCurrencies() {
  const found = new Set();
  // NW accounts
  (data._nwAccounts || []).forEach(a => { if (a.currency) found.add(a.currency.toUpperCase()); });
  // Metals
  (data._metals || []).forEach(m => { if (m.currency) found.add(m.currency.toUpperCase()); });
  // Real estate
  (data._realEstate || []).forEach(p => { if (p.currency) found.add(p.currency.toUpperCase()); });
  // Monthly transactions
  Object.keys(data).forEach(key => {
    if (!/^\d{4}-\d{2}$/.test(key)) return;
    const mo = data[key];
    ['income','expenses','investments','additional','metals','debts'].forEach(cat => {
      (mo[cat] || []).forEach(e => { if (e.currency) found.add(e.currency.toUpperCase()); });
    });
    (mo.realEstate || []).forEach(e => { if (e.currency) found.add(e.currency.toUpperCase()); });
  });
  // Always remove display currency from transaction-currency list
  found.delete(currentCurrency.code.toUpperCase());
  // But if display is not USD, ADD it back so user can set the USD→DisplayCurrency rate
  // This is needed for correct NW conversion when accounts are in USD and display is INR etc.
  if (currentCurrency.code.toUpperCase() !== 'USD') {
    found.add(currentCurrency.code.toUpperCase());
  }
  return [...found].sort();
}

function renderFXRatesPanel() {
  const el = document.getElementById('fx-rates-list');
  if (!el) return;
  const overrides = data._fxOverrides || {};
  const displayCode = currentCurrency.code.toUpperCase();
  const activeCurrencies = getActiveCurrencies();

  // Update base label and badge — show "1 USD = X {display}" context
  const baseLabel = document.getElementById('fx-base-label');
  if (baseLabel) baseLabel.textContent = displayCode === 'USD' ? 'USD' : `USD → ${displayCode}`;
  const badge = document.getElementById('fx-override-badge');
  const clearAllBtn = document.getElementById('fx-clear-all-btn');
  const hasAnyOverride = Object.keys(overrides).length > 0;
  if (badge) badge.style.display = hasAnyOverride ? '' : 'none';
  if (clearAllBtn) clearAllBtn.style.display = hasAnyOverride ? '' : 'none';

  if (activeCurrencies.length === 0) {
    el.innerHTML = `<div style="font-size:0.82em;color:var(--text-light);font-weight:600;text-align:center;padding:16px;">
      No foreign-currency data found yet. Add assets or transactions in other currencies and they'll appear here.
    </div>`;
    return;
  }

  const rows = activeCurrencies.map(code => {
    const builtIn = FX_USD_BASE[code];
    const override = overrides[code];
    const effective = override !== undefined ? override : (builtIn || null);
    // Rate shown as "1 USD = X foreign" — convert to "1 foreign = Y displayCurrency" for intuitive reading
    const displayRate = FX_USD_BASE[displayCode] || 1;
    const effectiveDisplay = effective ? (displayRate / effective) : null;
    const builtInDisplay  = builtIn   ? (displayRate / builtIn)   : null;
    const hasOverride = override !== undefined;
    const unknownRate = effective === null;
    const cInfo = CURRENCIES.find(c => c.code === code) || { flag: '🌐', name: code };

    return `<div style="border-bottom:1px solid #F5F5F5;padding:10px 0;" id="fx-row-${code}">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
          <span style="font-size:1.2em;">${cInfo.flag||'🌐'}</span>
          <div>
            <div style="font-weight:800;font-size:0.88em;color:var(--text-dark);">${code}
              ${hasOverride ? `<span style="background:#F0FFF4;color:#10B981;font-size:0.7em;border-radius:6px;padding:1px 6px;margin-left:4px;">✏️ Custom</span>` : ''}
            </div>
            <div style="font-size:0.72em;color:var(--text-light);font-weight:600;">${cInfo.name||''}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          ${unknownRate
            ? `<div style="font-size:0.78em;color:#EF4444;font-weight:700;">Rate unknown</div>`
            : `<div style="font-weight:900;font-size:0.92em;color:var(--primary);">1 ${code} = ${effectiveDisplay.toFixed(4)} ${displayCode}</div>
               <div style="font-size:0.68em;color:var(--text-light);font-weight:600;">1 USD = ${effective.toFixed(4)} ${code}</div>`
          }
        </div>
        <div style="display:flex;gap:4px;flex-shrink:0;">
          <button onclick="openFXOverride('${code}')"
            style="background:#F0F4FF;border:none;border-radius:7px;padding:4px 9px;font-size:0.72em;font-weight:800;color:var(--primary);cursor:pointer;">✏️ Set</button>
          ${hasOverride ? `<button onclick="resetFXOverride('${code}')"
            style="background:#FFF0F0;border:none;border-radius:7px;padding:4px 8px;font-size:0.72em;font-weight:800;color:#EF4444;cursor:pointer;">✕</button>` : ''}
        </div>
      </div>
      <!-- Inline edit panel (hidden by default) -->
      <div id="fx-edit-${code}" style="display:none;margin-top:8px;background:#F8F8F8;border-radius:9px;padding:10px 12px;">
        <div style="font-size:0.78em;font-weight:800;color:var(--text-dark);margin-bottom:6px;">Set rate for ${code}:</div>
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <div style="flex:1;">
            <div style="font-size:0.68em;color:var(--text-light);font-weight:700;margin-bottom:3px;">1 USD = ? ${code}</div>
            <input type="number" id="fx-input-usd-${code}" step="0.0001" placeholder="${effective ? effective.toFixed(4) : 'e.g. 83.5'}"
              style="width:100%;border:1.5px solid #DDD;border-radius:7px;padding:6px 8px;font-size:0.88em;font-weight:700;"
              oninput="syncFXInputs('${code}','usd')"
              value="${effective ? effective.toFixed(4) : ''}">
          </div>
          <div style="flex:1;">
            <div style="font-size:0.68em;color:var(--text-light);font-weight:700;margin-bottom:3px;">1 ${code} = ? ${displayCode}</div>
            <input type="number" id="fx-input-disp-${code}" step="0.0001" placeholder="${effectiveDisplay ? effectiveDisplay.toFixed(4) : ''}"
              style="width:100%;border:1.5px solid #DDD;border-radius:7px;padding:6px 8px;font-size:0.88em;font-weight:700;"
              oninput="syncFXInputs('${code}','disp')"
              value="${effectiveDisplay ? effectiveDisplay.toFixed(4) : ''}">
          </div>
        </div>
        ${builtIn ? `<div style="font-size:0.7em;color:var(--text-light);font-weight:600;margin-bottom:6px;">Built-in default: 1 USD = ${builtIn} ${code}</div>` : ''}
        <div style="display:flex;gap:6px;">
          <button onclick="applyFXOverride('${code}')"
            style="flex:1;background:#10B981;color:white;border:none;border-radius:7px;padding:7px;font-weight:800;font-size:0.82em;cursor:pointer;">✓ Apply</button>
          <button onclick="closeFXEdit('${code}')"
            style="background:#EEE;border:none;border-radius:7px;padding:7px 12px;font-weight:800;font-size:0.82em;cursor:pointer;color:var(--text-med);">Cancel</button>
        </div>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = rows || `<div style="font-size:0.82em;color:var(--text-light);font-weight:600;text-align:center;padding:16px;">No foreign currencies in use yet.</div>`;
}

function openFXOverride(code) {
  // Close any other open panels first
  document.querySelectorAll('[id^="fx-edit-"]').forEach(p => p.style.display = 'none');
  const panel = document.getElementById('fx-edit-' + code);
  if (panel) panel.style.display = '';
}

function closeFXEdit(code) {
  const panel = document.getElementById('fx-edit-' + code);
  if (panel) panel.style.display = 'none';
}

function syncFXInputs(code, changed) {
  const dispCode = currentCurrency.code.toUpperCase();
  const dispRate = FX_USD_BASE[dispCode] || 1;
  const usdInput  = document.getElementById('fx-input-usd-'  + code);
  const dispInput = document.getElementById('fx-input-disp-' + code);
  if (!usdInput || !dispInput) return;
  if (changed === 'usd') {
    const usdVal = parseFloat(usdInput.value);
    if (usdVal > 0) dispInput.value = (dispRate / usdVal).toFixed(6);
  } else {
    const dispVal = parseFloat(dispInput.value);
    if (dispVal > 0) usdInput.value = (dispRate / dispVal).toFixed(6);
  }
}

function applyFXOverride(code) {
  const usdInput = document.getElementById('fx-input-usd-' + code);
  const rate = parseFloat(usdInput?.value);
  if (!rate || rate <= 0) { showToast('Enter a valid rate ❌'); return; }
  if (!data._fxOverrides) data._fxOverrides = {};
  data._fxOverrides[code] = rate;
  save();
  renderFXRatesPanel();
  renderNetWorth();
  renderHome();
  showToast(`✅ ${code} rate saved — Net Worth recalculated!`);
}

function resetFXOverride(code) {
  if (!data._fxOverrides) return;
  delete data._fxOverrides[code];
  save();
  renderFXRatesPanel();
  renderNetWorth();
  renderHome();
  showToast(`${code} rate reset to built-in default`);
}

function clearAllFXOverrides() {
  if (!confirm('Clear ALL custom FX rate overrides? Built-in rates will be used.')) return;
  data._fxOverrides = {};
  save();
  renderFXRatesPanel();
  renderNetWorth();
  renderHome();
  showToast('✅ All FX overrides cleared — using built-in rates');
}

// ══════════════════════════════════════════════════════
// INVESTMENT CARD MANAGER
// ══════════════════════════════════════════════════════
const INV_EMOJI_OPTS = ['🏛️','🧓','📮','🏦','🛡️','📊','🪙','🥇','🏡','🗂','💹','🌐','💼','🎯','🏗️','📱','🌱','⚡','🔑','💎','🏅','🌍','📋','🏠'];
let pickedInvEmoji = '🏛️';

function renderInvCardSettings() {
  const cards = getHomeInvCards();
  const grid = document.getElementById('inv-card-grid');
  if(!grid) return;
  grid.innerHTML = cards.map((c,i) => {
    const templateLabel = c.fieldTemplate==='General' ? '💰' : c.fieldTemplate==='ETF/MF' ? '📊' : c.fieldTemplate==='Metals' ? '🥇' : c.fieldTemplate==='Crypto' ? '🪙' : c.fieldTemplate==='Real Estate' ? '🏡' : '📈';
    return `<div class="home-card-item">
      <span class="home-card-item-icon">${c.icon}</span>
      <div style="flex:1;min-width:0;">
        <div class="home-card-item-label" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.label||c.key}</div>
        <div style="font-size:0.68em;color:var(--text-light);font-weight:600;">${templateLabel} ${c.fieldTemplate||'General'}</div>
      </div>
      <button class="home-card-toggle ${c.visible!==false?'on':''}" onclick="toggleInvCard(${i})" title="${c.visible!==false?'Visible — click to hide':'Hidden — click to show'}">
        ${c.visible!==false?'✓':'○'}
      </button>
      <button class="home-card-toggle" onclick="removeInvCard(${i})" title="Remove" style="color:var(--expenses);font-size:0.8em;">✕</button>
    </div>`;
  }).join('');

  // Emoji picker row
  const emojiRow = document.getElementById('inv-card-emoji-row');
  if(emojiRow) emojiRow.innerHTML = INV_EMOJI_OPTS.map(e =>
    `<span class="emoji-opt ${e===pickedInvEmoji?'selected':''}" onclick="pickInvEmoji('${e}')">${e}</span>`
  ).join('');
}

function pickInvEmoji(e) { pickedInvEmoji = e; renderInvCardSettings(); }

function toggleInvCard(idx) {
  const cards = getHomeInvCards();
  cards[idx].visible = cards[idx].visible === false ? true : false;
  saveHomeInvCards(cards);
  renderInvCardSettings();
  if(homeTab==='invest') renderHome();
}

function removeInvCard(idx) {
  const cards = getHomeInvCards();
  if(!confirm(`Remove "${cards[idx].label||cards[idx].key}" investment card?`)) return;
  cards.splice(idx, 1);
  saveHomeInvCards(cards);
  renderInvCardSettings();
  if(homeTab==='invest') renderHome();
  showToast('Card removed');
}

function addInvCard() {
  const name = (document.getElementById('inv-card-name-input')?.value||'').trim();
  if(!name) { showToast('Enter a card name ❌'); return; }
  const template = document.getElementById('inv-card-template')?.value || 'General';
  const cards = getHomeInvCards();
  if(cards.find(c=>c.key===name||c.label===name)) { showToast('Card already exists ⚠️'); return; }

  const invColors = ['#0EA5E9','#8B5CF6','#059669','#D97706','#DC2626','#EC4899','#14B8A6','#F97316','#6366F1','#84CC16'];
  const invBgs   = ['#E0F2FE','#F3EEFF','#ECFDF5','#FFFBEB','#FEF2F2','#FDF2F8','#F0FDFA','#FFF7ED','#EEF2FF','#F7FEE7'];
  const idx = cards.length % invColors.length;

  cards.push({
    key: name,
    label: name,
    icon: pickedInvEmoji,
    color: invColors[idx],
    bg: invBgs[idx],
    fieldTemplate: template,
    visible: true,
  });
  saveHomeInvCards(cards);
  document.getElementById('inv-card-name-input').value = '';
  renderInvCardSettings();
  if(homeTab==='invest') renderHome();
  showToast(`✅ "${name}" card added!`);
}

// ══════════════════════════════════════════════════════
// HOME CARD MANAGER (Spending)
const EMOJI_OPTS = ['🍔','🛒','🏠','🚗','💊','🎓','⚡','🌊','✈️','🎬','👗','💆','🐾','🧹','📱','☕','🎮','📚','🍕','🎁','💪','🌱','🔧','🎵'];
let pickedEmoji = '🛒';

function renderHomeCardSettings() {
  const cards = getHomeSpendCards();
  const grid = document.getElementById('home-card-grid');
  if(!grid) return;
  grid.innerHTML = cards.map((c,i)=>`
    <div class="home-card-item">
      <span class="home-card-item-icon">${c.icon}</span>
      <span class="home-card-item-label">${c.label}</span>
      <button class="home-card-toggle ${c.visible!==false?'on':''}" onclick="toggleHomeCard(${i})" title="${c.visible!==false?'Visible':'Hidden'}">
        ${c.visible!==false?'✓':'○'}
      </button>
      <button class="home-card-toggle" onclick="removeHomeCard(${i})" title="Remove" style="color:var(--expenses);font-size:0.8em;">✕</button>
    </div>`).join('');
  // Emoji picker
  const emojiRow = document.getElementById('home-card-emoji-row');
  if(emojiRow) emojiRow.innerHTML = EMOJI_OPTS.map(e=>`<span class="emoji-opt ${e===pickedEmoji?'selected':''}" onclick="pickEmoji('${e}')">${e}</span>`).join('');
}

function pickEmoji(e) { pickedEmoji=e; renderHomeCardSettings(); }

function toggleHomeCard(idx) {
  const cards = getHomeSpendCards();
  cards[idx].visible = cards[idx].visible===false;
  saveHomeSpendCards(cards);
  renderHomeCardSettings();
  renderHome();
}

function removeHomeCard(idx) {
  const cards = getHomeSpendCards();
  if(!confirm(`Remove "${cards[idx].label}" card?`)) return;
  cards.splice(idx,1);
  saveHomeSpendCards(cards);
  renderHomeCardSettings();
  renderHome();
}

function addHomeCard() {
  const name = (document.getElementById('home-card-name-input')?.value||'').trim();
  if(!name){showToast('Enter a card name ❌');return;}
  const cards = getHomeSpendCards();
  const colors=['#FF6B35','#4A9EFF','#FF8C42','#4ECDC4','#FF4757','#10B981','#FFBE0B','#FF6B9D','#64B5F6','#7C3AED'];
  const color = colors[cards.length % colors.length];
  cards.push({key:name.toLowerCase().replace(/\s+/g,'_'),label:name,icon:pickedEmoji,color,cls:'other-cat',subcats:[name],visible:true});
  saveHomeSpendCards(cards);
  document.getElementById('home-card-name-input').value='';
  renderHomeCardSettings();
  renderHome();
  showToast(`✅ "${name}" card added to home!`);
}

// ══════════════════════════════════════════════════════
// NAVIGATION
// ══════════════════════════════════════════════════════
function switchScreen(name, btn) {
  // Clear transaction search when navigating away from tx screen
  if (name !== 'tx' && _txSearchActive) {
    clearTxSearch();
  }
  // Always close goals overlay when navigating away
  const goalsOverlay = document.getElementById('blist-goals');
  if (goalsOverlay) goalsOverlay.style.display = 'none';
  const goalsFabNav = document.getElementById('goals-fab-btn');
  if (goalsFabNav) goalsFabNav.style.display = 'none';
  closeGoalSheet();
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  if(btn) btn.classList.add('active');
  // Show FAB only on screens where adding transactions makes sense
  const fabScreens = ['home','tx','add'];
  const fab = document.getElementById('fab-add-btn');
  if(fab) fab.style.display = fabScreens.includes(name) ? 'flex' : 'none';
  if(name==='stats') renderStats();
  if(name==='account') renderAccount();
  if(name==='tx') renderTransactions();
  if(name==='home') renderHome();
  if(name==='add') renderAddScreen();
  if(name==='settings') renderSettings();
  if(name==='metals') renderMetals();
  if(name==='invest') renderInvestments();
  if(name==='data') { populateDataMonthSelect(); renderDataScreen(); }
  if(name==='settings') { renderRecurringRules(); }
  if(name==='budget') { budgetViewMonth = viewMonth; document.getElementById('budget-month-label').textContent = getDisplayMonth(budgetViewMonth); renderBudgetModule(); }
  if(name==='networth') renderNetWorth();
  if(name==='import') { setImportTab('transactions', document.querySelector('.import-tab')); renderGivenLedger(); renderResetSummary(); renderMonthsList(); }
}

function goToScreen(name) {
  // Clear transaction search when navigating away from tx screen
  if (name !== 'tx' && _txSearchActive) {
    clearTxSearch();
  }
  const goalsOverlay = document.getElementById('blist-goals');
  if (goalsOverlay) goalsOverlay.style.display = 'none';
  closeGoalSheet();
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  if(name==='settings') renderSettings();
  if(name==='metals') renderMetals();
  if(name==='invest') renderInvestments();
  if(name==='networth') renderNetWorth();
}

// ══════════════════════════════════════════════════════
// TRANSACTIONS / CALENDAR
// ══════════════════════════════════════════════════════
let calSelectedDay = null;


let calViewMode = 'calendar'; // 'calendar' | 'list'

function setCalView(mode) {
  calViewMode = mode;
  const calGrid  = document.getElementById('cal-grid');
  const listView = document.getElementById('cal-list-view');
  const btnCal   = document.getElementById('cal-view-btn-calendar');
  const btnList  = document.getElementById('cal-view-btn-list');
  const activeStyle  = 'background:#1E2A6E;color:white;border:none;border-radius:8px;padding:5px 12px;font-size:0.78em;font-weight:800;cursor:pointer;';
  const inactiveStyle= 'background:#F0F0F0;color:var(--text-med);border:none;border-radius:8px;padding:5px 12px;font-size:0.78em;font-weight:800;cursor:pointer;';
  const dowRow = document.getElementById('cal-dow-row');
  if (mode === 'calendar') {
    if (calGrid) calGrid.style.display = '';
    if (listView) listView.style.display = 'none';
    if (dowRow) dowRow.style.display = ''; // show DOW in calendar mode
    // Restore day-detail-wrap — it's managed by calendar interactions
    const dayDetail = document.getElementById('cal-day-detail-wrap');
    if (dayDetail) { dayDetail.style.display = ''; }
    if (btnCal)  btnCal.style.cssText  = activeStyle;
    if (btnList) btnList.style.cssText = inactiveStyle;
  } else {
    if (calGrid) calGrid.style.display = 'none';
    if (dowRow) dowRow.style.display = 'none'; // hide DOW in list mode
    // Also hide the day-detail card so it doesn't show below the list
    const dayDetail = document.getElementById('cal-day-detail-wrap');
    if (dayDetail) { dayDetail.style.display = 'none'; }
    if (listView) { listView.style.display = ''; renderCalListView(listView); }
    if (btnCal)  btnCal.style.cssText  = inactiveStyle;
    if (btnList) btnList.style.cssText = activeStyle;
  }
}

function renderCalListView(container) {
  const [y, mo] = viewMonth.split('-').map(Number);
  const mk = viewMonth;
  if (!data[mk]) { container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);font-weight:700;">No data for this month</div>'; return; }
  const toDisp = t => convertAmt(t.amount, t.currency);
  // Assign _idx so Edit/Delete buttons resolve correctly to the real array position
  const exp  = (data[mk].expenses    || []).map((t, i) => ({...t, _type:'expense',     _idx:i}));
  const inc  = (data[mk].income      || []).map((t, i) => ({...t, _type:'income',      _idx:i}));
  const inv  = (data[mk].investments || []).map((t, i) => ({...t, _type:'investment',  _idx:i}));
  const add  = (data[mk].additional  || []).map((t, i) => ({...t, _type:'additional',  _idx:i}));
  // Apply family author filter (same as calendar day view)
  const authorOk = t => _authorFilter === 'all' || !_authorFilter || (t._addedBy||'').toLowerCase() === _authorFilter.toLowerCase();
  const all  = [...inc, ...exp, ...inv, ...add]
    .filter(authorOk)
    .sort((a,b)=>(b.date||'').localeCompare(a.date||''));

  const typeColors = { expense:'#EF4444', income:'#10B981', investment:'#7C3AED', additional:'#F59E0B' };
  const typeLabels = { expense:'Expense', income:'Income', investment:'Invest', additional:'Other' };

  // Group by date
  const byDate = {};
  all.forEach(t => {
    const d = t.date || '?';
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(t);
  });

  const dateKeys = Object.keys(byDate).sort((a,b) => b.localeCompare(a));
  const totalInc = inc.reduce((s,t)=>s+toDisp(t),0);
  const totalExp = exp.reduce((s,t)=>s+toDisp(t),0);
  const totalInv = inv.reduce((s,t)=>s+toDisp(t),0);

  let html = ''; // 2a: No summary tiles in list view — transactions only

  dateKeys.forEach(date => {
    const txns = byDate[date];
    const d = new Date(date + 'T00:00:00');
    const dayLabel = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    const dayTotal = txns.reduce((s,t) => {
      if (t._type==='income') return s + toDisp(t);
      if (t._type==='expense'||t._type==='additional') return s - toDisp(t);
      return s;
    }, 0);
    html += `<div style="margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:#F8F8F8;border-radius:10px;margin-bottom:4px;">
        <div style="font-weight:800;font-size:0.82em;color:var(--text-dark);">${dayLabel}</div>
        <div style="font-weight:900;font-size:0.82em;color:${dayTotal>=0?'var(--income)':'var(--expenses)'};">${dayTotal>=0?'+':''}${fmt(Math.abs(dayTotal))}</div>
      </div>`;
    txns.forEach(t => {
      const color = typeColors[t._type] || '#888';
      const label = typeLabels[t._type] || t._type;
      const prefix = t._type === 'income' ? '+' : '-';
      const tIdx = all.indexOf(t);
      html += `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid #F5F5F5;">
        <div style="width:7px;height:7px;border-radius:50%;background:${color};flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:0.85em;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.description||t.category||'—'}</div>
          <div style="font-size:0.72em;font-weight:600;color:var(--text-light);">${t.category||''} · ${label}</div>
        </div>
        <div style="font-weight:900;font-size:0.88em;color:${color};flex-shrink:0;margin-right:4px;">${prefix}${fmt(toDisp(t))}</div>
        <button onclick="listEditTx('${mk}','${t._type}',${t._idx})" style="background:#F0F4FF;border:none;border-radius:7px;padding:4px 7px;font-size:0.7em;color:var(--primary);cursor:pointer;flex-shrink:0;">✏️</button>
        <button onclick="listDeleteTx('${mk}','${t._type}',${t._idx})" style="background:#FFF0F0;border:none;border-radius:7px;padding:4px 7px;font-size:0.7em;color:var(--expenses);cursor:pointer;flex-shrink:0;">✕</button>
      </div>`;
    });
    html += `</div>`;
  });

  if (dateKeys.length === 0) html += `<div style="text-align:center;padding:30px;color:var(--text-light);font-weight:700;">No transactions this month</div>`;
  container.innerHTML = html;
}

// ── Calendar swipe gesture ──────────────────────────────────────
let _calSwipeX = null;

function calSwipeStart(e) {
  _calSwipeX = e.touches ? e.touches[0].clientX : null;
}

function calSwipeEnd(e) {
  if (_calSwipeX === null) return;
  const endX = e.changedTouches ? e.changedTouches[0].clientX : null;
  if (endX === null) return;
  const delta = endX - _calSwipeX;
  _calSwipeX = null;
  if (Math.abs(delta) < 50) return; // too short — ignore
  calChangeMonth(delta < 0 ? 1 : -1); // swipe left = next, right = prev
}

function calChangeMonth(dir) {
  autoSnapshot(); // silently snapshot current month before leaving
  const [y,m] = viewMonth.split('-').map(Number);
  const d = new Date(y, m-1+dir, 1);
  viewMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  budgetViewMonth = viewMonth; // A: keep budget always in sync
  // Refresh list view if active
  if (calViewMode === 'list') { const lv=document.getElementById('cal-list-view'); if(lv&&lv.style.display!=='none') renderCalListView(lv); }
  const topbarMonth = document.getElementById('topbar-month');
  if(topbarMonth) topbarMonth.textContent = getDisplayMonth(viewMonth);
  calSelectedDay = null;
  renderTransactions();
  renderHome();
}

function fmtShort(n) {
  if(n >= 1000) return (n/1000).toFixed(1)+'k';
  return n.toFixed(0);
}

function renderAuthorChips() {
  const strip = document.getElementById('author-filter-strip');
  const row   = document.getElementById('author-chips-row');
  if (!strip || !row) return;

  // Gather all authors across current month
  const m = data[viewMonth] || {};
  const allEntries = [
    ...(m.expenses||[]), ...(m.income||[]), ...(m.investments||[]),
    ...(m.debts||[]), ...(m.givenToOthers||[]), ...(m.additional||[])
  ];
  const authors = [...new Set(allEntries.map(e => e._addedBy).filter(Boolean))];

  // Show family icon if there are ANY family members (firebase users sharing)
  // even if no transactions from others this month
  const isFamily = firebase.auth().currentUser !== null && 
    (data._familyMembers || []).length > 0 || authors.length > 1;
  
  if (authors.length <= 1 && !isFamily) {
    strip.style.display = 'none';
    _authorFilter = 'all';
    return;
  }
  
  if (authors.length <= 1) {
    // Family group but no multi-author transactions this month
    // Show icon only, no chips needed
    strip.style.display = '';
    row.innerHTML = '';
    const btn = document.getElementById('author-toggle-btn');
    if (btn) { btn.classList.remove('active'); }
    const slide = document.getElementById('author-chips-slide');
    if (slide) { slide.classList.remove('open'); _authorChipsOpen = false; }
    return;
  }

  strip.style.display = '';
  const chips = ['all', ...authors].map(a =>
    `<div class="author-chip ${_authorFilter===a?'active':''}"
      onclick="setAuthorFilter('${a}')">${a==='all'?'All':a}</div>`
  ).join('');
  row.innerHTML = chips;
  // Highlight 👥 button when a member filter is active
  const btn = document.getElementById('author-toggle-btn');
  if (btn) btn.classList.toggle('active', _authorFilter !== 'all');
}

function renderTransactions() {
  renderAuthorChips();
  ensureMonth(viewMonth);
  const m = data[viewMonth];
  const today = localDateStr();
  const [y, mo] = viewMonth.split('-').map(Number);

  const titleEl = document.getElementById('cal-month-title');
  if(titleEl) {
    const filterLabel = _authorFilter !== 'all' ? ` · ${_authorFilter}` : '';
    titleEl.textContent = getDisplayMonth(viewMonth) + filterLabel;
    titleEl.style.color = _authorFilter !== 'all' ? 'var(--primary)' : '';
  }

  // Gather all transactions — normalize dates so YYYY-M-D matches YYYY-MM-DD
  let allTx = [];
  const pushTx = (list, type) => (list||[]).forEach((e,i) => {
    const normDate = normalizeDate(e.date);   // ← fix: always padded YYYY-MM-DD
    allTx.push({...e, date: normDate, _type: type, _idx: i});
  });
  pushTx(m.expenses,      'expense');
  pushTx(m.income,        'income');
  pushTx(m.investments,   'investment');
  pushTx(m.debts,         'debt');
  pushTx(m.givenToOthers, 'given');
  pushTx(m.additional,    'additional');

  // Summary — apply author filter then convert to display currency
  const toDisp = t => convertAmt(t.amount, t.currency);
  const summaryTx = _authorFilter === 'all' ? allTx : allTx.filter(t => t._addedBy === _authorFilter);
  const totalInc  = summaryTx.filter(t=>t._type==='income').reduce((s,t)=>s+toDisp(t),0);
  const totalExp  = summaryTx.filter(t=>t._type==='expense'||t._type==='additional').reduce((s,t)=>s+toDisp(t),0);
  const totalInv  = summaryTx.filter(t=>t._type==='investment').reduce((s,t)=>s+toDisp(t),0);
  const totalOther= summaryTx.filter(t=>t._type==='debt'||t._type==='given').reduce((s,t)=>s+toDisp(t),0);
  const savings   = totalInv;  // "Investing" tile shows investments amount
  const net       = totalInc - totalExp - totalInv - totalOther;

  const el_inc  = document.getElementById('cal-total-income');
  const el_exp  = document.getElementById('cal-total-expense');
  const el_sav  = document.getElementById('cal-total-savings');
  const el_net  = document.getElementById('cal-total-net');
  if(el_inc) el_inc.textContent = fmt(totalInc);
  if(el_exp) el_exp.textContent = fmt(totalExp);
  if(el_sav) { el_sav.textContent = fmt(savings); el_sav.style.color = '#7C3AED'; }
  if(el_net) {
    el_net.textContent = (net>=0?'+':'-') + fmt(Math.abs(net));
    el_net.style.color = net>=0 ? 'var(--income)' : 'var(--expenses)';
  }

  // Apply author filter — if a member is selected, only show their transactions on calendar
  const visibleTx = _authorFilter === 'all'
    ? allTx
    : allTx.filter(t => t._addedBy === _authorFilter);

  // Group by normalized date — sort each day's txns desc by date then idx
  const byDate = {};
  visibleTx.forEach(t => {
    const d = t.date||'';
    if(d) { if(!byDate[d]) byDate[d]=[]; byDate[d].push(t); }
  });
  // Sort within each day: most recently added (highest idx) first
  Object.values(byDate).forEach(arr => arr.sort((a,b) => (b._idx||0) - (a._idx||0)));

  // Build calendar grid
  const firstDow = new Date(y, mo-1, 1).getDay();
  const daysInMonth = new Date(y, mo, 0).getDate();
  const typeColors = {
    expense:'#EF4444', income:'#10B981', investment:'#7C3AED',
    debt:'#8B5CF6', given:'#FF6B9D', additional:'#F59E0B'
  };

  let cells = '';
  for(let i=0; i<firstDow; i++) {
    cells += `<div class="cal-cell empty"></div>`;
  }
  for(let d=1; d<=daysInMonth; d++) {
    const dateStr = `${viewMonth}-${String(d).padStart(2,'0')}`;
    const txs = byDate[dateStr] || [];
    const isToday = dateStr === today;
    const isSel   = dateStr === calSelectedDay;
    const dayExp  = txs.filter(t=>t._type!=='income').reduce((s,t)=>s+convertAmt(t.amount,t.currency),0);
    const dayInc  = txs.filter(t=>t._type==='income').reduce((s,t)=>s+convertAmt(t.amount,t.currency),0);
    const uniqueTypes = [...new Set(txs.map(t=>t._type))].slice(0,4);
    const dots = uniqueTypes.map(tp=>`<div class="cal-dot" style="background:${typeColors[tp]||'#ccc'};"></div>`).join('');
    let amtHtml = '';
    if(txs.length > 0) {
      const parts = [];
      if(dayExp>0) parts.push(`<span style="color:var(--expenses)">${fmtShort(dayExp)}</span>`);
      if(dayInc>0) parts.push(`<span style="color:var(--income)">${fmtShort(dayInc)}</span>`);
      amtHtml = `<div class="cal-cell-amt">${parts.join('<br>')}</div>`;
    }
    cells += `<div class="cal-cell${isToday?' today':''}${isSel?' selected':''}" onclick="calSelectDay('${dateStr}')">
      <div class="cal-day-num">${d}</div>
      <div class="cal-dots">${dots}</div>
      ${amtHtml}
    </div>`;
  }

  const calGrid = document.getElementById('cal-grid');
  if(calGrid) calGrid.innerHTML = cells;
  // B: Auto-select most recent day that has transactions (not just today)
  if (!calSelectedDay) {
    const datesWithTx = Object.keys(byDate).sort().reverse();
    const todayStr = localDateStr();
    calSelectedDay = datesWithTx.includes(todayStr) ? todayStr : (datesWithTx[0] || todayStr);
  }
  renderCalDayDetail(visibleTx);

  // If currently in list view, refresh it too so author filter applies
  if (calViewMode === 'list') {
    const listView = document.getElementById('cal-list-view');
    if (listView && listView.style.display !== 'none') {
      renderCalListView(listView);
    }
  }
}

// ── Settings Accordion ──────────────────────────────────────────
function toggleAccordion(id) {
  const acc = document.getElementById(id);
  if (!acc) return;
  const body = acc.querySelector('.acc-body');
  const chev = acc.querySelector('.acc-chev');
  const isOpen = !acc.classList.contains('collapsed');
  if (isOpen) {
    acc.classList.add('collapsed');
    body.style.display = 'none';
    chev.textContent = '▸';
  } else {
    acc.classList.remove('collapsed');
    body.style.display = '';
    chev.textContent = '▾';
  }
}

// ── Long Press for Recurring ─────────────────────────────────────
let _longPressTimer = null;

function startLongPress(monthKey, type, idx) {
  clearLongPress();
  _longPressTimer = setTimeout(() => {
    openRecurringPopup(monthKey, type, idx);
  }, 600);
}

function clearLongPress() {
  if (_longPressTimer) { clearTimeout(_longPressTimer); _longPressTimer = null; }
}

// ── Recurring Popup ──────────────────────────────────────────────
let _recPopupMonth = null, _recPopupType = null, _recPopupIdx = null;

function openRecurringPopup(monthKey, type, idx) {
  clearLongPress();
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const tx = (data[monthKey]||{})[typeMap[type]]?.[idx];
  if (!tx) return;

  _recPopupMonth = monthKey; _recPopupType = type; _recPopupIdx = idx;

  // Check if rule already exists
  const existing = (data._recurring||[]).find(r => r._sourceMonth === monthKey && r._sourceIdx === idx);
  const typeIcon = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  const dayOfMonth = tx.date ? new Date(tx.date+'T00:00:00').getDate() : 1;

  document.getElementById('recurring-popup-body').innerHTML = `
    <div style="background:#F8F8F8;border-radius:12px;padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:1.4em;">${typeIcon[type]||'💰'}</span>
      <div>
        <div style="font-weight:900;font-size:0.9em;color:var(--text-dark);">${tx.category||'Other'}</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;">${tx.description||''} · ${fmt(convertAmt(tx.amount,tx.currency))}</div>
      </div>
    </div>
    ${existing ? `<div style="background:#FFF0F0;border-radius:10px;padding:10px 12px;margin-bottom:12px;font-size:0.82em;font-weight:700;color:#EF4444;">
      ⚠️ Already recurring — ${existing.frequency} on day ${existing.dayOfMonth}. Save below to update or delete rule.
    </div>` : ''}
    <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;">
      <select id="rec-popup-freq" style="flex:1;background:var(--white);border:1.5px solid #DDD;border-radius:8px;padding:8px 10px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;">
        <option value="monthly" ${(!existing||existing.frequency==='monthly')?'selected':''}>Monthly</option>
        <option value="biweekly" ${existing?.frequency==='biweekly'?'selected':''}>Bi-weekly (every 2 weeks)</option>
        <option value="weekly" ${existing?.frequency==='weekly'?'selected':''}>Weekly</option>
        <option value="yearly" ${existing?.frequency==='yearly'?'selected':''}>Yearly</option>
      </select>
      <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
        <span style="font-size:0.78em;font-weight:800;color:var(--text-med);">Day</span>
        <input type="number" id="rec-popup-day" min="1" max="31"
          value="${existing?.dayOfMonth||dayOfMonth}"
          style="width:55px;background:var(--white);border:1.5px solid #DDD;border-radius:8px;padding:8px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;text-align:center;">
      </div>
    </div>
    <div style="font-size:0.72em;color:var(--text-light);font-weight:600;margin-bottom:14px;">
      Auto-posts every month on this day starting next month
    </div>
    <div style="display:flex;gap:8px;">
      ${existing ? `<button onclick="deleteRecurringFromPopup()" style="flex:1;background:#FFF0F0;border:1.5px solid #FFCDD2;border-radius:10px;padding:10px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;color:#EF4444;cursor:pointer;">🗑 Remove Rule</button>` : ''}
      <button onclick="saveRecurringFromPopup()" style="flex:${existing?1:2};background:var(--primary);border:none;border-radius:10px;padding:10px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;color:white;cursor:pointer;">
        🔁 ${existing?'Update':'Create'} Rule
      </button>
    </div>`;

  const modal = document.getElementById('recurring-popup-modal');
  if (modal) { modal.style.display = 'flex'; modal.classList.add('open'); }
}

function closeRecurringPopup() {
  const modal = document.getElementById('recurring-popup-modal');
  if (modal) { modal.style.display = 'none'; modal.classList.remove('open'); }
  _recPopupMonth = null; _recPopupType = null; _recPopupIdx = null;
}

function saveRecurringFromPopup() {
  const freq = document.getElementById('rec-popup-freq')?.value || 'monthly';
  const day  = parseInt(document.getElementById('rec-popup-day')?.value) || 1;
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const tx = (data[_recPopupMonth]||{})[typeMap[_recPopupType]]?.[_recPopupIdx];
  if (!tx) return;

  if (!data._recurring) data._recurring = [];
  // Remove existing rule for this tx if any
  data._recurring = data._recurring.filter(r => !(r._sourceMonth === _recPopupMonth && r._sourceIdx === _recPopupIdx));
  // Add new rule
  data._recurring.push({
    id: 'rec_' + Date.now(),
    type: _recPopupType,
    category: tx.category || 'Other',
    amount: Math.abs(tx.amount || 0),
    currency: tx.currency || currentCurrency.code,
    description: tx.description || '',
    frequency: freq,
    dayOfMonth: day,
    startMonth: _recPopupMonth,
    startDate: tx.date || `${_recPopupMonth}-${String(day).padStart(2,'0')}`,
    active: true,
    _sourceMonth: _recPopupMonth,
    _sourceIdx: _recPopupIdx,
  });

  save();
  closeRecurringPopup();
  showToast(`🔁 Recurring rule created — posts on day ${day} every month!`);
  renderRecurringRules();
}

function deleteRecurringFromPopup() {
  const rule = (data._recurring||[]).find(r => r._sourceMonth === _recPopupMonth && r._sourceIdx === _recPopupIdx);
  if (!rule) return;
  closeRecurringPopup();
  showRecDeleteModal(
    rule,
    () => {
      data._recurring = (data._recurring||[]).filter(r =>
        !(r._sourceMonth === _recPopupMonth && r._sourceIdx === _recPopupIdx));
      save(); renderRecurringRules(); renderTransactions(); renderHome();
      showToast('⏹ Rule stopped — past entries kept');
    },
    () => {
      const typeMap = { expense:'expenses', income:'income', investment:'investments', debt:'debts', given:'givenToOthers', additional:'additional' };
      const listKey = typeMap[rule.type] || 'expenses';
      Object.keys(data).filter(k => /^\d{4}-\d{2}$/.test(k)).forEach(mk => {
        if (data[mk]?.[listKey])
          data[mk][listKey] = data[mk][listKey].filter(e => !e._recurringId?.startsWith(rule.id));
      });
      data._recurring = (data._recurring||[]).filter(r =>
        !(r._sourceMonth === _recPopupMonth && r._sourceIdx === _recPopupIdx));
      save(); renderRecurringRules(); renderTransactions(); renderHome();
      showToast('🗑 Rule + all auto-posted entries removed');
    }
  );
}

// ── Recurring Transactions Scheduler ────────────────────────────
function runRecurringScheduler() {
  if (!data._recurring || !data._recurring.length) return;
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const todayDay = now.getDate();
  const currentMk = getCurrentMonthKey();
  let posted = 0;
  const typeMap = { expense:'expenses', income:'income', investment:'investments', debt:'debts', given:'givenToOthers', additional:'additional' };

  data._recurring.filter(r => r.active).forEach(rule => {
    if (currentMk < rule.startMonth) return;
    const listKey = typeMap[rule.type] || 'expenses';

    if (rule.frequency === 'biweekly' || rule.frequency === 'weekly') {
      const intervalDays = rule.frequency === 'biweekly' ? 14 : 7;
      const startDate = rule.startDate || (rule.startMonth + '-' + String(rule.dayOfMonth||1).padStart(2,'0'));
      let cursor = new Date(startDate + 'T00:00:00');
      const todayDate = new Date(today + 'T00:00:00');
      while (cursor <= todayDate) {
        const dueMk = cursor.getFullYear() + '-' + String(cursor.getMonth()+1).padStart(2,'0');
        const dueDateStr = localDateStr(cursor);
        const occurrenceId = rule.id + '_' + dueDateStr;
        ensureMonth(dueMk);
        const alreadyPosted = (data[dueMk][listKey]||[]).some(e => e._recurringId === occurrenceId);
        if (!alreadyPosted && dueMk > rule.startMonth) {
          data[dueMk][listKey].push({ date: dueDateStr, category: rule.category, amount: rule.amount,
            currency: rule.currency || currentCurrency.code, description: rule.description || '',
            _recurringId: occurrenceId, _autoPosted: true });
          posted++;
        }
        cursor.setDate(cursor.getDate() + intervalDays);
      }
    } else if (rule.frequency === 'yearly') {
      const sm = parseInt((rule.startMonth||'').split('-')[1]||1);
      const cy = parseInt((currentMk||'').split('-')[0]);
      const dueMk = cy + '-' + String(sm).padStart(2,'0');
      if (dueMk !== currentMk) return;
      if (currentMk <= rule.startMonth) return;
      ensureMonth(currentMk);
      const alreadyPosted = (data[currentMk][listKey]||[]).some(e => e._recurringId === rule.id);
      if (alreadyPosted || todayDay < (rule.dayOfMonth||1)) return;
      const dateStr = currentMk + '-' + String(rule.dayOfMonth||1).padStart(2,'0');
      data[currentMk][listKey].push({ date: dateStr, category: rule.category, amount: rule.amount,
        currency: rule.currency || currentCurrency.code, description: rule.description || '',
        _recurringId: rule.id, _autoPosted: true });
      posted++;
    } else {
      // Monthly (default) — skip the month the rule was created in
      if (currentMk <= rule.startMonth) return;
      ensureMonth(currentMk);
      const alreadyPosted = (data[currentMk][listKey]||[]).some(e => e._recurringId === rule.id);
      if (alreadyPosted || todayDay < (rule.dayOfMonth||1)) return;
      const dateStr = currentMk + '-' + String(rule.dayOfMonth||1).padStart(2,'0');
      data[currentMk][listKey].push({ date: dateStr, category: rule.category, amount: rule.amount,
        currency: rule.currency || currentCurrency.code, description: rule.description || '',
        _recurringId: rule.id, _autoPosted: true });
      posted++;
    }
  });

  if (posted > 0) {
    save();
    showToast('🔁 ' + posted + ' recurring entr' + (posted === 1 ? 'y' : 'ies') + ' auto-posted!');
    renderHome();
    renderTransactions();
  }
}
// ── Recurring Rules Management ───────────────────────────────────
function renderRecurringRules() {
  const el = document.getElementById('recurring-rules-list');
  if (!el) return;
  const rules = data._recurring || [];
  if (rules.length === 0) {
    el.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-light);font-weight:700;font-size:0.85em;">No recurring rules yet.<br>Edit any transaction and toggle 🔁 Make Recurring.</div>`;
    return;
  }
  const typeIcon = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  el.innerHTML = rules.map((r, i) => `
    <div style="background:var(--white);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:12px 14px;display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <div style="font-size:1.4em;flex-shrink:0;">${typeIcon[r.type]||'🔁'}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:900;font-size:0.88em;color:var(--text-dark);">${r.category}</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-top:2px;">
          ${r.description ? r.description + ' · ' : ''}${r.frequency} · day ${r.dayOfMonth}
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-weight:900;font-size:0.92em;color:${r.type==='income'?'var(--income)':'var(--expenses)'};">${fmtConverted(r.amount, r.currency||currentCurrency.code)}</div>
        <div style="font-size:0.68em;font-weight:700;margin-top:2px;">
          <span style="cursor:pointer;color:${r.active?'#10B981':'#EF4444'};" onclick="toggleRecurringRule(${i})">
            ${r.active ? '● Active' : '○ Paused'}
          </span>
        </div>
      </div>
      <button onclick="deleteRecurringRule(${i})"
        style="flex-shrink:0;background:#FFF0F0;border:none;border-radius:8px;width:28px;height:28px;color:#EF4444;font-size:0.85em;cursor:pointer;font-weight:900;">✕</button>
    </div>`).join('');
}

function toggleRecurringRule(idx) {
  if (!data._recurring || !data._recurring[idx]) return;
  data._recurring[idx].active = !data._recurring[idx].active;
  save(); renderRecurringRules();
  showToast(data._recurring[idx].active ? '▶️ Rule activated' : '⏸ Rule paused');
}

function deleteRecurringRule(idx) {
  const rule = data._recurring[idx];
  if (!rule) return;
  showRecDeleteModal(
    rule,
    () => {
      // Stop future only — remove rule, keep history
      data._recurring.splice(idx, 1);
      save(); renderRecurringRules(); renderTransactions(); renderHome();
      showToast('⏹ Rule stopped — past entries kept');
    },
    () => {
      // Remove everything — rule + all auto-posts
      const typeMap = { expense:'expenses', income:'income', investment:'investments', debt:'debts', given:'givenToOthers', additional:'additional' };
      const listKey = typeMap[rule.type] || 'expenses';
      Object.keys(data).filter(k => /^\d{4}-\d{2}$/.test(k)).forEach(mk => {
        if (data[mk]?.[listKey])
          data[mk][listKey] = data[mk][listKey].filter(e => !e._recurringId?.startsWith(rule.id));
      });
      data._recurring.splice(idx, 1);
      save(); renderRecurringRules(); renderTransactions(); renderHome();
      showToast('🗑 Rule + all auto-posted entries removed');
    }
  );
}

// ── Recurring Delete Choice Modal ───────────────────────────────
let _recDeleteOnStop = null, _recDeleteOnAll = null;

function showRecDeleteModal(rule, onStop, onAll) {
  _recDeleteOnStop = onStop;
  _recDeleteOnAll  = onAll;
  const typeIcon = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  const freq = rule.frequency === 'biweekly' ? 'Bi-weekly' :
               rule.frequency === 'weekly'   ? 'Weekly'    :
               rule.frequency === 'yearly'   ? 'Yearly'    : 'Monthly';
  document.getElementById('rec-delete-body').innerHTML = `
    <div style="background:#F8F8F8;border-radius:12px;padding:12px 14px;margin-bottom:16px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:1.4em;">${typeIcon[rule.type]||'🔁'}</span>
      <div>
        <div style="font-weight:900;font-size:0.9em;color:var(--text-dark);">${rule.category}</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;">${freq} · ${fmt(rule.amount)}</div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <button onclick="recDeleteChoice('stop')"
        style="background:#F0FBF3;border:1.5px solid #10B98130;border-radius:12px;padding:14px 16px;text-align:left;cursor:pointer;font-family:Nunito,sans-serif;">
        <div style="font-weight:900;font-size:0.88em;color:#10B981;">⏹ Stop future posts</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-top:3px;">
          Keep all previously auto-posted entries intact
        </div>
      </button>
      <button onclick="recDeleteChoice('all')"
        style="background:#FFF0F0;border:1.5px solid #EF444430;border-radius:12px;padding:14px 16px;text-align:left;cursor:pointer;font-family:Nunito,sans-serif;">
        <div style="font-weight:900;font-size:0.88em;color:#EF4444;">🗑 Remove everything</div>
        <div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-top:3px;">
          Delete rule and all auto-posted entries from all months
        </div>
      </button>
    </div>`;
  const modal = document.getElementById('rec-delete-modal');
  if (modal) { modal.style.display = 'flex'; modal.classList.add('open'); }
}

function recDeleteChoice(choice) {
  closeRecDeleteModal();
  if (choice === 'stop' && _recDeleteOnStop) _recDeleteOnStop();
  if (choice === 'all'  && _recDeleteOnAll)  _recDeleteOnAll();
  _recDeleteOnStop = null; _recDeleteOnAll = null;
}

function closeRecDeleteModal() {
  const modal = document.getElementById('rec-delete-modal');
  if (modal) { modal.style.display = 'none'; modal.classList.remove('open'); }
}

// ── Author Filter ───────────────────────────────────────────────
let _authorChipsOpen = false;

function toggleAuthorChips() {
  _authorChipsOpen = !_authorChipsOpen;
  const slide  = document.getElementById('author-chips-slide');
  const btn    = document.getElementById('author-toggle-btn');
  if (slide) slide.classList.toggle('open', _authorChipsOpen);
  if (btn)   btn.classList.toggle('active', _authorChipsOpen);
  // Reset filter when closing
  if (!_authorChipsOpen && _authorFilter !== 'all') {
    _authorFilter = 'all';
    renderTransactions();
  }
}

function setAuthorFilter(author) {
  _authorFilter = author;
  if (_txSearchActive) {
    // H/E: Re-run active search with new author filter
    const input = document.getElementById('tx-search-input');
    if (input && input.value) {
      onTxSearch(input.value);
      return;
    }
  }
  renderTransactions(); // re-renders chips + day detail
}

// ── Transaction Search ──────────────────────────────────────────
let _txSearchActive = false;
let _authorFilter = 'all'; // 'all' or specific author name

function onTxSearch(q) {
  const clearBtn = document.getElementById('tx-search-clear');
  const resultsEl = document.getElementById('tx-search-results');
  const calWrap = document.getElementById('cal-grid-wrap');
  const listView = document.getElementById('cal-list-view');
  const dayWrap = document.getElementById('cal-day-detail-wrap');
  const header = document.getElementById('cal-month-title')?.closest('.cal-header');

  q = (q || '').trim().toLowerCase();
  _txSearchActive = !!q;

  if (clearBtn) clearBtn.style.display = q ? '' : 'none';

  if (!q) {
    // Restore calendar
    if (calWrap) calWrap.style.display = '';
    if (listView) listView.style.display = 'none';
    if (dayWrap) dayWrap.style.display = '';
    if (resultsEl) resultsEl.style.display = 'none';
    // Restore summary to current month totals
    renderTransactions();
    return;
  }

  // Hide calendar, show results
  if (calWrap) calWrap.style.display = 'none';
  if (listView) listView.style.display = 'none';
  if (dayWrap) dayWrap.style.display = 'none';
  if (resultsEl) resultsEl.style.display = '';

  // Search ALL months
  const typeMap = { expenses:'expense', income:'income', investments:'investment', debts:'debt', givenToOthers:'given', additional:'additional' };
  const iconMap = { expense:'💸', income:'💵', investment:'📈', debt:'📉', given:'🤝', additional:'🎁' };
  const colorMap = { expense:'#EF4444', income:'#10B981', investment:'#7C3AED', debt:'#8B5CF6', given:'#FF6B9D', additional:'#F59E0B' };
  const bgMap = { expense:'#EF444415', income:'#10B98115', investment:'#7C3AED15', debt:'#8B5CF615', given:'#FF6B9D15', additional:'#F59E0B15' };

  let results = [];
  Object.keys(data).filter(mk => /^\d{4}-\d{2}$/.test(mk)).sort().reverse().forEach(mk => {
    const m = data[mk];
    ['expenses','income','investments','debts','givenToOthers','additional'].forEach(listKey => {
      (m[listKey] || []).forEach((e, idx) => {
        const cat  = (e.category    || '').toLowerCase();
        const desc = (e.description || '').toLowerCase();
        const amt  = String(e.amount || '');
        if (cat.includes(q) || desc.includes(q) || amt.includes(q)) {
          results.push({ ...e, _month: mk, _type: typeMap[listKey], _idx: idx });
        }
      });
    });
  });
  // Apply family author filter on top of search if active
  if (_authorFilter !== 'all') {
    results = results.filter(r => r._addedBy === _authorFilter);
  }

  // ── Update summary bar to reflect search results ──
  const _srInc = results.filter(r => r._type === 'income').reduce((s,r) => s + convertAmt(r.amount, r.currency), 0);
  const _srExp = results.filter(r => r._type === 'expense').reduce((s,r) => s + convertAmt(r.amount, r.currency), 0);
  const _srInv = results.filter(r => r._type === 'investment').reduce((s,r) => s + convertAmt(r.amount, r.currency), 0);
  const _srNet = _srInc - _srExp - _srInv;
  const _elInc = document.getElementById('cal-total-income');
  const _elExp = document.getElementById('cal-total-expense');
  const _elSav = document.getElementById('cal-total-savings');
  const _elNet = document.getElementById('cal-total-net');
  if (_elInc) _elInc.textContent = fmt(_srInc);
  if (_elExp) _elExp.textContent = fmt(_srExp);
  if (_elSav) { _elSav.textContent = fmt(_srInv); _elSav.style.color = '#7C3AED'; }
  if (_elNet) {
    _elNet.textContent = (_srNet >= 0 ? '+' : '-') + fmt(Math.abs(_srNet));
    _elNet.style.color = _srNet >= 0 ? 'var(--income)' : 'var(--expenses)';
  }

  if (results.length === 0) {
    resultsEl.innerHTML = `<div style="text-align:center;padding:32px;color:var(--text-light);font-weight:700;font-size:0.9em;">
      No transactions found for "<strong>${q}</strong>"</div>`;
    return;
  }

  // Group by month for context
  const byMonth = {};
  results.forEach(r => {
    if (!byMonth[r._month]) byMonth[r._month] = [];
    byMonth[r._month].push(r);
  });

  const authorTag = _authorFilter !== 'all' ? ` · 👤 ${_authorFilter}` : '';
  resultsEl.innerHTML = `
    <div style="font-size:0.78em;font-weight:800;color:var(--text-light);margin-bottom:10px;padding:0 2px;">
      ${results.length} result${results.length !== 1 ? 's' : ''} across ${Object.keys(byMonth).length} month${Object.keys(byMonth).length !== 1 ? 's' : ''}${authorTag}
    </div>` +
    Object.keys(byMonth).sort().reverse().map(mk => `
      <div style="margin-bottom:14px;">
        <div style="font-weight:900;font-size:0.82em;color:var(--text-med);margin-bottom:6px;padding:0 2px;">
          📅 ${getDisplayMonth(mk)}
        </div>
        ${byMonth[mk].map(t => {
          const d = t.date ? new Date(t.date+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
          const amt = convertAmt(t.amount, t.currency);
          return `<div style="background:var(--white);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);
                              padding:11px 14px;margin-bottom:6px;">
            <div style="display:flex;align-items:center;gap:11px;">
              <div style="width:38px;height:38px;border-radius:11px;background:${bgMap[t._type]||'#eee'};
                          display:flex;align-items:center;justify-content:center;font-size:1.1em;flex-shrink:0;">
                ${iconMap[t._type]||'💰'}
              </div>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:900;font-size:0.88em;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                  ${t.category || 'Other'}
                </div>
                <div style="font-size:0.73em;color:var(--text-light);font-weight:600;margin-top:2px;">
                  ${d}${t.description ? ' · ' + t.description : ''}
                </div>
              </div>
              <div style="font-weight:900;font-size:0.92em;color:${t._type==='income'?'var(--income)':'var(--expenses)'};flex-shrink:0;">
                ${t._type==='income'?'+':'-'}${fmt(amt)}
              </div>
            </div>
            <div style="display:flex;gap:6px;margin-top:8px;justify-content:flex-end;">
              <button onclick="searchEditTx('${t._month}','${t._type}',${t._idx})"
                style="background:#F0F4FF;border:none;border-radius:8px;padding:5px 12px;font-size:0.72em;font-weight:800;color:var(--primary);cursor:pointer;">✏️ Edit</button>
              <button data-month="${t._month}" data-type="${t._type}" data-idx="${t._idx}" data-amt="${Math.abs(Number(t.amount||0))}" data-cat="${(t.category||'').replace(/"/g,'&quot;')}"
                onclick="searchDeleteTxByEl(this)"
                style="background:#FFF0F0;border:none;border-radius:8px;padding:5px 12px;font-size:0.72em;font-weight:800;color:var(--expenses);cursor:pointer;">✕ Delete</button>
            </div>
          </div>`;
        }).join('')}
      </div>`
    ).join('');
}

function searchEditTx(monthKey, type, idx) {
  // Navigate to the transaction screen and open edit modal directly
  clearTxSearch();
  viewMonth = monthKey;
  calSelectedDay = null;
  renderTransactions();
  setTimeout(() => openEditTx(monthKey, type, idx), 150);
}

function searchDeleteTxByEl(btn) {
  const monthKey = btn.dataset.month;
  const type = btn.dataset.type;
  const idx = parseInt(btn.dataset.idx);
  const amt = parseFloat(btn.dataset.amt);
  const cat = btn.dataset.cat;
  searchDeleteTx(monthKey, type, idx, amt, cat);
}

function searchDeleteTx(monthKey, type, snapshotIdx, snapshotAmt, snapshotCat) {
  // Use snapshot values to verify we're deleting the right item
  // Re-find by matching category+amount+approximate index for safety
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const listKey = typeMap[type];
  if (!listKey || !data[monthKey] || !data[monthKey][listKey]) return;
  // Re-resolve current index: find item matching the snapshot fingerprint
  const list = data[monthKey][listKey];
  let resolvedIdx = -1;
  // First try exact match by category+amount at stored index (fast path)
  if (list[snapshotIdx] &&
      String(list[snapshotIdx].category) === String(snapshotCat) &&
      Math.abs(Number(list[snapshotIdx].amount)) === Math.abs(Number(snapshotAmt))) {
    resolvedIdx = snapshotIdx;
  } else {
    // Fallback: search entire list for matching item
    resolvedIdx = list.findIndex(t =>
      String(t.category) === String(snapshotCat) &&
      Math.abs(Number(t.amount)) === Math.abs(Number(snapshotAmt))
    );
  }
  if (resolvedIdx < 0) { showToast('Transaction not found — may already be deleted'); return; }
  const tx = list[resolvedIdx];
  if (!confirm(`Delete "${tx.category}" · ${fmtConverted(Math.abs(tx.amount), tx.currency||currentCurrency.code)}?`)) return;
  // If metal-linked — also remove the _metals entry
  if (tx._qaLinkId && data._metals) {
    const mi = data._metals.findIndex(m => m._qaLinkId === tx._qaLinkId);
    if (mi >= 0) data._metals.splice(mi, 1);
  }
  list.splice(resolvedIdx, 1);
  save();
  renderHome(); renderMetals(); renderNetWorth();
  showToast('🗑 Deleted');
  const input = document.getElementById('tx-search-input');
  if (input && input.value) onTxSearch(input.value);
}

function listEditTx(monthKey, type, idx) {
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const tx = data[monthKey] && data[monthKey][typeMap[type]] && data[monthKey][typeMap[type]][idx];
  if (!tx) return;
  // Switch to calendar mode, set the selected day, then open the edit sheet
  calSelectedDay = tx.date || null;
  viewMonth = monthKey;
  setCalView('calendar'); // correct function name
  setTimeout(() => openEditTx(monthKey, type, idx), 100);
}
function listDeleteTx(monthKey, type, idx) {
  const typeMap = {expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const listKey = typeMap[type];
  if (!data[monthKey] || !data[monthKey][listKey]) return;
  const tx = data[monthKey][listKey][idx];
  if (!tx) return;
  if (!confirm(`Delete "${tx.category}" · ${fmtConverted(Math.abs(tx.amount), tx.currency||currentCurrency.code)}?`)) return;
  // If metal-linked — also remove the _metals entry
  if (tx._qaLinkId && data._metals) {
    const mi = data._metals.findIndex(m => m._qaLinkId === tx._qaLinkId);
    if (mi >= 0) data._metals.splice(mi, 1);
  }
  data[monthKey][listKey].splice(idx, 1);
  save(); renderHome(); renderMetals(); renderNetWorth();
  showToast('🗑 Deleted');
  const lv = document.getElementById('cal-list-view');
  if (lv && lv.style.display !== 'none') renderCalListView(lv);
}

function clearTxSearch() {
  const input = document.getElementById('tx-search-input');
  if (input) { input.value = ''; onTxSearch(''); input.focus(); }
}

function calSelectDay(dateStr) {
  calSelectedDay = calSelectedDay === dateStr ? null : dateStr;
  // scroll detail into view smoothly
  if(calSelectedDay) {
    setTimeout(()=>{ const el=document.getElementById('cal-day-detail'); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'}); }, 80);
  }
  renderTransactions();
}

function renderCalDayDetail(allTx) {
  const detail = document.getElementById('cal-day-detail');
  if(!detail) return;
  if(!calSelectedDay) { detail.innerHTML=''; return; }

  const dayTx = (allTx||[]).filter(t => t.date === calSelectedDay);
  let d; try { d = new Date(calSelectedDay+'T00:00:00'); } catch(e){ d = new Date(); }
  const dateLabel = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const dayIn  = dayTx.filter(t=>t._type==='income').reduce((s,t)=>s+convertAmt(t.amount,t.currency),0);
  const dayOut = dayTx.filter(t=>t._type!=='income').reduce((s,t)=>s+convertAmt(t.amount,t.currency),0);
  const net    = dayIn - dayOut;

  if(dayTx.length === 0) {
    detail.innerHTML=`<div class="cal-empty-day">
      <div style="font-size:1.8em;margin-bottom:8px;">🗓</div>
      <div style="font-weight:800;font-size:0.95em;color:var(--text-dark);">${dateLabel}</div>
      <div style="font-size:0.82em;margin-top:6px;color:var(--text-light);">No transactions recorded</div>
      <button onclick="openQuickAdd('expense',null)" style="margin-top:12px;background:var(--yellow);border:none;border-radius:12px;padding:8px 18px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;cursor:pointer;">+ Add one</button>
    </div>`;
    return;
  }

  const typeLabel = {expense:'Expense',income:'Income',investment:'Investment',debt:'Debt',given:'Given',additional:'Additional'};
  const iconMap   = {expense:'💸',income:'💵',investment:'📈',debt:'📉',given:'🤝',additional:'🎁'};
  const bgMap     = {expense:'#EF444415',income:'#10B98115',investment:'#7C3AED15',debt:'#8B5CF615',given:'#FF6B9D15',additional:'#F59E0B15'};
  const colorMap  = {expense:'#EF4444',income:'#10B981',investment:'#7C3AED',debt:'#8B5CF6',given:'#FF6B9D',additional:'#F59E0B'};
  // Amounts: income green plain, everything else red plain — no misleading signs
  const amtColor  = t => t._type==='income' ? 'var(--income)' : 'var(--expenses)';

  detail.innerHTML=`
    <!-- Day summary strip -->
    <div style="background:var(--white);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:14px 16px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div>
          <div style="font-weight:900;font-size:1em;color:var(--text-dark);">${dateLabel}</div>
          <div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-top:2px;">${dayTx.length} transaction${dayTx.length===1?'':'s'}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:0.72em;font-weight:800;color:var(--text-light);margin-bottom:2px;">NET</div>
          <div style="font-size:1.1em;font-weight:900;color:${net>=0?'var(--income)':'var(--expenses)'};">${net>=0?'+':'−'}${fmt(Math.abs(net))}</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;">
        ${dayIn>0?`<div style="flex:1;background:#F0FBF3;border-radius:10px;padding:8px 10px;text-align:center;"><div style="font-size:0.68em;font-weight:800;color:var(--income);margin-bottom:2px;">IN</div><div style="font-weight:900;font-size:0.95em;color:var(--income);">+${fmt(dayIn)}</div></div>`:''}
        ${dayOut>0?`<div style="flex:1;background:#FFF0F0;border-radius:10px;padding:8px 10px;text-align:center;"><div style="font-size:0.68em;font-weight:800;color:var(--expenses);margin-bottom:2px;">OUT</div><div style="font-weight:900;font-size:0.95em;color:var(--expenses);">−${fmt(dayOut)}</div></div>`:''}
      </div>
    </div>

    <!-- Transaction rows — view only, ✕ to delete -->
    <div style="display:flex;flex-direction:column;gap:8px;">
      ${dayTx.filter(t => _authorFilter === 'all' || t._addedBy === _authorFilter).map(t=>`
        <div style="background:var(--white);border-radius:var(--radius-sm);box-shadow:0 2px 10px rgba(0,0,0,0.06);padding:12px 14px;display:flex;align-items:center;gap:12px;">
          <!-- Icon — long press for recurring -->
          <div
            ontouchstart="startLongPress('${viewMonth}','${t._type}',${t._idx})"
            ontouchend="clearLongPress()" ontouchmove="clearLongPress()"
            oncontextmenu="event.preventDefault();openRecurringPopup('${viewMonth}','${t._type}',${t._idx})"
            title="Hold for recurring"
            style="width:42px;height:42px;border-radius:13px;background:${bgMap[t._type]||'#eee'};border:1.5px solid ${colorMap[t._type]||'#ccc'}22;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;cursor:pointer;user-select:none;">${iconMap[t._type]||'💰'}</div>
          <!-- Info -->
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
              <span style="font-weight:900;font-size:0.9em;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.category||'Other'}</span>
              <span style="font-size:0.65em;font-weight:800;color:${colorMap[t._type]};background:${bgMap[t._type]};border-radius:20px;padding:2px 7px;flex-shrink:0;">${typeLabel[t._type]||t._type}</span>
            </div>
            <div style="font-size:0.78em;color:var(--text-light);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.description||'—'}</div>
            ${t._addedBy && t._addedBy !== 'You' ? `<div style="font-size:0.65em;color:#A0A8C0;font-weight:700;margin-top:1px;">👤 ${t._addedBy}</div>` : ''}
          </div>
          <!-- Amount -->
          <div style="text-align:right;flex-shrink:0;">
            <div style="font-size:1em;font-weight:900;color:${amtColor(t)};">${fmtConvertedFull(t.amount,t.currency)}</div>
            ${t.currency&&t.currency!==currentCurrency.code?`<div style="font-size:0.65em;color:var(--text-light);font-weight:700;">${t.currency} ${Number(t.amount||0).toFixed(2)}</div>`:''}
          </div>
          <!-- Edit + Delete -->
          <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;">
            <button
              onclick="openEditTx('${viewMonth}','${t._type}',${t._idx})"
              style="background:#FFF8DC;border:none;border-radius:8px;width:28px;height:28px;color:#D4A000;font-size:0.8em;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:900;">✏️</button>
            <button onclick="calDeleteTx('${viewMonth}','${t._type}',${t._idx})"
              style="background:#FFF0F0;border:none;border-radius:8px;width:28px;height:28px;color:#EF4444;font-size:0.8em;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:900;">✕</button>
          </div>
        </div>`).join('')}
    </div>
  `;
}

function calDeleteTx(monthKey, type, idx) {
  if(!confirm('Delete this transaction?')) return;
  const typeMap={expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  data[monthKey][typeMap[type]].splice(idx,1);
  save(); renderTransactions(); renderHome(); showToast('Transaction deleted');
}

function setTxFilter(filter, el) { /* legacy – no-op in calendar view */ }

function deleteTx(monthKey, type, idx) {
  if(!confirm('Delete this transaction?')) return;
  const typeMap={expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const listKey = typeMap[type];
  const tx = data[monthKey] && data[monthKey][listKey] && data[monthKey][listKey][idx];
  // If metal-linked investment — also remove the paired _metals entry
  if (tx && tx._qaLinkId && data._metals) {
    const mi = data._metals.findIndex(m => m._qaLinkId === tx._qaLinkId);
    if (mi >= 0) data._metals.splice(mi, 1);
  }
  data[monthKey][listKey].splice(idx,1);
  save(); renderTransactions(); renderHome(); renderMetals(); renderNetWorth();
  showToast('🗑 Transaction deleted');
}

// ══════════════════════════════════════════════════════
// ADD SCREEN (full screen add)
// ══════════════════════════════════════════════════════
function renderAddScreen() {
  document.getElementById('add-date').value = localDateStr();
  renderNumpad(); renderSubCats();
}

function setAddType(type, btn) {
  currentAddType=type; currentAmountStr=''; updateAmountDisplay();
  document.querySelectorAll('.add-type-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderSubCats();
}

function renderSubCats() {
  const cats=getCatsForType(currentAddType);
  selectedSubCat=cats[0]||'';
  document.getElementById('sub-cats-row').innerHTML=cats.map(c=>`<div class="sub-cat-pill ${c===selectedSubCat?'active':''}" onclick="selectSubCat('${c}',this)">${c}</div>`).join('');
}
function selectSubCat(cat,el) { selectedSubCat=cat; document.querySelectorAll('.sub-cat-pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); }

function renderNumpad() {
  const keys=['7','8','9','⌫','4','5','6','%','1','2','3','÷','$','0','.','='];
  document.getElementById('numpad-grid').innerHTML=keys.map(k=>`<button class="num-btn ${['⌫','%','÷'].includes(k)?'special':''} ${k==='='?'save-btn':''}" onclick="handleNumpad('${k}')">${k}</button>`).join('');
}

function handleNumpad(key) {
  if(key==='⌫'){currentAmountStr=currentAmountStr.slice(0,-1);}
  else if(key==='='){saveTransaction();return;}
  else if(key==='$'){currentAmountStr='';}
  else if(['%','÷'].includes(key)){}
  else{if(currentAmountStr.includes('.')&&key==='.') return; if(currentAmountStr.length>=10) return; currentAmountStr+=key;}
  updateAmountDisplay();
}
function updateAmountDisplay() { document.getElementById('add-amount-display').textContent=currentAmountStr||'0'; }

function saveTransaction() {
  const amount=parseFloat(currentAmountStr);
  if(!amount||amount<=0){showToast('Enter an amount',2000);return;}
  const date=document.getElementById('add-date').value||localDateStr();
  const note=document.getElementById('add-note').value.trim();
  const monthKey=getMonthKey(date)||getCurrentMonthKey();
  ensureMonth(monthKey);
  const typeMap={expense:'expenses',income:'income',investment:'investments',debt:'debts',given:'givenToOthers',additional:'additional'};
  const entry={date:normalizeDate(date),category:selectedSubCat||'Other',amount,description:note,currency:currentCurrency.code};
  data[monthKey][typeMap[currentAddType]].push(entry);
  save(); currentAmountStr=''; updateAmountDisplay();
  document.getElementById('add-note').value='';
  showToast(`Saved! ✅`);
  if(monthKey===viewMonth) renderHome();
}

// ══════════════════════════════════════════════════════
// ACCOUNT SCREEN
// ══════════════════════════════════════════════════════
function getAccountsList() {
  if(!data._accounts) data._accounts=[{id:'1',name:'Cash',type:'Cash',balance:1000},{id:'2',name:'Paypal',type:'Debit',balance:1500},{id:'3',name:'Bank',type:'Debit',balance:5000}];
  return data._accounts;
}
function renderAccount() {
  const accounts=getAccountsList();
  let totalAssets=0, totalDebt=0;
  accounts.forEach(a=>{ if(a.type==='Credit') totalDebt+=Math.abs(Number(a.balance||0)); else totalAssets+=Number(a.balance||0); });
  document.getElementById('nw-amount').textContent=fmt(totalAssets-totalDebt);
  document.getElementById('nw-assets').textContent=fmt(totalAssets);
  document.getElementById('nw-liabilities').textContent='-'+fmt(totalDebt);
  const accIcons={Debit:'🏦',Cash:'💵',Investment:'📈',Credit:'💳'};
  const renderGrid=list=>list.map(a=>`<div class="account-card ${a.type==='Credit'?'credit':''}" onclick="editAccount('${a.id}')"><div class="acc-icon">${accIcons[a.type]||'💰'}</div><div class="acc-name">${a.name}</div><div class="acc-amount">${a.type==='Credit'?'-':''}${fmt(a.balance||0)}</div></div>`).join('');
  document.getElementById('account-assets-grid').innerHTML=renderGrid(accounts.filter(a=>a.type!=='Credit'))||'<p style="color:var(--text-light);font-size:0.85em;padding:8px;">No assets yet</p>';
  document.getElementById('account-debts-grid').innerHTML=renderGrid(accounts.filter(a=>a.type==='Credit'))||'<p style="color:var(--text-light);font-size:0.85em;padding:8px;">No liabilities</p>';
}
function showAddAccountModal() { document.getElementById('acc-name-input').value=''; document.getElementById('acc-balance-input').value=''; document.getElementById('add-account-modal').classList.add('open'); }
function saveAccount() {
  const name=document.getElementById('acc-name-input').value.trim(), type=document.getElementById('acc-type-input').value, balance=parseFloat(document.getElementById('acc-balance-input').value)||0;
  if(!name){showToast('Enter account name');return;}
  if(!data._accounts) data._accounts=[];
  data._accounts.push({id:Date.now().toString(),name,type,balance});
  save(); closeModal('add-account-modal'); renderAccount(); showToast('Account added!');
}
function editAccount(id) { const acc=getAccountsList().find(a=>a.id===id); if(!acc) return; const nb=prompt(`Balance for ${acc.name}:`,acc.balance); if(nb===null) return; acc.balance=parseFloat(nb)||0; save(); renderAccount(); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ══════════════════════════════════════════════════════
// DATA SCREEN
// ══════════════════════════════════════════════════════
function populateDataMonthSelect() {
  const sel=document.getElementById('data-month-select');
  const cur=sel.value;
  const currentKey=getCurrentMonthKey();
  sel.innerHTML='';
  let opt=document.createElement('option'); opt.value=currentKey; opt.textContent='Current: '+getDisplayMonth(currentKey); sel.appendChild(opt);
  Object.keys(data).filter(k=>!k.startsWith('_')&&k!==currentKey).sort((a,b)=>b.localeCompare(a)).forEach(key=>{
    opt=document.createElement('option'); opt.value=key; opt.textContent=getDisplayMonth(key); sel.appendChild(opt);
  });
  if(cur&&[...sel.options].some(o=>o.value===cur)) sel.value=cur; else sel.value=currentKey;
}

function getDataEffectiveEntries(type) {
  const selectedMonth=document.getElementById('data-month-select').value;
  const startDate=document.getElementById('data-filter-start').value;
  const endDate=document.getElementById('data-filter-end').value;
  const isGlobal=!!(startDate||endDate);
  let list=[];
  if(isGlobal){
    Object.keys(data).forEach(mKey=>{ if(data[mKey][type]) data[mKey][type].forEach((e,i)=>list.push({...e,_month:mKey,_idx:i})); });
  } else {
    ensureMonth(selectedMonth);
    (data[selectedMonth][type]||[]).forEach((e,i)=>list.push({...e,_month:selectedMonth,_idx:i}));
  }
  return list.filter(e=>{ if(!isGlobal) return true; if(!e.date) return true; if(startDate&&e.date<startDate) return false; if(endDate&&e.date>endDate) return false; return true; });
}

function dataSortEntries(entries, type) {
  let col=null, dir='asc';
  Object.keys(dataSortState).forEach(k=>{ if(k.startsWith(type+'-')){col=k.split('-').slice(1).join('-');dir=dataSortState[k];} });
  if(!col) return entries;
  return [...entries].sort((a,b)=>{
    let va,vb;
    if(col==='date'){va=new Date(a.date||'1900-01-01');vb=new Date(b.date||'1900-01-01');}
    else if(['amount','weightGms','purchaseValue','currentValue'].includes(col)){va=parseFloat(a[col]||0);vb=parseFloat(b[col]||0);}
    else{va=String(a[col]||'').toLowerCase();vb=String(b[col]||'').toLowerCase();}
    return dir==='asc'?(va>vb?1:-1):(va<vb?1:-1);
  });
}
function toggleDataSort(type, col) { const k=`${type}-${col}`; dataSortState[k]=(!dataSortState[k]||dataSortState[k]==='desc')?'asc':'desc'; renderDataScreen(); }
function sortArrow(type,col){const k=`${type}-${col}`;return dataSortState[k]==='asc'?' ↑':dataSortState[k]==='desc'?' ↓':' ↕';}

function renderDataStandardSection(type, label, icon, color) {
  const selectedMonth=document.getElementById('data-month-select').value;
  let entries=dataSortEntries(getDataEffectiveEntries(type),type);
  const total=entries.reduce((s,r)=>s+Number(r.amount||0),0);
  return `<div class="data-section">
    <div class="data-section-header" onclick="this.nextElementSibling.classList.toggle('open')">
      <div class="data-section-title">${icon} ${label} <span style="background:#F0F0F0;border-radius:20px;padding:2px 8px;font-size:0.82em;font-weight:700;color:var(--text-light);">${entries.length}</span></div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="data-section-total" style="color:${color};">$${total.toFixed(2)}</span>
        <button class="icon-btn danger" onclick="clearDataSection('${selectedMonth}','${type}');event.stopPropagation();">🗑️</button>
        <button class="icon-btn" onclick="exportDataCategory('${type}');event.stopPropagation();">📥</button>
      </div>
    </div>
    <div class="data-section-body">
      ${entries.length ? `<div class="data-table-wrap"><table class="data-table">
        <thead><tr>
          <th onclick="toggleDataSort('${type}','date')">Date${sortArrow(type,'date')}</th>
          <th onclick="toggleDataSort('${type}','category')">Category${sortArrow(type,'category')}</th>
          <th onclick="toggleDataSort('${type}','amount')">Amount${sortArrow(type,'amount')}</th>
          <th onclick="toggleDataSort('${type}','description')">Description${sortArrow(type,'description')}</th>
          <th>Action</th>
        </tr></thead>
        <tbody>${entries.map(row=>`<tr>
          <td contenteditable="true" onblur="updateDataStandard('${row._month}','${type}',${row._idx},'date',this.textContent)">${row.date}</td>
          <td contenteditable="true" onblur="updateDataStandard('${row._month}','${type}',${row._idx},'category',this.textContent)">${row.category}</td>
          <td contenteditable="true" onblur="updateDataStandard('${row._month}','${type}',${row._idx},'amount',this.textContent)" style="color:${Number(row.amount)<0?'var(--expenses)':'inherit'};">$${Number(row.amount).toFixed(2)}</td>
          <td contenteditable="true" onblur="updateDataStandard('${row._month}','${type}',${row._idx},'description',this.textContent)">${row.description||''}</td>
          <td><button class="del-btn-sm" onclick="removeDataEntry('${row._month}','${type}',${row._idx})">×</button></td>
        </tr>`).join('')}</tbody>
      </table></div>` : '<div style="text-align:center;padding:24px;color:var(--text-light);font-weight:700;">No entries</div>'}
      <div class="quick-add-row">
        <input type="date" class="qa-input" id="qa-date-${type}" style="min-width:110px;flex:0;">
        <input type="text" list="catlist" class="qa-input" id="qa-cat-${type}" placeholder="Category">
        <input type="number" class="qa-input" id="qa-amt-${type}" placeholder="Amount" step="0.01" style="max-width:110px;">
        <input type="text" class="qa-input" id="qa-desc-${type}" placeholder="Description">
        <button class="qa-btn" onclick="addDataRow('${selectedMonth}','${type}')">+ Add</button>
      </div>
      <div class="import-panel">
        <div class="import-panel-title">📥 Import — Paste: date category amount description</div>
        <textarea class="paste-area" id="paste-${type}"></textarea>
        <div class="import-controls">
          <button class="icon-btn" onclick="parsePaste('${selectedMonth}','${type}')">Import Text</button>
          <input type="file" id="file-${type}" accept=".csv,.xlsx" style="font-size:0.82em;">
          <button class="icon-btn" onclick="importFile('${selectedMonth}','${type}')">Import File</button>
        </div>
      </div>
    </div>
  </div>`;
}

function renderDataMetalsSection() {
  const selectedMonth=document.getElementById('data-month-select').value;
  let entries=getDataEffectiveEntries('metals');
  const weights={};
  entries.forEach(e=>{ const t=(e.metalType||'Gold').trim(); weights[t]=(weights[t]||0)+(Number(e.weightGms)||0); });
  const summary=Object.keys(weights).length?Object.entries(weights).map(([k,v])=>`<b>${k}</b>: ${v.toFixed(2)}g`).join(' | '):'No Data';
  return `<div class="data-section">
    <div class="data-section-header" onclick="this.nextElementSibling.classList.toggle('open')">
      <div class="data-section-title">🥇 Metals <small style="opacity:0.7;font-size:0.85em;">(${entries.length})</small></div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:0.8em;font-weight:700;color:var(--text-med);">${summary}</span>
        <button class="icon-btn danger" onclick="clearDataSection('${selectedMonth}','metals');event.stopPropagation();">🗑️</button>
        <button class="icon-btn" onclick="exportDataCategory('metals');event.stopPropagation();">📥</button>
      </div>
    </div>
    <div class="data-section-body">
      ${entries.length?`<div class="data-table-wrap"><table class="data-table">
        <thead><tr><th>Metal</th><th>Purity</th><th>Occasion</th><th>Item</th><th>Weight</th><th>Action</th></tr></thead>
        <tbody>${entries.map(row=>`<tr>
          <td contenteditable="true" onblur="updateDataMetal('${row._month}',${row._idx},'metalType',this.textContent)">${row.metalType||''}</td>
          <td contenteditable="true" onblur="updateDataMetal('${row._month}',${row._idx},'purity',this.textContent)">${row.purity||''}</td>
          <td contenteditable="true" onblur="updateDataMetal('${row._month}',${row._idx},'occasion',this.textContent)">${row.occasion||''}</td>
          <td contenteditable="true" onblur="updateDataMetal('${row._month}',${row._idx},'itemName',this.textContent)">${row.itemName||''}</td>
          <td contenteditable="true" onblur="updateDataMetal('${row._month}',${row._idx},'weightGms',this.textContent)">${row.weightGms||0}g</td>
          <td><button class="del-btn-sm" onclick="removeDataEntry('${row._month}','metals',${row._idx})">×</button></td>
        </tr>`).join('')}</tbody>
      </table></div>`:'<div style="text-align:center;padding:24px;color:var(--text-light);font-weight:700;">No metals</div>'}
      <div class="quick-add-row">
        <select class="qa-input" id="qa-metal-type" style="max-width:100px;"><option>Gold</option><option>Silver</option><option>Platinum</option></select>
        <input type="text" class="qa-input" id="qa-metal-purity" placeholder="Purity">
        <input type="text" class="qa-input" id="qa-metal-occasion" placeholder="Occasion">
        <input type="text" class="qa-input" id="qa-metal-item" placeholder="Item Name">
        <input type="number" class="qa-input" id="qa-metal-weight" placeholder="Weight (g)" style="max-width:100px;">
        <button class="qa-btn" onclick="addDataMetalRow('${selectedMonth}')">+ Add</button>
      </div>
    </div>
  </div>`;
}

function renderDataRealEstateSection() {
  const selectedMonth=document.getElementById('data-month-select').value;
  let entries=getDataEffectiveEntries('realEstate');
  const totals={};
  entries.forEach(r=>{ const c=(r.currency||'USD').toUpperCase(); if(!totals[c]) totals[c]={p:0,cv:0}; totals[c].p+=Number(r.purchaseValue||0); totals[c].cv+=Number(r.currentValue||0); });
  const summary=Object.entries(totals).length?Object.entries(totals).map(([c,v])=>`<b>${c}</b>: Inv ${getCompactNum(v.p)} / Cur ${getCompactNum(v.cv)}`).join(' | '):'No Data';
  return `<div class="data-section">
    <div class="data-section-header" onclick="this.nextElementSibling.classList.toggle('open')">
      <div class="data-section-title">🏡 Real Estate <small style="opacity:0.7;font-size:0.85em;">(${entries.length})</small></div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:0.8em;font-weight:700;color:var(--text-med);">${summary}</span>
        <button class="icon-btn danger" onclick="clearDataSection('${selectedMonth}','realEstate');event.stopPropagation();">🗑️</button>
        <button class="icon-btn" onclick="exportDataCategory('realEstate');event.stopPropagation();">📥</button>
      </div>
    </div>
    <div class="data-section-body">
      ${entries.length?`<div class="data-table-wrap"><table class="data-table">
        <thead><tr><th>Date</th><th>Country</th><th>Currency</th><th>Purchase</th><th>Description</th><th>Area</th><th>Current Value</th><th>Action</th></tr></thead>
        <tbody>${entries.map(row=>{const sym=getCurrencySymbol(row.currency);return`<tr>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'date',this.textContent)">${row.date}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'country',this.textContent)">${row.country||''}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'currency',this.textContent)">${row.currency||'USD'}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'purchaseValue',this.textContent)">${sym}${Number(row.purchaseValue||0).toLocaleString()}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'description',this.textContent)">${row.description||''}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'areaCents',this.textContent)">${row.areaCents||0}</td>
          <td contenteditable="true" onblur="updateDataRealEstate('${row._month}',${row._idx},'currentValue',this.textContent)">${sym}${Number(row.currentValue||0).toLocaleString()}</td>
          <td><button class="del-btn-sm" onclick="removeDataEntry('${row._month}','realEstate',${row._idx})">×</button></td>
        </tr>`;}).join('')}</tbody>
      </table></div>`:'<div style="text-align:center;padding:24px;color:var(--text-light);font-weight:700;">No entries</div>'}
      <div class="quick-add-row">
        <input type="date" class="qa-input" id="qa-re-date" style="min-width:110px;flex:0;">
        <select class="qa-input" id="qa-re-country" style="max-width:90px;"><option value="US">US</option><option value="India">India</option></select>
        <select class="qa-input" id="qa-re-currency" style="max-width:80px;"><option>USD</option><option>INR</option></select>
        <input type="number" class="qa-input" id="qa-re-purchase" placeholder="Purchase Value">
        <input type="text" class="qa-input" id="qa-re-desc" placeholder="Description">
        <input type="number" class="qa-input" id="qa-re-area" placeholder="Area">
        <input type="number" class="qa-input" id="qa-re-current" placeholder="Current Value">
        <button class="qa-btn" onclick="addDataRealEstateRow('${selectedMonth}')">+ Add</button>
      </div>
    </div>
  </div>`;
}

function renderDataScreen() {
  document.getElementById('data-sections').innerHTML=[
    renderDataStandardSection('income','Income','💵','#10B981'),
    renderDataStandardSection('expenses','Expenses','💸','#EF4444'),
    renderDataStandardSection('investments','Investments','💎','#7C3AED'),
    renderDataRealEstateSection(),
    renderDataMetalsSection(),
    renderDataStandardSection('additional','Additional','🎁','#F59E0B'),
    renderDataStandardSection('debts','Debts','📉','#EF4444'),
    renderDataStandardSection('givenToOthers','Given To Others','🤝','#EC4899'),
  ].join('');
}

function clearDataFilter() { document.getElementById('data-filter-start').value=''; document.getElementById('data-filter-end').value=''; renderDataScreen(); }
function deleteCurrentDataMonth() { const k=document.getElementById('data-month-select').value; if(!confirm(`Delete all data for ${k}?`)) return; delete data[k]; save(); populateDataMonthSelect(); renderDataScreen(); }
function clearDataSection(monthKey,type) { if(!confirm(`Clear all ${type} for this view?`)) return; ensureMonth(monthKey); data[monthKey][type]=[]; save(); renderDataScreen(); }
function removeDataEntry(monthKey,type,idx) { if(!confirm('Delete?')) return; data[monthKey][type].splice(idx,1); save(); renderDataScreen(); showToast('Entry deleted'); }
function updateDataStandard(monthKey,type,idx,field,val) { if(field==='date') val=normalizeDate(val); if(field==='amount') val=parseFloat(val.replace(/[^0-9.-]/g,''))||0; data[monthKey][type][idx][field]=val; save(); }
function updateDataMetal(monthKey,idx,field,val) { if(field==='weightGms') val=parseFloat(val.replace(/[^0-9.]/g,''))||0; data[monthKey].metals[idx][field]=val; save(); }
function updateDataRealEstate(monthKey,idx,field,val) { if(field==='date') val=normalizeDate(val); if(['purchaseValue','currentValue','areaCents'].includes(field)) val=parseFloat(val.replace(/[^0-9.-]/g,''))||0; data[monthKey].realEstate[idx][field]=val; save(); }

function addDataRow(monthKey,type) {
  const date=normalizeDate(document.getElementById(`qa-date-${type}`).value), category=document.getElementById(`qa-cat-${type}`).value.trim(), amount=parseFloat(document.getElementById(`qa-amt-${type}`).value)||0, description=document.getElementById(`qa-desc-${type}`).value.trim();
  if(!date||!category){showToast('Date and Category required');return;}
  const targetMonth=getMonthKey(date)||monthKey; ensureMonth(targetMonth);
  data[targetMonth][type].push({date,category,amount,description}); save(); renderDataScreen(); populateDataMonthSelect();
  if(targetMonth!==monthKey) showToast(`✅ Added to ${getDisplayMonth(targetMonth)}`);
  document.getElementById(`qa-date-${type}`).value=''; document.getElementById(`qa-amt-${type}`).value=''; document.getElementById(`qa-desc-${type}`).value='';
}

function addDataMetalRow(monthKey) {
  const metalType=document.getElementById('qa-metal-type').value, purity=document.getElementById('qa-metal-purity').value, occasion=document.getElementById('qa-metal-occasion').value, itemName=document.getElementById('qa-metal-item').value, weightGms=parseFloat(document.getElementById('qa-metal-weight').value)||0;
  if(!itemName||!weightGms){showToast('Item and Weight required');return;}
  ensureMonth(monthKey); data[monthKey].metals.push({metalType,purity,occasion,itemName,weightGms}); save(); renderDataScreen();
}

function addDataRealEstateRow(monthKey) {
  const date=normalizeDate(document.getElementById('qa-re-date').value), country=document.getElementById('qa-re-country').value, currency=document.getElementById('qa-re-currency').value, purchaseValue=parseFloat(document.getElementById('qa-re-purchase').value)||0, description=document.getElementById('qa-re-desc').value, areaCents=parseFloat(document.getElementById('qa-re-area').value)||0, currentValue=parseFloat(document.getElementById('qa-re-current').value)||0;
  if(!date||!purchaseValue){showToast('Date and Purchase Value required');return;}
  const targetMonth=getMonthKey(date)||monthKey; ensureMonth(targetMonth);
  data[targetMonth].realEstate.push({date,country,currency,purchaseValue,description,areaCents,currentValue}); save(); renderDataScreen(); populateDataMonthSelect();
}

// ══════════════════════════════════════════════════════
// STATS
// ══════════════════════════════════════════════════════
function renderStats() {
  const months=[]; for(let i=5;i>=0;i--){const dt=new Date();dt.setMonth(dt.getMonth()-i);months.push(`${dt.getFullYear()}-${(dt.getMonth()+1).toString().padStart(2,'0')}`);}
  const spendByMonth=months.map(k=>!data[k]?0:(data[k].expenses||[]).reduce((s,r)=>s+Number(r.amount||0),0)+(data[k].investments||[]).reduce((s,r)=>s+Number(r.amount||0),0)+(data[k].debts||[]).reduce((s,r)=>s+Number(r.amount||0),0));
  const incByMonth=months.map(k=>!data[k]?0:(data[k].income||[]).reduce((s,r)=>s+Number(r.amount||0),0));
  document.getElementById('stat-spending-total').textContent=fmt(spendByMonth.reduce((s,v)=>s+v,0));
  document.getElementById('stat-income-total').textContent=fmt(incByMonth.reduce((s,v)=>s+v,0));
  if(charts.trend) charts.trend.destroy();
  const tc=document.getElementById('trendChart').getContext('2d');
  charts.trend=new Chart(tc,{type:'line',data:{labels:months.map(m=>getDisplayMonth(m)),datasets:[{label:'Spending',data:spendByMonth,borderColor:'#EF4444',backgroundColor:'rgba(239,68,68,0.1)',tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:'#EF4444'},{label:'Income',data:incByMonth,borderColor:'#10B981',backgroundColor:'rgba(16,185,129,0.1)',tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:'#10B981'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{font:{family:'Nunito',size:10},color:'#9AA0B2'}},y:{grid:{color:'#F0F0F0'},ticks:{font:{family:'Nunito',size:10},color:'#9AA0B2',callback:v=>'$'+v.toLocaleString()}}}}});
  const catTotals={};
  Object.values(data).forEach(m=>{if(!m||!m.expenses) return; m.expenses.forEach(e=>{catTotals[e.category||'Other']=(catTotals[e.category||'Other']||0)+Number(e.amount||0);});});
  const sorted=Object.entries(catTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const grandTotal=sorted.reduce((s,[,v])=>s+v,0);
  const donutColors=['#FF6B35','#FF8C42','#FF4757','#4A9EFF','#FFBE0B'];
  if(charts.donut) charts.donut.destroy();
  charts.donut=new Chart(document.getElementById('donutChart').getContext('2d'),{type:'doughnut',data:{datasets:[{data:sorted.map(([,v])=>v),backgroundColor:donutColors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:false}}}});
  document.getElementById('top5-list').innerHTML=sorted.map(([cat,val],i)=>`<div class="top-item"><div class="top-dot" style="background:${donutColors[i]};"></div><div class="top-label">${cat}</div><div class="top-pct">${grandTotal>0?(val/grandTotal*100).toFixed(1):0}%</div></div>`).join('');
  const curM=data[viewMonth]||{};
  document.getElementById('budget-bars').innerHTML=catConfig.filter(c=>c.key!=='invest'&&c.key!=='salary'&&c.key!=='debt'&&c.key!=='other').map(cat=>{
    const spent=((curM.expenses||[]).filter(e=>e.category===cat.label).reduce((s,e)=>s+Number(e.amount||0),0));
    const pct=Math.min(spent/1000*100,100);
    return `<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;margin-bottom:6px;"><div style="display:flex;align-items:center;gap:8px;"><div style="width:28px;height:28px;background:${cat.color}20;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.9em;">${cat.icon}</div><span style="font-weight:700;font-size:0.88em;">${cat.label}</span></div><span style="font-weight:700;font-size:0.82em;color:var(--text-med);">${fmt(spent)} / $1000</span></div><div style="height:6px;background:#F0F0F0;border-radius:4px;overflow:hidden;"><div style="width:${pct}%;height:100%;background:${cat.color};border-radius:4px;"></div></div></div>`;
  }).join('');
  const accounts=getAccountsList(), accTypes={};
  accounts.forEach(a=>{accTypes[a.type]=(accTypes[a.type]||0)+Math.abs(Number(a.balance||0));});
  const accColors=['#FFBE0B','#4A9EFF','#FF6B35','#4ECDC4'];
  const accKeys=Object.keys(accTypes), accVals=accKeys.map(k=>accTypes[k]);
  const accTotal=accVals.reduce((s,v)=>s+v,0);
  if(charts.account) charts.account.destroy();
  charts.account=new Chart(document.getElementById('accountChart').getContext('2d'),{type:'doughnut',data:{datasets:[{data:accVals,backgroundColor:accColors,borderWidth:0}]},options:{responsive:false,cutout:'60%',plugins:{legend:{display:false}}}});
  document.getElementById('account-breakdown').innerHTML=accKeys.map((k,i)=>`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:0.82em;font-weight:700;"><div style="width:10px;height:10px;border-radius:50%;background:${accColors[i]};flex-shrink:0;"></div><span>${k}</span><span style="color:var(--text-med);margin-left:auto;">${accTotal>0?(accVals[i]/accTotal*100).toFixed(1):0}%</span></div>`).join('');
}

// ══════════════════════════════════════════════════════
// SETTINGS
// ══════════════════════════════════════════════════════
// ── Net Worth Type Visibility (Settings) ──
const NW_TYPE_ORDER_BASE = ['checking','savings_acc','brokerage','retirement','bonds_fd','metals','realestate','cash','credit_card','loan','other_liability'];
const NW_TYPE_SHORT_BASE = { checking:'Checking', savings_acc:'Savings', brokerage:'Investment', retirement:'Retirement', bonds_fd:'Bonds/FD', metals:'Metals', realestate:'Property', cash:'Cash', credit_card:'Credit Card', loan:'Loan', other_liability:'Other Liab.' };

function getNWCustomTypes() { return data._nwCustomTypes || []; }
function getNWTypeOrder() {
  const custom = getNWCustomTypes().map(c => c.key);
  return [...NW_TYPE_ORDER_BASE, ...custom];
}
function getNWTypeShort() {
  const shorts = { ...NW_TYPE_SHORT_BASE };
  getNWCustomTypes().forEach(c => { shorts[c.key] = c.label; });
  return shorts;
}
// Aliases used across the codebase
let NW_TYPE_ORDER = NW_TYPE_ORDER_BASE;
let NW_TYPE_SHORT = NW_TYPE_SHORT_BASE;

const NW_TYPE_EMOJI_OPTS = ['🏦','🏠','🚗','💰','📦','🎓','💼','🏅','🌐','💳','🏗️','🏋️','📱','🎨','🛡️'];
let pickedNWTypeEmoji = '🏦';

function addCustomNWType() {
  const name = (document.getElementById('nw-type-name-input').value || '').trim();
  const isLiab = document.getElementById('nw-type-is-liab').checked;
  if (!name) { showToast('Enter a type name ❌'); return; }
  const key = 'custom_' + name.toLowerCase().replace(/\s+/g,'_') + '_' + Date.now().toString(36);
  const label = name;
  if (!data._nwCustomTypes) data._nwCustomTypes = [];
  // Add to NW_TYPES runtime object
  NW_TYPES[key] = { label, emoji: pickedNWTypeEmoji, color: '#6B7280', isLiab };
  data._nwCustomTypes.push({ key, label, emoji: pickedNWTypeEmoji, isLiab });
  // Add to visibility
  const vis = getNWTypeVisibility();
  vis[key] = true;
  save();
  document.getElementById('nw-type-name-input').value = '';
  document.getElementById('nw-type-is-liab').checked = false;
  renderNWTypeSettings();
  showToast('✅ ' + label + ' type added!');
}

function removeCustomNWType(key) {
  if (!confirm('Remove this custom account type?')) return;
  data._nwCustomTypes = (data._nwCustomTypes||[]).filter(c => c.key !== key);
  const vis = getNWTypeVisibility();
  delete vis[key];
  delete NW_TYPES[key];
  save();
  renderNWTypeSettings();
  showToast('Type removed');
}

function getNWTypeVisibility() {
  if (!data._nwTypeVisible) {
    // Default: all visible
    data._nwTypeVisible = {};
    NW_TYPE_ORDER.forEach(t => { data._nwTypeVisible[t] = true; });
  }
  return data._nwTypeVisible;
}

function renderNWTypeSettings() {
  const grid = document.getElementById('nw-type-visibility-grid');
  if (!grid) return;
  const vis = getNWTypeVisibility();
  const order = getNWTypeOrder();
  const shorts = getNWTypeShort();
  const customKeys = getNWCustomTypes().map(c => c.key);
  grid.innerHTML = order.map(t => {
    const cfg = NW_TYPES[t];
    if (!cfg) return '';
    const on = vis[t] !== false;
    const isCustom = customKeys.includes(t);
    return `<div class="home-card-item">
      <span class="home-card-item-icon">${cfg.emoji}</span>
      <span class="home-card-item-label">${shorts[t]||cfg.label}${cfg.isLiab?' <span style="font-size:0.7em;color:var(--expenses);">Liab</span>':''}</span>
      <button class="home-card-toggle ${on?'on':''}" onclick="toggleNWType('${t}')" title="${on?'Visible':'Hidden'}">
        ${on?'✓':'○'}
      </button>
      ${isCustom ? `<button class="home-card-toggle" onclick="removeCustomNWType('${t}')" title="Remove" style="color:var(--expenses);font-size:0.8em;">✕</button>` : ''}
    </div>`;
  }).join('');
  // Emoji picker
  const emojiRow = document.getElementById('nw-type-emoji-row');
  if (emojiRow) emojiRow.innerHTML = NW_TYPE_EMOJI_OPTS.map(e => `<span class="emoji-opt ${e===pickedNWTypeEmoji?'selected':''}" onclick="pickedNWTypeEmoji='${e}';renderNWTypeSettings();">${e}</span>`).join('');
}

function toggleNWType(type) {
  const vis = getNWTypeVisibility();
  vis[type] = vis[type] === false; // toggle
  save();
  renderNWTypeSettings();
}

function renderSettings() {
  const months=Object.keys(data).filter(k=>!k.startsWith('_')).sort((a,b)=>b.localeCompare(a));
  renderRecurringRules();

  // Theme badge
  document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active-theme'));
  const tc = document.getElementById('theme-'+currentTheme);
  if(tc) tc.classList.add('active-theme');
  // Currency display
  const cd = document.getElementById('settings-curr-display');
  const cn = document.getElementById('settings-curr-name');
  if(cd) cd.textContent = `${currentCurrency.flag} ${currentCurrency.code} — ${currentCurrency.symbol}`;
  if(cn) cn.textContent = currentCurrency.name + (currentCurrency.country?' · '+currentCurrency.country:'');
  // Home card manager
  renderHomeCardSettings();
  // Investment card manager
  renderInvCardSettings();
  // Category pills
  renderCatPills();
  // Net Worth type visibility
  renderNWTypeSettings();
  // FX rate overrides panel
  renderFXRatesPanel();
}
function deleteMonth(key) { if(!confirm(`Delete all data for ${getDisplayMonth(key)}?`)) return; delete data[key]; save(); renderHome(); renderMonthsList(); renderResetSummary(); showToast('🗑️ ' + getDisplayMonth(key) + ' deleted'); }


// ══════════════════════════════════════════════════════
// EXPORT / IMPORT / BACKUP
// ══════════════════════════════════════════════════════
function downloadBackup() {
  // Full envelope — data object + separate localStorage prefs
  const envelope = {
    _appVersion: 'MoneyFi-2.0',
    _exportedAt: new Date().toISOString(),
    _theme: localStorage.getItem('mf_theme') || 'default',
    _currency: localStorage.getItem('mf_currency') || null,
    data: data
  };
  const blob = new Blob([JSON.stringify(envelope, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'MoneyFi_Backup_' + new Date().toISOString().slice(0,10) + '.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  // Summary toast
  const months = Object.keys(data).filter(k => /^\d{4}-\d{2}$/.test(k)).length;
  const txCount = Object.keys(data).filter(k => /^\d{4}-\d{2}$/.test(k))
    .reduce((s,mk) => s + ['expenses','income','investments','debts','givenToOthers','additional']
      .reduce((ss,t) => ss + (data[mk][t]||[]).length, 0), 0);
  showToast('✅ Backup saved · ' + months + ' months · ' + txCount + ' transactions', 3500);
}
function restoreBackup(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      // Support both formats: new envelope {_appVersion, data} or legacy raw data object
      const isEnvelope = parsed._appVersion || parsed.data;
      const importedData = isEnvelope ? parsed.data : parsed;
      const importedTheme = isEnvelope ? parsed._theme : null;
      const importedCurrency = isEnvelope ? parsed._currency : null;

      // Build preview summary
      const months = Object.keys(importedData).filter(k => /^\d{4}-\d{2}$/.test(k));
      const txCount = months.reduce((s,mk) => s +
        ['expenses','income','investments','debts','givenToOthers','additional']
          .reduce((ss,t) => ss + (importedData[mk]?.[t]||[]).length, 0), 0);
      const metalsCount = (importedData._metals||[]).length;
      const nwCount = (importedData._nwAccounts||[]).length;
      const exportedAt = parsed._exportedAt ? new Date(parsed._exportedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'unknown date';

      const summary = [
        '📦 Backup from: ' + exportedAt,
        '📅 ' + months.length + ' months of transactions',
        '💳 ' + txCount + ' total transactions',
        '🥇 ' + metalsCount + ' metal entries',
        '💎 ' + nwCount + ' NW accounts',
        importedTheme ? '🎨 Theme: ' + importedTheme : '',
        importedCurrency ? '💱 Currency: ' + JSON.parse(importedCurrency).code : '',
      ].filter(Boolean).join('\n');

      if (!confirm('⚠️ RESTORE BACKUP\n\n' + summary + '\n\nThis will OVERWRITE all current data. Continue?')) return;

      // Restore data
      data = importedData;

      // Restore theme if present
      if (importedTheme) {
        localStorage.setItem('mf_theme', importedTheme);
        setTheme(importedTheme);
      }

      // Restore currency if present
      if (importedCurrency) {
        try {
          const cur = JSON.parse(importedCurrency);
          currentCurrency = cur;
          localStorage.setItem('mf_currency', importedCurrency);
        } catch(e) {}
      }

      // Save and full re-render
      save();
      populateDataMonthSelect();
      renderHome();
      try { renderTransactions(); } catch(e) {}
      try { renderBudget(); } catch(e) {}
      try { renderNetWorth(); } catch(e) {}
      try { renderMetals(); } catch(e) {}
      try { renderSettings(); } catch(e) {}
      showToast('✅ Restored · ' + months.length + ' months · ' + txCount + ' transactions', 3500);
    } catch(err) {
      showToast('❌ Invalid backup file — ' + err.message);
    }
  };
  reader.readAsText(file);
}
function exportAllData() {
  const wb=XLSX.utils.book_new();
  [{key:'income',name:'Income'},{key:'expenses',name:'Expenses'},{key:'investments',name:'Investments'},{key:'realEstate',name:'Real Estate'},{key:'metals',name:'Metals'},{key:'additional',name:'Additional'},{key:'debts',name:'Debts'},{key:'givenToOthers',name:'Given To Others'}].forEach(cat=>{
    let rows=[];
    if(cat.key==='metals') rows.push(['Month','Metal','Purity','Occasion','Item','Weight(g)']);
    else if(cat.key==='realEstate') rows.push(['Month','Date','Country','Currency','Purchase','Desc','Area','Current']);
    else rows.push(['Month','Date','Category','Amount','Description']);
    Object.keys(data).filter(k=>!k.startsWith('_')).sort().forEach(mKey=>{
      (data[mKey][cat.key]||[]).forEach(r=>{
        const ml=getDisplayMonth(mKey);
        if(cat.key==='metals') rows.push([ml,r.metalType,r.purity,r.occasion,r.itemName,r.weightGms]);
        else if(cat.key==='realEstate') rows.push([ml,r.date,r.country,r.currency,r.purchaseValue,r.description,r.areaCents,r.currentValue]);
        else rows.push([ml,r.date,r.category,r.amount,r.description]);
      });
    });
    if(rows.length>1){const ws=XLSX.utils.aoa_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,cat.name);}
  });
  // Sheet: Global Metals (_metals array)
  const metalsGlobal = data._metals || [];
  if (metalsGlobal.length) {
    const mRows = [['Metal Type','Name','Purity','Occasion','Form','Weight (g)','Price/g','Value (USD)','Date','Notes']];
    metalsGlobal.forEach(m => {
      const g = Number(m.grams||m.weightGms||0);
      const p = Number(m.price||0) || (METAL_CONFIG[m.metalType]||{}).pricePerGram || 0;
      mRows.push([m.metalType||'', m.name||'', m.purity||'', m.occasion||'', m.form||'', g, p, (g*p).toFixed(2), m.date||'', m.notes||'']);
    });
    const mWs = XLSX.utils.aoa_to_sheet(mRows);
    XLSX.utils.book_append_sheet(wb, mWs, 'Metals (Portfolio)');
  }

  // Sheet: Global Real Estate (_realEstate array)
  const reGlobal = data._realEstate || [];
  if (reGlobal.length) {
    const reRows = [['Description','Country','Currency','Purchase Value','Current Value','Area','Date']];
    reGlobal.forEach(p => reRows.push([p.description||'', p.country||'', p.currency||'', p.purchaseValue||0, p.currentValue||0, p.area||'', p.date||'']));
    const reWs = XLSX.utils.aoa_to_sheet(reRows);
    XLSX.utils.book_append_sheet(wb, reWs, 'Real Estate (Portfolio)');
  }

  // Sheet: NW Accounts (_nwAccounts)
  const nwAccts = data._nwAccounts || [];
  if (nwAccts.length) {
    const nwRows = [['Type','Name','Balance','Currency','Last Updated','Bank','Notes','Purity','Grams','Purchase Value','Country']];
    nwAccts.forEach(a => {
      const m = a.meta || {};
      nwRows.push([a.type||'', a.name||'', a.balance||0, a.currency||'', a.lastUpdated||'', m.bank||'', m.notes||'', m.purity||'', m.grams||'', m.purchaseValue||'', m.country||'']);
    });
    const nwWs = XLSX.utils.aoa_to_sheet(nwRows);
    XLSX.utils.book_append_sheet(wb, nwWs, 'NW Accounts');
  }

  XLSX.writeFile(wb,"MoneyFlow_Complete.xlsx"); showToast('Excel exported ✅');
}
function exportDataCategory(type) {
  const list=getDataEffectiveEntries(type); if(!list.length){showToast('No data to export');return;}
  const clean=list.map(({_month,_idx,...r})=>r);
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(clean); XLSX.utils.book_append_sheet(wb,ws,type);
  XLSX.writeFile(wb,`${type}_Export.xlsx`);
}

// ══════════════════════════════════════════════════════
// PASTE / FILE IMPORT
// ══════════════════════════════════════════════════════
function parsePaste(monthKey, type) {
  const text=(document.getElementById(`paste-${type}`)||{}).value||''; if(!text.trim()) return;
  if(type==='metals'){parseMetalsPaste(monthKey,text);return;}
  if(type==='realEstate'){parseRealEstatePaste(monthKey,text);return;}
  const lines=text.trim().split('\n'); let count=0;
  lines.forEach(line=>{
    const parts=line.replace(/,/g,'').split(/\s+/);
    if(parts.length<2) return;
    const dateIdx=parts.findIndex(p=>!isNaN(Date.parse(p))&&(p.includes('/')||p.includes('-')));
    if(dateIdx===-1) return;
    const date=normalizeDate(parts[dateIdx]);
    let amtIdx=-1;
    for(let i=parts.length-1;i>=0;i--){if(i===dateIdx)continue;const c=parts[i].replace(/[$€£]/g,'');if(!isNaN(parseFloat(c))&&isFinite(c)){amtIdx=i;break;}}
    if(amtIdx===-1) return;
    const amount=parseFloat(parts[amtIdx].replace(/[$€£]/g,''));
    const desc=parts.filter((_,i)=>i!==dateIdx&&i!==amtIdx).join(' ');
    const tm=getMonthKey(date)||monthKey; ensureMonth(tm);
    data[tm][type].push({date,category:'Imported',amount,description:desc}); count++;
  });
  if(count>0){save();populateDataMonthSelect();renderDataScreen();showToast(`✅ Parsed ${count} rows!`);(document.getElementById(`paste-${type}`)||{}).value='';}else showToast('Could not parse. Check format.');
}
function parseMetalsPaste(monthKey,text){const lines=text.trim().split('\n');let count=0;lines.forEach(line=>{const p=line.split(/[,\t]/).map(s=>s.trim());if(p.length<5)return;data[monthKey].metals.push({metalType:p[0],purity:p[1],occasion:p[2],itemName:p[3],weightGms:parseFloat(p[4])||0});count++;});if(count>0){save();renderDataScreen();showToast(`✅ Parsed ${count} rows!`);}else showToast('Could not parse.');}
function parseRealEstatePaste(monthKey,text){const lines=text.trim().split('\n');let count=0;lines.forEach(line=>{const p=line.split(/[,\t]/).map(s=>s.trim());if(p.length<4)return;const date=normalizeDate(p[0]);const tm=getMonthKey(date)||monthKey;ensureMonth(tm);data[tm].realEstate.push({date,country:p[1],currency:p[2],purchaseValue:parseFloat(p[3])||0,description:p[4],areaCents:parseFloat(p[5])||0,currentValue:parseFloat(p[6])||0});count++;});if(count>0){save();renderDataScreen();showToast(`✅ Parsed ${count} rows!`);}else showToast('Could not parse.');}

function importFile(monthKey, type) {
  const fi=document.getElementById(`file-${type}`); if(!fi||!fi.files[0]){showToast('Select a file first');return;}
  const file=fi.files[0], reader=new FileReader();
  reader.onload=function(e){
    if(file.name.endsWith('.csv')){PapaParse.parse(e.target.result,{header:true,skipEmptyLines:true,complete:r=>processImportRows(r.data,monthKey,type)});}
    else{const d=new Uint8Array(e.target.result);const wb=XLSX.read(d,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];processImportRows(XLSX.utils.sheet_to_json(ws,{raw:false}),monthKey,type);}
  };
  if(file.name.endsWith('.csv')) reader.readAsText(file); else reader.readAsArrayBuffer(file);
}
function processImportRows(rows,selectedMonth,type){
  let added=0;
  rows.forEach(r=>{
    if(type==='metals'){const w=parseFloat(r.Weight||r.weight||r.WeightGms||r['Weight (gms)']||0);const item=r.Item||r.item||r.ItemName||r['Item Name'];if(w&&item){data[selectedMonth].metals.push({metalType:r.Metal||r.metal||r.MetalType||'Gold',purity:r.Purity||r.purity||'',occasion:r.Occasion||r.occasion||'',itemName:item,weightGms:w});added++;}return;}
    if(type==='realEstate'){const date=normalizeDate(r.Date||r.date);const val=parseFloat(String(r.PurchaseValue||r.Purchase||r.purchaseValue||r['Purchase Value']||0).replace(/[^0-9.-]/g,''));if(date&&val){const tm=getMonthKey(date)||selectedMonth;ensureMonth(tm);data[tm].realEstate.push({date,country:r.Country||r.country||'US',currency:r.Currency||r.currency||'USD',purchaseValue:val,description:r.Description||'',areaCents:parseFloat(r.Area||r.area||0),currentValue:parseFloat(r.CurrentValue||r.currentValue||0)});added++;}return;}
    const dateStr=r.Date||r.date||r.DATE;const amtStr=r.Amount||r.amount||r.Debit||r.Credit;
    if(dateStr&&amtStr){const date=normalizeDate(dateStr);const amount=parseFloat(String(amtStr).replace(/[^0-9.-]/g,''));if(date&&!isNaN(amount)){const tm=getMonthKey(date)||selectedMonth;ensureMonth(tm);data[tm][type].push({date,category:r.Category||'Imported',amount,description:r.Description||''});added++;}}
  });
  if(added>0){save();populateDataMonthSelect();renderDataScreen();showToast(`✅ Imported ${added} rows!`);}else showToast('No valid rows found.');
}

// ══════════════════════════════════════════════════════
// METALS
// ══════════════════════════════════════════════════════
function getMetals() { if(!data._metals) data._metals=[]; return data._metals; }
function toggleAddPanel() { addPanelOpen=!addPanelOpen; document.getElementById('metal-add-panel-body').classList.toggle('open',addPanelOpen); const t=document.getElementById('add-panel-toggle'); t.textContent=addPanelOpen?'−':'+'; t.classList.toggle('open',addPanelOpen); }
function showMetalPriceEdit() {
  openMetalPriceSheet();
}

function openMetalPriceSheet() {
  const sheet = document.getElementById('metal-price-sheet');
  const backdrop = document.getElementById('metal-price-sheet-backdrop');
  if (!sheet || !backdrop) return;

  const mc = METAL_CONFIG[currentMetal] || {};
  // Default to grams, update UI to reflect
  metalPriceUnit = 'g';
  _syncUnitButtons();

  // Populate input with current base price in display currency / gram
  const base = getMetalBasePrice(currentMetal);
  const baseDisp = metalPriceToDisplay(base);
  document.getElementById('metal-sheet-title').textContent = `⚙️ Set ${mc.label || currentMetal} Price`;
  _updatePriceLabel();
  document.getElementById('metal-price-override-input').value = baseDisp.toFixed(2);

  // Hide purity sub-panel
  const poi = document.getElementById('purity-override-inline');
  if (poi) poi.style.display = 'none';

  renderPurityPrices(currentMetal);

  // Show as bottom sheet — slide up from bottom
  backdrop.style.display = 'block';
  sheet.style.display = 'flex';
  sheet.style.transform = 'translateY(100%)';
  requestAnimationFrame(() => requestAnimationFrame(() => {
    backdrop.style.opacity = '1';
    sheet.style.transform = 'translateY(0%)';
  }));
}

function closeMetalPriceSheet() {
  const sheet = document.getElementById('metal-price-sheet');
  const backdrop = document.getElementById('metal-price-sheet-backdrop');
  if (!sheet || !backdrop) return;
  sheet.style.transform = 'translateY(100%)';
  backdrop.style.opacity = '0';
  setTimeout(() => {
    sheet.style.display = 'none';
    backdrop.style.display = 'none';
  }, 320);
}

function toggleMetalPriceUnit() { /* legacy — now handled by setMetalPriceUnit */ }

let metalPriceUnit = 'g'; // module-level state for unit toggle

function _updatePriceLabel() {
  const metalLabel = currentMetal === 'gold' ? '24K pure' : currentMetal === 'silver' ? '999 Fine' : 'Pt999';
  const lbl = document.getElementById('metal-price-override-label');
  if (lbl) lbl.textContent = `Base price (${metalLabel}) — ${sym()}/${metalPriceUnit}`;
}

function _syncUnitButtons() {
  const bg = document.getElementById('unit-btn-g');
  const boz = document.getElementById('unit-btn-oz');
  if (!bg || !boz) return;
  if (metalPriceUnit === 'g') {
    bg.style.background = 'white'; bg.style.color = 'var(--text-dark)';
    bg.style.boxShadow = '0 1px 4px rgba(0,0,0,0.10)';
    boz.style.background = 'transparent'; boz.style.color = 'var(--text-med)';
    boz.style.boxShadow = 'none';
  } else {
    boz.style.background = 'white'; boz.style.color = 'var(--text-dark)';
    boz.style.boxShadow = '0 1px 4px rgba(0,0,0,0.10)';
    bg.style.background = 'transparent'; bg.style.color = 'var(--text-med)';
    bg.style.boxShadow = 'none';
  }
}

function setMetalPriceUnit(unit) {
  metalPriceUnit = unit;
  _syncUnitButtons();
  _updatePriceLabel();
  // Convert current input value between g and oz
  const inp = document.getElementById('metal-price-override-input');
  const cur = parseFloat(inp?.value) || 0;
  if (inp && cur > 0) {
    inp.value = unit === 'oz'
      ? (cur * 31.1035).toFixed(2)   // g → oz
      : (cur / 31.1035).toFixed(2);  // oz → g
  } else {
    // Populate from live price
    const base = getMetalBasePrice(currentMetal);
    const baseDisp = metalPriceToDisplay(base);
    if (inp) inp.value = unit === 'oz' ? (baseDisp * 31.1035).toFixed(2) : baseDisp.toFixed(2);
  }
  renderPurityPrices(currentMetal);
}

function applyMetalPriceOverride() {
  let price = parseFloat(document.getElementById('metal-price-override-input').value);
  if (!price || price <= 0) { showToast('Enter a valid price ❌'); return; }
  // Close the sheet before re-renders
  closeMetalPriceSheet();
  // Convert oz → g if user is in oz mode
  if (metalPriceUnit === 'oz') price = price / 31.1035; // 1 troy oz = 31.1035g
  // Convert display currency/gram → USD/gram for internal storage
  const priceUSD = metalPriceToUSD(price);
  updateMetalPriceOverride(currentMetal, priceUSD);
  showToast('✅ Price updated');
}

function renderPurityPrices(metalType) {
  const el = document.getElementById('metal-purity-prices');
  if (!el) return;
  const base = getMetalBasePrice(metalType);
  const overrides = data._metalPriceOverrides || {};

  const purities = metalType === 'gold'
    ? [['24K',1.0],['22K',0.9167],['21K',0.875],['18K',0.75],['14K',0.5833],['10K',0.4167],['9K',0.375]]
    : metalType === 'silver'
    ? [['999',1.0],['995',0.995],['925',0.925],['900',0.9],['850',0.85],['800',0.8]]
    : [['999',1.0],['Pt950',0.95],['Pt900',0.9],['Pt850',0.85]];

  const rows = purities.map(([p, mult]) => {
    const purityKey = metalType + '|' + normalizePurity(p);
    const hasOverride = overrides[purityKey] !== undefined;
    const effectivePriceUSD = hasOverride ? overrides[purityKey] : (base * mult);
    const effectivePrice = metalPriceToDisplay(effectivePriceUSD); // convert USD → display
    const overrideBadge = hasOverride
      ? `<span style="color:#10B981;font-size:0.85em;" title="Custom price set">✏️</span>`
      : '';
    return `<tr style="border-bottom:1px solid #F0F0F0;">
      <td style="padding:4px 6px;font-weight:800;color:var(--text-dark);font-size:0.82em;">${p}</td>
      <td style="padding:4px 6px;font-weight:700;color:var(--text-med);font-size:0.78em;">${hasOverride ? '' : (mult*100).toFixed(1)+'%'}</td>
      <td style="padding:4px 6px;font-weight:900;color:var(--primary);font-size:0.88em;">${sym()}${(metalPriceUnit==='oz'?(effectivePrice*31.1035):effectivePrice).toFixed(2)}/${metalPriceUnit} ${overrideBadge}</td>
      <td style="padding:4px 2px;text-align:right;">
        <button onclick="openPurityOverride('${metalType}','${p}',${effectivePrice})"
          style="background:#F0F4FF;border:none;border-radius:5px;padding:2px 7px;font-size:0.7em;font-weight:800;color:var(--primary);cursor:pointer;">Set</button>
        ${hasOverride ? `<button onclick="updateMetalPriceOverride('${metalType}',0,'${p}')"
          style="background:#FFF0F0;border:none;border-radius:5px;padding:2px 7px;font-size:0.7em;font-weight:800;color:#EF4444;cursor:pointer;margin-left:2px;">✕</button>` : ''}
      </td>
    </tr>`;
  }).join('');

  el.innerHTML = `<div style="font-size:0.78em;font-weight:700;color:var(--text-med);margin-bottom:5px;">💎 Price by Purity — tap <b>Set</b> to override any row:</div>
    <table style="width:100%;border-collapse:collapse;">${rows}</table>
    `;
}

let _poiMetal = '', _poiPurity = '';
function openPurityOverride(metalType, purity, currentPrice) {
  _poiMetal = metalType; _poiPurity = purity;
  const panel = document.getElementById('purity-override-inline');
  const label = document.getElementById('poi-label');
  const input = document.getElementById('poi-input');
  if (!panel) return;
  if (label) label.textContent = `Set ${sym()}/gram for ${purity} ${metalType.charAt(0).toUpperCase()+metalType.slice(1)}:`;
  // currentPrice from renderPurityPrices is already in USD — convert to display
  if (input) { input.value = metalPriceToDisplay(currentPrice).toFixed(2); input.focus(); }
  panel.style.display = '';
}
function applyPurityOverride() {
  const priceDisp = parseFloat(document.getElementById('poi-input')?.value);
  if (!priceDisp || priceDisp <= 0) { showToast('Enter a valid price ❌'); return; }
  // Convert display currency/gram → USD/gram for internal storage
  const price = metalPriceToUSD(priceDisp);
  updateMetalPriceOverride(_poiMetal, price, _poiPurity);
  // Hide the purity sub-panel but keep the sheet open
  const poi = document.getElementById('purity-override-inline');
  if (poi) poi.style.display = 'none';
  renderPurityPrices(currentMetal); // refresh to show updated price
}

function switchMetal(type) {
  currentMetal=type; const cfg=METAL_CONFIG[type];
  ['gold','silver','platinum'].forEach(t=>document.getElementById('mini-'+t).classList.toggle('active-metal',t===type));
  const iw=document.getElementById('metal-detail-icon'); iw.textContent=cfg.emoji; iw.className='metal-detail-icon-wrap '+type;
  document.getElementById('metal-detail-name').textContent=cfg.label;
  document.getElementById('metal-detail-usd').className='metal-detail-usd '+type;
  const basePrice = getMetalBasePrice(type);
  const hasOverride = (data._metalPriceOverrides||{})[type] !== undefined;
  document.getElementById('metal-live-price').textContent=sym()+metalPriceToDisplay(basePrice).toFixed(2)+(hasOverride?' ✏️':'');
  const baseLabel = type === 'gold' ? sym()+'/gram (24K pure)' : type === 'silver' ? sym()+'/gram (999 Fine)' : sym()+'/gram (Pt999)';
  const baseLabelEl = document.getElementById('metal-price-base-label');
  if (baseLabelEl) baseLabelEl.textContent = baseLabel;
  // Also update QA form purchase price label to show current currency
  const pfLabel = document.getElementById('metal-price-field-label');
  if (pfLabel) pfLabel.textContent = `Purchase Price / ${sym()}gram`;
  document.getElementById('metal-add-icon').textContent=cfg.emoji;
  document.getElementById('metal-add-label').textContent=cfg.label;
  document.getElementById('metal-save-btn').textContent='+ Add '+cfg.label+' Entry';
  document.getElementById('metal-save-btn').className='metal-save-btn '+type;
  document.getElementById('metal-price-hint').textContent='💡 '+cfg.hint;
  document.getElementById('holdings-list-title').textContent=cfg.emoji+' '+cfg.label+' Holdings';
  // Close price panel when switching metals
  const panel = document.getElementById('metal-price-override-panel');
  if (panel) panel.style.display = 'none';
  renderMetals();
}
function renderMetals() {
  const metals=getMetals(), cfg=METAL_CONFIG;
  const totals={};
  // Also fold in NW-sheet metal accounts so mini-tiles show combined totals
  const nwMetalAccounts = (data._nwAccounts||[]).filter(a=>a.type==='metals');
  Object.keys(cfg).forEach(t=>{
    const entries=metals.filter(m=>m.metalType===t);
    const grams=entries.reduce((s,m)=>s+Number(m.grams||m.weightGms||0),0);
    const usd=entries.reduce((s,m)=>{
      const g=Number(m.grams||m.weightGms||0);
      // Always use live price (not stored purchase price) so total matches NetWorth
      const price=getPriceForMetal(t, m.purity);
      return s+g*price;
    },0);
    // Add NW manual accounts for this metal type
    const nwEntries=nwMetalAccounts.filter(a=>a.meta&&a.meta.metalType===t);
    const nwGrams=nwEntries.reduce((s,a)=>s+Number(a.meta.grams||0),0);
    const nwUsd=nwEntries.reduce((s,a)=>{
      const g=Number(a.meta&&a.meta.grams||0);
      const purity=a.meta&&a.meta.purity||'';
      // Always recompute from grams × live price so Metals page stays in sync with NetWorth
      return s + g * getPriceForMetal(t, purity);
    },0);
    totals[t]={entries,grams:grams+nwGrams,usd:usd+nwUsd,avgCost:(grams+nwGrams)>0?(usd+nwUsd)/(grams+nwGrams):0};
  });
  const grandTotal=Object.values(totals).reduce((s,t)=>s+t.usd,0);
  // Convert USD totals to display currency for rendering
  const grandTotalDisp = convertAmt(grandTotal, 'USD');
  document.getElementById('metals-grand-total').textContent=fmt(grandTotalDisp);
  Object.keys(cfg).forEach(t=>{
    document.getElementById('mini-'+t+'-grams').textContent=totals[t].grams.toFixed(2)+' g';
    document.getElementById('mini-'+t+'-usd').textContent=fmt(convertAmt(totals[t].usd,'USD'));
  });
  const active=totals[currentMetal], ac=cfg[currentMetal];
  document.getElementById('metal-detail-grams').textContent=active.grams.toFixed(3)+' g · '+(active.grams/31.1035).toFixed(3)+' oz';
  document.getElementById('metal-detail-usd').textContent=fmt(convertAmt(active.usd,'USD'));
  document.getElementById('metal-stat-entries').textContent=active.entries.length;
  document.getElementById('metal-stat-oz').textContent=(active.grams/31.1035).toFixed(3);
  document.getElementById('metal-stat-avg').textContent=active.avgCost>0?sym()+active.avgCost.toFixed(2):sym()+'0';
  // Sync live price display to current currency (so currency switch updates it)
  const _lp = document.getElementById('metal-live-price');
  if (_lp) {
    const _lpBase = getMetalBasePrice(currentMetal);
    const _lpOv = (data._metalPriceOverrides||{})[currentMetal] !== undefined;
    _lp.textContent = sym() + metalPriceToDisplay(_lpBase).toFixed(2) + (_lpOv?' ✏️':'');
  }
  const _bll = document.getElementById('metal-price-base-label');
  if (_bll) {
    _bll.textContent = currentMetal==='gold' ? sym()+'/gram (24K pure)' :
                       currentMetal==='silver' ? sym()+'/gram (999 Fine)' : sym()+'/gram (Pt999)';
  }
  document.getElementById('holdings-list-count').textContent=active.entries.length+(active.entries.length===1?' entry':' entries');
  const hl=document.getElementById('metals-holdings-list');
  if(active.entries.length===0){hl.innerHTML=`<div class="metal-empty"><div class="metal-empty-icon">${ac.emoji}</div><div class="metal-empty-text">No ${ac.label.toLowerCase()} entries yet.<br>Tap + above to add one.</div></div>`;return;}
  // Combine _metals + NW accounts for this metal type
  const nwMetalForType = (data._nwAccounts||[]).filter(a=>a.type==='metals'&&a.meta&&a.meta.metalType===currentMetal);
  const allEntries = [
    ...active.entries.map((m,i) => ({ ...m, _source: 'portfolio', _metalIdx: (data._metals||[]).indexOf(m) })),
    ...nwMetalForType.map(a => ({
      name: a.name, grams: Number(a.meta.grams||0), price: 0,
      purity: a.meta.purity||'', occasion: a.meta.occasion||'', form: a.meta.form||'',
      date: a.lastUpdated||'', notes: a.meta.notes||'', _source: 'networth', _nwId: a.id
    }))
  ];
  // Issue 6: Sort newest first
  allEntries.sort((a,b) => (b.date||'').localeCompare(a.date||''));
  renderMetalROI(); // ROI chart
  document.getElementById('holdings-list-count').textContent = allEntries.length + (allEntries.length===1?' entry':' entries');
  if(allEntries.length===0){hl.innerHTML=`<div class="metal-empty"><div class="metal-empty-icon">${ac.emoji}</div><div class="metal-empty-text">No ${ac.label.toLowerCase()} entries yet.<br>Tap + above to add one.</div></div>`;return;}
  // Issue 8: Group entries by date — no-date at bottom with friendly label
  const datedEntries   = allEntries.filter(m => m.date);
  const undatedEntries = allEntries.filter(m => !m.date);
  const byDateGroup = {};
  datedEntries.forEach(m => {
    const dk = m.date; // YYYY-MM-DD
    if (!byDateGroup[dk]) byDateGroup[dk] = [];
    byDateGroup[dk].push(m);
  });
  const dateGroupKeys = Object.keys(byDateGroup).sort().reverse(); // newest first

  let holdingHtml = '';
  dateGroupKeys.forEach(dk => {
    const groupLabel = new Date(dk+'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
    holdingHtml += `<div style="font-size:0.72em;font-weight:800;color:var(--text-light);padding:8px 20px 2px;text-transform:uppercase;letter-spacing:0.04em;background:#FAFAFA;border-bottom:1px solid #F0F0F0;">${groupLabel}</div>`;
    byDateGroup[dk].forEach((m,idx) => {
      holdingHtml += renderMetalHoldingRow(m, allEntries.indexOf(m));
    });
  });
  if (undatedEntries.length > 0) {
    holdingHtml += `<div style="font-size:0.72em;font-weight:800;color:var(--text-light);padding:8px 20px 2px;text-transform:uppercase;letter-spacing:0.04em;background:#FAFAFA;border-bottom:1px solid #F0F0F0;">📦 No Date Recorded</div>`;
    undatedEntries.forEach((m,idx) => {
      holdingHtml += renderMetalHoldingRow(m, allEntries.indexOf(m));
    });
  }
  hl.innerHTML = holdingHtml;
}

function renderMetalROI() {
  const entries = getMetals().filter(m => m.metalType === currentMetal);
  if (!entries.length) {
    const card = document.getElementById('metal-roi-card');
    if (card) card.style.display = 'none';
    return;
  }
  const card = document.getElementById('metal-roi-card');
  if (card) card.style.display = '';

  // Compute cost basis (entries with stored price) and live value
  // Cost basis: m.price is stored as $/gram at purchase time in USD
  // Live value: always USD via getPriceForMetal
  // Both in USD → convert together at end for display
  let totalCostUSD = 0, totalValueUSD = 0, gramsWithCost = 0;
  entries.forEach(m => {
    const g = Number(m.grams || m.weightGms || 0);
    const livePrice = getPriceForMetal(currentMetal, m.purity || '');
    totalValueUSD += g * livePrice;
    if (Number(m.costBasisUSD || 0) > 0) {
      // New canonical field: total cost already in USD
      totalCostUSD += Number(m.costBasisUSD);
      gramsWithCost += g;
    } else if (Number(m.price || 0) > 0) {
      // Legacy: price-per-gram in m.priceCurrency → convert to USD total
      const storedCurr = m.priceCurrency || 'USD';
      const fxRate = convertAmt(1, 'USD'); // 1 USD in display currency
      const priceUSD = fxRate > 0 ? convertAmt(m.price, storedCurr) / fxRate : m.price;
      totalCostUSD += g * priceUSD;
      gramsWithCost += g;
    }
  });
  if (gramsWithCost === 0) totalCostUSD = totalValueUSD; // no cost data — no gain display

  const gainUSD = totalValueUSD - totalCostUSD;
  const gainPct = totalCostUSD > 0 ? gainUSD / totalCostUSD * 100 : 0;
  const gainColor = gainUSD >= 0 ? '#10B981' : '#EF4444';
  const gainBg   = gainUSD >= 0 ? '#D1FAE5' : '#FEE2E2';

  // Update tiles
  const costEl  = document.getElementById('metal-roi-cost');
  const valEl   = document.getElementById('metal-roi-value');
  const gainEl  = document.getElementById('metal-roi-gain');
  const badgeEl = document.getElementById('metal-roi-gain-badge');
  if (costEl)  costEl.textContent  = fmt(convertAmt(totalCostUSD, 'USD'));
  if (valEl)   valEl.textContent   = fmt(convertAmt(totalValueUSD, 'USD'));
  if (gainEl)  { gainEl.textContent = (gainUSD >= 0 ? '+' : '') + fmt(convertAmt(gainUSD, 'USD')); gainEl.style.color = gainColor; }
  if (badgeEl) { badgeEl.textContent = (gainPct >= 0 ? '+' : '') + gainPct.toFixed(1) + '%'; badgeEl.style.background = gainBg; badgeEl.style.color = gainColor; }

  // Progress bar — cost as grey, value as gold overlay
  const maxVal = Math.max(totalCostUSD, totalValueUSD);
  const costBar  = document.getElementById('metal-roi-bar-cost');
  const valueBar = document.getElementById('metal-roi-bar-value');
  if (costBar)  costBar.style.width  = maxVal > 0 ? (totalCostUSD  / maxVal * 100) + '%' : '0%';
  if (valueBar) valueBar.style.width = maxVal > 0 ? (totalValueUSD / maxVal * 100) + '%' : '0%';

  // Acquisition over time chart — cumulative grams by date
  // Prefer purchaseDate for ROI trend accuracy, fall back to entry date
  const dated = entries.filter(m => m.purchaseDate || m.date)
    .sort((a,b) => (a.purchaseDate||a.date).localeCompare(b.purchaseDate||b.date));
  if (!dated.length) return;

  const canvas = document.getElementById('metal-roi-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 300;
  canvas.width = W * (window.devicePixelRatio || 1);
  canvas.height = 70 * (window.devicePixelRatio || 1);
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

  // Build cumulative grams timeline
  let cumGrams = 0;
  const points = dated.map(m => {
    cumGrams += Number(m.grams || m.weightGms || 0);
    return { date: m.purchaseDate || m.date, grams: cumGrams };
  });

  const minG = 0, maxG = points[points.length - 1].grams;
  const padL = 0, padR = 0, padT = 8, padB = 0;
  const chartW = W - padL - padR;
  const chartH = 70 - padT - padB;

  const xScale = (i) => padL + (i / (points.length - 1 || 1)) * chartW;
  const yScale = (g) => padT + chartH - (maxG > 0 ? (g / maxG) * chartH : 0);

  // Gradient fill
  const grad = ctx.createLinearGradient(0, padT, 0, padT + chartH);
  grad.addColorStop(0, 'rgba(245,158,11,0.35)');
  grad.addColorStop(1, 'rgba(245,158,11,0.03)');

  ctx.beginPath();
  points.forEach((p, i) => {
    const x = xScale(i), y = yScale(p.grams);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(xScale(points.length - 1), padT + chartH);
  ctx.lineTo(xScale(0), padT + chartH);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  points.forEach((p, i) => {
    const x = xScale(i), y = yScale(p.grams);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = '#F59E0B';
  ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.stroke();

  // End dot
  const lastX = xScale(points.length - 1), lastY = yScale(points[points.length - 1].grams);
  ctx.beginPath();
  ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#F59E0B';
  ctx.fill();
}

function renderMetalHoldingRow(m, idx) {
  // Standalone helper — uses currentMetal from outer scope
  const ac = METAL_CONFIG[currentMetal];
  const grams=Number(m.grams||m.weightGms||0);
  const purity = m.purity||'';
  const price = getPriceForMetal(currentMetal, purity);
  const usdVal=grams*price;
  const oz=(grams/31.1035).toFixed(3);
  const purityTag = purity ? `<span style="background:#F5F5F5;border-radius:5px;padding:1px 6px;font-size:0.75em;font-weight:700;color:#7C3AED;">${purity}</span>` : '';
  const priceTag = `<span style="color:var(--text-light);font-size:0.75em;">$${price.toFixed(2)}/g <span style="color:#10B981;font-size:0.85em;font-weight:800;">live</span></span>`;
  const sourceTag = m._source==='networth' ? `<span style="font-size:0.7em;color:var(--text-light);"> · 📊 NW</span>` : '';
  // Resolve paid cost → prefer canonical costBasisUSD, fall back to legacy m.price/gram
  let paidCostUSD = 0;
  if (Number(m.costBasisUSD || 0) > 0) {
    paidCostUSD = Number(m.costBasisUSD);
  } else if (m.price && m.price > 0) {
    const pStoredCurr = m.priceCurrency || currentCurrency.code;
    const pDispVal = convertAmt(m.price, pStoredCurr);
    const fxToUSD = convertAmt(1, 'USD');
    paidCostUSD = fxToUSD > 0 ? (pDispVal / fxToUSD) * grams : m.price * grams;
  }
  // Show purchase date if available
  const purchaseDateStr = m.purchaseDate
    ? ` · <span style="font-size:0.9em;color:#9AA0B2;">${m.purchaseDate.slice(0,7)}</span>` : '';
  const paidTag = paidCostUSD > 0
    ? `<div style="font-size:0.7em;color:#7C3AED;font-weight:700;margin-top:1px;">paid ${fmt(convertAmt(paidCostUSD,'USD'))}${purchaseDateStr}</div>` : '';
  const qaTag = ''; // Propagation is seamless — no need to show source chip
  const delBtn = m._source==='networth'
    ? `<button class="metal-holding-del" onclick="navigateTo('networth')" title="Manage in Net Worth">↗️</button>`
    : `<button class="metal-holding-del" onclick="deleteMetalEntry(${m._metalIdx})" title="Delete">✕</button>`;
  return `<div class="metal-holding-item">
      <div class="metal-holding-badge ${currentMetal}">${ac.emoji}</div>
      <div class="metal-holding-main">
        <div class="metal-holding-top">
          <span class="metal-holding-name-text">${m.name||m.itemName||'Unnamed'}</span>
          ${purityTag}${qaTag||''}
        </div>
        <div class="metal-holding-bottom">${grams.toFixed(2)}g · ${oz}oz ${priceTag}${m.occasion?' · '+m.occasion:''}${m.notes?' · '+m.notes:''}${sourceTag}</div>
      </div>
      <div class="metal-holding-right">
        <div class="metal-holding-value">${fmt(convertAmt(usdVal,'USD'))}</div>
        <div class="metal-holding-weight">${grams.toFixed(2)} g</div>
        ${paidTag||''}
      </div>
      <button class="metal-holding-del" onclick="openEditMetalSheet(${m._metalIdx})" title="Edit" style="color:#4A9EFF;">${m._source==='portfolio'?'✏️':''}</button>
      ${delBtn}
    </div>`;
}

function addMetalEntry() {
  const name=document.getElementById('metal-name').value.trim(), grams=parseFloat(document.getElementById('metal-grams').value), price=parseFloat(document.getElementById('metal-price').value)||0, date=document.getElementById('metal-date').value||localDateStr(), form=document.getElementById('metal-form').value, notes=document.getElementById('metal-notes').value.trim(), purity=document.getElementById('metal-purity').value.trim(), occasion=document.getElementById('metal-occasion').value.trim();
  if(!name){showToast('Enter a source/name ❌');return;} if(!grams||grams<=0){showToast('Enter a valid weight ❌');return;}
  // Compute costBasisUSD from entered price (price is per-gram in display currency)
  let costBasisUSD = 0;
  if (price > 0) {
    const fxRate = convertAmt(1, 'USD'); // 1 USD in display currency
    costBasisUSD = fxRate > 0 ? (price * grams) / fxRate : price * grams;
  }
  getMetals().push({metalType:currentMetal,name,grams,costBasisUSD,date,form,notes,purity,occasion});
  save(); renderMetals();
  ['name','grams','price','notes','purity','occasion'].forEach(id=>{try{document.getElementById('metal-'+id).value='';}catch(e){}});
  addPanelOpen=false; document.getElementById('metal-add-panel-body').classList.remove('open'); document.getElementById('add-panel-toggle').textContent='+';
  showToast(METAL_CONFIG[currentMetal].emoji+' '+METAL_CONFIG[currentMetal].label+' entry added!');
}
function deleteMetalEntry(idx) {
  if (idx < 0 || idx >= (data._metals||[]).length) { showToast('Cannot find entry ❌'); return; }
  if (!confirm('Delete this metal entry?')) return;
  const entry = data._metals[idx];
  // Use stable _qaLinkId to find and delete linked investment tx
  if (entry && entry._qaLinkId) {
    const mk = entry._fromQAMonth;
    if (mk && data[mk] && data[mk].investments) {
      const invIdx = data[mk].investments.findIndex(t => t._qaLinkId === entry._qaLinkId);
      if (invIdx >= 0) data[mk].investments.splice(invIdx, 1);
    }
  }
  data._metals.splice(idx, 1);
  save();
  // Refresh all affected views
  renderMetals();
  renderNetWorth();
  renderHome();
  renderTransactions();
  showToast('🗑 Entry deleted from Metals, Investing & NW');
}

// Delete an imported metal entry directly from NW screen
function deleteImportedMetal(idx) {
  if (!confirm('Delete this metal entry?')) return;
  if (!data._metals || !data._metals[idx]) return;
  const entry = data._metals[idx];
  if (entry && entry._qaLinkId) {
    const mk = entry._fromQAMonth;
    if (mk && data[mk] && data[mk].investments) {
      const invIdx = data[mk].investments.findIndex(t => t._qaLinkId === entry._qaLinkId);
      if (invIdx >= 0) data[mk].investments.splice(invIdx, 1);
    }
  }
  data._metals.splice(idx, 1);
  save(); renderNetWorth(); renderMetals(); renderHome(); renderTransactions();
  showToast('🗑 Metal entry deleted');
}

// Open edit sheet for an imported metal entry from NW screen
function openEditMetalSheet(idx) {
  const m = (data._metals || [])[idx];
  if (!m) return;

  // Always remove and recreate so currency symbols are always fresh
  const old = document.getElementById('metal-edit-modal');
  if (old) old.remove();

  const S = sym(); // current display currency symbol e.g. ₹
  const C = currentCurrency.code; // e.g. INR

  const modal = document.createElement('div');
  modal.id = 'metal-edit-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:flex-end;justify-content:center;';
  modal.innerHTML = `<div style="background:white;border-radius:22px 22px 0 0;padding:22px 20px 36px;width:100%;max-width:480px;box-shadow:0 -8px 32px rgba(0,0,0,0.15);max-height:90vh;overflow-y:auto;">
    <!-- Handle + header -->
    <div style="display:flex;justify-content:center;margin-bottom:10px;">
      <div style="width:38px;height:4px;background:#E0E0E0;border-radius:4px;"></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <div style="font-weight:900;font-size:1.05em;color:#222;">✏️ Edit Metal Entry</div>
      <button onclick="document.getElementById('metal-edit-modal').remove()" style="background:#F5F5F5;border:none;border-radius:50%;width:32px;height:32px;font-size:1.1em;cursor:pointer;">✕</button>
    </div>
    <div style="display:grid;gap:10px;">
      <!-- Name -->
      <input id="me-name" placeholder="Item name (e.g. Earrings)" style="width:100%;padding:10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;box-sizing:border-box;">
      <!-- Weight + Purity -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="position:relative;">
          <input id="me-grams" type="number" placeholder="Weight" step="0.001" min="0" style="width:100%;padding:10px 38px 10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;box-sizing:border-box;">
          <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:0.75em;font-weight:700;color:#9AA0B2;">g</span>
        </div>
        <input id="me-purity" placeholder="Purity e.g. 22K" style="padding:10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;width:100%;box-sizing:border-box;">
      </div>
      <!-- Occasion -->
      <input id="me-occasion" placeholder="Occasion (e.g. Anniversary)" style="width:100%;padding:10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;box-sizing:border-box;">
      <!-- Metal type -->
      <select id="me-type" style="width:100%;padding:10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;background:white;box-sizing:border-box;">
        <option value="gold">🥇 Gold</option>
        <option value="silver">🥈 Silver</option>
        <option value="platinum">⬜ Platinum</option>
      </select>

      <!-- ── Cost Basis block ── -->
      <div style="background:#F8F8F8;border-radius:14px;padding:14px;">
        <div style="font-size:0.68em;font-weight:800;color:#9AA0B2;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;">💰 Purchase Cost (for ROI)</div>

        <!-- Mode toggle: Total price vs Per-gram -->
        <div style="background:#EBEBEB;border-radius:10px;padding:3px;display:flex;gap:2px;margin-bottom:12px;">
          <button id="me-mode-total" onclick="meCostMode('total')"
            style="flex:1;border:none;border-radius:8px;padding:7px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.78em;cursor:pointer;background:white;color:#222;box-shadow:0 1px 3px rgba(0,0,0,0.10);">
            Total price paid
          </button>
          <button id="me-mode-pergram" onclick="meCostMode('pergram')"
            style="flex:1;border:none;border-radius:8px;padding:7px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.78em;cursor:pointer;background:transparent;color:#9AA0B2;">
            Avg price / gram
          </button>
        </div>

        <!-- Total price input -->
        <div id="me-cost-total-row" style="position:relative;">
          <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-weight:800;font-size:0.88em;color:#9AA0B2;pointer-events:none;">${S}</span>
          <input id="me-cost-total" type="number" placeholder="e.g. 24500" step="0.01" min="0"
            style="width:100%;padding:10px 12px 10px 28px;border:1.5px solid #E0E0E0;border-radius:10px;font-size:0.95em;font-weight:800;font-family:Nunito,sans-serif;outline:none;box-sizing:border-box;background:white;"
            onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#E0E0E0'">
        </div>

        <!-- Per-gram input (hidden by default) -->
        <div id="me-cost-pergram-row" style="display:none;position:relative;">
          <span style="position:absolute;left:11px;top:50%;transform:translateY(-50%);font-weight:800;font-size:0.88em;color:#9AA0B2;pointer-events:none;">${S}</span>
          <input id="me-cost-pergram" type="number" placeholder="e.g. 6282" step="0.01" min="0"
            style="width:100%;padding:10px 12px 10px 28px;border:1.5px solid #E0E0E0;border-radius:10px;font-size:0.95em;font-weight:800;font-family:Nunito,sans-serif;outline:none;box-sizing:border-box;background:white;"
            onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#E0E0E0'">
        </div>

        <div style="font-size:0.62em;color:#9AA0B2;font-weight:700;margin-top:6px;">
          Entered in <strong>${C}</strong> — stored internally in USD for consistent ROI tracking
        </div>
      </div>

      <!-- Purchase date -->
      <div style="position:relative;">
        <div style="font-size:0.68em;font-weight:800;color:#9AA0B2;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:5px;">📅 Purchase Date <span style="font-weight:600;font-size:0.9em;">(optional — improves ROI trends)</span></div>
        <input id="me-purchase-date" type="date"
          style="width:100%;padding:10px 12px;border:1.5px solid #E8E8E8;border-radius:10px;font-family:Nunito,sans-serif;font-weight:700;font-size:0.9em;box-sizing:border-box;background:white;">
      </div>

      <button onclick="saveMetalEdit()" style="background:#10B981;color:white;border:none;border-radius:12px;padding:14px;font-weight:900;font-size:1em;cursor:pointer;font-family:Nunito,sans-serif;">✅ Save Changes</button>
    </div>
  </div>`;
  document.body.appendChild(modal);

  // Pre-fill fields
  document.getElementById('me-name').value     = m.itemName || m.name || '';
  document.getElementById('me-grams').value    = m.grams || m.weightGms || '';
  document.getElementById('me-purity').value   = m.purity || '';
  document.getElementById('me-occasion').value = m.occasion || '';
  document.getElementById('me-type').value     = m.metalType || 'gold';

  // Pre-fill cost basis — costBasisUSD is the canonical field (total cost in USD)
  // Legacy: m.price was price-per-gram in m.priceCurrency
  const grams = parseFloat(m.grams || m.weightGms || 0);
  let totalInDisp = '';
  if (m.costBasisUSD > 0) {
    // New canonical field — convert USD total → display currency
    totalInDisp = convertAmt(m.costBasisUSD, 'USD').toFixed(2);
  } else if (m.price > 0 && grams > 0) {
    // Legacy per-gram field — reconstruct total in display currency
    const storedCurr = m.priceCurrency || 'USD';
    const perGramDisp = convertAmt(m.price, storedCurr);
    totalInDisp = (perGramDisp * grams).toFixed(2);
  }
  if (totalInDisp) document.getElementById('me-cost-total').value = totalInDisp;

  // Pre-fill purchase date (use m.purchaseDate if set, else fall back to m.date)
  const dateEl = document.getElementById('me-purchase-date');
  if (dateEl) dateEl.value = m.purchaseDate || m.date || '';

  modal.dataset.idx = idx;
  modal.style.display = 'flex';
}

function meCostMode(mode) {
  const isTotal = mode === 'total';
  document.getElementById('me-cost-total-row').style.display    = isTotal ? '' : 'none';
  document.getElementById('me-cost-pergram-row').style.display  = isTotal ? 'none' : '';
  // Button styles
  const btnT = document.getElementById('me-mode-total');
  const btnP = document.getElementById('me-mode-pergram');
  btnT.style.background   = isTotal ? 'white' : 'transparent';
  btnT.style.color        = isTotal ? '#222' : '#9AA0B2';
  btnT.style.boxShadow    = isTotal ? '0 1px 3px rgba(0,0,0,0.10)' : 'none';
  btnP.style.background   = isTotal ? 'transparent' : 'white';
  btnP.style.color        = isTotal ? '#9AA0B2' : '#222';
  btnP.style.boxShadow    = isTotal ? 'none' : '0 1px 3px rgba(0,0,0,0.10)';
}

function saveMetalEdit() {
  const modal = document.getElementById('metal-edit-modal');
  if (!modal) return;
  const idx = parseInt(modal.dataset.idx);
  const m = (data._metals || [])[idx];
  if (!m) return;

  const name     = document.getElementById('me-name').value.trim();
  const grams    = parseFloat(document.getElementById('me-grams').value);
  const purity   = document.getElementById('me-purity').value.trim();
  const occasion = document.getElementById('me-occasion').value.trim();
  const type     = document.getElementById('me-type').value;

  if (!name)             { showToast('Enter item name ❌'); return; }
  if (!grams || grams <= 0) { showToast('Enter valid weight ❌'); return; }

  // Resolve cost basis → always store as total USD internally (costBasisUSD)
  const totalRow   = document.getElementById('me-cost-total-row');
  const useTotal   = totalRow && totalRow.style.display !== 'none';
  let costBasisUSD = m.costBasisUSD || 0; // keep existing if not changed

  if (useTotal) {
    const totalDisp = parseFloat(document.getElementById('me-cost-total').value);
    if (!isNaN(totalDisp) && totalDisp > 0) {
      // Convert display currency total → USD
      const fxRate = convertAmt(1, 'USD'); // 1 USD in display currency
      costBasisUSD = fxRate > 0 ? totalDisp / fxRate : totalDisp;
    } else if (totalDisp === 0) {
      costBasisUSD = 0;
    }
  } else {
    const perGramDisp = parseFloat(document.getElementById('me-cost-pergram').value);
    if (!isNaN(perGramDisp) && perGramDisp > 0) {
      const totalDisp = perGramDisp * grams;
      const fxRate = convertAmt(1, 'USD');
      costBasisUSD = fxRate > 0 ? totalDisp / fxRate : totalDisp;
    } else if (perGramDisp === 0) {
      costBasisUSD = 0;
    }
  }

  // Save purchase date if provided
  const purchaseDateEl = document.getElementById('me-purchase-date');
  const purchaseDate = purchaseDateEl ? purchaseDateEl.value.trim() : '';

  const updatedEntry = { ...m, metalType:type, name, itemName:name, grams, weightGms:grams, purity, occasion, costBasisUSD };
  if (purchaseDate) updatedEntry.purchaseDate = purchaseDate;
  // Clear legacy per-gram price fields to avoid double-counting in ROI
  delete updatedEntry.price;
  delete updatedEntry.priceCurrency;

  data._metals[idx] = updatedEntry;
  save(); renderMetals(); renderNetWorth();
  // Animate close like a bottom sheet sliding down
  const sheet = modal.querySelector('div');
  if (sheet) { sheet.style.transition = 'transform 0.28s ease'; sheet.style.transform = 'translateY(100%)'; }
  setTimeout(() => { modal.remove(); showToast('✅ Entry saved successfully!'); }, 260);
}

// ══════════════════════════════════════════════════════
// INVESTMENTS
// ══════════════════════════════════════════════════════
function getInvestments() { if(!data._investments) data._investments=[]; return data._investments; }
function filterInvest(cat,btn) { currentInvestFilter=cat; document.querySelectorAll('.invest-cat-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderInvestments(); }
function renderInvestments() {
  const investments=getInvestments();
  let totalCost=0, totalValue=0;
  investments.forEach(inv=>{totalCost+=Number(inv.shares||0)*Number(inv.cost||0);totalValue+=Number(inv.shares||0)*Number(inv.price||inv.cost||0);});
  const totalGain=totalValue-totalCost, totalPct=totalCost>0?totalGain/totalCost*100:0;
  document.getElementById('invest-total-value').textContent=fmt(totalValue);
  document.getElementById('invest-total-cost').textContent=fmt(totalCost);
  document.getElementById('invest-total-gain').textContent=(totalGain>=0?'+':'-')+fmt(Math.abs(totalGain));
  document.getElementById('invest-total-pct').textContent=(totalPct>=0?'+':'')+totalPct.toFixed(1)+'%';
  const filtered=currentInvestFilter==='All'?investments:investments.filter(inv=>inv.category===currentInvestFilter);
  const hl=document.getElementById('invest-holdings-list');
  if(filtered.length===0){hl.innerHTML=`<div style="text-align:center;padding:40px;color:var(--text-light);background:var(--white);border-radius:var(--radius);box-shadow:var(--card-shadow);"><div style="font-size:2.5em;margin-bottom:8px;">📊</div><div style="font-weight:700;">No investments${currentInvestFilter!=='All'?' in '+currentInvestFilter:''} yet</div></div>`;return;}
  const catColors={Stocks:'#4A9EFF',ETF:'#10B981',Crypto:'#F59E0B',Retirement:'#7C3AED','Real Estate':'#FF6B35',Other:'#9AA0B2'};
  hl.innerHTML=filtered.map(inv=>{const realIdx=investments.indexOf(inv);const cost=Number(inv.shares||0)*Number(inv.cost||0);const val=Number(inv.shares||0)*Number(inv.price||inv.cost||0);const gain=val-cost;const pct=cost>0?gain/cost*100:0;const color=catColors[inv.category]||'#9AA0B2';return`<div class="invest-holding-row"><div class="invest-ticker-badge" style="background:${color}18;color:${color};">${(inv.ticker||'?').toUpperCase()}</div><div class="invest-info"><div class="invest-name">${inv.ticker||'Investment'}</div><div class="invest-detail">${inv.shares} shares · ${inv.broker||''} · ${inv.category||''}</div></div><div class="invest-values"><div class="invest-value">${fmt(val)}</div><div class="invest-gain ${gain>=0?'up':'down'}">${gain>=0?'+':'-'}${fmtFull(Math.abs(gain))} (${pct.toFixed(1)}%)</div></div><button onclick="deleteInvestEntry(${realIdx})" style="background:#FFF0F0;border:none;border-radius:8px;padding:6px 8px;font-size:0.75em;color:var(--expenses);cursor:pointer;margin-left:8px;">✕</button></div>`;}).join('');
}
function addInvestEntry() {
  const ticker=document.getElementById('inv-ticker').value.trim().toUpperCase(), category=document.getElementById('inv-cat').value, shares=parseFloat(document.getElementById('inv-shares').value), cost=parseFloat(document.getElementById('inv-cost').value), price=parseFloat(document.getElementById('inv-price').value)||cost, date=document.getElementById('inv-date').value||localDateStr(), broker=document.getElementById('inv-broker').value.trim();
  if(!ticker||!shares||!cost){showToast('Fill in ticker, shares & cost ❌');return;}
  const investments=getInvestments();
  const existing=investments.find(inv=>inv.ticker===ticker&&inv.category===category);
  if(existing){if(confirm(`${ticker} already exists. Add more shares?`)){const ts=Number(existing.shares)+shares;existing.cost=((Number(existing.cost)*Number(existing.shares)+cost*shares)/ts).toFixed(2);existing.shares=ts.toFixed(4);if(price) existing.price=price.toFixed(2);}else return;}
  else investments.push({ticker,category,shares:shares.toFixed(4),cost:cost.toFixed(2),price:price.toFixed(2),date,broker});
  save(); renderInvestments();
  ['inv-ticker','inv-shares','inv-cost','inv-price','inv-broker'].forEach(id=>document.getElementById(id).value='');
  showToast(`📈 ${ticker} added to portfolio!`);
}
function deleteInvestEntry(idx) { if(!confirm('Remove this investment?')) return; data._investments.splice(idx,1); save(); renderInvestments(); showToast('Investment removed'); }

// ══════════════════════════════════════════════════════
// PIN LOCK — COMMENTED OUT (RE-ENABLE LATER)
// ══════════════════════════════════════════════════════
/*
=== PIN LOCK JAVASCRIPT — Uncomment this entire block to re-enable ===
=== Also uncomment: CSS block, HTML lock screen div, initLockScreen() in init ===

const PIN_KEY = 'mf_pin';
let pinBuffer = '', lockMode = 'unlock', setupFirstPin = '', lockAttempts = 0;
const MAX_ATTEMPTS = 5;
let lockoutTimerInterval = null;

function getStoredPIN(){ return localStorage.getItem(PIN_KEY)||''; }
function hasPin(){ return !!getStoredPIN(); }

function initLockScreen(){
  const ls = document.getElementById('lock-screen');
  if(!ls) return;
  if(hasPin()){
    lockMode = 'unlock';
    ls.style.display = 'flex';
  } else {
    ls.style.display = 'none';
  }
}

function pinPress(digit){ ... }
function pinDel(){ ... }
function handlePinComplete(){ ... }
function unlockApp(){ ... }
function hideLockScreen(){ ... }
function handlePinToggle(){ ... }
function openLockForSetup(){ ... }
function showChangePIN(){ ... }
function updateSettingsPinUI(){ ... }
// (fill in the full implementations from the original code)

=== END PIN LOCK JAVASCRIPT ===
*/

// ══════════════════════════════════════════════════════
// BUDGET MODULE
// ══════════════════════════════════════════════════════
let budgetViewMonth = getCurrentMonthKey();
let currentBudgetTab = 'overview';
let currentBudgetCatDetail = null; // {type:'expense'|'savings', goalKey}
let editingBudgetKey = null; // null = new, string = existing key
let editingBudgetType = 'expense';
let pickedBudgetEmoji = '💸';

const BUDGET_EMOJIS = ['💸','🛒','🚗','🏠','💊','🎭','🍔','☕','🎓','🐾','✈️','👗','🎮','🏋️','🎁','📱','⚡','🚌','💈','🎪','🏥','🏦','🔧','🌮','📚','🐟','🌿','💡','🎯','🏡','🥇','💰','📈','🏛️','🎉','🍕','🌺','🌊','🎶','🧘'];

// Default budgets — empty for new users, they set up their own
const DEFAULT_EXPENSE_BUDGETS = [
  // 🍔 Food & Daily Living
  { key:'Groceries & Food',   name:'Groceries & Food',   amount:0, linkedCats:['Groceries','FastFood','Restaurant','Breakfast','Lunch','Dinner','Takeout','Swiggy','Zomato','Snacks','Coffee'], icon:'🛒', type:'expense' },
  { key:'Transport',          name:'Transport',           amount:0, linkedCats:['Gas','Fuel','Uber','Ola','Auto','Transport','Metro','Bus','Parking','Toll'],              icon:'🚌', type:'expense' },
  { key:'Housing & Utilities',name:'Housing & Utilities', amount:0, linkedCats:['Rent','Mortgage','Electricity','Water','Internet','WiFi','Gas Bill','Utility','Maintenance'], icon:'🏠', type:'expense' },
  { key:'Health & Medical',   name:'Health & Medical',    amount:0, linkedCats:['Doctor','Medicine','Pharmacy','Dental','Hospital','Gym','Lab Test'],                      icon:'💊', type:'expense' },
  { key:'Phone & Subscriptions',name:'Phone & Subscriptions',amount:0,linkedCats:['Phone','Mobile','Netflix','Spotify','Amazon Prime','Hotstar','YouTube Premium','Software'],icon:'📱', type:'expense' },
  { key:'Shopping',           name:'Shopping',            amount:0, linkedCats:['Clothing','Electronics','Cosmetics','Household','Furniture','Amazon','Flipkart','Shopping'],icon:'🛍️', type:'expense' },
  { key:'Family & Giving',    name:'Family & Giving',     amount:0, linkedCats:['Parents','Family','Kids','Spouse','Gift','Charity','Donation'],                            icon:'❤️', type:'expense' },
  { key:'Entertainment & Travel',name:'Entertainment & Travel',amount:0,linkedCats:['Travel','Flight','Hotel','Vacation','Movies','Entertainment','Sports','Hobby'],        icon:'✈️', type:'expense' },
  { key:'Education',          name:'Education',           amount:0, linkedCats:['School Fees','College','Course','Books','Tuition','Coaching'],                            icon:'🎓', type:'expense' },
  { key:'EMI & Loan',         name:'EMI & Loan',          amount:0, linkedCats:['EMI','Loan Payment','Mortgage'],                                                           icon:'🏦', type:'expense' },
];

const DEFAULT_SAVINGS_BUDGETS = [
  // 📈 Investments & Savings
  { key:'Equity Investments',  name:'Equity Investments',  amount:0, linkedCats:['Stocks','ETF','Mutual Fund','SIP','Crypto'],         icon:'📈', type:'savings' },
  { key:'Gold & Metals',       name:'Gold & Metals',        amount:0, linkedCats:['Gold','Silver','Gold & Metals','Metals'],               icon:'🥇', type:'savings' },
  { key:'Retirement Savings',  name:'Retirement Savings',   amount:0, linkedCats:['NPS','PPF','EPF','VPF','401k','IRA','Retirement'],   icon:'🏛️', type:'savings' },
  { key:'Fixed Income',        name:'Fixed Income',         amount:0, linkedCats:['FD','RD','Bonds','Fixed Deposit'],                   icon:'🏦', type:'savings' },
  { key:'Emergency Fund',      name:'Emergency Fund',       amount:0, linkedCats:['Emergency','Savings','Liquid'],                      icon:'🛡️', type:'savings' },
];

function getBudgetGoals(type) {
  const key = type === 'savings' ? '_savingsGoals' : '_expenseGoals';
  if (!data[key]) {
    data[key] = type === 'savings' ? DEFAULT_SAVINGS_BUDGETS.map(g => ({...g})) : DEFAULT_EXPENSE_BUDGETS.map(g => ({...g}));
    save();
  }
  return data[key];
}


// ═══════════════════════════════════════════════════════
// GOALS MODULE (Feature 4)
// ═══════════════════════════════════════════════════════
function getGoals() { return data._goals || []; }
function saveGoals(goals) { data._goals = goals; save(); }

function openGoalSheet(editId) {
  const goals = getGoals();
  const g = editId ? goals.find(x => x.id === editId) : null;

  document.getElementById('goal-sheet-title').textContent = g ? '✏️ Edit Goal' : '🎯 New Goal';
  const saveBtn = document.getElementById('gs-save-btn');
  if (saveBtn) saveBtn.textContent = g ? '✏️ Update Goal' : '🎯 Add Goal';
  document.getElementById('gs-name').value    = g ? g.name : '';
  document.getElementById('gs-icon').value    = g ? (g.icon||'🎯') : '🎯';
  document.getElementById('gs-target').value  = g ? g.target : '';
  document.getElementById('gs-unit').value    = g ? (g.unit||'currency') : 'currency';
  document.getElementById('gs-currency').value= g ? (g.currency||'USD') : 'USD';
  document.getElementById('gs-date').value    = g ? (g.targetDate||'') : '';
  document.getElementById('gs-desc').value    = g ? (g.desc||'') : '';
  document.getElementById('gs-editing-id').value = editId || '';
  const goalTypeEl = document.getElementById('gs-goaltype');
  if (goalTypeEl) goalTypeEl.value = g ? (g.goalType||'grow') : 'grow';
  const startBalEl = document.getElementById('gs-startbal');
  if (startBalEl) startBalEl.value = g ? (g.startBalance||'') : '';
  toggleGoalTypeFields();

  // Build account picker from NW accounts
  buildGoalAccountPicker(g ? (g.mappedAccounts||[]) : []);
  // Render icon picker with current selection highlighted
  renderGoalIconPicker(g ? (g.icon||'🎯') : '🎯');
  updateGoalPreview();

  document.getElementById('goal-sheet').style.display = 'block';
  document.getElementById('goal-sheet-overlay').style.display = 'block';
}

function toggleGoalTypeFields() {
  const goalType = document.getElementById('gs-goaltype')?.value || 'grow';
  const startBalRow = document.getElementById('gs-startbal-row');
  if (startBalRow) startBalRow.style.display = goalType === 'reduce' ? '' : 'none';
  // For reduce goals, show liability-friendly label on account picker
  const pickerLabel = document.getElementById('gs-picker-label');
  if (pickerLabel) {
    pickerLabel.textContent = goalType === 'reduce'
      ? 'Map Liability Accounts to track reduction progress'
      : 'Map NW Accounts to this Goal';
  }
  const pickerHint = document.getElementById('gs-picker-hint');
  if (pickerHint) {
    pickerHint.textContent = goalType === 'reduce'
      ? 'Select loan/credit card accounts. Progress tracks as the balance goes down.'
      : 'Search and select accounts — grouped by type. Combined value counts as current progress.';
  }
  updateGoalPreview();
}

function closeGoalSheet() {
  document.getElementById('goal-sheet').style.display = 'none';
  document.getElementById('goal-sheet-overlay').style.display = 'none';
}

function closeGoalsPanelBack() {
  // Go back to budget overview
  const panel = document.getElementById('blist-goals');
  const fab   = document.getElementById('goals-fab-btn');
  if (panel) panel.style.display = 'none';
  if (fab)   fab.style.display   = 'none';
  setBudgetTab('overview', document.getElementById('btab-overview'));
}

// ── Holds the full account list so filter can re-render without recomputing
let _gapAllGroups = [];
let _gapSelectedIds = new Set();

// ── Goals panel tab state ──
let goalsTab = 'active'; // 'active' | 'achieved'

const GOAL_EMOJIS = [
  '🎯','🏆','🏅','💰','🏠','🚗','🎓','✈️','👨‍👩‍👧‍👦','🏖️',
  '💎','🥇','📈','🏛️','🛡️','🌍','🧓','💊','🎉','🔑',
  '🏗️','🌱','⚡','📱','🏋️','🎨','🚢','🌺','🎶','🐾',
];

function renderGoalIconPicker(currentIcon) {
  const grid = document.getElementById('gs-icon-grid');
  if (!grid) return;
  const picked = currentIcon || document.getElementById('gs-icon')?.value || '🎯';
  grid.innerHTML = GOAL_EMOJIS.map(e =>
    `<div onclick="pickGoalIcon('${e}')"
      style="width:38px;height:38px;border-radius:10px;border:2px solid ${e===picked?'var(--yellow)':'transparent'};
             background:${e===picked?'var(--yellow-light)':'var(--bg)'};
             display:flex;align-items:center;justify-content:center;font-size:1.2em;cursor:pointer;transition:all 0.15s;"
      id="gs-icon-opt-${e.codePointAt(0)}">${e}</div>`
  ).join('');
}

function pickGoalIcon(e) {
  document.getElementById('gs-icon').value = e;
  renderGoalIconPicker(e);
}

function setGoalsTab(tab) {
  goalsTab = tab;
  const activeBtn   = document.getElementById('gtab-active');
  const achievedBtn = document.getElementById('gtab-achieved');
  if (activeBtn) {
    activeBtn.style.background   = tab === 'active'   ? 'var(--yellow)' : '#F0F0F0';
    activeBtn.style.color        = tab === 'active'   ? 'var(--text-dark)' : 'var(--text-med)';
  }
  if (achievedBtn) {
    achievedBtn.style.background = tab === 'achieved' ? 'var(--yellow)' : '#F0F0F0';
    achievedBtn.style.color      = tab === 'achieved' ? 'var(--text-dark)' : 'var(--text-med)';
  }
  renderGoalsPanel();
}

function buildGoalAccountPicker(selectedIds) {
  _gapSelectedIds = new Set(selectedIds || []);
  const nw = computeNetWorth();

  // Build grouped structure — one group per NW type
  _gapAllGroups = [];
  Object.keys(NW_TYPES).forEach(t => {
    const cfg   = NW_TYPES[t];
    const group = nw.byType[t];
    if (!group || group.accounts.length === 0) return;

    // For metals: consolidate individual rows by metalType+purity to avoid 190-row floods
    let accounts = group.accounts;
    if (t === 'metals') {
      const consolidated = {};
      accounts.forEach(a => {
        const metal  = (a.meta && a.meta.metalType) || 'gold';
        const purity = (a.meta && a.meta.purity)    || '';
        const key    = metal + '|' + purity;
        if (!consolidated[key]) {
          consolidated[key] = {
            ...a,
            id:   a.id,                      // keep first id for simple cases
            _ids: [a.id],                    // ALL ids in this group
            name: cfg.emoji + ' ' + metal.charAt(0).toUpperCase() + metal.slice(1) + (purity ? ' · ' + purity : ''),
            _val:  a._val || 0,
            meta: { ...a.meta },
          };
        } else {
          consolidated[key]._ids.push(a.id);
          consolidated[key]._val  += (a._val  || 0);
          consolidated[key].meta.grams = (Number(consolidated[key].meta.grams) || 0) + (Number(a.meta && a.meta.grams) || 0);
        }
      });
      accounts = Object.values(consolidated).map(c => ({
        ...c,
        id: c._ids[0],          // primary id for single-account goal mapping
        _allIds: c._ids,        // all ids so user can select the whole group
      }));
    }

    const groupTotal = accounts.reduce((s, a) => s + (a._val || 0), 0);
    _gapAllGroups.push({ type:t, cfg, accounts, groupTotal });
  });

  if (_gapAllGroups.length === 0) {
    const picker = document.getElementById('gs-account-picker');
    if (picker) picker.innerHTML = '<div class="gap-empty">No Net Worth accounts yet — add them in the Net Worth screen.</div>';
    return;
  }
  // Clear search and render
  const searchInput = document.getElementById('gap-search-input');
  if (searchInput) searchInput.value = '';
  _renderGapGroups('');
}

function _renderGapGroups(query) {
  const picker = document.getElementById('gs-account-picker');
  if (!picker) return;
  const q = query.toLowerCase().trim();
  let html = '';
  let anyResult = false;

  _gapAllGroups.forEach((grp, gi) => {
    const filteredAccounts = q
      ? grp.accounts.filter(a => a.name.toLowerCase().includes(q))
      : grp.accounts;
    if (filteredAccounts.length === 0) return;
    anyResult = true;

    const groupSelectedCount = filteredAccounts.filter(a => {
      const ids = a._allIds || [a.id];
      return ids.some(id => _gapSelectedIds.has(id));
    }).length;
    const allSelected = groupSelectedCount === filteredAccounts.length;
    const groupTotalFmt = fmt(grp.groupTotal);
    const collapseId = 'gapgrp_' + gi;

    html += `<div class="gap-group">
      <div class="gap-group-header" onclick="toggleGapGroup('${collapseId}')">
        <div class="gap-group-title">
          <span>${grp.cfg.emoji}</span>
          <span>${grp.cfg.label}</span>
          ${groupSelectedCount > 0 ? `<span style="background:var(--primary);color:white;font-size:0.65em;border-radius:20px;padding:2px 7px;">${groupSelectedCount} selected</span>` : ''}
        </div>
        <div class="gap-group-meta">
          <span class="gap-group-total">${groupTotalFmt}</span>
          <span style="font-size:0.75em;color:var(--text-light)">${filteredAccounts.length} acct${filteredAccounts.length===1?'':'s'}</span>
          <span class="gap-group-chevron open" id="${collapseId}_chev">›</span>
        </div>
      </div>
      <div class="gap-group-body" id="${collapseId}">
        ${!q ? `<div class="gap-select-all" onclick="gapSelectAll(${gi},${allSelected})">
          ${allSelected ? '☑ Deselect all in group' : '☐ Select all in group'}
        </div>` : ''}
        ${filteredAccounts.map((a, ai) => {
          const ids = a._allIds || [a.id];
          const isChecked = ids.some(id => _gapSelectedIds.has(id));
          const grams = a.meta && a.meta.grams ? Number(a.meta.grams).toFixed(1) + 'g' : '';
          const oz    = a.meta && a.meta.grams ? (Number(a.meta.grams)/31.1035).toFixed(3) + ' oz' : '';
          const subLine = grams ? `${grams} · ${oz}` : (a.meta && a.meta.purity ? a.meta.purity : '');
          return `<div class="gap-acc-row ${isChecked?'selected':''}" onclick="gapToggleAcc(${gi},${ai},'${ids.join(',')}',this)">
            <div class="gap-acc-cb ${isChecked?'checked':''}" id="gapcb_${gi}_${ai}">${isChecked?'✓':''}</div>
            <div style="flex:1;min-width:0;">
              <div class="gap-acc-name">${a.name}</div>
              ${subLine ? `<div class="gap-acc-sub">${subLine}</div>` : ''}
            </div>
            <div class="gap-acc-val">
              <div class="gap-acc-val-main">${fmt(a._val||0)}</div>
              ${a.currency && a.currency !== currentCurrency.code ? `<div class="gap-acc-val-sub">${a.currency}</div>` : ''}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  });

  picker.innerHTML = anyResult ? html : '<div class="gap-empty">No accounts match your search</div>';
}

function toggleGapGroup(id) {
  const body = document.getElementById(id);
  const chev = document.getElementById(id + '_chev');
  if (!body) return;
  const collapsed = body.classList.toggle('collapsed');
  if (chev) { chev.classList.toggle('open', !collapsed); }
}

function gapSelectAll(groupIdx, deselectMode) {
  const grp = _gapAllGroups[groupIdx];
  if (!grp) return;
  grp.accounts.forEach(a => {
    const ids = a._allIds || [a.id];
    ids.forEach(id => deselectMode ? _gapSelectedIds.delete(id) : _gapSelectedIds.add(id));
  });
  _renderGapGroups(document.getElementById('gap-search-input')?.value || '');
  updateGoalPreview();
}

function gapToggleAcc(groupIdx, accIdx, idsStr, rowEl) {
  const ids = idsStr.split(',');
  const isNowSelected = ids.some(id => _gapSelectedIds.has(id));
  if (isNowSelected) {
    ids.forEach(id => _gapSelectedIds.delete(id));
  } else {
    ids.forEach(id => _gapSelectedIds.add(id));
  }
  // Update visual without full re-render for speed
  const cb = rowEl.querySelector('.gap-acc-cb');
  rowEl.classList.toggle('selected', !isNowSelected);
  if (cb) { cb.classList.toggle('checked', !isNowSelected); cb.textContent = !isNowSelected ? '✓' : ''; }
  // Update group selected badge — re-render group header only
  _renderGapGroups(document.getElementById('gap-search-input')?.value || '');
  updateGoalPreview();
}

function filterGoalPicker(query) {
  _renderGapGroups(query);
}

function getGoalCheckedIds() {
  return [..._gapSelectedIds];
}

function updateGoalPreview() {
  const selectedIds = getGoalCheckedIds();
  const rawTarget = parseFloat(document.getElementById('gs-target').value) || 0;
  const unit      = document.getElementById('gs-unit').value;
  const goalCur   = (document.getElementById('gs-currency')?.value || currentCurrency.code).toUpperCase();
  const preview   = document.getElementById('gs-preview');
  if (!preview) return;

  if (selectedIds.length === 0 || rawTarget === 0) {
    preview.style.display = 'none';
    return;
  }

  // Convert target from goal's currency to display currency (for apples-to-apples comparison)
  const targetDisplay = unit === 'currency' ? convertAmt(rawTarget, goalCur) : rawTarget;
  const goalType      = document.getElementById('gs-goaltype')?.value || 'grow';
  const current       = computeGoalCurrent(selectedIds, unit, goalType);
  // For 'reduce' goals: progress = how much balance has dropped from startBalance toward target
  let pct;
  if (goalType === 'reduce') {
    const startBal = parseFloat(document.getElementById('gs-startbal')?.value) || 0;
    const reduced  = Math.max(startBal - current, 0);
    const totalReduce = Math.max(startBal - targetDisplay, 0);
    pct = totalReduce > 0 ? Math.min(reduced / totalReduce * 100, 100) : (current <= targetDisplay ? 100 : 0);
  } else {
    pct = targetDisplay > 0 ? Math.min(current / targetDisplay * 100, 100) : 0;
  }
  const unitLabel     = unit === 'grams' ? 'g' : unit === 'kg' ? 'kg' : unit === 'sqft' ? ' sqft' : '';
  const fmtCurrent    = unit === 'currency' ? fmt(current)        : current.toFixed(unit === 'sqft' ? 0 : 2) + unitLabel;
  const fmtTarget     = unit === 'currency' ? fmt(targetDisplay)  : rawTarget.toFixed(0) + unitLabel;
  const barColor      = pct >= 100 ? '#10B981' : pct >= 75 ? '#3B9EFF' : pct >= 40 ? '#F59E0B' : '#EF4444';
  const isForeign     = unit === 'currency' && goalCur !== currentCurrency.code;

  preview.style.display = '';
  const fill = document.getElementById('gap-preview-fill');
  const cur  = document.getElementById('gap-preview-current');
  const pctEl= document.getElementById('gap-preview-pct');
  const tgt  = document.getElementById('gap-preview-target');
  if (fill)  { fill.style.width = pct.toFixed(1) + '%'; fill.style.background = barColor; }
  if (cur)   {
    cur.textContent = goalType === 'reduce' ? 'Balance: ' + fmtCurrent : fmtCurrent;
    cur.style.color = barColor;
  }
  if (pctEl) { pctEl.textContent = pct.toFixed(0) + '%'; pctEl.style.color = barColor; }
  if (tgt)   {
    tgt.textContent = goalType === 'reduce'
      ? `→ Target: ${fmtTarget}`
      : isForeign
        ? `of ${fmtTarget} (${fmtGoalOriginal(rawTarget, goalCur)} ${goalCur})`
        : `of ${fmtTarget}`;
  }
}

function computeGoalCurrent(mappedAccountIds, unit, goalType) {
  const nw = computeNetWorth();
  const allAccounts = [];
  Object.keys(NW_TYPES).forEach(t => {
    const group = nw.byType[t];
    if (group) group.accounts.forEach(a => allAccounts.push({ ...a, _nwType: t }));
  });

  let total = 0;
  mappedAccountIds.forEach(id => {
    const acc = allAccounts.find(a => a.id === id);
    if (!acc) return;
    const isLiab = NW_TYPES[acc._nwType] && NW_TYPES[acc._nwType].isLiab;

    if (unit === 'grams') {
      total += Number(acc.meta && acc.meta.grams || 0);
    } else if (unit === 'kg') {
      total += Number(acc.meta && acc.meta.grams || 0) / 1000;
    } else if (unit === 'count') {
      total += 1;
    } else if (unit === 'sqft') {
      // For real estate: sum area (areaCents field stores sqft/area)
      total += Number(acc.meta && acc.meta.area || acc.meta && acc.meta.areaCents || 0);
    } else {
      // Currency: liabilities subtract from total (for net worth / grow goals)
      // For 'reduce' goals, we just sum the raw liability balance directly
      if (goalType === 'reduce') {
        total += Number(acc._val || 0);
      } else {
        // grow / networth: assets add, liabilities subtract
        total += isLiab ? -Number(acc._val || 0) : Number(acc._val || 0);
      }
    }
  });
  return total;
}

function saveGoal() {
  const name = document.getElementById('gs-name').value.trim();
  const targetRaw = document.getElementById('gs-target').value;
  const target = parseFloat(targetRaw);
  const goalType = document.getElementById('gs-goaltype')?.value || 'grow';
  if (!name) { showToast('Enter a goal name ❌'); return; }
  if (targetRaw === '' || isNaN(target)) { showToast('Enter a target amount ❌'); return; }
  if (goalType !== 'reduce' && !target) { showToast('Enter a target amount ❌'); return; }

  const goals = getGoals();
  const editId = document.getElementById('gs-editing-id').value;
  const mappedAccounts = [..._gapSelectedIds];

  const goal = {
    id:   editId || ('goal_' + Date.now()),
    name,
    icon:   document.getElementById('gs-icon').value || '🎯',
    target,
    unit:   document.getElementById('gs-unit').value,
    currency: document.getElementById('gs-currency').value,
    targetDate: document.getElementById('gs-date').value,
    desc:   document.getElementById('gs-desc').value.trim(),
    goalType: document.getElementById('gs-goaltype')?.value || 'grow',
    startBalance: parseFloat(document.getElementById('gs-startbal')?.value) || 0,
    mappedAccounts,
    createdAt: editId ? (goals.find(g=>g.id===editId)||{}).createdAt : localDateStr(),
  };

  if (editId) {
    const idx = goals.findIndex(g => g.id === editId);
    if (idx >= 0) goals[idx] = goal; else goals.push(goal);
  } else {
    goals.push(goal);
  }

  saveGoals(goals);
  closeGoalSheet();
  renderGoalsPanel();
  showToast('🎯 Goal saved!');
}

function deleteGoal(id) {
  if (!confirm('Delete this goal?')) return;
  data._goals = getGoals().filter(g => g.id !== id);
  save();
  renderGoalsPanel();
  showToast('Goal deleted');
}

// ── Convert a goal's raw target amount into the display currency.
// The target is stored in g.currency (e.g. ₹10,00,000 INR).
// computeGoalCurrent returns values in the display currency (e.g. USD).
// We must convert the target into display currency before computing the ratio.
function goalTargetInDisplay(g) {
  if ((g.unit || 'currency') !== 'currency') return Number(g.target || 0);
  const goalCur = (g.currency || currentCurrency.code).toUpperCase();
  return convertAmt(g.target || 0, goalCur);
}

// Get the currency symbol for a goal's declared currency
function goalCurrencySym(goalCurrencyCode) {
  const c = CURRENCIES.find(x => x.code === goalCurrencyCode);
  return c ? c.symbol : (goalCurrencyCode || sym());
}

// Format a raw amount in the goal's own currency (for display as the original target)
function fmtGoalOriginal(amount, currencyCode) {
  const s = goalCurrencySym(currencyCode);
  return s + Math.round(Number(amount || 0)).toLocaleString();
}

function renderGoalsPanel() {
  const el = document.getElementById('goals-list-grid');
  if (!el) return;
  const allGoals = getGoals();

  // Compute achieved status for every goal up front
  const tagged = allGoals.map(g => {
    const current       = computeGoalCurrent(g.mappedAccounts || [], g.unit || 'currency', g.goalType || 'grow');
    const targetDisplay = goalTargetInDisplay(g);
    let pct;
    if ((g.goalType || 'grow') === 'reduce') {
      const startBal = Number(g.startBalance || 0);
      const reduced  = Math.max(startBal - current, 0);
      const totalReduce = Math.max(startBal - targetDisplay, 0);
      pct = totalReduce > 0 ? Math.min(reduced / totalReduce * 100, 100) : (current <= targetDisplay ? 100 : 0);
    } else {
      pct = targetDisplay > 0 ? Math.min(current / targetDisplay * 100, 100) : 0;
    }
    return { g, current, targetDisplay, pct, achieved: pct >= 100 };
  });

  const activeList   = tagged.filter(t => !t.achieved);
  const achievedList = tagged.filter(t =>  t.achieved);

  // Update tab count badges
  const ac = document.getElementById('gtab-active-count');
  const hc = document.getElementById('gtab-achieved-count');
  if (ac) ac.textContent = activeList.length;
  if (hc) hc.textContent = achievedList.length;

  if (allGoals.length === 0) {
    el.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--text-light);">
      <div style="font-size:2.5em;margin-bottom:8px;">🎯</div>
      <div style="font-weight:800;font-size:0.9em;margin-bottom:4px;">No goals yet</div>
      <div style="font-size:0.78em;">Tap the <strong>＋</strong> button below to track financial milestones</div>
    </div>`;
    return;
  }

  const list = goalsTab === 'achieved' ? achievedList : activeList;

  if (list.length === 0) {
    el.innerHTML = goalsTab === 'achieved'
      ? `<div style="text-align:center;padding:40px 20px;color:var(--text-light);">
           <div style="font-size:2.5em;margin-bottom:8px;">🏆</div>
           <div style="font-weight:800;font-size:0.9em;margin-bottom:4px;">No achieved goals yet</div>
           <div style="font-size:0.78em;">Keep going — completed goals will appear here!</div>
         </div>`
      : `<div style="text-align:center;padding:40px 20px;color:var(--text-light);">
           <div style="font-size:2.5em;margin-bottom:8px;">🎉</div>
           <div style="font-weight:800;font-size:0.9em;margin-bottom:4px;">All goals achieved!</div>
           <div style="font-size:0.78em;">Incredible — set new ones with the ＋ button</div>
         </div>`;
    return;
  }

  el.innerHTML = list.map(({ g, current, targetDisplay, pct, achieved }) => {
    const unit        = g.unit || 'currency';
    const goalType    = g.goalType || 'grow';
    const goalCurCode = (g.currency || currentCurrency.code).toUpperCase();
    const isForeignCur = unit === 'currency' && goalCurCode !== currentCurrency.code;
    const barColor    = achieved ? '#10B981' : pct >= 75 ? '#3B9EFF' : pct >= 40 ? '#F59E0B' : '#EF4444';
    const fmtVal = v => unit === 'currency'
      ? fmt(v)
      : v.toFixed(unit === 'grams' ? 1 : unit === 'sqft' ? 0 : 2) + (unit === 'grams' ? 'g' : unit === 'kg' ? 'kg' : unit === 'sqft' ? ' sqft' : '');
    // For reduce goals: show how much is left to reduce
    const remaining = goalType === 'reduce'
      ? Math.max(current - targetDisplay, 0)   // still owe this much
      : Math.max(targetDisplay - current, 0);  // still need to grow by this
    // Goal type badge
    const goalTypeBadge = goalType === 'reduce'
      ? `<span style="font-size:0.65em;font-weight:800;background:#FFF0F0;color:#EF4444;border-radius:8px;padding:2px 7px;margin-left:4px;">📉 Reduce</span>`
      : goalType === 'grow' ? '' : '';
    // For reduce: show current balance vs target balance
    const progressLabel = goalType === 'reduce'
      ? `Balance: ${fmtVal(current)} → Target: ${fmtVal(targetDisplay)}`
      : `${fmtVal(current)} of ${fmtVal(targetDisplay)}`;

    // Target date tag
    let dateTag = '';
    if (g.targetDate) {
      const diffMs   = new Date(g.targetDate + '-01') - new Date();
      const diffDays = Math.ceil(diffMs / 86400000);
      dateTag = diffDays > 0
        ? `<span style="font-size:0.7em;font-weight:700;color:${diffDays<90?'#EF4444':'var(--text-light)'};margin-left:6px;">⏳ ${diffDays>60?Math.ceil(diffDays/30)+'mo':diffDays+'d'}</span>`
        : `<span style="font-size:0.7em;font-weight:700;color:#10B981;margin-left:6px;">✓ Deadline passed</span>`;
    }

    // Celebration banner only on achieved tab
    const achievedBanner = achieved ? `
      <div style="background:linear-gradient(135deg,#10B981,#059669);color:white;border-radius:10px;
                  padding:10px 14px;margin-bottom:10px;display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.6em;">🏆</span>
        <div>
          <div style="font-weight:900;font-size:0.88em;">Goal Achieved!</div>
          <div style="font-size:0.72em;opacity:0.85;">You hit ${fmtVal(targetDisplay)} — outstanding work</div>
        </div>
      </div>` : '';

    return `<div style="background:white;border-radius:16px;padding:14px 16px;margin-bottom:10px;
        box-shadow:0 2px 10px rgba(0,0,0,0.06);border:1.5px solid ${achieved?'#10B981':'#F0F0F0'};">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px;flex:1;min-width:0;">
          <span style="font-size:1.3em;">${g.icon||'🎯'}</span>
          <span style="font-weight:900;font-size:0.92em;color:var(--text-dark);margin-left:4px;">${g.name}</span>
          ${goalTypeBadge}
          ${dateTag}
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0;margin-left:8px;">
          <button onclick="openGoalSheet('${g.id}')" style="background:#F0F4FF;border:none;border-radius:8px;padding:5px 9px;font-size:0.75em;font-weight:800;color:var(--primary);cursor:pointer;">✏️</button>
          <button onclick="deleteGoal('${g.id}')" style="background:#FFF0F0;border:none;border-radius:8px;padding:5px 9px;font-size:0.75em;font-weight:800;color:var(--expenses);cursor:pointer;">✕</button>
        </div>
      </div>
      ${g.desc ? `<div style="font-size:0.75em;color:var(--text-light);font-weight:600;margin-bottom:8px;">${g.desc}</div>` : ''}
      ${achievedBanner}
      ${isForeignCur ? `<div style="font-size:0.72em;font-weight:700;color:var(--text-med);margin-bottom:6px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
        <span>🎯 Target:</span>
        <span style="font-weight:900;color:var(--text-dark);">${fmtGoalOriginal(g.target, goalCurCode)}</span>
        <span style="color:var(--text-light);">≈</span>
        <span style="font-weight:900;color:var(--primary);">${fmt(targetDisplay)}</span>
        <span style="background:#F0F4FF;color:var(--primary);font-size:0.9em;border-radius:6px;padding:1px 5px;">${goalCurCode} → ${currentCurrency.code}</span>
      </div>` : ''}
      <div style="background:#F5F5F5;border-radius:20px;height:10px;overflow:hidden;margin-bottom:6px;">
        <div style="height:100%;width:${pct.toFixed(1)}%;background:${barColor};border-radius:20px;transition:width 0.5s ease;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:0.75em;font-weight:700;color:var(--text-med);">${progressLabel}</div>
        <div style="font-size:0.88em;font-weight:900;color:${barColor};">${pct.toFixed(0)}%</div>
      </div>
      ${!achieved ? `<div style="font-size:0.72em;font-weight:700;color:var(--text-light);margin-top:3px;">${goalType === 'reduce' ? 'Still to reduce: ' + fmtVal(remaining) : 'Still need: ' + fmtVal(remaining)}</div>` : ''}
      ${(g.mappedAccounts||[]).length > 0 ? `<div style="font-size:0.7em;font-weight:600;color:var(--text-light);margin-top:5px;border-top:1px solid #F5F5F5;padding-top:5px;">📊 ${g.mappedAccounts.length} account${g.mappedAccounts.length>1?'s':''} mapped</div>` : ''}
    </div>`;
  }).join('');
}

// ── Home card long press → Budget detail ────────────────────────
let _homeLongPressTimer  = null;
let _homeLongPressKey    = null;
let _homeLongPressStartX = null;
let _homeLongPressStartY = null;
let _homeLongPressSubcat = null;
let _homeLongPressType   = null;
let _didLongPress        = false;

// Touch handlers — most reliable on mobile PWA
function homeCardTouchStart(e, cardKey, type, subcat) {
  _didLongPress   = false;
  _homeLongPressKey = cardKey;
  _homeLongPressStartX = e.touches[0].clientX;
  _homeLongPressStartY = e.touches[0].clientY;
  _homeLongPressSubcat = subcat;
  _homeLongPressType   = type;
  _homeLongPressTimer  = setTimeout(() => {
    _didLongPress       = true;
    _homeLongPressTimer = null;
    if (navigator.vibrate) navigator.vibrate(50);
    // Route correctly: investments → search by invest type; expense/income → budget detail
    if (_homeLongPressType === 'investment') {
      goToInvestDetail(cardKey);
    } else {
      goToBudgetDetail(cardKey);
    }
  }, 600);
}

function homeCardTouchMove(e) {
  if (!_homeLongPressTimer) return;
  const dx = Math.abs(e.touches[0].clientX - _homeLongPressStartX);
  const dy = Math.abs(e.touches[0].clientY - _homeLongPressStartY);
  if (dx > 10 || dy > 10) {
    // User scrolling — cancel long press
    clearTimeout(_homeLongPressTimer);
    _homeLongPressTimer = null;
  }
}

function homeCardTouchEnd(e) {
  if (_homeLongPressTimer) {
    // Timer still pending = short tap → Quick Add
    clearTimeout(_homeLongPressTimer);
    _homeLongPressTimer = null;
    if (!_didLongPress) openQuickAdd(_homeLongPressType, _homeLongPressSubcat);
  }
  // If _didLongPress = true, long press already handled — do nothing
}

function clearHomeLongPress(e) {
  if (_homeLongPressTimer) { clearTimeout(_homeLongPressTimer); _homeLongPressTimer = null; }
}

function handleHomeCardClick(e, type, subcat) {
  // Kept for desktop fallback — touch devices use homeCardTouchEnd
  if (_didLongPress) { _didLongPress = false; return; }
  openQuickAdd(type, subcat);
}

function goToInvestDetail(cardKey) {
  // Long press on invest card → go to transactions filtered by that investment type
  goToScreen('tx');
  setTimeout(() => {
    const searchInput = document.getElementById('tx-search-input');
    if (searchInput) {
      searchInput.value = cardKey;
      onTxSearch(cardKey);
      // Show context toast with total for that invest category
      const cards = getHomeInvCards();
      const card = cards.find(c => c.key === cardKey);
      if (card) showToast(`📈 ${card.label || cardKey} · all history`);
    }
  }, 80);
}

function goToBudgetDetail(cardKey) {
  // Find the home card to get its subcategories
  const cards = getHomeSpendCards();
  const card  = cards.find(c => (c.key||c.label) === cardKey);
  const subcats = card ? (card.subcats || [card.label]) : [cardKey];
  const cardLabel = card ? card.label : cardKey;

  // Try to find matching budget goal
  const expGoals = getBudgetGoals('expense');
  const savGoals = getBudgetGoals('savings');
  let goal = expGoals.find(g => g.key === cardKey);
  let type = 'expense';
  if (!goal) { goal = savGoals.find(g => g.key === cardKey); type = 'savings'; }
  if (!goal) {
    goal = expGoals.find(g =>
      (g.linkedCats||[g.key]).some(c => subcats.map(s=>s.toLowerCase()).includes(c.toLowerCase())) ||
      (g.name||g.key).toLowerCase() === cardLabel.toLowerCase()
    );
    type = 'expense';
  }

  // Always go to transactions with category search — no flash, no intermediate screen
  // If a budget goal exists, show a banner but stay in transactions
  goToScreen('tx');
  setTimeout(() => {
    const searchInput = document.getElementById('tx-search-input');
    if (searchInput) {
      const searchTerm = subcats[0] || cardLabel;
      searchInput.value = searchTerm;
      onTxSearch(searchTerm);
      if (goal) showToast(`📊 ${goal.name || goal.key} · ${fmt((goal.amount||0))} budget`);
    }
  }, 80);
}

// ── Budget swipe gesture ────────────────────────────────────────
let _budgetSwipeX = null;
let _budgetSwipeBlocked = false; // Issue 7: block if swipe started on bubble scroll

function budgetSwipeStart(e) {
  // Issue 7: Don't capture swipe if it starts inside a scrollable bubble area
  const target = e.target;
  const inBubbleScroll = target.closest('.budget-cats-scroll');
  if (inBubbleScroll) {
    _budgetSwipeBlocked = true;
    _budgetSwipeX = null;
    return;
  }
  _budgetSwipeBlocked = false;
  _budgetSwipeX = e.touches ? e.touches[0].clientX : null;
}

function budgetSwipeEnd(e) {
  if (_budgetSwipeBlocked || _budgetSwipeX === null) { _budgetSwipeBlocked = false; return; }
  const endX = e.changedTouches ? e.changedTouches[0].clientX : null;
  if (endX === null) { _budgetSwipeX = null; return; }
  const delta = endX - _budgetSwipeX;
  _budgetSwipeX = null;
  if (Math.abs(delta) < 60) return; // slightly higher threshold for intentional swipe
  budgetChangeMonth(delta < 0 ? 1 : -1);
}

function budgetChangeMonth(dir) {
  const [y, m] = budgetViewMonth.split('-').map(Number);
  const d = new Date(y, m - 1 + dir, 1);
  budgetViewMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  viewMonth = budgetViewMonth; // keep global month in sync
  document.getElementById('budget-month-label').textContent = getDisplayMonth(budgetViewMonth);
  // Issue 1: update ALL month labels so Home stays in sync
  updatePeriodLabel();
  renderBudgetModule();
  // If detail pane is open, re-render it for the new month
  if (currentBudgetCatDetail) {
    const { type, goalKey } = currentBudgetCatDetail;
    const goals = getBudgetGoals(type);
    const goal  = goals.find(g => g.key === goalKey);
    if (goal) {
      const prefix = type === 'savings' ? 'sav' : 'exp';
      _renderBudgetDetail(prefix, goal, type);
    }
  }
}

function setBudgetTab(tab, el) {
  currentBudgetTab = tab;
  document.querySelectorAll('.bm-tab').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  // Hide goals overlay first
  const goalsPanel = document.getElementById('blist-goals');
  const goalsFab   = document.getElementById('goals-fab-btn');
  if (goalsPanel) goalsPanel.style.display = 'none';
  if (goalsFab)   goalsFab.style.display   = 'none';
  if (tab === 'goals') {
    // Show goals as full overlay + its own FAB
    if (goalsPanel) goalsPanel.style.display = '';
    if (goalsFab)   { goalsFab.style.display = 'flex'; }
    renderGoalsPanel();
    return;
  }
  document.querySelectorAll('.budget-section').forEach(s => s.style.display = 'none');
  const sec = document.getElementById('bsec-' + tab);
  if (sec) sec.style.display = '';
  renderBudgetModule();
}

// Compute actual spent for a goal in a given month
function getBudgetActual(goal, monthKey) {
  ensureMonth(monthKey);
  const m = data[monthKey];
  const cats = (goal.linkedCats || [goal.key]).map(c => c.toLowerCase().trim());
  let total = 0;
  ['expenses', 'investments', 'additional'].forEach(listKey => {
    (m[listKey] || []).forEach(e => {
      const ec  = (e.category   || '').toLowerCase().trim();
      const eit = (e.investType || '').toLowerCase().trim(); // G: also check investType
      const esc = (e.subCategory|| '').toLowerCase().trim();
      // Match on category OR investType OR subCategory
      if (cats.some(c => ec === c || eit === c || esc === c)) {
        total += convertAmt(e.amount, e.currency);
      }
    });
  });
  return total;
}

// Get last 12 months keys
function getLast12Months(fromMonthKey) {
  const [y, m] = fromMonthKey.split('-').map(Number);
  const months = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(y, m - 1 - i, 1);
    months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
  }
  return months;
}

function renderBudgetModule() {
  document.getElementById('budget-month-label').textContent = getDisplayMonth(budgetViewMonth);
  if (currentBudgetTab === 'overview') renderBudgetOverview();
  else if (currentBudgetTab === 'expenses') renderBudgetGoalsList('expense');
  else if (currentBudgetTab === 'savings') renderBudgetGoalsList('savings');
}

let budgetViewMode = 'month'; // 'month' | 'year'

function setBudgetViewMode(mode) {
  budgetViewMode = mode;
  document.getElementById('bh-btn-month').classList.toggle('active', mode === 'month');
  document.getElementById('bh-btn-year').classList.toggle('active', mode === 'year');
  renderBudgetOverview();
}

function getYearMonthKeys(monthKey) {
  const year = monthKey.split('-')[0];
  const all = [];
  for (let m = 1; m <= 12; m++) {
    all.push(`${year}-${String(m).padStart(2,'0')}`);
  }
  return all;
}

function renderBudgetOverview() {
  const expGoals = getBudgetGoals('expense');
  const savGoals = getBudgetGoals('savings');
  const isYear = budgetViewMode === 'year';
  const year = budgetViewMonth.split('-')[0];

  // ── Compute totals depending on mode ──
  let totalExpBudget, totalSavBudget, totalExpActual, totalSavActual;
  // Convert goal amount from stored currency to current display currency
  // Goals without stored currency are assumed to be in current display currency
  const goalToDisp = g => {
    const raw = Number(g.amount || 0);
    if (!g.currency || g.currency === currentCurrency.code) return raw;
    return convertAmt(raw, g.currency);
  };
  const monthlyExpBudget = expGoals.reduce((s, g) => s + goalToDisp(g), 0);
  const monthlySavBudget = savGoals.reduce((s, g) => s + goalToDisp(g), 0);

  if (isYear) {
    // Annualized budget = monthly × 12
    totalExpBudget = monthlyExpBudget * 12;
    totalSavBudget = monthlySavBudget * 12;
    // YTD actuals — sum only months in this year UP TO the selected/current month
    const todayMk = new Date().toISOString().slice(0,7);
    const capMk = budgetViewMonth < todayMk ? budgetViewMonth : todayMk;
    const yearMonths = getYearMonthKeys(budgetViewMonth).filter(mk => mk <= capMk);
    totalExpActual = yearMonths.reduce((s, mk) => s + expGoals.reduce((ss, g) => ss + getBudgetActual(g, mk), 0), 0);
    totalSavActual = yearMonths.reduce((s, mk) => s + savGoals.reduce((ss, g) => ss + getBudgetActual(g, mk), 0), 0);
  } else {
    totalExpBudget = monthlyExpBudget;
    totalSavBudget = monthlySavBudget;
    totalExpActual = expGoals.reduce((s, g) => s + getBudgetActual(g, budgetViewMonth), 0);
    totalSavActual = savGoals.reduce((s, g) => s + getBudgetActual(g, budgetViewMonth), 0);
  }

  const totalBudget = totalExpBudget + totalSavBudget;
  const totalLeft = totalBudget - totalExpActual - totalSavActual;
  const isOver = totalLeft < 0;

  // ── Hero numbers ──
  const yearBadge = isYear ? `<span class="bh-year-badge">${year}</span>` : '';
  document.getElementById('bh-title').innerHTML = (isYear ? 'ANNUAL BUDGET' : 'TOTAL BUDGETED') + yearBadge;
  document.getElementById('bh-amount').textContent = fmt(isYear ? totalExpActual + totalSavActual : totalBudget);
  document.getElementById('bh-sub').innerHTML = isYear
    ? `<span style="color:var(--text-light);">of ${fmt(totalBudget)} annual goal · </span><span style="color:${isOver?'var(--expenses)':'var(--income)'};">${isOver ? fmt(Math.abs(totalLeft))+' over' : fmt(totalLeft)+' left'}</span>`
    : `<span style="color:${isOver ? 'var(--expenses)' : 'var(--income)'};">${isOver ? '▲ ' + fmt(Math.abs(totalLeft)) + ' over' : '▼ ' + fmt(totalLeft) + ' left'}</span>`;

  // ── Dual stat blocks ──
  const expLeft = totalExpBudget - totalExpActual;
  document.getElementById('bh-exp-val').textContent = fmt(totalExpActual);
  document.getElementById('bh-exp-val').style.color = expLeft < 0 ? 'var(--expenses)' : 'var(--text-dark)';
  document.getElementById('bh-exp-sub').innerHTML = `<span style="color:${expLeft<0?'var(--expenses)':'var(--income)'};">${expLeft<0 ? fmt(Math.abs(expLeft))+' over' : fmt(expLeft)+' left'}</span><br><span style="color:var(--text-light);font-size:0.9em;">of ${fmt(totalExpBudget)}${isYear?' annual':''}</span>`;

  const savLeft = totalSavBudget - totalSavActual;
  document.getElementById('bh-sav-val').textContent = fmt(totalSavActual);
  document.getElementById('bh-sav-val').style.color = savLeft < 0 ? 'var(--expenses)' : 'var(--text-dark)';
  document.getElementById('bh-sav-sub').innerHTML = `<span style="color:${savLeft<0?'var(--expenses)':'var(--income)'};">${savLeft<0 ? fmt(Math.abs(savLeft))+' over' : fmt(savLeft)+' left'}</span><br><span style="color:var(--text-light);font-size:0.9em;">of ${fmt(totalSavBudget)}${isYear?' annual':''}</span>`;

  // ── Chart ──
  const canvasId = 'budget-overview-chart';
  if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }
  const ctx = document.getElementById(canvasId);
  if (ctx) {
    if (isYear) {
      // Year view: grouped bar chart Jan–Dec with expense + savings bars per month
      const yearMonths = getYearMonthKeys(budgetViewMonth);
      const labels = yearMonths.map(mk => { const [,mo] = mk.split('-'); return ['J','F','M','A','M','J','J','A','S','O','N','D'][parseInt(mo)-1]; });
      const expData = yearMonths.map(mk => expGoals.reduce((s, g) => s + getBudgetActual(g, mk), 0));
      const savData = yearMonths.map(mk => savGoals.reduce((s, g) => s + getBudgetActual(g, mk), 0));
      const curIdx = yearMonths.indexOf(budgetViewMonth);
      charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Expenses', data: expData, backgroundColor: expData.map((_, i) => i === curIdx ? '#EF4444' : '#EF444466'), borderRadius: 4, barPercentage: 0.55, categoryPercentage: 0.75 },
            { label: 'Savings',  data: savData, backgroundColor: savData.map((_, i) => i === curIdx ? '#10B981' : '#10B98166'), borderRadius: 4, barPercentage: 0.55, categoryPercentage: 0.75 },
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', callbacks: { label: c => c.dataset.label + ': ' + fmt(c.raw) } } },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 9, family: 'Nunito', weight: '700' }, color: '#9AA0B2' } },
            y: { display: false }
          }
        }
      });
    } else {
      // Month view: dual line chart — last 12 months
      const months12 = getLast12Months(budgetViewMonth);
      const expActuals12 = months12.map(mk => expGoals.reduce((s, g) => s + getBudgetActual(g, mk), 0));
      const savActuals12 = months12.map(mk => savGoals.reduce((s, g) => s + getBudgetActual(g, mk), 0));
      const labels12 = months12.map(mk => { const [,mo] = mk.split('-'); return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(mo)-1]; });
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels12,
          datasets: [
            { label: 'Expense Actual', data: expActuals12, borderColor: '#EF4444', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 2, tension: 0.3 },
            { label: 'Expense Budget', data: months12.map(() => monthlyExpBudget), borderColor: '#EF444444', borderWidth: 1.5, borderDash: [4,4], backgroundColor: 'transparent', pointRadius: 0 },
            { label: 'Savings Actual', data: savActuals12, borderColor: '#10B981', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 2, tension: 0.3 },
            { label: 'Savings Budget', data: months12.map(() => monthlySavBudget), borderColor: '#10B98144', borderWidth: 1.5, borderDash: [4,4], backgroundColor: 'transparent', pointRadius: 0 },
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', callbacks: { label: c => c.dataset.label + ': ' + fmt(c.raw) } } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 9, family: 'Nunito', weight: '700' }, color: '#9AA0B2' } }, y: { display: false } } }
      });
    }
  }

  // ── Category bubbles — two visually separated rows: 💸 Expenses + 💰 Savings ──
  function makeBubbleHTML(goal, gtype) {
    let actual, budget;
    if (isYear) {
      const todayMk2 = new Date().toISOString().slice(0,7);
      const capMk2 = budgetViewMonth < todayMk2 ? budgetViewMonth : todayMk2;
      const ytdMonths = getYearMonthKeys(budgetViewMonth).filter(mk => mk <= capMk2);
      actual = ytdMonths.reduce((s, mk) => s + getBudgetActual(goal, mk), 0);
      budget = Number(goal.amount || 0) * 12;
    } else {
      actual = getBudgetActual(goal, budgetViewMonth);
      budget = Number(goal.amount || 0);
    }
    const pct = budget > 0 ? Math.min(actual / budget, 1) : 0;
    const isGoalOver = actual > budget && budget > 0;
    const isSav = gtype === 'savings';
    const statusColor = isSav ? (actual >= budget ? '#10B981' : '#F59E0B') : (isGoalOver ? '#EF4444' : '#10B981');
    const trackColor  = isSav ? '#10B981' : (isGoalOver ? '#EF4444' : '#10B981');
    const bgColor     = isSav ? '#10B98120' : (isGoalOver ? '#EF444420' : '#10B98118');
    const r = 30;
    const circumference = 2 * Math.PI * r;
    const dash = pct * circumference;
    const leftAmt = budget - actual;
    const statusText = budget > 0 ? (leftAmt < 0 ? fmt(Math.abs(leftAmt)) + ' over' : fmt(leftAmt) + ' left') : fmt(actual);
    return `<div class="bcat-bubble" onclick="openBudgetCatDetail('${gtype}','${goal.key}')">
      <div class="bcat-ring" style="background:${bgColor};">
        <svg viewBox="0 0 72 72"><circle cx="36" cy="36" r="${r}" fill="none" stroke="#E8E8E8" stroke-width="5"/><circle cx="36" cy="36" r="${r}" fill="none" stroke="${trackColor}" stroke-width="5" stroke-dasharray="${dash} ${circumference}" stroke-linecap="round"/></svg>
        <div class="bcat-icon-wrap">${goal.icon || (isSav ? '💰' : '💸')}</div>
      </div>
      <div class="bcat-name">${goal.name}</div>
      <div class="bcat-status" style="color:${statusColor};">${statusText}</div>
    </div>`;
  }

  const expBubblesEl = document.getElementById('budget-cats-bubbles-exp');
  const savBubblesEl = document.getElementById('budget-cats-bubbles-sav');
  const expLabelEl   = document.getElementById('bcat-label-exp');
  const savLabelEl   = document.getElementById('bcat-label-sav');

  if (expBubblesEl) {
    if (expGoals.length === 0) {
      expBubblesEl.innerHTML = '';
      if (expLabelEl) expLabelEl.style.display = 'none';
    } else {
      if (expLabelEl) expLabelEl.style.display = 'flex';
      expBubblesEl.innerHTML = expGoals.map(g => makeBubbleHTML(g, 'expense')).join('');
    }
  }

  if (savBubblesEl) {
    if (savGoals.length === 0) {
      savBubblesEl.innerHTML = '';
      if (savLabelEl) savLabelEl.style.display = 'none';
    } else {
      if (savLabelEl) savLabelEl.style.display = 'flex';
      savBubblesEl.innerHTML = savGoals.map(g => makeBubbleHTML(g, 'savings')).join('');
    }
  }
}

function renderBudgetGoalsList(type) {
  const goals = getBudgetGoals(type);
  const listId = type === 'savings' ? 'budget-sav-goals' : 'budget-exp-goals';
  const el = document.getElementById(listId);
  if (!el) return;

  if (goals.length === 0) {
    el.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-light);background:var(--white);border-radius:var(--radius);box-shadow:var(--card-shadow);"><div style="font-size:2.5em;margin-bottom:8px;">${type === 'savings' ? '💰' : '🎯'}</div><div style="font-weight:700;">No ${type === 'savings' ? 'savings goals' : 'expense budgets'} yet</div><button onclick="openEditBudgetPopup(null,'${type}')" style="margin-top:12px;background:var(--yellow);border:none;border-radius:12px;padding:10px 20px;font-family:Nunito,sans-serif;font-weight:800;font-size:0.85em;cursor:pointer;">+ Add Goal</button></div>`;
    return;
  }

  el.innerHTML = goals.map(goal => {
    const actual = getBudgetActual(goal, budgetViewMonth);
    const budget = goal.currency && goal.currency !== currentCurrency.code ? convertAmt(Number(goal.amount||0), goal.currency) : Number(goal.amount||0);
    const pct = budget > 0 ? Math.min(actual / budget * 100, 100) : 0;
    const isOver = actual > budget && budget > 0;
    const isSav = type === 'savings';
    const barColor = isSav ? (actual >= budget ? '#10B981' : '#F59E0B') : (isOver ? '#EF4444' : '#10B981');
    const amtColor = isSav ? (actual >= budget ? 'var(--income)' : 'var(--text-dark)') : (isOver ? 'var(--expenses)' : 'var(--text-dark)');
    const leftAmt = budget - actual;
    const statusLabel = budget > 0 ? (leftAmt < 0 ? fmt(Math.abs(leftAmt)) + ' over' : fmt(leftAmt) + ' left') : '';
    const iconBg = isSav ? '#10B98118' : (isOver ? '#EF444418' : '#10B98118');

    return `<div class="budget-goal-row">
      <div class="bgr-top">
        <div class="bgr-icon" style="background:${iconBg};">${goal.icon || '💸'}</div>
        <div class="bgr-info">
          <div class="bgr-name">${goal.name}</div>
          <div class="bgr-type">${isSav ? '💰 Savings Goal' : '💸 Expense Budget'} · ${getDisplayMonth(budgetViewMonth)}</div>
        </div>
        <div class="bgr-right">
          <div class="bgr-spent" style="color:${amtColor};">${fmt(actual)}</div>
          <div class="bgr-budget">of ${fmt(budget)}</div>
        </div>
      </div>
      <div class="bgr-bar"><div class="bgr-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>
      <div class="bgr-actions">
        <button class="bgr-action-btn" style="background:var(--yellow-light);color:var(--text-dark);" onclick="openBudgetCatDetail('${type}','${goal.key}')">📊 Details</button>
        <button class="bgr-action-btn" style="background:#F0F8FF;color:#4A9EFF;" onclick="openEditBudgetPopup('${goal.key}','${type}')">✏️ Edit</button>
      </div>
    </div>`;
  }).join('');
}

// Shared function to (re)build the detail view for a given goal
function _renderBudgetDetail(prefix, goal, type) {
  const actual  = getBudgetActual(goal, budgetViewMonth);
  const budget  = goal.currency && goal.currency !== currentCurrency.code ? convertAmt(Number(goal.amount||0), goal.currency) : Number(goal.amount||0);
  const leftAmt = budget - actual;
  const isOver  = actual > budget && budget > 0;
  const isSav   = type === 'savings';

  // Header
  document.getElementById(`bcd-${prefix}-icon`).textContent  = goal.icon || (isSav ? '💰' : '💸');
  document.getElementById(`bcd-${prefix}-name`).textContent  = goal.name;
  document.getElementById(`bcd-${prefix}-spent`).innerHTML   =
    `<span style="color:${isOver?'var(--expenses)':'var(--text-dark)'};">${fmt(actual)} spent</span>` +
    ` <span style="color:var(--text-light);">/ ${fmt(budget)} ${isSav?'goal':'budget'}</span>` +
    ` · <span style="color:${isOver?'var(--expenses)':'var(--income)'};">${isOver ? fmt(Math.abs(leftAmt))+' over' : fmt(leftAmt)+' left'}</span>`;

  // Budget chip label
  const chipLabel = document.getElementById(`bcd-${prefix}-chip-label`);
  const chipInput = document.getElementById(`bcd-${prefix}-chip-input`);
  if (chipLabel) chipLabel.textContent = fmt(budget);
  if (chipInput) chipInput.value = budget;

  // ── Chart ──
  const months12  = getLast12Months(budgetViewMonth);
  const actuals12 = months12.map(mk => getBudgetActual(goal, mk));
  const labels12  = months12.map(mk => { const [,mo] = mk.split('-'); return ['J','F','M','A','M','J','J','A','S','O','N','D'][parseInt(mo)-1]; });
  const curIdx    = months12.indexOf(budgetViewMonth);

  const lineColor = isSav ? '#10B981' : '#1E2A6E';
  const barColors = actuals12.map((a, i) => {
    if (i === curIdx) return isSav ? '#10B981' : '#3B4A9C';
    if (budget > 0)   return a > budget ? '#EF4444' : (isSav ? '#10B98199' : '#10B98199');
    return '#10B98199';
  });

  const chartId = `bcd-${prefix}-chart`;
  if (charts[chartId]) { charts[chartId].destroy(); delete charts[chartId]; }
  const ctx = document.getElementById(chartId);
  if (!ctx) return;

  charts[chartId] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels12,
      datasets: [
        {
          label: 'Spent',
          data: actuals12,
          backgroundColor: barColors,
          borderRadius: 6,
          barPercentage: 0.65,
          order: 2
        },
        {
          label: 'Budget',
          data: months12.map(() => budget),
          type: 'line',
          borderColor: lineColor,
          borderWidth: 2.5,
          borderDash: [6, 4],
          backgroundColor: 'transparent',
          pointRadius: 0,
          pointHoverRadius: 0,
          order: 1,
          // Draw a solid dot at the rightmost point to anchor the chip visually
          pointRadius: months12.map((_, i) => i === months12.length - 1 ? 4 : 0),
          pointBackgroundColor: lineColor
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: c => (c.dataset.label || '') + ': ' + fmt(Number(c.raw || 0))
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 9, family: 'Nunito', weight: '700' }, color: '#9AA0B2' }
        },
        y: { display: false }
      }
    }
  });

  // ── Metrics ──
  const yearStart  = budgetViewMonth.split('-')[0];
  const yearMonths = Object.keys(data).filter(k => k.startsWith(yearStart + '-') && !k.startsWith('_'));
  const yearTotal  = yearMonths.reduce((s, mk) => s + getBudgetActual(goal, mk), 0);
  const avgPerMonth = yearMonths.length > 0 ? yearTotal / yearMonths.length : 0;

  document.getElementById(`bcd-${prefix}-metrics`).innerHTML = `
    <div class="bcd-metric-card"><div class="bcd-metric-label">Total ${yearStart}</div><div class="bcd-metric-val">${fmt(yearTotal)}</div></div>
    <div class="bcd-metric-card"><div class="bcd-metric-label">Avg / Month</div><div class="bcd-metric-val">${fmt(avgPerMonth)}</div></div>
    <div class="bcd-metric-card"><div class="bcd-metric-label">${isSav ? 'Monthly Goal' : 'Monthly Budget'}</div><div class="bcd-metric-val">${fmt(budget)}</div></div>
    <div class="bcd-metric-card"><div class="bcd-metric-label">${isOver ? 'Over by' : 'Remaining'}</div><div class="bcd-metric-val" style="color:${isOver?'var(--expenses)':'var(--income)'};">${fmt(Math.abs(leftAmt))}</div></div>
  `;

  // ── Transactions ──
  ensureMonth(budgetViewMonth);
  const m    = data[budgetViewMonth];
  const cats = (goal.linkedCats || [goal.key]).map(c => c.toLowerCase().trim());
  let txns   = [];
  ['expenses', 'investments', 'additional'].forEach(listKey => {
    (m[listKey] || []).forEach(e => {
      const ec  = (e.category    || '').toLowerCase().trim();
      const eit = (e.investType  || '').toLowerCase().trim();
      const esc = (e.subCategory || '').toLowerCase().trim();
      // G: match category OR investType OR subCategory
      if (cats.some(c => ec === c || eit === c || esc === c)) txns.push({ ...e, _type: listKey });
    });
  });
  txns.sort((a, b) => (b.date || '').localeCompare(a.date || ''));

  const txnMonthLabel = document.getElementById(`bcd-${prefix}-txn-month`);
  if (txnMonthLabel) txnMonthLabel.textContent = `${getDisplayMonth(budgetViewMonth)} Transactions (${txns.length})`;

  const txnsEl = document.getElementById(`bcd-${prefix}-txns`);
  if (txnsEl) {
    txnsEl.innerHTML = txns.length === 0
      ? `<div style="text-align:center;padding:20px;color:var(--text-light);font-size:0.85em;font-weight:700;">No transactions this month</div>`
      : txns.map(t => {
          const d   = t.date ? new Date(t.date + 'T00:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' }) : '';
          const amt = convertAmt(t.amount, t.currency);
          const amtColor = isSav ? 'var(--income)' : 'var(--expenses)';
          const metalTag = t.metalGrams ? ` · ${t.metalGrams}g ${t.metalType||''}` : '';
          return `<div class="bcd-tx-row">
            <div class="bcd-tx-icon" style="background:${isSav?'#10B98115':'#EF444415'};">${goal.icon || (isSav?'💰':'💸')}</div>
            <div class="bcd-tx-info">
              <div class="bcd-tx-name">${t.description || t.category || 'Transaction'}</div>
              <div class="bcd-tx-date">${d}${t.category ? ' · ' + t.category : ''}${metalTag}</div>
            </div>
            <div class="bcd-tx-amt" style="color:${amtColor};">${isSav?'+':'-'}${fmt(amt)}</div>
          </div>`;
        }).join('');
  }
}

function openBudgetCatDetail(type, goalKey) {
  currentBudgetCatDetail = { type, goalKey };
  const goals = getBudgetGoals(type);
  const goal  = goals.find(g => g.key === goalKey);
  if (!goal) return;

  // Switch tab
  if (type === 'savings' && currentBudgetTab !== 'savings') {
    setBudgetTab('savings', document.getElementById('btab-savings'));
  } else if (type === 'expense' && currentBudgetTab !== 'expenses') {
    setBudgetTab('expenses', document.getElementById('btab-expenses'));
  }

  const prefix = type === 'savings' ? 'sav' : 'exp';
  document.getElementById(`bcat-detail-${type === 'savings' ? 'savings' : 'expenses'}`).classList.add('open');
  document.getElementById(`blist-${type === 'savings' ? 'savings' : 'expenses'}`).style.display = 'none';

  _renderBudgetDetail(prefix, goal, type);
}

function closeBudgetCatDetail(type) {
  currentBudgetCatDetail = null;
  const detailId = type === 'savings' ? 'bcat-detail-savings' : 'bcat-detail-expenses';
  const listId   = type === 'savings' ? 'blist-savings' : 'blist-expenses';
  document.getElementById(detailId).classList.remove('open');
  document.getElementById(listId).style.display = '';
}

// ── Budget chip: click to edit inline ──
function activateBudgetChip(type) {
  const prefix = type === 'savings' ? 'sav' : 'exp';
  const chip   = document.getElementById(`bcd-${prefix}-chip`);
  const input  = document.getElementById(`bcd-${prefix}-chip-input`);
  if (!chip || chip.classList.contains('editing')) return;
  chip.classList.add('editing');
  input.focus();
  input.select();
}

function saveBudgetChip(type) {
  const prefix = type === 'savings' ? 'sav' : 'exp';
  const chip   = document.getElementById(`bcd-${prefix}-chip`);
  const input  = document.getElementById(`bcd-${prefix}-chip-input`);
  if (!chip || !chip.classList.contains('editing')) return;

  const newAmt = parseFloat(input.value);
  if (isNaN(newAmt) || newAmt < 0) { cancelBudgetChip(type); return; }

  // Save to data
  const det  = currentBudgetCatDetail;
  if (!det) { cancelBudgetChip(type); return; }
  const storageKey = type === 'savings' ? '_savingsGoals' : '_expenseGoals';
  const goals = data[storageKey] || [];
  const goal  = goals.find(g => g.key === det.goalKey);
  if (goal) {
    goal.amount = newAmt;
    goal.currency = currentCurrency.code; // store currency at time of quick-edit
    save();
    showToast(`✅ Budget updated to ${fmt(newAmt)}`);
    // Re-render everything
    chip.classList.remove('editing');
    _renderBudgetDetail(prefix, goal, type);
    renderBudgetModule(); // refresh bubbles & hero too
  } else {
    cancelBudgetChip(type);
  }
}

function cancelBudgetChip(type) {
  const prefix = type === 'savings' ? 'sav' : 'exp';
  const chip   = document.getElementById(`bcd-${prefix}-chip`);
  if (chip) chip.classList.remove('editing');
}

// Edit Budget Popup
const BUDGET_EMOJI_PANEL_OPTS = ['💸','🛒','🚗','🏠','💊','🎭','🍔','☕','🎓','🐾','✈️','👗','🎮','🏋️','🎁','📱','⚡','🚌','💰','📈','🥇','🏦','🌊','🎯'];

function openEditBudgetPopup(goalKey, forceType) {
  editingBudgetKey = goalKey || null;
  editingBudgetType = forceType || currentBudgetTab === 'savings' ? 'savings' : 'expense';
  if (forceType) editingBudgetType = forceType;

  const popup = document.getElementById('edit-budget-popup');
  const delBtn = document.getElementById('ebp-del-btn');

  // Render emoji row
  document.getElementById('ebp-emoji-row').innerHTML = BUDGET_EMOJI_PANEL_OPTS.map(e =>
    `<div class="ebp-emoji-opt ${e === pickedBudgetEmoji ? 'picked' : ''}" onclick="pickBudgetEmoji('${e}')">${e}</div>`
  ).join('');

  document.getElementById('ebp-type').value = editingBudgetType;
  document.getElementById('ebp-title').textContent = goalKey ? '✏️ Edit Budget Goal' : '➕ Add Budget Goal';

  if (goalKey) {
    const goals = getBudgetGoals(editingBudgetType);
    const goal = goals.find(g => g.key === goalKey);
    if (goal) {
      pickedBudgetEmoji = goal.icon || '💸';
      document.getElementById('ebp-name').value = goal.name || goal.key;
      document.getElementById('ebp-amount').value = goal.amount || '';
      initLinkedCatPicker(goal.linkedCats || [], editingBudgetType);
      delBtn.style.display = '';
    }
  } else {
    pickedBudgetEmoji = '💸';
    document.getElementById('ebp-name').value = '';
    document.getElementById('ebp-amount').value = '';
    initLinkedCatPicker([], editingBudgetType);
    delBtn.style.display = 'none';
  }

  // Re-render emoji row with selection
  document.getElementById('ebp-emoji-row').innerHTML = BUDGET_EMOJI_PANEL_OPTS.map(e =>
    `<div class="ebp-emoji-opt ${e === pickedBudgetEmoji ? 'picked' : ''}" onclick="pickBudgetEmoji('${e}')">${e}</div>`
  ).join('');

  popup.classList.add('open');
}

function pickBudgetEmoji(e) {
  pickedBudgetEmoji = e;
  document.querySelectorAll('.ebp-emoji-opt').forEach(el => el.classList.remove('picked'));
  event.target.classList.add('picked');
}

function closeEditBudgetPopup() {
  document.getElementById('edit-budget-popup').classList.remove('open');
}

function saveEditedBudget() {
  const name = document.getElementById('ebp-name').value.trim();
  const amount = parseFloat(document.getElementById('ebp-amount').value) || 0;
  const type = document.getElementById('ebp-type').value;
  const linkedCatsRaw = document.getElementById('ebp-linked-cats').value.trim();
  const linkedCats = linkedCatsRaw ? linkedCatsRaw.split(',').map(c => c.trim()).filter(Boolean) : [name];

  if (!name) { showToast('Enter a name ❌'); return; }
  if (!amount) { showToast('Enter a budget amount ❌'); return; }

  const goals = getBudgetGoals(type);
  const key = editingBudgetKey || name.replace(/\s+/g, '_');

  if (editingBudgetKey) {
    const idx = goals.findIndex(g => g.key === editingBudgetKey);
    if (idx >= 0) {
      goals[idx] = {...goals[idx], name, amount, currency: currentCurrency.code, icon: pickedBudgetEmoji, linkedCats};
    }
  } else {
    goals.push({key, name, icon: pickedBudgetEmoji, amount, currency: currentCurrency.code, linkedCats});
  }

  const storageKey = type === 'savings' ? '_savingsGoals' : '_expenseGoals';
  data[storageKey] = goals;
  save();
  closeEditBudgetPopup();
  renderBudgetModule();
  showToast(`✅ "${name}" ${editingBudgetKey ? 'updated' : 'added'}!`);
}

function deleteEditedBudget() {
  if (!editingBudgetKey) return;
  const type = document.getElementById('ebp-type').value;
  const goals = getBudgetGoals(type);
  const goal = goals.find(g => g.key === editingBudgetKey);
  if (!goal) return;
  if (!confirm(`Delete "${goal.name}"?`)) return;
  const storageKey = type === 'savings' ? '_savingsGoals' : '_expenseGoals';
  data[storageKey] = goals.filter(g => g.key !== editingBudgetKey);
  save();
  closeEditBudgetPopup();
  closeBudgetCatDetail(type);
  renderBudgetModule();
  showToast(`🗑️ "${goal.name}" removed`);
}

// ══════════════════════════════════════════════════════
// FAB SMART LAUNCHER
// ══════════════════════════════════════════════════════
let fabOpen = false;

function toggleFabMenu() {
  fabOpen ? closeFabMenu() : openFabMenu();
}

function openFabMenu() {
  fabOpen = true;
  document.getElementById('fab-add-btn').classList.add('open');
  document.getElementById('fab-backdrop').classList.add('open');
  // Stagger items in reverse so bottom item appears first
  ['fmi-expense','fmi-income','fmi-investment'].forEach((id, i) => {
    setTimeout(() => document.getElementById(id).classList.add('visible'), i * 40);
  });
}

function closeFabMenu() {
  fabOpen = false;
  document.getElementById('fab-add-btn').classList.remove('open');
  document.getElementById('fab-backdrop').classList.remove('open');
  document.querySelectorAll('.fab-menu-item').forEach(el => el.classList.remove('visible'));
}

// Close FAB when Quick Add opens
const _origOpenQuickAdd = openQuickAdd;
// (closeFabMenu is called inline on each menu button click — no wrap needed)

// ══════════════════════════════════════════════════════
// NET WORTH MODULE — Account-based system
// ══════════════════════════════════════════════════════

const NW_TYPES = {
  checking:        { label:'Checking Account',       emoji:'🏦', color:'#4A9EFF',   isLiab:false },
  savings_acc:     { label:'Savings Account',        emoji:'💵', color:'#10B981',   isLiab:false },
  brokerage:       { label:'Brokerage / Investment', emoji:'📈', color:'#7C3AED',   isLiab:false },
  retirement:      { label:'Retirement Account',     emoji:'🏛️', color:'#F59E0B',   isLiab:false },
  bonds_fd:        { label:'Bond / FD / CD',         emoji:'📋', color:'#06B6D4',   isLiab:false },
  metals:          { label:'Precious Metals',        emoji:'🥇', color:'#C8900A',   isLiab:false },
  realestate:      { label:'Real Estate',            emoji:'🏡', color:'#10B981',   isLiab:false },
  cash:            { label:'Cash / Wallet',          emoji:'💴', color:'#84CC16',   isLiab:false },
  credit_card:     { label:'Credit Card',            emoji:'💳', color:'#EF4444',   isLiab:true  },
  loan:            { label:'Loan / Mortgage',        emoji:'🏠', color:'#F97316',   isLiab:true  },
  other_liability: { label:'Other Liability',        emoji:'📉', color:'#8B5CF6',   isLiab:true  },
};

const RETIRE_SUBTYPES = ['401k','403b','IRA','Roth IRA','PPF','EPF','NPS','Other'];

function getNWAccounts() {
  if (!data._nwAccounts) data._nwAccounts = [];
  return data._nwAccounts;
}

function getNWSnapshots() {
  if (!data._nwSnapshots) data._nwSnapshots = [];
  // Filter out any future-month snapshots caused by UTC timezone drift (IST +5:30 edge)
  const nowMk = getCurrentMonthKey();
  return data._nwSnapshots.filter(s => {
    const mk = s.month || (s.date || '').slice(0, 7) || '2000-01';
    return mk <= nowMk;
  });
}

// Convert a snapshot's stored value to the CURRENT display currency
// Snapshots store value in whatever currency was active at capture time
function snapValue(s) {
  if (!s) return 0;
  const storedCurrency = (s.currency || 'USD').toUpperCase();
  const raw = s.value || 0;
  if (storedCurrency === currentCurrency.code.toUpperCase()) return raw;
  // Convert: stored → USD → current display currency
  return nwConvert(raw, storedCurrency);
}
// Same for income/expenses/investments fields in a snapshot
function snapField(s, field) {
  if (!s) return 0;
  const storedCurrency = (s.currency || 'USD').toUpperCase();
  const raw = s[field] || 0;
  if (storedCurrency === currentCurrency.code.toUpperCase()) return raw;
  return nwConvert(raw, storedCurrency);
}

function getRealEstateAssets() {
  if (!data._realEstate) data._realEstate = [];
  return data._realEstate;
}

// INR_TO_USD removed — all currency conversion goes through convertAmt() which respects user overrides

// ── Convert account balance to display currency ──
function nwConvert(balance, currency) {
  const b = Number(balance || 0);
  const c = (currency || currentCurrency.code).toUpperCase();
  const dispCode = currentCurrency.code.toUpperCase();
  if (c === dispCode) return b;
  // Convert: amount in currency C → display currency
  // All rates are stored as "1 USD = N units of currency"
  const overrides = data._fxOverrides || {};
  const fromRate = overrides[c]        ?? FX_USD_BASE[c]        ?? 1; // 1 USD = fromRate C
  const toRate   = overrides[dispCode] ?? FX_USD_BASE[dispCode] ?? 1; // 1 USD = toRate display
  // b / fromRate = USD value → * toRate = display value
  return (b / fromRate) * toRate;
}

// ── Compute net worth from accounts ──
function computeNetWorth() {
  const accounts = getNWAccounts();
  const byType = {};
  let totalAssets = 0, liabTotal = 0;

  // Also pull metals from import data as read-only reference — one row per entry
  const metalsFromImport = (data._metals || []).map((m, idx) => {
    const mc = METAL_CONFIG[m.metalType] || METAL_CONFIG['gold'];
    const grams = Number(m.grams || m.weightGms || 0);
    const price = Number(m.price || 0) || getPriceForMetal(m.metalType||'gold', m.purity);
    const val = grams * price;
    const oz = (grams / 31.1035).toFixed(3);
    // Build a descriptive name: "Gold · 22K · Bangle" or just "Gold · 10g"
    const nameParts = [mc.emoji + ' ' + ((m.metalType||'gold').charAt(0).toUpperCase()+(m.metalType||'gold').slice(1))];
    if (m.purity)   nameParts.push(m.purity);
    if (m.occasion) nameParts.push(m.occasion);
    if (!m.purity && !m.occasion && m.name && m.name !== m.metalType) nameParts.push(m.name);
    return {
      id: 'import_metal_' + idx,
      name: nameParts.join(' · '),
      balance: val,
      currency: 'USD',
      lastUpdated: m.date || '',
      _imported: true,
      type: 'metals',
      meta: {
        grams,
        oz,
        metalType: m.metalType,
        purity: m.purity || '',
        occasion: m.occasion || '',
        form: m.form || '',
        notes: m.notes || '',
        originalName: m.name || ''
      }
    };
  });

  // Also pull real estate from import data as read-only reference
  const reFromImport = (data._realEstate || []).map((p, idx) => {
    const cv = Number(p.currentValue || p.purchaseValue || 0);
    const curr = (p.currency || 'USD').toUpperCase();
    // Store raw value + real currency — let nwConvert handle conversion once, consistently
    const nameParts = ['🏡', p.description || 'Property'];
    if (p.country && p.country !== 'US') nameParts.push(p.country);
    return {
      id: 'import_re_' + idx,
      name: nameParts.join(' '),
      balance: cv,      // raw value in original currency
      currency: curr,   // nwConvert will convert correctly
      lastUpdated: p.date || '',
      _imported: true,
      type: 'realestate',
      meta: {
        purchaseValue: p.purchaseValue,
        country: p.country,
        area: p.area,
        description: p.description
      }
    };
  });

  const allAccounts = [...accounts, ...metalsFromImport, ...reFromImport];

  Object.keys(NW_TYPES).forEach(t => { byType[t] = { total: 0, accounts: [] }; });

  allAccounts.forEach(acc => {
    const t = acc.type;
    if (!byType[t]) return;
    let val = nwConvert(acc.balance, acc.currency);
    // For metals type, auto-calc from grams using purity-aware pricing
    if (t === 'metals' && acc.meta && acc.meta.grams) {
      const metalType = acc.meta.metalType || 'gold';
      const purity    = acc.meta.purity || '';
      const calcPrice = getPriceForMetal(metalType, purity); // always USD/gram
      const calcValUSD = Number(acc.meta.grams) * calcPrice; // always USD
      // Convert calcVal from USD to display currency
      const calcVal = nwConvert(calcValUSD, 'USD');
      // Use calculated value if no explicit balance, or if explicit balance is 0
      if (!Number(acc.balance) || acc._imported) val = calcVal;
      else val = Math.max(nwConvert(Number(acc.balance), acc.currency || 'USD'), calcVal);
    }
    byType[t].total += val;
    byType[t].accounts.push({ ...acc, _val: val });
    if (NW_TYPES[t].isLiab) liabTotal += val;
    else totalAssets += val;
  });

  const netWorth = totalAssets - liabTotal;
  const debtRatio = totalAssets > 0 ? liabTotal / totalAssets : 0;
  return { netWorth, totalAssets, liabTotal, debtRatio, byType };
}

// ── Render Net Worth ──

function buildNWMetalsBody(accounts, cfg, addBtnLabel) {
  // Group by metalType first, then by purity within each type
  const METAL_ORDER = ['gold','silver','platinum'];
  const METAL_LABELS = { gold:'🥇 Gold', silver:'🥈 Silver', platinum:'🔘 Platinum' };

  // Bucket accounts
  const byMetal = {};
  METAL_ORDER.forEach(mt => { byMetal[mt] = []; });
  accounts.forEach(acc => {
    const mt = (acc.meta && acc.meta.metalType) || 'gold';
    if (!byMetal[mt]) byMetal[mt] = [];
    byMetal[mt].push(acc);
  });

  let html = '';

  METAL_ORDER.forEach(mt => {
    const items = byMetal[mt];
    if (!items.length) return;

    const metalTotal = items.reduce((s, a) => s + (a._val || 0), 0);
    const metalGrams = items.reduce((s, a) => s + Number((a.meta && a.meta.grams) || 0), 0);

    // Metal type header row
    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 4px;border-bottom:2px solid #F0F0F0;">
      <div style="font-weight:900;font-size:0.95em;color:var(--text-dark);">${METAL_LABELS[mt] || mt}</div>
      <div style="text-align:right;">
        <div style="font-weight:900;font-size:0.95em;color:${cfg.color};">${fmt(metalTotal)}</div>
        <div style="font-size:0.72em;color:var(--text-light);font-weight:700;">${metalGrams.toFixed(2)}g · ${(metalGrams/31.1035).toFixed(3)} oz</div>
      </div>
    </div>`;

    // Group by purity within this metal type
    const byPurity = {};
    items.forEach(acc => {
      const purity = (acc.meta && acc.meta.purity) || 'Other';
      if (!byPurity[purity]) byPurity[purity] = [];
      byPurity[purity].push(acc);
    });

    Object.keys(byPurity).forEach(purity => {
      const pItems = byPurity[purity];
      const pTotal  = pItems.reduce((s, a) => s + (a._val || 0), 0);
      const pGrams  = pItems.reduce((s, a) => s + Number((a.meta && a.meta.grams) || 0), 0);
      const pOz     = (pGrams / 31.1035).toFixed(3);

      // Purity subgroup header — collapsible
      const pCollapseId = `nw-metal-grp-${mt}-${purity.replace(/\s+/g,'')}`;
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0 4px 12px;border-bottom:1px dashed #EEEEEE;cursor:pointer;" onclick="toggleNWMetalGroup('${pCollapseId}')">
        <div style="font-weight:800;font-size:0.82em;color:var(--text-med);">
          <span id="${pCollapseId}-chev" style="display:inline-block;transition:transform 0.2s;margin-right:4px;">▾</span>${purity}
        </div>
        <div style="text-align:right;">
          <div style="font-weight:800;font-size:0.82em;color:${cfg.color};">${fmt(pTotal)}</div>
          <div style="font-size:0.7em;color:var(--text-light);font-weight:700;">${pGrams.toFixed(2)}g · ${pOz} oz</div>
        </div>
      </div>`;
      html += `<div id="${pCollapseId}" class="nw-metal-grp-body">`;

      // Individual items
      pItems.forEach(acc => {
        const g = Number((acc.meta && acc.meta.grams) || 0);
        const oz = (g / 31.1035).toFixed(3);
        // Name: occasion · item name (strip redundant metal+purity prefix from display name)
        const occasion = (acc.meta && acc.meta.occasion) || '';
        const originalName = (acc.meta && acc.meta.originalName) || '';
        const displayName = occasion
          ? (originalName && originalName.toLowerCase() !== mt ? occasion + ' · ' + originalName : occasion)
          : (originalName && originalName.toLowerCase() !== mt ? originalName : acc.name);
        const dateStr = acc.lastUpdated ? new Date(acc.lastUpdated+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
        // For imported metals — use _metals array index for edit/delete
        const metalIdx = acc.id.replace('import_metal_','');
        const editBtn = acc._imported
          ? `<button class="nw-account-btn" onclick="openEditMetalSheet(${metalIdx})" title="Edit">✏️</button>
             <button class="nw-account-btn del" onclick="deleteImportedMetal(${metalIdx})" title="Delete">✕</button>`
          : `<button class="nw-account-btn" onclick="openNWSheet('metals','${acc.id}')">✏️</button>
             <button class="nw-account-btn del" onclick="deleteNWAccount('${acc.id}')">✕</button>`;

        html += `<div class="nw-account-row" style="padding-left:24px;">
          <div class="nw-account-left">
            <div class="nw-account-name" style="font-size:0.87em;">${displayName || '—'}</div>
            <div class="nw-account-meta">${g.toFixed(2)}g · ${oz} oz${dateStr?' · '+dateStr:''}</div>
          </div>
          <div class="nw-account-right">
            <div>
              <div class="nw-account-val" style="color:${cfg.color};font-size:0.9em;">${fmt(acc._val)}</div>
            </div>
            <div class="nw-account-actions">${editBtn}</div>
          </div>
        </div>`;
      });
      html += `</div>`; // close nw-metal-grp-body
    });
  });`<div style="padding-top:8px;"><button class="nw-section-add" onclick="openNWSheet('metals')">${addBtnLabel}</button></div>`;
  return html;
}

function renderNetWorth() {
  const nw = computeNetWorth();

  // ── Hero ──
  document.getElementById('nw-total').textContent = fmt(nw.netWorth);
  document.getElementById('nw-total').style.color = nw.netWorth < 0 ? '#FF6B6B' : 'white';
  document.getElementById('nw-assets-hero').textContent = fmt(nw.totalAssets);
  document.getElementById('nw-liab-hero').textContent   = fmt(nw.liabTotal);
  const drPct = (nw.debtRatio * 100).toFixed(1);
  document.getElementById('nw-debt-ratio').textContent = drPct + '%';
  const badge = document.getElementById('nw-debt-badge');
  if (nw.debtRatio < 0.2)      { badge.textContent = '● Healthy';  badge.style.background = '#10B98130'; badge.style.color = '#10B981'; }
  else if (nw.debtRatio < 0.4) { badge.textContent = '● Moderate'; badge.style.background = '#F59E0B30'; badge.style.color = '#F59E0B'; }
  else                          { badge.textContent = '● High';     badge.style.background = '#EF444430'; badge.style.color = '#EF4444'; }

  // Change since FIRST snapshot
  const snaps = getNWSnapshots();
  const changeEl = document.getElementById('nw-change');
  if (snaps.length >= 1) {
    const first = snaps[0].value;
    const diff  = nw.netWorth - first;
    const pct   = first !== 0 ? (diff / Math.abs(first) * 100).toFixed(1) : 0;
    const color = diff >= 0 ? '#86EFAC' : '#FCA5A5';
    const arrow = diff >= 0 ? '▲' : '▼';
    changeEl.innerHTML = `<span style="color:${color};">${arrow} ${fmt(Math.abs(diff))} (${pct}%)</span> <span style="opacity:0.6;font-size:0.9em;">since first snapshot</span>`;
  } else {
    changeEl.innerHTML = `<span style="opacity:0.6;font-size:0.88em;">Save a snapshot to track changes over time</span>`;
  }

  // Group totals in header
  const assetsEl = document.getElementById('nw-assets-total');
  const liabEl   = document.getElementById('nw-liab-total');
  if (assetsEl) assetsEl.textContent = fmt(nw.totalAssets);
  if (liabEl)   liabEl.textContent   = fmt(nw.liabTotal);

  // ── Insights cards ──
  renderNWInsights(nw);

  // ── Trend + Snapshots ──
  const chartCard = document.getElementById('nw-chart-card');
  const snapCountEl = document.getElementById('nw-snap-count');
  if (snaps.length >= 1) {
    chartCard.style.display = '';
    if (snapCountEl) snapCountEl.textContent = snaps.length + ' Snapshot' + (snaps.length !== 1 ? 's' : '');
    // Trend line chart
    const canvasId = 'nw-trend-chart';
    if (charts[canvasId]) { charts[canvasId].destroy(); delete charts[canvasId]; }
    const ctx = document.getElementById(canvasId);
    if (ctx && snaps.length >= 2) {
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: snaps.map(s => {
            const d = new Date(s.date+'T00:00:00');
            return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
          }),
          datasets: [{
            data: snaps.map(s => snapValue(s)),
            borderColor: '#C8900A',
            backgroundColor: 'rgba(245,200,66,0.12)',
            borderWidth: 2.5,
            pointRadius: 5,
            pointBackgroundColor: '#F5C842',
            pointBorderColor: 'white',
            pointBorderWidth: 2,
            fill: true,
            tension: 0.35
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => fmt(c.raw) } } },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 9, family:'Nunito', weight:'700' }, color:'#9AA0B2' } },
            y: { display: false }
          }
        }
      });
    }
    renderMonthlyIntelligence();
  } else {
    const intCard = document.getElementById('nw-intelligence-card');
    if (intCard) intCard.style.display = 'none';
  }

  // ── Asset Allocation donut ──
  renderNWDonut(nw);

  // ── Account Sections ──
  Object.keys(NW_TYPES).forEach(t => {
    const cfg    = NW_TYPES[t];
    const group  = nw.byType[t];
    const valEl  = document.getElementById('nw-val-'+t);
    const subEl  = document.getElementById('nw-sub-'+t);
    const bodyEl = document.getElementById('nw-body-'+t);
    if (!valEl || !bodyEl) return;

    valEl.textContent = fmt(group.total);
    const cnt = group.accounts.length;
    if (subEl) {
      if (cnt === 0) subEl.textContent = 'No accounts yet';
      else subEl.textContent = cnt + ' account' + (cnt !== 1 ? 's' : '');
    }

    const addBtnLabel = t === 'metals' ? '+ Add Entry' : t === 'realestate' ? '+ Add Property' : t === 'credit_card' ? '+ Add Card' : t === 'loan' ? '+ Add Loan' : '+ Add Account';

    if (cnt === 0) {
      bodyEl.innerHTML = `<button class="nw-section-add" onclick="openNWSheet('${t}')" style="margin-top:8px;">${addBtnLabel}</button>`;
      return;
    }

    const sectionTotal = group.total;

    if (t === 'metals') {
      // ── Grouped hierarchy: Metal Type → Purity → Items ──
      bodyEl.innerHTML = buildNWMetalsBody(group.accounts, cfg, addBtnLabel);
    } else {
      bodyEl.innerHTML = group.accounts.map(acc => {
        const pct     = sectionTotal > 0 ? Math.min(acc._val / sectionTotal, 1) : 0;
        const dateStr = acc.lastUpdated ? new Date(acc.lastUpdated+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
        const metaLine = buildAccountMetaLine(acc);
        const isLiab   = cfg.isLiab;
        const valColor = isLiab ? 'var(--expenses)' : cfg.color;
        const editBtn  = acc._imported ? '' : `<button class="nw-account-btn" onclick="openNWSheet('${acc.type}','${acc.id}')">✏️</button><button class="nw-account-btn del" onclick="deleteNWAccount('${acc.id}')">✕</button>`;
        return `<div class="nw-account-row">
          <div class="nw-account-left">
            <div class="nw-account-name">${acc.name}</div>
            ${metaLine ? `<div class="nw-account-meta">${metaLine}</div>` : ''}
            <div class="nw-account-bar-wrap"><div class="nw-account-bar-fill" style="width:${(pct*100).toFixed(0)}%;background:${cfg.color};"></div></div>
          </div>
          <div class="nw-account-right">
            <div>
              <div class="nw-account-val" style="color:${valColor};">${fmt(acc._val)}</div>
              ${dateStr ? `<div class="nw-account-updated">Updated ${dateStr}</div>` : ''}
            </div>
            <div class="nw-account-actions">${editBtn}</div>
          </div>
        </div>`;
      }).join('') + `<div style="padding-top:8px;"><button class="nw-section-add" onclick="openNWSheet('${t}')">${addBtnLabel}</button></div>`;
    }
  });

  // ── Render custom type sections (not in static HTML) ──
  const customTypes = (data._nwCustomTypes || []);
  const customAssetEl = document.getElementById('nw-custom-sections-assets');
  const customLiabEl  = document.getElementById('nw-custom-sections-liab');
  if (customAssetEl) customAssetEl.innerHTML = '';
  if (customLiabEl)  customLiabEl.innerHTML  = '';

  customTypes.forEach(ct => {
    const t = ct.key;
    const cfg = NW_TYPES[t];
    if (!cfg) return;
    const group = nw.byType[t] || { total: 0, accounts: [] };
    const container = cfg.isLiab ? customLiabEl : customAssetEl;
    if (!container) return;

    const cnt = group.accounts.length;
    const addBtnLabel = '+ Add Account';

    // Build section HTML
    const secId    = 'nw-sec-' + t;
    const bodyId   = 'nw-body-' + t;
    const valId    = 'nw-val-' + t;
    const subId    = 'nw-sub-' + t;
    const chevId   = 'nw-chev-' + t;

    // Check if element already exists (re-render)
    let secEl = document.getElementById(secId);
    if (!secEl) {
      secEl = document.createElement('div');
      secEl.className = 'nw-section';
      secEl.id = secId;
      container.appendChild(secEl);
    }

    const valColor = cfg.isLiab ? 'var(--expenses)' : (cfg.color || '#6B7280');
    const sectionTotal = group.total;

    // Build body rows
    let bodyHTML = '';
    if (cnt === 0) {
      bodyHTML = `<button class="nw-section-add" onclick="openNWSheet('${t}')" style="margin-top:8px;">${addBtnLabel}</button>`;
    } else {
      bodyHTML = group.accounts.map(acc => {
        const pct     = sectionTotal > 0 ? Math.min(acc._val / sectionTotal, 1) : 0;
        const dateStr = acc.lastUpdated ? new Date(acc.lastUpdated+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
        const metaLine = buildAccountMetaLine(acc);
        const isLiab   = cfg.isLiab;
        const valColorAcc = isLiab ? 'var(--expenses)' : valColor;
        const editBtn  = acc._imported ? '' : `<button class="nw-account-btn" onclick="openNWSheet('${acc.type}','${acc.id}')">✏️</button><button class="nw-account-btn del" onclick="deleteNWAccount('${acc.id}')">✕</button>`;
        return `<div class="nw-account-row">
          <div class="nw-account-left">
            <div class="nw-account-name">${acc.name}</div>
            ${metaLine ? `<div class="nw-account-meta">${metaLine}</div>` : ''}
            <div class="nw-account-bar-wrap"><div class="nw-account-bar-fill" style="width:${(pct*100).toFixed(0)}%;background:${valColor};"></div></div>
          </div>
          <div class="nw-account-right">
            <div>
              <div class="nw-account-val" style="color:${valColorAcc};">${fmt(acc._val)}</div>
              ${dateStr ? `<div class="nw-account-updated">Updated ${dateStr}</div>` : ''}
            </div>
            <div class="nw-account-actions">${editBtn}</div>
          </div>
        </div>`;
      }).join('') + `<div style="padding-top:8px;"><button class="nw-section-add" onclick="openNWSheet('${t}')">${addBtnLabel}</button></div>`;
    }

    secEl.innerHTML = `
      <div class="nw-section-header" onclick="toggleNWSection('${t}')">
        <div class="nw-section-left">
          <div class="nw-section-icon">${cfg.emoji}</div>
          <div><div class="nw-section-name">${cfg.label}</div><div class="nw-section-sub" id="${subId}">${cnt === 0 ? 'No accounts yet' : cnt + ' account' + (cnt !== 1 ? 's' : '')}</div></div>
        </div>
        <div class="nw-section-right">
          <div class="nw-section-val" id="${valId}" style="color:${valColor};">${fmt(group.total)}</div>
          <span class="nw-section-chevron" id="${chevId}">▼</span>
        </div>
      </div>
      <div class="nw-section-body" id="${bodyId}">${bodyHTML}</div>`;
  });
}

function deleteNWSnapshot(snapId) {
  // snapId is either _id (string) or fallback numeric index
  const snaps = getNWSnapshots();
  let resolvedIdx = -1;
  if (typeof snapId === 'string') {
    resolvedIdx = snaps.findIndex(s => s._id === snapId);
  }
  if (resolvedIdx < 0) {
    // Fallback: treat as index
    resolvedIdx = parseInt(snapId);
  }
  if (resolvedIdx < 0 || resolvedIdx >= snaps.length) {
    showToast('Snapshot not found'); return;
  }
  if (!confirm('Delete this snapshot?')) return;
  snaps.splice(resolvedIdx, 1);
  data._nwSnapshots = snaps;
  save();
  renderNetWorth();
  showToast('Snapshot deleted');
}


function buildAccountMetaLine(acc) {
  const parts = [];
  const m = acc.meta || {};
  if (acc.type === 'retirement' && m.subtype) parts.push(m.subtype);
  if (m.ytdContribution) parts.push('YTD: ' + fmt(m.ytdContribution));
  if (acc.type === 'credit_card') {
    if (m.limit) parts.push('Limit: ' + fmt(m.limit));
    if (m.apr) parts.push('APR: ' + m.apr + '%');
    if (m.limit && acc.balance) {
      const util = Math.min(Number(acc.balance)/Number(m.limit)*100,100).toFixed(0);
      parts.push('Utilization: ' + util + '%');
    }
  }
  if (acc.type === 'loan' && m.interestRate) parts.push('Rate: ' + m.interestRate + '%');
  if (acc.type === 'bonds_fd') {
    if (m.interestRate) parts.push('Rate: ' + m.interestRate + '%');
    if (m.maturityDate) parts.push('Matures: ' + m.maturityDate);
  }
  if (acc.type === 'metals' && acc.meta) {
    const g = Number(acc.meta.grams || 0);
    if (g > 0) {
      const oz = (g / 31.1035).toFixed(3);
      parts.push(g.toFixed(2) + 'g (' + oz + ' oz)');
    }
    if (acc.meta.purity)   parts.push(acc.meta.purity);
    if (acc.meta.occasion) parts.push(acc.meta.occasion);
    if (acc.meta.form && acc.meta.form !== 'Jewelry') parts.push(acc.meta.form);
    if (acc.meta.originalName && acc.meta.originalName !== acc.meta.metalType) parts.push(acc.meta.originalName);
  }
  if (m.bank) parts.push(m.bank);
  if (m.last4) parts.push('····' + m.last4);
  if (m.notes) parts.push(m.notes);
  if (acc.currency && acc.currency !== currentCurrency.code) parts.push(acc.currency);
  if (acc.type === 'realestate' && acc.meta) {
    if (acc.meta.area)          parts.push(acc.meta.area);
    if (acc.meta.country)       parts.push(acc.meta.country);
    if (acc.meta.purchaseValue) parts.push('Purchased: ' + fmt(acc.meta.purchaseValue));
  }
  if (acc._imported) parts.push('📥 imported');
  return parts.join(' · ');
}

function renderNWInsights(nw) {
  const container = document.getElementById('nw-insights-list');
  if (!container) return;

  const cards = [];
  const todayMk = new Date().toISOString().slice(0,7);
  let monthlyExp = 0;
  if (data[todayMk]) (data[todayMk].expenses||[]).forEach(e => monthlyExp += nwConvert(e.amount, e.currency));

  // 1. Debt ratio
  const drPct = (nw.debtRatio * 100).toFixed(0);
  if (nw.liabTotal > 0) {
    const isHigh = nw.debtRatio > 0.4, isMod = nw.debtRatio > 0.2;
    cards.push({
      icon: isHigh ? '🔴' : isMod ? '💛' : '✅',
      iconBg: isHigh ? '#FFEEEE' : isMod ? '#FFFBE8' : '#E8FDF5',
      border: isHigh ? '#EF4444' : isMod ? '#F59E0B' : '#10B981',
      title: `Debt ratio at ${drPct}%`,
      sub: isHigh ? 'Consider paying down debt to reduce financial risk.' : isMod ? 'Manageable but worth monitoring. Aim to get this below 30% over time.' : 'Excellent! Your debt is well under control.'
    });
  }

  // 2. Emergency fund
  const liquid = (nw.byType.checking?.total||0) + (nw.byType.savings_acc?.total||0) + (nw.byType.cash?.total||0);
  if (monthlyExp > 0) {
    const months = liquid / monthlyExp;
    const isGood = months >= 3;
    cards.push({
      icon: isGood ? '🛡️' : '🆘',
      iconBg: isGood ? '#E8F5FF' : '#FFEEEE',
      border: isGood ? '#4A9EFF' : '#EF4444',
      title: isGood ? `${months.toFixed(1)} months emergency fund` : 'Low emergency fund',
      sub: `${fmt(liquid)} in liquid accounts. Aim for 3–6 months of expenses as a safety net.`
    });
  }

  // 3. Investment allocation
  const investVal = (nw.byType.brokerage?.total||0) + (nw.byType.retirement?.total||0) + (nw.byType.bonds_fd?.total||0) + (nw.byType.metals?.total||0);
  if (nw.totalAssets > 0) {
    const invPct = (investVal / nw.totalAssets * 100).toFixed(0);
    cards.push({
      icon: '📊',
      iconBg: '#F0EBFF',
      border: '#7C3AED',
      title: `${invPct}% of assets invested`,
      sub: `${fmt(investVal)} in investments, retirement, bonds & metals.`
    });
  }

  // 4. Real estate concentration
  const reVal = nw.byType.realestate?.total || 0;
  if (reVal > 0 && nw.totalAssets > 0) {
    const rePct = (reVal / nw.totalAssets * 100).toFixed(0);
    cards.push({
      icon: '🏡',
      iconBg: '#E8FDF5',
      border: '#F97316',
      title: `Real estate: ${rePct}% of assets`,
      sub: `${fmt(reVal)} in property.${rePct > 70 ? ' Consider diversifying into other asset classes.' : ' Good diversification across asset types.'}`
    });
  }

  // 5. Net worth positive
  if (nw.netWorth > 0) {
    cards.push({
      icon: '💪',
      iconBg: '#E8FDF5',
      border: '#10B981',
      title: `Positive net worth: ${fmt(nw.netWorth)}`,
      sub: 'Your assets exceed your liabilities — keep building!'
    });
  }

  container.innerHTML = cards.map(c => `
    <div class="nw-insight-card" style="border-left-color:${c.border};">
      <div class="nw-insight-icon-wrap" style="background:${c.iconBg};">${c.icon}</div>
      <div>
        <div class="nw-insight-title">${c.title}</div>
        <div class="nw-insight-sub">${c.sub}</div>
      </div>
    </div>`).join('');
}


function renderNWDonut(nw) {
  const allocCard = document.getElementById('nw-alloc-card');
  const legendEl  = document.getElementById('nw-donut-legend');
  const barEl     = document.getElementById('nw-alloc-stacked-bar');
  const totalEl   = document.getElementById('nw-alloc-total');

  const TYPE_COLORS = {
    realestate: '#F97316', retirement: '#7C3AED', brokerage: '#8B5CF6',
    savings_acc: '#10B981', bonds_fd: '#F59E0B', checking: '#3B9EFF',
    metals: '#C8900A', cash: '#84CC16'
  };
  const TYPE_LABELS = {
    realestate: 'Real Estate', retirement: 'Retirement', brokerage: 'Investment',
    savings_acc: 'Savings', bonds_fd: 'Bonds/FD', checking: 'Checking',
    metals: 'Precious Metals', cash: 'Cash'
  };
  // Include custom types
  (data._nwCustomTypes||[]).forEach(c => {
    TYPE_LABELS[c.key] = c.label;
    TYPE_COLORS[c.key] = c.color || '#6B7280';
  });

  const segments = [];
  Object.keys(NW_TYPES).forEach(t => {
    if (NW_TYPES[t].isLiab) return;
    const val = nw.byType[t]?.total || 0;
    if (val > 0) {
      const label = TYPE_LABELS[t] || NW_TYPES[t]?.label || t;
      segments.push({ type: t, val, color: TYPE_COLORS[t] || '#9AA0B2', label });
    }
  });
  segments.sort((a, b) => b.val - a.val);

  if (segments.length === 0) { if (allocCard) allocCard.style.display = 'none'; return; }
  if (allocCard) allocCard.style.display = '';

  if (totalEl) totalEl.textContent = fmt(nw.totalAssets);

  // Stacked horizontal bar
  if (barEl) {
    barEl.innerHTML = segments.map(s => {
      const pct = nw.totalAssets > 0 ? (s.val / nw.totalAssets * 100) : 0;
      return `<div style="flex:${pct};background:${s.color};min-width:${pct > 1 ? '4px' : '0'};transition:flex 0.4s ease;" title="${s.label}: ${fmt(s.val)} (${pct.toFixed(0)}%)"></div>`;
    }).join('');
  }

  // Legend as clean rows
  if (legendEl) {
    legendEl.innerHTML = segments.map(s => {
      const pct = nw.totalAssets > 0 ? (s.val / nw.totalAssets * 100).toFixed(1) : '0';
      const barWidth = Math.min(parseFloat(pct), 100);
      return `<div style="margin-bottom:9px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
          <div style="display:flex;align-items:center;gap:7px;">
            <div style="width:10px;height:10px;border-radius:3px;background:${s.color};flex-shrink:0;"></div>
            <span style="font-size:0.78em;font-weight:700;color:var(--text-dark);">${s.label}</span>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <span style="font-size:0.72em;font-weight:700;color:var(--text-light);">${pct}%</span>
            <span style="font-size:0.78em;font-weight:900;color:var(--text-dark);min-width:60px;text-align:right;">${fmt(s.val)}</span>
          </div>
        </div>
        <div style="height:4px;background:#F0F0F0;border-radius:2px;">
          <div style="height:100%;width:${barWidth}%;background:${s.color};border-radius:2px;transition:width 0.4s ease;"></div>
        </div>
      </div>`;
    }).join('');
  }
}


function toggleNWMetalGroup(id) {
  const body = document.getElementById(id);
  const chev = document.getElementById(id + '-chev');
  if (!body) return;
  const collapsed = body.classList.toggle('collapsed');
  if (chev) chev.style.transform = collapsed ? 'rotate(-90deg)' : '';
}

function toggleNWSection(name) {
  const body = document.getElementById('nw-body-'+name);
  const chev = document.getElementById('nw-chev-'+name);
  if (body) body.classList.toggle('open');
  if (chev) chev.classList.toggle('open');
}

// ── NW Balance Visibility Toggle ──────────────────────────────
let _nwHidden = false;
function toggleNWVisibility() {
  _nwHidden = !_nwHidden;
  const iconEl = document.getElementById('nw-eye-icon');
  if (iconEl) iconEl.textContent = _nwHidden ? '🔒' : '🔓';
  // Mask/unmask all monetary value elements in NW screen
  const targets = document.querySelectorAll(
    '#nw-total, #nw-assets-hero, #nw-liab-hero, #nw-change, ' +
    '#nw-assets-total, #nw-liab-total, #nw-alloc-total, ' +
    '.nw-section-val, .nw-group-total, .nw-snap-val, ' +
    '[id^="nw-val-"], .nw-account-val, .nw-holding-val, ' +
    '.nw-holding-row-val, .metal-holding-value, ' +
    '#mi-kpi-row, #mi-cat-bars, #mi-budget-section'
  );
  // Also mask/unmask inline-rendered account body values (dynamically generated)
  document.querySelectorAll('#screen-networth [style*="font-weight:900"]').forEach(el => {
    // Only target elements that look like monetary values (contain $ or currency sym)
    if (el.textContent && /[$₹€£¥]|,\d{3}/.test(el.textContent)) {
      el.classList.toggle('nw-masked', _nwHidden);
    }
  });
  targets.forEach(el => {
    el.classList.toggle('nw-masked', _nwHidden);
  });
  // Also mask the insight cards amounts
  document.querySelectorAll('#nw-insights-list .nw-insight-val').forEach(el => {
    el.classList.toggle('nw-masked', _nwHidden);
  });
}

function buildMonthlySnapshot(monthKey) {
  // Build a rich snapshot for a given month capturing full financial picture
  const nw = computeNetWorth();
  const mk = monthKey || viewMonth;
  const mdata = data[mk] || {};
  const toDisp = (amt, cur) => convertAmt(amt, cur || currentCurrency.code);

  // NW by type
  const byType = {};
  Object.keys(nw.byType).forEach(t => { byType[t] = nw.byType[t].total; });

  // Monthly P&L
  const expenses   = (mdata.expenses    || []).reduce((s,e) => s + toDisp(e.amount, e.currency), 0);
  const income     = (mdata.income      || []).reduce((s,e) => s + toDisp(e.amount, e.currency), 0);
  const investments= (mdata.investments || []).reduce((s,e) => s + toDisp(e.amount, e.currency), 0);
  const savingsRate = income > 0 ? ((income - expenses) / income * 100) : 0;

  // Top spending categories
  const catTotals = {};
  (mdata.expenses || []).forEach(e => {
    const c = e.category || 'Other';
    catTotals[c] = (catTotals[c] || 0) + toDisp(e.amount, e.currency);
  });
  const topCategories = Object.entries(catTotals)
    .sort((a,b) => b[1]-a[1]).slice(0,5)
    .map(([cat, amt]) => ({ cat, amt }));

  // Budget performance (goals vs actual)
  const budgetPerformance = [];
  try {
    const expGoals = getBudgetGoals('expense');
    expGoals.forEach(g => {
      const actual = getBudgetActual(g, mk);
      const _gDisp = g.currency && g.currency !== currentCurrency.code ? convertAmt(Number(g.amount||0), g.currency) : Number(g.amount||0);
      budgetPerformance.push({ name: g.key, goal: _gDisp, actual, pct: _gDisp > 0 ? actual/_gDisp*100 : 0 });
    });
  } catch(e) {}

  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  return {
    date: localDateStr(),
    time: timeStr,
    month: mk,
    value: nw.netWorth,
    totalAssets: nw.totalAssets,
    liabilities: nw.liabTotal,
    byType,
    income, expenses, investments,
    savingsRate,
    topCategories,
    budgetPerformance,
    currency: currentCurrency.code,
  };
}


// ══════════════════════════════════════════════════════════════════
// MONTHLY INTELLIGENCE — full render
// ══════════════════════════════════════════════════════════════════
function _snapMonthLabel(snap, fmt) {
  // Safe cross-browser month label from a snapshot — no Date() parsing
  const mk = snap.month || snap.date || '';
  // mk is either 'YYYY-MM' or 'YYYY-MM-DD'
  const parts = mk.split('-');
  if (parts.length < 2) return mk || '—';
  const year = parseInt(parts[0]);
  const month = parseInt(parts[1]) - 1; // 0-indexed
  if (isNaN(year) || isNaN(month)) return '—';
  const MONTHS_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const MONTHS_LONG  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const mo = MONTHS_SHORT[month] || '?';
  const moL = MONTHS_LONG[month] || '?';
  if (fmt === 'short') return mo + " '" + String(year).slice(2);      // Jan '26
  if (fmt === 'medium') return mo + ' ' + year;                        // Jan 2026
  if (fmt === 'long') return moL + ' ' + year;                         // January 2026
  if (fmt === 'axis') return mo + ' ' + String(year).slice(2);         // Jan 26
  return mo + ' ' + year;
}

function renderMonthlyIntelligence() {
  const allSnaps = getNWSnapshots().slice().sort((a,b) => (a.month||a.date||'').localeCompare(b.month||b.date||''));
  // For the trend chart + comparison: use one entry per month (latest value wins)
  const monthMap = new Map();
  allSnaps.forEach(s => {
    const mk = s.month || s.date?.slice(0,7) || '';
    const prev = monthMap.get(mk);
    // Keep the one with richer data or higher _id (most recent manual)
    if (!prev || (s._id && (!prev._id || s._id > prev._id))) monthMap.set(mk, s);
  });
  const snaps = [...monthMap.values()].sort((a,b) => (a.month||a.date||'').localeCompare(b.month||b.date||''));
  const intCard = document.getElementById('nw-intelligence-card');
  if (!intCard) return;

  if (snaps.length === 0) { intCard.style.display = 'none'; return; }
  intCard.style.display = '';

  // ── NW Trend Chart ──────────────────────────────────────────────
  const chartCard = document.getElementById('nw-chart-card');
  if (chartCard) chartCard.style.display = '';
  document.getElementById('nw-snap-count').textContent = snaps.length + (snaps.length===1?' month':' months');

  const chartEl = document.getElementById('nw-trend-chart');
  if (chartEl && typeof Chart !== 'undefined') {
    const existing = Chart.getChart(chartEl);
    if (existing) existing.destroy();
    const labels = snaps.map(s => _snapMonthLabel(s, 'axis'));
    const values = snaps.map(s => snapValue(s));
    const minVal = Math.min(...values);
    new Chart(chartEl, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: values,
          borderColor: '#7C3AED',
          backgroundColor: 'rgba(124,58,237,0.08)',
          borderWidth: 2.5,
          tension: 0.35,
          fill: true,
          pointBackgroundColor: '#7C3AED',
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: {
          callbacks: { label: ctx => ' ' + fmt(ctx.raw) }
        }},
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 9, family:'Nunito', weight:'700' }, color:'#9AA0B2' }},
          y: { display: false, min: minVal * 0.95 }
        }
      }
    });
  }

  // ── Month selector dropdowns ─────────────────────────────────────
  const selA = document.getElementById('mi-month-a');
  const selB = document.getElementById('mi-month-b');
  if (selA && selB) {
    const opts = snaps.map((s,i) => `<option value="${i}">${_snapMonthLabel(s,'medium')}</option>`).join('');
    selA.innerHTML = opts;
    selB.innerHTML = opts;
    // Default: latest vs one before
    selA.value = Math.max(0, snaps.length - 2);
    selB.value = snaps.length - 1;
  }

  _renderMIComparison();

  // ── Snapshot list ───────────────────────────────────────────────
  const snapListEl = document.getElementById('nw-snapshots-list');
  if (snapListEl) {
    const listSnaps = allSnaps.slice().reverse(); // ALL snapshots in list (newest first)
    const maxVal = Math.max(...listSnaps.map(s => snapValue(s)), 1);
    // Group by year for collapsible display
    const byYear = {};
    listSnaps.forEach((s, i) => {
      const yr = (s.month || s.date || '2000').slice(0,4);
      if (!byYear[yr]) byYear[yr] = [];
      byYear[yr].push({ s, i });
    });
    const years = Object.keys(byYear).sort().reverse();
    const currentYr = new Date().getFullYear().toString();

    snapListEl.innerHTML = years.map((yr, yi) => {
      const isCurrentYear = yr === currentYr;
      const colId = 'snap-yr-' + yr;
      const entries = byYear[yr].map(({ s, i }) => {
        const realIdx = allSnaps.length - 1 - i;
      // Label: manual snapshots show full date + time, auto-snapshots show month only
      const monthLabel = _snapMonthLabel(s, 'medium');
      const isManual = s._manual;
      const timeLabel = isManual && s.time ? ` · ${s.time}` : '';
      const dateLabel = isManual && s.date ? new Date(s.date + 'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      const d = isManual ? `${dateLabel}${timeLabel}` : monthLabel;
      const subLabel = isManual ? `<div style="font-size:0.65em;color:var(--text-light);font-weight:700;">${monthLabel}</div>` : '';
      const pct = (snapValue(s) / maxVal * 100).toFixed(0);
      const hasFull = s.income !== undefined;
      const savTag = hasFull && s.savingsRate !== undefined && s.savingsRate !== 0
        ? `<span style="font-size:0.62em;background:${s.savingsRate>=0?'#D1FAE5':'#FEE2E2'};color:${s.savingsRate>=0?'#10B981':'#EF4444'};border-radius:4px;padding:1px 5px;font-weight:800;white-space:nowrap;">${s.savingsRate>=0?'+':''}${s.savingsRate.toFixed(0)}% saved</span>`
        : '';
      return `<div class="nw-snap-row" style="align-items:flex-start;padding:9px 0;">
        <div class="nw-snap-date" style="width:90px;flex-shrink:0;">
          <div style="font-size:0.78em;font-weight:800;color:var(--text-dark);line-height:1.3;">${d}</div>
          ${subLabel}
          ${savTag}
        </div>
        <div class="nw-snap-bar-wrap" style="margin-top:6px;"><div class="nw-snap-bar-fill" style="width:${pct}%;"></div></div>
        <div class="nw-snap-val">${fmt(snapValue(s))}</div>
        <button class="nw-snap-del" onclick="deleteNWSnapshot('${s._id||realIdx}')" title="Delete">×</button>
      </div>`;
    }).join('');

    // Wrap entries in collapsible year accordion
    return `
      <div style="margin-bottom:4px;">
        <div onclick="const b=document.getElementById('${colId}');const ch=document.getElementById('${colId}-ch');b.style.display=b.style.display==='none'?'':'none';ch.style.transform=b.style.display==='none'?'rotate(-90deg)':'';"
          style="display:flex;align-items:center;justify-content:space-between;padding:7px 2px;cursor:pointer;user-select:none;">
          <div style="font-size:0.72em;font-weight:900;color:var(--text-med);letter-spacing:0.5px;">
            ${yr}${isCurrentYear ? ' · Current' : ''}
            <span style="font-size:0.85em;color:var(--text-light);font-weight:700;margin-left:6px;">${byYear[yr].length} snapshot${byYear[yr].length!==1?'s':''}</span>
          </div>
          <span id="${colId}-ch" style="font-size:0.7em;color:var(--text-light);transition:transform 0.2s;">▼</span>
        </div>
        <div id="${colId}" style="display:${isCurrentYear?'':'none'};">${entries}</div>
      </div>`;
  }).join('');
  }

  // ── Savings rate sparkline ───────────────────────────────────────
  _renderSavingsTrend(snaps);
}

function _renderMIComparison() {
  const snaps = getNWSnapshots().slice().sort((a,b) => (a.month||a.date||'').localeCompare(b.month||b.date||''));
  const selA = document.getElementById('mi-month-a');
  const selB = document.getElementById('mi-month-b');
  if (!selA || !selB || snaps.length < 1) return;

  const idxA = parseInt(selA.value) || 0;
  const idxB = parseInt(selB.value) || Math.min(1, snaps.length-1);
  const a = snaps[Math.min(idxA, snaps.length-1)] || snaps[0];
  const b = snaps[Math.min(idxB, snaps.length-1)] || snaps[0];
  const hasFull = a.income !== undefined && b.income !== undefined;

  // KPI cards
  const kpiEl = document.getElementById('mi-kpi-row');
  if (kpiEl) {
    const kpis = [
      { label:'Net Worth', valA: snapValue(a), valB: snapValue(b), fmt: v => sym()+getCompactNum(v), icon:'💎' },
      { label:'Income', valA: snapField(a,'income'), valB: snapField(b,'income'), fmt: v => sym()+getCompactNum(v), icon:'💵', hidden: !hasFull },
      { label:'Expenses', valA: snapField(a,'expenses'), valB: snapField(b,'expenses'), fmt: v => sym()+getCompactNum(v), icon:'💸', flip: true, hidden: !hasFull },
      { label:'Savings %', valA: a.savingsRate||0, valB: b.savingsRate||0, fmt: v => v.toFixed(1)+'%', icon:'🏦', hidden: !hasFull },
    ].filter(k => !k.hidden);

    kpiEl.style.gridTemplateColumns = `repeat(${kpis.length},1fr)`;
    kpiEl.innerHTML = kpis.map(k => {
      const delta = k.valB - k.valA;
      const pct = k.valA !== 0 ? delta / Math.abs(k.valA) * 100 : 0;
      const up = k.flip ? delta <= 0 : delta >= 0;
      const arrow = delta === 0 ? '→' : delta > 0 ? '↑' : '↓';
      const color = delta === 0 ? '#9AA0B2' : up ? '#10B981' : '#EF4444';
      return `<div style="background:#FAFAFA;border-radius:10px;padding:8px 6px;text-align:center;">
        <div style="font-size:0.65em;font-weight:800;color:var(--text-light);text-transform:uppercase;">${k.icon} ${k.label}</div>
        <div style="font-weight:900;font-size:0.82em;color:var(--text-dark);margin:3px 0;">${k.fmt(k.valB)}</div>
        <div style="font-size:0.65em;font-weight:800;color:${color};">${arrow} ${Math.abs(pct).toFixed(1)}%</div>
      </div>`;
    }).join('');
  }

  // Category comparison bars
  const catEl = document.getElementById('mi-cat-bars');
  if (catEl && hasFull) {
    const allCats = new Set([
      ...(a.topCategories||[]).map(c=>c.cat),
      ...(b.topCategories||[]).map(c=>c.cat)
    ]);
    const pairs = [...allCats].map(cat => {
      const ca = (a.topCategories||[]).find(c=>c.cat===cat);
      const cb = (b.topCategories||[]).find(c=>c.cat===cat);
      // Convert category amounts from snapshot's stored currency to current display currency
      const convA = ca ? nwConvert(ca.amt||0, a.currency||'USD') : 0;
      const convB = cb ? nwConvert(cb.amt||0, b.currency||'USD') : 0;
      return { cat, amtA: convA, amtB: convB };
    }).sort((x,y) => Math.max(y.amtA,y.amtB) - Math.max(x.amtA,x.amtB)).slice(0,6);

    const maxAmt = Math.max(...pairs.map(p => Math.max(p.amtA, p.amtB)), 1);
    const mkLabel = (s) => _snapMonthLabel(s, 'short');

    catEl.innerHTML = `
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-bottom:6px;font-size:0.62em;font-weight:800;color:var(--text-light);">
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;border-radius:2px;background:#C4B5FD;display:inline-block;"></span>${_snapMonthLabel(a,"short")}</span>
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;border-radius:2px;background:#7C3AED;display:inline-block;"></span>${_snapMonthLabel(b,"short")}</span>
      </div>
      ${pairs.map(p => {
        const pctA = p.amtA / maxAmt * 100;
        const pctB = p.amtB / maxAmt * 100;
        const delta = p.amtB - p.amtA;
        const deltaColor = delta <= 0 ? '#10B981' : '#EF4444';
        return `<div style="margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
            <div style="font-size:0.72em;font-weight:800;color:var(--text-dark);">${p.cat}</div>
            <div style="font-size:0.65em;font-weight:800;color:${deltaColor};">${delta>=0?'+':''}${sym()}${getCompactNum(Math.abs(delta))}</div>
          </div>
          <div style="display:flex;gap:3px;height:7px;">
            <div style="flex:1;background:#F0F0F0;border-radius:4px;overflow:hidden;">
              <div style="width:${pctA.toFixed(1)}%;height:100%;background:#C4B5FD;border-radius:4px;"></div>
            </div>
            <div style="flex:1;background:#F0F0F0;border-radius:4px;overflow:hidden;">
              <div style="width:${pctB.toFixed(1)}%;height:100%;background:#7C3AED;border-radius:4px;"></div>
            </div>
          </div>
        </div>`;
      }).join('')}`;
  } else if (catEl && !hasFull) {
    catEl.innerHTML = `<div style="font-size:0.72em;color:var(--text-light);text-align:center;padding:8px 0;">Save a snapshot to start seeing category trends</div>`;
  }

  // Budget performance
  const budgetEl = document.getElementById('mi-budget-section');
  if (budgetEl && hasFull && (b.budgetPerformance||[]).length > 0) {
    budgetEl.innerHTML = `
      <div style="font-size:0.68em;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:0.4px;margin-bottom:8px;">Budget Performance — ${_snapMonthLabel(b,'long')}</div>
      ${(b.budgetPerformance||[]).slice(0,5).map(bp => {
        const pct = Math.min(bp.pct, 150);
        const over = bp.pct > 100;
        const bCurr = b.currency||'USD';
        const bActual = nwConvert(bp.actual||0, bCurr);
        const bGoal = nwConvert(bp.goal||0, bCurr);
        return `<div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
            <div style="font-size:0.72em;font-weight:800;color:var(--text-dark);">${bp.name}</div>
            <div style="font-size:0.65em;font-weight:800;color:${over?'#EF4444':'#10B981'};">${fmt(bActual)} / ${fmt(bGoal)}</div>
          </div>
          <div style="height:6px;background:#F0F0F0;border-radius:4px;overflow:hidden;">
            <div style="width:${Math.min(pct,100).toFixed(1)}%;height:100%;background:${over?'#EF4444':'#10B981'};border-radius:4px;"></div>
          </div>
        </div>`;
      }).join('')}`;
  } else if (budgetEl) {
    budgetEl.innerHTML = '';
  }
}

function _renderSavingsTrend(snaps) {
  const canvas = document.getElementById('mi-savings-chart');
  if (!canvas) return;
  const richSnaps = snaps.filter(s => s.savingsRate !== undefined);
  if (richSnaps.length < 2) {
    canvas.style.display = 'none'; return;
  }
  canvas.style.display = 'block';
  const W = canvas.offsetWidth || 300;
  canvas.width = W * (window.devicePixelRatio || 1);
  canvas.height = 50 * (window.devicePixelRatio || 1);
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio||1, window.devicePixelRatio||1);

  const rates = richSnaps.map(s => s.savingsRate || 0);
  const minR = Math.min(...rates, 0);
  const maxR = Math.max(...rates, 1);
  const range = maxR - minR || 1;
  const padT = 6, padB = 14, chartH = 50 - padT - padB;
  const xScale = i => (i / (rates.length - 1)) * W;
  const yScale = v => padT + chartH - ((v - minR) / range * chartH);

  // Zero line
  const zeroY = yScale(0);
  ctx.beginPath(); ctx.moveTo(0, zeroY); ctx.lineTo(W, zeroY);
  ctx.strokeStyle = '#E0E0E0'; ctx.lineWidth = 1; ctx.setLineDash([3,3]); ctx.stroke();
  ctx.setLineDash([]);

  // Fill above zero (green) / below zero (red)
  rates.forEach((r, i) => {
    if (i === 0) return;
    const x1 = xScale(i-1), x2 = xScale(i);
    const y1 = yScale(rates[i-1]), y2 = yScale(r);
    const isPos = r >= 0 && rates[i-1] >= 0;
    ctx.beginPath();
    ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
    ctx.lineTo(x2, zeroY); ctx.lineTo(x1, zeroY);
    ctx.closePath();
    ctx.fillStyle = isPos ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)';
    ctx.fill();
  });

  // Line
  ctx.beginPath();
  rates.forEach((r, i) => { const x=xScale(i), y=yScale(r); i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
  ctx.strokeStyle = '#10B981'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();

  // Month labels below
  ctx.fillStyle = '#9AA0B2'; ctx.font = `bold ${9 * (window.devicePixelRatio||1)}px Nunito`;
  ctx.scale(1/(window.devicePixelRatio||1), 1/(window.devicePixelRatio||1));
  richSnaps.forEach((s, i) => {
    const mk = s.month || s.date || '';
    const label = _snapMonthLabel(s, 'short').split("'")[0].trim(); // "Jan '26" → "Jan" for sparkline
    const x = xScale(i) * (window.devicePixelRatio||1);
    ctx.textAlign = i === 0 ? 'left' : i === richSnaps.length-1 ? 'right' : 'center';
    ctx.fillText(label, x, (50 - 2) * (window.devicePixelRatio||1));
  });
}

function autoSnapshot() {
  // Called when month changes — silently save previous month's snapshot
  const snaps = getNWSnapshots();
  const snap = buildMonthlySnapshot(viewMonth);
  const existing = snaps.find(s => s.month === snap.month);
  if (existing) {
    Object.assign(existing, snap); // update
  } else {
    snaps.push(snap);
  }
  save();
}

function saveNWSnapshot() {
  const snap = buildMonthlySnapshot(viewMonth);
  snap._manual = true; // flag as manual — shown with full date+time
  snap._id = 'snap_' + Date.now(); // unique id so multiple per month are allowed
  // Push directly to data._nwSnapshots — NOT the filtered copy from getNWSnapshots()
  if (!data._nwSnapshots) data._nwSnapshots = [];
  const tooRecent = data._nwSnapshots.find(s => s._id && Math.abs(Date.now() - parseInt(s._id.split('_')[1]||0)) < 5000);
  if (!tooRecent) data._nwSnapshots.push(snap);
  save();
  renderNetWorth();
  renderMonthlyIntelligence();
  showToast('📸 Snapshot saved · ' + fmt(snapValue(snap)));
}

function _nwsBuildTypePicker() {
  const vis = getNWTypeVisibility();
  const visibleTypes = getNWTypeOrder().filter(t => vis[t] !== false);
  const grid = document.getElementById('nws-type-grid');
  if (!grid) return;
  if (!visibleTypes.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-light);font-size:0.85em;padding:20px 0;">All account types are hidden.<br>Enable them in Settings → Net Worth Account Types.</div>';
    return;
  }
  grid.innerHTML = visibleTypes.map(t => {
    const cfg = NW_TYPES[t];
    const sel = t === nwSheetType;
    return `<div class="nws-type-tile${sel?' selected':''}" onclick="_nwsSelectType('${t}',event)">
      <div class="nws-type-tile-icon">${cfg.emoji}</div>
      <div class="nws-type-tile-name">${getNWTypeShort()[t]||cfg.label}</div>
    </div>`;
  }).join('');
}

function _nwsSelectType(type, ev) {
  nwSheetType = type;
  document.querySelectorAll('.nws-type-tile').forEach(t => t.classList.remove('selected'));
  if (ev && ev.currentTarget) ev.currentTarget.classList.add('selected');
  _nwsShowForm();
}

function _nwsShowForm() {
  const type = nwSheetType;
  const cfg = NW_TYPES[type];
  if (!cfg) return;
  const existing = nwSheetEditId ? (data._nwAccounts||[]).find(a=>a.id===nwSheetEditId) : null;
  const m = existing ? (existing.meta||{}) : {};

  document.getElementById('nws-phase-pick').style.display = 'none';
  document.getElementById('nws-phase-form').style.display = '';

  document.getElementById('nws-banner-icon').textContent = cfg.emoji;
  document.getElementById('nws-banner-name').textContent = cfg.label;
  const badge = document.getElementById('nws-banner-badge');
  badge.textContent = cfg.isLiab ? 'LIABILITY' : 'ASSET';
  badge.className   = 'nws-type-badge ' + (cfg.isLiab ? 'liab' : 'asset');

  _nwsBuildForm(type, existing, m);
}

function openNWSheet(type, editId) {
  nwSheetType   = type || null;
  nwSheetEditId = editId || null;
  const phasePick = document.getElementById('nws-phase-pick');
  const phaseForm = document.getElementById('nws-phase-form');

  if (type) {
    // Direct call from section button — skip picker, show form immediately
    phasePick.style.display = 'none';
    phaseForm.style.display = '';
    _nwsShowForm();
  } else {
    // "+ Add Account" CTA — show type picker first, no type pre-selected
    phasePick.style.display = '';
    phaseForm.style.display = 'none';
    _nwsBuildTypePicker();
  }

  document.getElementById('nw-sheet-overlay').classList.add('open');
  document.getElementById('nw-sheet').classList.add('open');
  document.getElementById('nw-sheet').scrollTop = 0;
}

function _nwsBuildForm(type, existing, m) {
  let extraFields = '';
  if (type === 'retirement') {
    const opts = RETIRE_SUBTYPES.map(s => `<option value="${s}" ${(m.subtype===s)?'selected':''}>${s}</option>`).join('');
    extraFields += `<div class="nw-sheet-field"><div class="nw-sheet-label">Account Subtype</div><select class="nw-sheet-select" id="nws-subtype">${opts}</select></div>`;
    extraFields += `<div class="nw-sheet-field"><div class="nw-sheet-label">YTD Contribution</div><input class="nw-sheet-input" id="nws-ytd" type="number" placeholder="0" value="${m.ytdContribution||''}"></div>`;
  }
  if (type === 'credit_card') {
    extraFields += `<div class="nw-sheet-row"><div class="nw-sheet-field"><div class="nw-sheet-label">Credit Limit</div><input class="nw-sheet-input" id="nws-limit" type="number" placeholder="5000" value="${m.limit||''}"></div><div class="nw-sheet-field"><div class="nw-sheet-label">APR %</div><input class="nw-sheet-input" id="nws-apr" type="number" placeholder="19.99" step="0.01" value="${m.apr||''}"></div></div>`;
  }
  if (type === 'loan') {
    extraFields += `<div class="nw-sheet-row"><div class="nw-sheet-field"><div class="nw-sheet-label">Interest Rate %</div><input class="nw-sheet-input" id="nws-rate" type="number" placeholder="6.5" step="0.01" value="${m.interestRate||''}"></div><div class="nw-sheet-field"><div class="nw-sheet-label">Monthly Payment</div><input class="nw-sheet-input" id="nws-mpay" type="number" placeholder="0" value="${m.monthlyPayment||''}"></div></div>`;
  }
  if (type === 'bonds_fd') {
    extraFields += `<div class="nw-sheet-row"><div class="nw-sheet-field"><div class="nw-sheet-label">Interest Rate %</div><input class="nw-sheet-input" id="nws-rate" type="number" placeholder="5.0" step="0.01" value="${m.interestRate||''}"></div><div class="nw-sheet-field"><div class="nw-sheet-label">Maturity Date</div><input class="nw-sheet-input" id="nws-maturity" type="date" value="${m.maturityDate||''}"></div></div>`;
  }
  if (type === 'metals') {
    const metalTypes = ['gold','silver','platinum'];
    const mOpts = metalTypes.map(mt => `<option value="${mt}" ${(m.metalType===mt)?'selected':''}>${mt.charAt(0).toUpperCase()+mt.slice(1)}</option>`).join('');
    const purityOpts = ['24K','22K','21K','18K','14K','10K','999 Fine','925 Silver','850','Other'].map(p=>`<option value="${p}" ${(m.purity===p)?'selected':''}>${p}</option>`).join('');
    const unitOpts = ['g','oz'].map(u=>`<option value="${u}" ${((m.weightUnit||'g')===u)?'selected':''}>${u}</option>`).join('');
    extraFields += `<div class="nw-sheet-row"><div class="nw-sheet-field"><div class="nw-sheet-label">Metal Type</div><select class="nw-sheet-select" id="nws-metaltype">${mOpts}</select></div><div class="nw-sheet-field"><div class="nw-sheet-label">Purity</div><select class="nw-sheet-select" id="nws-purity">${purityOpts}</select></div></div>`;
    extraFields += `<div class="nw-sheet-row"><div class="nw-sheet-field" style="flex:2;"><div class="nw-sheet-label">Weight</div><input class="nw-sheet-input" id="nws-grams" type="number" placeholder="10" step="0.001" value="${m.grams||''}"></div><div class="nw-sheet-field"><div class="nw-sheet-label">Unit</div><select class="nw-sheet-select" id="nws-weightunit">${unitOpts}</select></div></div>`;
    extraFields += `<div class="nw-sheet-field"><div class="nw-sheet-label">Price per gram (${currentCurrency.code})</div><input class="nw-sheet-input" id="nws-pricepergram" type="number" placeholder="auto" step="0.01" value="${m.pricePerGram||''}"><div style="font-size:0.7em;color:var(--text-light);margin-top:4px;">Leave blank to auto-use live price from Metals module</div></div>`;
    extraFields += `<div class="nw-sheet-meta">💡 If oz selected, weight is converted to grams automatically on save</div>`;
  }

  const currencies = ['USD','INR','EUR','GBP','AED','CAD','AUD','SGD'];
  const currOpts = currencies.map(c => `<option value="${c}" ${(existing ? existing.currency : currentCurrency.code)===c?'selected':''}>${c}</option>`).join('');

  const isLiab = NW_TYPES[type].isLiab;
  const balLabel = isLiab ? 'Outstanding Balance' : 'Current Balance';
  const showBalance = type !== 'metals';

  document.getElementById('nw-sheet-body').innerHTML = `
    <div class="nw-sheet-field">
      <div class="nws-section-label">Last Updated</div>
      <input class="nw-sheet-input" id="nws-date" type="date" value="${existing ? existing.lastUpdated : localDateStr()}">
    </div>
    <div class="nw-sheet-field">
      <div class="nws-section-label">Name</div>
      <input class="nw-sheet-input" id="nws-name" type="text" placeholder="e.g. Chase Checking" value="${existing ? existing.name : ''}">
    </div>
    ${type !== 'metals' && type !== 'realestate' ? `<div class="nw-sheet-field"><div class="nws-section-label">Bank / Institution</div><input class="nw-sheet-input" id="nws-bank" type="text" placeholder="e.g. Chase, BofA, SBI" value="${m.bank||''}"></div>` : ''}
    ${type === 'realestate' ? `
    <div class="nw-sheet-row">
      <div class="nw-sheet-field"><div class="nws-section-label">Country</div><input class="nw-sheet-input" id="nws-re-country" type="text" placeholder="e.g. US, IN, AE" value="${m.country||''}"></div>
      <div class="nw-sheet-field"><div class="nws-section-label">Currency</div><select class="nw-sheet-select" id="nws-currency">${currOpts}</select></div>
    </div>
    <div class="nw-sheet-row">
      <div class="nw-sheet-field"><div class="nws-section-label">Purchase Value</div><input class="nw-sheet-input" id="nws-re-pv" type="number" placeholder="0" step="0.01" value="${m.purchaseValue||''}"></div>
      <div class="nw-sheet-field"><div class="nws-section-label">Current Value</div><input class="nw-sheet-input" id="nws-balance" type="number" placeholder="0" step="0.01" value="${existing ? existing.balance : (m.currentValue||'')}"></div>
    </div>
    <div class="nw-sheet-row">
      <div class="nw-sheet-field"><div class="nws-section-label">Area (sq ft / sq m)</div><input class="nw-sheet-input" id="nws-re-area" type="text" placeholder="e.g. 1200 sqft" value="${m.area||''}"></div>
      <div class="nw-sheet-field"><div class="nws-section-label">Purchase Date</div><input class="nw-sheet-input" id="nws-date" type="date" value="${existing ? existing.lastUpdated : localDateStr()}"></div>
    </div>
    <div class="nw-sheet-field"><div class="nws-section-label">Description / Address</div><input class="nw-sheet-input" id="nws-re-desc" type="text" placeholder="e.g. 3BR Apartment, Main St" value="${m.description||''}"></div>
    ` : `${showBalance ? `
    <div class="nw-sheet-field">
      <div class="nws-section-label">Current Balance</div>
      <input class="nw-sheet-input" id="nws-balance" type="number" placeholder="0.00" step="0.01" value="${existing ? existing.balance : ''}">
    </div>
    <div class="nw-sheet-row">
      <div class="nw-sheet-field"><div class="nws-section-label">Currency</div><select class="nw-sheet-select" id="nws-currency">${currOpts}</select></div>
      ${(type === 'checking' || type === 'savings_acc' || type === 'credit_card') ? `<div class="nw-sheet-field"><div class="nws-section-label">Account # (Last 4)</div><input class="nw-sheet-input" id="nws-acct4" type="text" maxlength="4" placeholder="1234" value="${m.last4||''}"></div>` : ''}
    </div>` : ''}`}
    ${extraFields}
    <div class="nw-sheet-field">
      <div class="nws-section-label">Notes</div>
      <input class="nw-sheet-input" id="nws-notes" type="text" placeholder="Optional" value="${m.notes||''}">
    </div>
  `;
}


function deleteNWAccount(id) {
  if (!confirm('Delete this account?')) return;
  if (!data._nwAccounts) return;
  data._nwAccounts = data._nwAccounts.filter(a => a.id !== id);
  save();
  renderNetWorth();
  showToast('Account deleted');
}

function closeNWSheet() {
  document.getElementById('nw-sheet-overlay').classList.remove('open');
  document.getElementById('nw-sheet').classList.remove('open');
  // Reset for next open
  setTimeout(() => {
    const pick = document.getElementById('nws-phase-pick');
    const form = document.getElementById('nws-phase-form');
    if (pick) pick.style.display = '';
    if (form) form.style.display = 'none';
    nwSheetType = null;
    nwSheetEditId = null;
  }, 320); // after slide-down animation
}

function saveNWAccount() {
  const name = document.getElementById('nws-name')?.value?.trim();
  if (!name) { showToast('⚠️ Account name required'); return; }

  const type = nwSheetType;
  const meta = {};
  let balance = 0;
  let currency = currentCurrency.code;

  const balEl = document.getElementById('nws-balance');
  if (balEl) balance = Number(balEl.value || 0);
  const currEl = document.getElementById('nws-currency');
  if (currEl) currency = currEl.value;

  // Extra meta — always try reading all possible fields
  const subtypeEl = document.getElementById('nws-subtype');
  if (subtypeEl) meta.subtype = subtypeEl.value;
  const ytdEl = document.getElementById('nws-ytd');
  if (ytdEl && ytdEl.value) meta.ytdContribution = Number(ytdEl.value);
  const limitEl = document.getElementById('nws-limit');
  if (limitEl && limitEl.value) meta.limit = Number(limitEl.value);
  const aprEl = document.getElementById('nws-apr');
  if (aprEl && aprEl.value) meta.apr = Number(aprEl.value);
  const rateEl = document.getElementById('nws-rate');
  if (rateEl && rateEl.value) meta.interestRate = Number(rateEl.value);
  const mpayEl = document.getElementById('nws-mpay');
  if (mpayEl && mpayEl.value) meta.monthlyPayment = Number(mpayEl.value);
  const matEl = document.getElementById('nws-maturity');
  if (matEl && matEl.value) meta.maturityDate = matEl.value;
  const mtEl = document.getElementById('nws-metaltype');
  if (mtEl) meta.metalType = mtEl.value;
  const gramsEl = document.getElementById('nws-grams');
  const unitEl  = document.getElementById('nws-weightunit');
  if (gramsEl && gramsEl.value) {
    const rawWeight = Number(gramsEl.value);
    const isOz = unitEl && unitEl.value === 'oz';
    meta.grams = isOz ? rawWeight * 31.1035 : rawWeight;
    meta.weightUnit = isOz ? 'oz' : 'g';
    meta.weightDisplay = rawWeight; // original input value
  }
  const ppgEl = document.getElementById('nws-pricepergram');
  if (ppgEl && ppgEl.value) meta.pricePerGram = Number(ppgEl.value);
  const purityEl = document.getElementById('nws-purity');
  if (purityEl && purityEl.value) meta.purity = purityEl.value;
  // Real estate specific fields
  const rePvEl   = document.getElementById('nws-re-pv');
  const reDescEl = document.getElementById('nws-re-desc');
  const reAreaEl = document.getElementById('nws-re-area');
  const reCountryEl = document.getElementById('nws-re-country');
  if (rePvEl && rePvEl.value)     meta.purchaseValue = Number(rePvEl.value);
  if (reDescEl && reDescEl.value) meta.description   = reDescEl.value.trim();
  if (reAreaEl && reAreaEl.value) meta.area          = reAreaEl.value.trim();
  if (reCountryEl && reCountryEl.value) meta.country = reCountryEl.value.trim();
  // New fields
  const bankEl  = document.getElementById('nws-bank');
  if (bankEl && bankEl.value) meta.bank = bankEl.value.trim();
  const acct4El = document.getElementById('nws-acct4');
  if (acct4El && acct4El.value) meta.last4 = acct4El.value.trim();
  const notesEl = document.getElementById('nws-notes');
  if (notesEl && notesEl.value) meta.notes = notesEl.value.trim();
  const dateEl = document.getElementById('nws-date');
  const lastUpdated = dateEl ? dateEl.value : localDateStr();

  if (!data._nwAccounts) data._nwAccounts = [];
  if (nwSheetEditId) {
    const idx = data._nwAccounts.findIndex(a => a.id === nwSheetEditId);
    if (idx >= 0) data._nwAccounts[idx] = { ...data._nwAccounts[idx], name, type, balance, currency, lastUpdated, meta };
  } else {
    const id = 'nwa_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
    data._nwAccounts.push({ id, name, type, balance, currency, lastUpdated, meta });
  }

  save();
  closeNWSheet();
  renderNetWorth();
  showToast('✅ Account saved');
}

// ══════════════════════════════════════════════════════
// IMPORT HUB
// ══════════════════════════════════════════════════════
let importState = {
  transactions: { rows: [], headers: [], type: 'expense', colMap: {}, catMerges: {} },
  given: { rows: [], headers: [] },
  metals: { rows: [], headers: [] },
  realestate: { rows: [], headers: [] },
};

function setImportTab(tab, el) {
  document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.import-section').forEach(s => s.classList.remove('active'));
  if (el) el.classList.add('active');
  const sec = document.getElementById('isec-' + tab);
  if (sec) sec.classList.add('active');
  if (tab === 'given') renderGivenLedger();
  if (tab === 'reset') { renderResetSummary(); renderMonthsList(); }
}

function handleImportDrop(event, type) {
  event.preventDefault();
  document.querySelectorAll('.import-drop-zone').forEach(z => z.classList.remove('dragover'));
  const file = event.dataTransfer.files[0];
  if (file) processImportFile(file, type);
}

function handleImportFile(input, type) {
  const file = input.files[0];
  if (file) processImportFile(file, type);
  input.value = '';
}

function processImportFile(file, type) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });
      if (rawRows.length < 2) { showToast('File appears empty ❌'); return; }
      const headers = (rawRows[0] || []).map(h => String(h || '').trim());
      const rows = rawRows.slice(1).filter(r => r.some(c => c !== null && c !== undefined && String(c).trim() !== ''));
      importState[type] = { ...importState[type], rows, headers };
      showToast(`✅ Loaded ${rows.length} rows`);
      if (type === 'transactions') buildTxColMap(headers, rows);
      else if (type === 'given')      showGivenPreview(rows, headers);
      else if (type === 'metals')     showMetalsPreview(rows, headers);
      else if (type === 'realestate') showREPreview(rows, headers);
    } catch(err) { showToast('Error reading file ❌ ' + err.message); }
  };
  reader.readAsArrayBuffer(file);
}

// ── TRANSACTIONS IMPORTER ──
function buildTxColMap(headers, rows) {
  // Smart auto-detect
  const find = (keywords) => headers.findIndex(h => keywords.some(k => h.toLowerCase().includes(k)));
  const colMap = {
    date:     find(['date']),
    category: find(['category','cat','type']),
    amount:   find(['amount','amt','sum','value']),
    description: find(['description','desc','store','note','merchant']),
    month:    find(['month']),
  };
  importState.transactions.colMap = colMap;

  // Build col map UI
  const fields = [
    { key: 'date', label: '📅 Date', required: true },
    { key: 'category', label: '🏷️ Category', required: true },
    { key: 'amount', label: '💲 Amount', required: true },
    { key: 'description', label: '📝 Description', required: false },
  ];
  const txType = document.querySelector('input[name="itx-type"]:checked')?.value || 'expense';
  document.getElementById('itx-map-sub').textContent = `Mapping ${rows.length} rows from your ${txType} file.`;

  document.getElementById('itx-col-map').innerHTML = fields.map(f => `
    <div class="import-col-row">
      <div class="import-col-field">${f.label}${f.required?' *':''}</div>
      <select class="import-col-select" id="imap-${f.key}" onchange="updateTxPreview()">
        <option value="-1">— skip —</option>
        ${headers.map((h,i) => `<option value="${i}" ${colMap[f.key]===i?'selected':''}>${h}</option>`).join('')}
      </select>
    </div>
  `).join('');

  updateTxPreview();
  goToImportStep('transactions', 'step2');
}

function updateTxPreview() {
  const { rows, headers } = importState.transactions;
  const getCol = key => parseInt(document.getElementById(`imap-${key}`)?.value ?? '-1');
  const preview = rows.slice(0, 5).map(row => ({
    Date: row[getCol('date')] || '',
    Category: row[getCol('category')] || '',
    Amount: row[getCol('amount')] || '',
    Description: row[getCol('description')] || '',
  }));
  const tbl = document.getElementById('itx-preview-table');
  if (!tbl) return;
  const cols = ['Date','Category','Amount','Description'];
  tbl.innerHTML = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${
    preview.map(r => `<tr>${cols.map(c=>`<td>${r[c]}</td>`).join('')}</tr>`).join('')
  }</tbody>`;
}

function goToImportStep(type, step) {
  if (type === 'transactions') {
    document.querySelectorAll('#isec-transactions .import-step').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(`itx-${step}`);
    if (el) el.classList.add('active');
    if (step === 'step3') buildCatReview();
    if (step === 'step4') buildFinalPreview();
  }
}

function buildCatReview() {
  const { rows, headers, catMerges } = importState.transactions;
  const getCol = key => parseInt(document.getElementById(`imap-${key}`)?.value ?? '-1');
  const catCol = getCol('category');
  if (catCol < 0) { document.getElementById('itx-cat-review').innerHTML = '<div style="color:var(--text-light);font-size:0.85em;">No category column selected.</div>'; return; }

  const rawCats = [...new Set(rows.map(r => String(r[catCol] || '').trim()).filter(Boolean))].sort();

  // Detect near-duplicates: trim, lowercase, remove trailing spaces
  const groups = {};
  rawCats.forEach(cat => {
    const norm = cat.toLowerCase().replace(/\s+/g, ' ').trim();
    if (!groups[norm]) groups[norm] = [];
    groups[norm].push(cat);
  });

  // Flag groups with multiple raw values as duplicates
  const dups = Object.entries(groups).filter(([,cats]) => cats.length > 1);
  const singles = Object.entries(groups).filter(([,cats]) => cats.length === 1);

  let html = '';
  if (dups.length === 0) {
    html = `<div style="background:#F0FBF3;border-radius:var(--radius-sm);padding:12px;color:#10B981;font-weight:700;font-size:0.85em;margin-bottom:12px;">✅ No duplicate categories detected — ${rawCats.length} unique categories found</div>`;
  } else {
    html = `<div style="font-size:0.78em;color:var(--text-light);font-weight:700;margin-bottom:10px;">${dups.length} possible duplicate(s) found — review and choose action:</div>`;
    dups.forEach(([norm, cats]) => {
      const isMerged = catMerges[norm] !== undefined;
      html += `<div class="cat-review-item">
        <span class="cat-review-flag dup">⚠️ Duplicate</span>
        <div class="cat-review-names">${cats.map(c=>`"${c}"`).join(' + ')}</div>
        <div class="cat-review-action">
          <button class="cat-merge-btn ${isMerged&&catMerges[norm]===cats[0]?'active':''}" onclick="setCatMerge('${norm}','${cats[0].replace(/'/g,"\\'")}')">Merge → "${cats[0]}"</button>
          <button class="cat-keep-btn" onclick="setCatKeep('${norm}')">Keep separate</button>
        </div>
      </div>`;
    });
  }

  document.getElementById('itx-cat-review').innerHTML = html;
}

function setCatMerge(norm, canonical) {
  importState.transactions.catMerges[norm] = canonical;
  buildCatReview();
  showToast(`Merged → "${canonical}"`);
}

function setCatKeep(norm) {
  delete importState.transactions.catMerges[norm];
  buildCatReview();
}

function buildFinalPreview() {
  const records = buildTxRecords();
  const monthCounts = {};
  records.forEach(r => { monthCounts[r._month] = (monthCounts[r._month]||0)+1; });
  const totalAmt = records.reduce((s,r)=>s+r.amount,0);

  document.getElementById('itx-summary-grid').innerHTML = `
    <div class="import-summary-box"><div class="isb-num">${records.length}</div><div class="isb-label">Transactions</div></div>
    <div class="import-summary-box"><div class="isb-num">${Object.keys(monthCounts).length}</div><div class="isb-label">Months</div></div>
    <div class="import-summary-box"><div class="isb-num">${fmt(totalAmt)}</div><div class="isb-label">Total</div></div>
  `;

  const preview = records.slice(0, 20);
  const tbl = document.getElementById('itx-final-table');
  tbl.innerHTML = `<thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Description</th></tr></thead><tbody>${
    preview.map(r=>`<tr><td>${r.date}</td><td>${r.category}</td><td>${fmtConverted(r.amount, r.currency||currentCurrency.code)}</td><td>${r.description||''}</td></tr>`).join('')
  }${records.length>20?`<tr><td colspan="4" style="text-align:center;color:var(--text-light);font-style:italic;">... and ${records.length-20} more</td></tr>`:''}</tbody>`;
}

function buildTxRecords() {
  const { rows, catMerges } = importState.transactions;
  const getCol = key => parseInt(document.getElementById(`imap-${key}`)?.value ?? '-1');
  const dateCol = getCol('date'), catCol = getCol('category'), amtCol = getCol('amount'), descCol = getCol('description');
  const txType = document.querySelector('input[name="itx-type"]:checked')?.value || 'expense';
  const records = [];

  rows.forEach(row => {
    const rawDate = String(row[dateCol] || '').trim();
    let dateStr = '';
    if (rawDate) {
      // Handle Excel date formats
      const d = new Date(rawDate);
      if (!isNaN(d)) dateStr = localDateStr(d);
      else dateStr = rawDate.substring(0,10);
    }
    if (!dateStr || dateStr === 'NaN-aN-aN') return;

    const monthKey = dateStr.substring(0,7);
    let rawCat = String(row[catCol] || '').trim();
    const norm = rawCat.toLowerCase().replace(/\s+/g,' ').trim();
    if (catMerges[norm]) rawCat = catMerges[norm];

    const rawAmt = String(row[amtCol] || '0').replace(/[$,]/g,'');
    const amount = Math.abs(parseFloat(rawAmt) || 0);
    if (!amount && !rawCat) return;

    const description = descCol >= 0 ? String(row[descCol] || '').trim() : '';
    records.push({ date: dateStr, category: rawCat, amount, description, _month: monthKey, _type: txType });
  });
  return records;
}

function confirmImport(type) {
  if (type !== 'transactions') return;
  const records = buildTxRecords();
  if (records.length === 0) { showToast('No valid records to import ❌'); return; }

  const typeMap = { expense: 'expenses', income: 'income', investment: 'investments' };
  let imported = 0;

  records.forEach(r => {
    ensureMonth(r._month);
    const listKey = typeMap[r._type] || 'expenses';
    const entry = { date: r.date, category: r.category, amount: r.amount, description: r.description, currency: currentCurrency.code };
    data[r._month][listKey].push(entry);
    imported++;
  });

  save();
  document.getElementById('itx-done-title').textContent = `Import Complete! 🎉`;
  document.getElementById('itx-done-sub').textContent = `${imported} transactions loaded across ${new Set(records.map(r=>r._month)).size} months`;
  goToImportStep('transactions', 'step5');
  renderHome();
  showToast(`✅ ${imported} transactions imported!`);
}

function resetImportStep(type) {
  if (type === 'transactions') {
    importState.transactions = { rows: [], headers: [], type: 'expense', colMap: {}, catMerges: {} };
    document.querySelectorAll('#isec-transactions .import-step').forEach(s => s.classList.remove('active'));
    document.getElementById('itx-step1').classList.add('active');
  }
}

// ── GIVEN TO OTHERS ──
function processGivenImport(rows, headers) {
  const find = kws => headers.findIndex(h => kws.some(k => h.toLowerCase().includes(k)));
  const dateCol = find(['date']), catCol = find(['category','person','name']), amtCol = find(['amount','amt']), descCol = find(['desc','note']);

  if (dateCol < 0 || catCol < 0 || amtCol < 0) { showToast('Could not detect required columns ❌'); return; }

  let imported = 0;
  rows.forEach(row => {
    const rawDate = String(row[dateCol]||'').trim();
    const d = new Date(rawDate);
    if (isNaN(d)) return;
    const dateStr = localDateStr(d);
    const monthKey = dateStr.substring(0,7);
    ensureMonth(monthKey);
    const amount = Math.abs(parseFloat(String(row[amtCol]||'0').replace(/[$,]/g,''))||0);
    if (!amount) return;
    const entry = { date: dateStr, category: String(row[catCol]||'').trim(), amount, description: descCol>=0?String(row[descCol]||'').trim():'', currency: currentCurrency.code };
    if (!data[monthKey].givenToOthers) data[monthKey].givenToOthers = [];
    data[monthKey].givenToOthers.push(entry);
    imported++;
  });

  save();
}

function renderGivenLedger() {
  const el = document.getElementById('given-ledger-list');
  if (!el) return;
  const balances = {};
  Object.keys(data).filter(k=>!k.startsWith('_')).forEach(mk=>{
    (data[mk].givenToOthers||[]).forEach(e=>{
      balances[e.category] = (balances[e.category]||0) + convertAmt(e.amount, e.currency);
    });
  });
  const entries = Object.entries(balances);
  if (!entries.length) { el.innerHTML = '<div style="color:var(--text-light);font-size:0.82em;padding:8px 0;">No given-to-others data yet</div>'; return; }
  const total = entries.reduce((s,[,v])=>s+v,0);
  el.innerHTML = entries.sort((a,b)=>b[1]-a[1]).map(([name, val]) =>
    `<div class="given-ledger-row"><div><div class="given-person">${name}</div><div style="font-size:0.7em;color:var(--text-light);font-weight:600;">Outstanding</div></div><div class="given-total">${fmt(val)}</div></div>`
  ).join('') + `<div style="border-top:2px solid var(--yellow);margin-top:8px;padding-top:8px;display:flex;justify-content:space-between;font-weight:900;font-size:0.92em;"><span>Total</span><span style="color:var(--expenses);">${fmt(total)}</span></div>`;
}

// ── METALS IMPORTER ──

// ── Preview helpers for Metals / Given / RE imports ──

let _metalsPreviewRows = [], _metalsPreviewHeaders = [];
let _givenPreviewRows  = [], _givenPreviewHeaders  = [];
let _rePreviewRows     = [], _rePreviewHeaders     = [];

function _buildPreviewTable(headers, rows, maxRows=5) {
  const display = rows.slice(0, maxRows);
  const th = headers.map(h=>`<th style="padding:6px 10px;background:#F0F0F0;font-size:0.75em;font-weight:800;white-space:nowrap;">${h}</th>`).join('');
  const trs = display.map(r=>'<tr>'+headers.map((_,i)=>`<td style="padding:5px 10px;font-size:0.78em;border-bottom:1px solid #F0F0F0;">${r[i]||''}</td>`).join('')+'</tr>').join('');
  return `<table style="border-collapse:collapse;width:100%;"><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
}

function showMetalsPreview(rows, headers) {
  _metalsPreviewRows = rows; _metalsPreviewHeaders = headers;
  document.getElementById('imet-step1').classList.remove('active');
  document.getElementById('imet-step2').classList.add('active');
  document.getElementById('imetals-preview-table-wrap').innerHTML = _buildPreviewTable(headers, rows);
  document.getElementById('imetals-summary').innerHTML = `<div style="background:#F0FBF3;border-radius:10px;padding:10px 14px;color:#10B981;font-weight:700;font-size:0.85em;">${rows.length} rows detected · Review above then confirm</div>`;
}
function resetMetalsImport() {
  _metalsPreviewRows=[]; _metalsPreviewHeaders=[];
  document.getElementById('imet-step1').classList.add('active');
  document.getElementById('imet-step2').classList.remove('active');
  document.getElementById('imet-step3').classList.remove('active');
}
function confirmMetalsImport() {
  const before = (data._metals||[]).length;
  processMetalsImport(_metalsPreviewRows, _metalsPreviewHeaders);
  const after = (data._metals||[]).length;
  document.getElementById('imet-step2').classList.remove('active');
  document.getElementById('imet-step3').classList.add('active');
  document.getElementById('imet-done-title').textContent = (after-before) + ' Metals Imported!';
  document.getElementById('imet-done-sub').textContent = 'Total: ' + (data._metals||[]).length + ' entries in portfolio';
  _metalsPreviewRows=[]; _metalsPreviewHeaders=[];
}

function showGivenPreview(rows, headers) {
  _givenPreviewRows = rows; _givenPreviewHeaders = headers;
  document.getElementById('igiv-step1').classList.remove('active');
  document.getElementById('igiv-step2').classList.add('active');
  document.getElementById('igiven-preview-table-wrap').innerHTML = _buildPreviewTable(headers, rows);
  document.getElementById('igiven-summary').innerHTML = `<div style="background:#F0FBF3;border-radius:10px;padding:10px 14px;color:#10B981;font-weight:700;font-size:0.85em;">${rows.length} rows detected · Review above then confirm</div>`;
}
function resetGivenImport() {
  _givenPreviewRows=[]; _givenPreviewHeaders=[];
  document.getElementById('igiv-step1').classList.add('active');
  document.getElementById('igiv-step2').classList.remove('active');
  document.getElementById('igiv-step3').classList.remove('active');
}
function confirmGivenImport() {
  // Count rows that will be imported (non-empty valid rows)
  const added = _givenPreviewRows.filter(r => r && r.length > 0).length;
  processGivenImport(_givenPreviewRows, _givenPreviewHeaders);
  document.getElementById('igiv-step2').classList.remove('active');
  document.getElementById('igiv-step3').classList.add('active');
  document.getElementById('igiv-done-title').textContent = added + ' Records Imported! 🎉';
  document.getElementById('igiv-done-sub').textContent = 'Your Given to Others ledger has been updated';
  _givenPreviewRows=[]; _givenPreviewHeaders=[];
  renderGivenLedger();
  showToast('✅ ' + added + ' Given to Others imported!');
}

function showREPreview(rows, headers) {
  _rePreviewRows = rows; _rePreviewHeaders = headers;
  document.getElementById('ire-step1').classList.remove('active');
  document.getElementById('ire-step2').classList.add('active');
  document.getElementById('ire-preview-table-wrap').innerHTML = _buildPreviewTable(headers, rows);
  document.getElementById('ire-summary').innerHTML = `<div style="background:#F0FBF3;border-radius:10px;padding:10px 14px;color:#10B981;font-weight:700;font-size:0.85em;">${rows.length} properties detected · Review above then confirm</div>`;
}
function resetREImport() {
  _rePreviewRows=[]; _rePreviewHeaders=[];
  document.getElementById('ire-step1').classList.add('active');
  document.getElementById('ire-step2').classList.remove('active');
  document.getElementById('ire-step3').classList.remove('active');
}
function confirmREImport() {
  const reBefore = ((data._realEstate)||[]).length;
  processREImport(_rePreviewRows, _rePreviewHeaders);
  const reAfter = ((data._realEstate)||[]).length;
  const added = reAfter - reBefore;
  document.getElementById('ire-step2').classList.remove('active');
  document.getElementById('ire-step3').classList.add('active');
  document.getElementById('ire-done-title').textContent = added + ' Properties Imported! 🎉';
  document.getElementById('ire-done-sub').textContent = 'Total: ' + reAfter + ' real estate entries';
  _rePreviewRows=[]; _rePreviewHeaders=[];
  showToast('✅ ' + added + ' properties imported!');
}

function processMetalsImport(rows, headers) {
  const find = kws => headers.findIndex(h => kws.some(k => h.toLowerCase().includes(k)));
  const metalCol = find(['metal']), purityCol = find(['purity']), occasionCol = find(['occasion']), itemCol = find(['item','name']), weightCol = find(['weight','grams','gram','wt']);

  if (metalCol < 0 || weightCol < 0) { showToast('Could not detect Metal and Weight columns ❌'); return; }

  let imported = 0;
  if (!data._metals) data._metals = [];
  rows.forEach(row => {
    const metalRaw = String(row[metalCol]||'').trim().toLowerCase();
    const metalType = metalRaw.includes('gold') ? 'gold' : metalRaw.includes('silver') ? 'silver' : metalRaw.includes('platinum') ? 'platinum' : 'gold';
    const grams = parseFloat(String(row[weightCol]||'0').replace(/[^\d.]/g,''))||0;
    if (!grams) return;
    data._metals.push({
      metalType,
      name: itemCol >= 0 ? String(row[itemCol]||'').trim() : metalType,
      grams,
      price: METAL_CONFIG[metalType]?.pricePerGram || 0,
      date: localDateStr(),
      form: 'Jewelry',
      purity: purityCol >= 0 ? String(row[purityCol]||'').trim() : '',
      occasion: occasionCol >= 0 ? String(row[occasionCol]||'').trim() : '',
    });
    imported++;
  });

  save();
}

// ── REAL ESTATE IMPORTER ──
function processREImport(rows, headers) {
  const find = kws => headers.findIndex(h => kws.some(k => h.toLowerCase().includes(k)));
  const dateCol = find(['date']), countryCol = find(['country']), currencyCol = find(['currency','curr']),
        pvCol = find(['purchase']), descCol = find(['desc','description']), areaCol = find(['area']),
        cvCol = find(['current']);

  let imported = 0;
  const reAssets = getRealEstateAssets();
  rows.forEach(row => {
    const desc = descCol >= 0 ? String(row[descCol]||'').trim() : '';
    const pv = parseFloat(String(row[pvCol>=0?pvCol:0]||'0').replace(/[^\d.]/g,''))||0;
    if (!pv && !desc) return;
    const rawDate = dateCol >= 0 ? String(row[dateCol]||'').trim() : '';
    const dateStr = parseDateSafe(rawDate);
    reAssets.push({
      date: dateStr,
      country: countryCol >= 0 ? String(row[countryCol]||'').trim() : 'US',
      currency: currencyCol >= 0 ? String(row[currencyCol]||'USD').trim().toUpperCase() : 'USD',
      purchaseValue: pv,
      currentValue: cvCol >= 0 ? parseFloat(String(row[cvCol]||'0').replace(/[^\d.]/g,''))||pv : pv,
      description: desc,
      area: areaCol >= 0 ? String(row[areaCol]||'').trim() : '',
      areaCents: areaCol >= 0 ? parseFloat(String(row[areaCol]||'0').replace(/[^\d.]/g,''))||0 : 0,
    });
    imported++;
  });

  data._realEstate = reAssets;
  save();
  save();
}

// ── RESET ──
function renderResetSummary() {
  const el = document.getElementById('reset-data-summary');
  if (!el) return;
  const monthKeys = Object.keys(data).filter(k => !k.startsWith('_'));
  let totalTx = 0;
  monthKeys.forEach(mk => {
    ['expenses','income','investments','debts','givenToOthers','additional'].forEach(t => {
      totalTx += (data[mk][t]||[]).length;
    });
  });
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div class="import-summary-box"><div class="isb-num">${totalTx}</div><div class="isb-label">Transactions</div></div>
      <div class="import-summary-box"><div class="isb-num">${monthKeys.length}</div><div class="isb-label">Months</div></div>
      <div class="import-summary-box"><div class="isb-num">${(data._metals||[]).length}</div><div class="isb-label">Metal Items</div></div>
      <div class="import-summary-box"><div class="isb-num">${(data._realEstate||[]).length}</div><div class="isb-label">Properties</div></div>
    </div>
  `;
  // Update specific dataset counts
  const metalsEl = document.getElementById('reset-metals-count');
  if (metalsEl) metalsEl.textContent = (data._metals||[]).length + ' entries';
  const givenEl = document.getElementById('reset-given-count');
  if (givenEl) givenEl.textContent = (data._given||[]).length + ' records';
  const reEl = document.getElementById('reset-re-count');
  if (reEl) reEl.textContent = (data._realEstate||[]).length + ' properties';
  const nwEl = document.getElementById('reset-nw-count');
  if (nwEl) nwEl.textContent = (data._nwAccounts||[]).length + ' accounts';
}

function renderMonthsList() {
  const el = document.getElementById('months-list');
  if (!el) return;
  const ALL_TX_TYPES = ['expenses','income','investments','debts','givenToOthers','additional'];
  const hasTransactions = mk => ALL_TX_TYPES.some(t => (data[mk]?.[t]||[]).length > 0);
  const monthKeys = Object.keys(data)
    .filter(k => !k.startsWith('_') && /^\d{4}-\d{2}$/.test(k) && hasTransactions(k))
    .sort().reverse();
  if (!monthKeys.length) { el.innerHTML = '<p style="color:var(--text-light);font-size:0.85em;padding:4px 0;">No month data yet.</p>'; return; }

  // Group by year
  const byYear = {};
  monthKeys.forEach(mk => { const yr = mk.split('-')[0]; if (!byYear[yr]) byYear[yr]=[]; byYear[yr].push(mk); });
  const years = Object.keys(byYear).sort().reverse();

  el.innerHTML = years.map(yr => {
    const mks = byYear[yr];
    const yrInc = mks.reduce((s,mk)=>s+(data[mk]?.income||[]).reduce((si,e)=>si+Number(e.amount||0),0),0);
    const yrExp = mks.reduce((s,mk)=>s+(data[mk]?.expenses||[]).reduce((si,e)=>si+Number(e.amount||0),0),0);
    const yrTx  = mks.reduce((s,mk)=>{const m=data[mk]||{};return s+(m.expenses||[]).length+(m.income||[]).length+(m.investments||[]).length;},0);
    const colId = 'reset-yr-' + yr;

    const monthRows = mks.map(mk => {
      const m = data[mk] || {};
      const txCount = (m.expenses||[]).length + (m.income||[]).length + (m.investments||[]).length;
      const inc = (m.income||[]).reduce((s,e)=>s+Number(e.amount||0),0);
      const exp = (m.expenses||[]).reduce((s,e)=>s+Number(e.amount||0),0);
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px 9px 20px;border-bottom:1px solid #F5F5F5;">
        <div><div style="font-weight:800;font-size:0.85em;color:var(--text-dark);">${getDisplayMonth(mk)}</div>
        <div style="font-size:0.7em;color:var(--text-light);font-weight:600;">${txCount} txns · <span style="color:var(--income);">+${fmt(inc)}</span> · <span style="color:var(--expenses);">-${fmt(exp)}</span></div></div>
        <button onclick="deleteMonth('${mk}')" style="background:#FFF0F0;border:none;border-radius:9px;padding:5px 10px;font-weight:800;font-size:0.75em;color:var(--expenses);cursor:pointer;flex-shrink:0;">🗑️</button>
      </div>`;
    }).join('');

    return `<div style="margin-bottom:6px;border:1px solid #EEE;border-radius:12px;overflow:hidden;">
      <div onclick="toggleResetYear('${colId}')" style="display:flex;justify-content:space-between;align-items:center;padding:11px 14px;background:#F8F8F8;cursor:pointer;">
        <div><span style="font-weight:900;font-size:0.92em;color:var(--text-dark);">${yr}</span>
          <span style="font-size:0.72em;font-weight:700;color:var(--text-light);margin-left:8px;">${mks.length} months · ${yrTx} txns</span></div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="text-align:right;font-size:0.72em;font-weight:700;">
            <span style="color:var(--income);">+${fmt(yrInc)}</span> <span style="color:var(--expenses);">-${fmt(yrExp)}</span></div>
          <span id="${colId}-chev" style="font-size:0.8em;transition:transform 0.2s;">▾</span></div>
      </div>
      <div id="${colId}" style="max-height:1200px;overflow:hidden;transition:max-height 0.3s ease;">${monthRows}</div>
    </div>`;
  }).join('');
}

function toggleResetYear(id) {
  const el = document.getElementById(id);
  const chev = document.getElementById(id + '-chev');
  if (!el) return;
  const isOpen = el.style.maxHeight !== '0px';
  el.style.maxHeight = isOpen ? '0px' : '1200px';
  if (chev) chev.style.transform = isOpen ? 'rotate(-90deg)' : '';
}

function clearDataset(type) {
  const labels = { metals:'Metals Holdings', given:'Given to Others', realestate:'Real Estate Assets', networth:'Net Worth Accounts' };
  if (!confirm(`Clear all ${labels[type]||type} data? Your transactions will NOT be affected.`)) return;
  if (type === 'metals')     { data._metals = []; }
  if (type === 'given')      { data._given = []; }
  if (type === 'realestate') { data._realEstate = []; }
  if (type === 'networth')   { data._nwAccounts = []; }
  save();
  renderResetSummary();
  renderMonthsList();
  if (type === 'metals')     { try { renderMetals(); } catch(e){} }
  if (type === 'networth')   { try { renderNetWorth(); } catch(e){} }
  showToast('🧹 ' + (labels[type]||type) + ' cleared');
}

function confirmResetAll() {
  if (!confirm('⚠️ CLEAN RESTART\n\nThis deletes ALL your data and resets cards + categories to defaults.\n\nYour currency, theme and family members will be kept.\n\nAre you sure?')) return;
  if (!confirm('🚨 Final confirmation — this cannot be undone. Reset everything?')) return;

  // Wipe ALL transaction months (YYYY-MM keys)
  Object.keys(data).filter(k => /^\d{4}-\d{2}$/.test(k)).forEach(k => delete data[k]);

  // Wipe ALL _keys — cards, categories, goals, everything resets to code defaults
  // Only keep: currency preference, family roster (so members don't get kicked), NW type structure
  const KEEP = ['_familyMembers', '_nwCustomTypes', '_nwTypeVisible'];
  Object.keys(data).filter(k => k.startsWith('_')).forEach(k => {
    if (!KEEP.includes(k)) delete data[k];
  });
  // _homeSpendCards + _homeInvCards deliberately NOT in KEEP
  // → getHomeSpendCards() / getHomeInvCards() will auto-return DEFAULT_* on next call
  // _customCats deliberately NOT in KEEP → getCatsForType() returns DEFAULT_CATS
  // _expenseGoals + _savingsGoals deliberately NOT in KEEP → getBudgetGoals() re-seeds defaults

  // Theme + currency stay (they are separate localStorage keys, not in data)
  save();
  try { renderResetSummary(); } catch(e) {}
  try { renderMonthsList(); } catch(e) {}
  renderHome();
  try { renderTransactions(); } catch(e) {}
  try { renderBudget(); } catch(e) {}
  try { renderNetWorth(); } catch(e) {}
  try { renderMetals(); } catch(e) {}
  showToast('🧹 Factory reset complete — fresh start ready', 3000);
}

// ══════════════════════════════════════════════════════
// ONBOARDING — Intro slides + Coach marks
// ══════════════════════════════════════════════════════
const OB_SEEN_KEY = 'mf_onboarding_seen';
let obCurrentSlide = 0;
const OB_TOTAL = 5;

function showOnboarding() {
  obCurrentSlide = 0;
  const overlay = document.getElementById('onboarding-overlay');
  if (!overlay) return;
  overlay.classList.remove('hiding');
  overlay.style.display = 'flex';
  obGoTo(0);
}

function dismissOnboarding() {
  const overlay = document.getElementById('onboarding-overlay');
  if (!overlay) return;
  overlay.classList.add('hiding');
  setTimeout(() => {
    overlay.style.display = 'none';
    overlay.classList.remove('hiding');
    // After intro slides, launch the coach marks tour
    startCoachTour();
  }, 600);
  localStorage.setItem(OB_SEEN_KEY, '1');
}

function obGoTo(idx) {
  obCurrentSlide = Math.max(0, Math.min(idx, OB_TOTAL - 1));
  const track = document.getElementById('ob-track');
  if (track) track.style.transform = `translateX(-${obCurrentSlide * 100}vw)`;
  document.querySelectorAll('.ob-dot').forEach((d, i) => d.classList.toggle('active', i === obCurrentSlide));
  // Re-trigger animations
  const slides = document.querySelectorAll('.ob-slide');
  slides.forEach((s, i) => {
    if (i !== obCurrentSlide) return;
    ['.ob-slide-art','.ob-slide-title','.ob-slide-desc'].forEach(sel => {
      const el = s.querySelector(sel);
      if (!el) return;
      el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    });
  });
  const nextBtn = document.getElementById('ob-next-btn');
  const skipBtn = document.getElementById('ob-skip-btn');
  if (nextBtn) nextBtn.textContent = obCurrentSlide === OB_TOTAL - 1 ? "Start Tour 🎯" : 'Next →';
  if (skipBtn) skipBtn.style.display = obCurrentSlide === OB_TOTAL - 1 ? 'none' : '';
}

function obNext() {
  if (obCurrentSlide < OB_TOTAL - 1) obGoTo(obCurrentSlide + 1);
  else dismissOnboarding();
}

// Swipe support for intro slides
(function() {
  let sx = 0, sy = 0;
  document.addEventListener('touchstart', e => {
    const ov = document.getElementById('onboarding-overlay');
    if (!ov || ov.style.display === 'none') return;
    sx = e.touches[0].clientX; sy = e.touches[0].clientY;
  }, { passive: true });
  document.addEventListener('touchend', e => {
    const ov = document.getElementById('onboarding-overlay');
    if (!ov || ov.style.display === 'none') return;
    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40)
      dx < 0 ? obGoTo(obCurrentSlide + 1) : obGoTo(obCurrentSlide - 1);
  }, { passive: true });
})();

// ── COACH MARKS ──────────────────────────────────────
// Each step: { screen, elementId, title, desc, tag, arrow }
// screen = which screen to switch to before showing
// arrow  = 'up' | 'down' | 'right' (direction of tooltip arrow relative to tooltip)
const COACH_STEPS = [
  {
    screen: 'home',
    elementId: 'fab-add-btn',
    tag: 'Quick Add · Step 1 of 11',
    title: '➕ The Add Button',
    desc: 'This golden ＋ button is your fastest way in. Tap it from any screen to log an expense, income, or investment in seconds.',
    arrow: 'down'
  },
  {
    screen: 'home',
    elementId: 'fmi-expense',
    tag: 'Quick Add · Step 2 of 11',
    title: '💸 Log an Expense',
    desc: 'Tap 💸 Expense to record spending. Pick a category, enter the amount and description — done in under 10 seconds.',
    arrow: 'right',
    preAction: () => {
      const menu = document.getElementById('fab-menu');
      const fab  = document.getElementById('fab-add-btn');
      if (fab && (!menu || !menu.classList.contains('open'))) fab.click();
    }
  },
  {
    screen: 'home',
    elementId: 'tx-search-input',
    tag: 'Recurring · Step 3 of 11',
    title: '🔁 Recurring Transactions',
    desc: 'Long-press any transaction to make it recurring — weekly, biweekly or monthly. MoneyFi auto-posts it every period. Perfect for salary, rent, subscriptions.',
    arrow: 'down',
    preAction: () => {
      const menu = document.getElementById('fab-menu');
      const fab  = document.getElementById('fab-add-btn');
      if (fab && menu && menu.classList.contains('open')) fab.click();
      switchScreen('home', document.querySelector('.nav-item:nth-child(1)'));
    }
  },
  {
    screen: 'home',
    elementId: 'author-toggle-btn',
    tag: 'Family · Step 4 of 11',
    title: '👨‍👩‍👧 Family View',
    desc: 'Tap the people icon to filter transactions by family member. See just your entries, or your partner\'s — everyone adds to the same shared ledger.',
    arrow: 'down',
    preAction: () => {
      switchScreen('home', document.querySelector('.nav-item:nth-child(1)'));
    }
  },
  {
    screen: 'budget',
    elementId: 'btab-goals',
    tag: 'Budget & Goals · Step 5 of 11',
    title: '🎯 Goals Tab',
    desc: 'Switch to Goals here to set financial milestones — save for a house, pay off a loan, build an emergency fund.',
    arrow: 'down',
    preAction: () => {
      const menu = document.getElementById('fab-menu');
      const fab  = document.getElementById('fab-add-btn');
      if (fab && menu && menu.classList.contains('open')) fab.click();
      switchScreen('budget', document.querySelector('.nav-item:nth-child(3)'));
    }
  },
  {
    screen: 'budget',
    elementId: 'goals-fab-btn',
    tag: 'Budget & Goals · Step 6 of 11',
    title: '＋ Add a Goal',
    desc: 'Tap this to create a new goal. Choose Grow (build savings) or Reduce (pay down debt). Map your accounts to track progress automatically.',
    arrow: 'up',
    preAction: () => {
      setBudgetTab('goals', document.getElementById('btab-goals'));
    }
  },
  {
    screen: 'networth',
    elementId: 'nw-total',
    tag: 'Net Worth · Step 7 of 11',
    title: '💎 Your Net Worth',
    desc: 'This is the big number — total assets minus total liabilities. It updates live as you add accounts and transactions.',
    arrow: 'down',
    preAction: () => {
      switchScreen('networth', document.querySelector('.nav-item:nth-child(4)'));
    }
  },
  {
    screen: 'networth',
    // Target the always-visible section header, not the collapsible body
    elementId: 'nw-sec-checking',
    tag: 'Net Worth · Step 8 of 11',
    title: '🏦 Add Accounts',
    desc: 'Tap any row to expand it, then tap "+ Add Account" inside. Add checking, savings, real estate, loans — each category stays organised.',
    arrow: 'up',
    // No preAction needed — already on networth screen
  },
  {
    screen: 'metals',
    elementId: 'mini-gold',
    tag: 'Metals · Step 9 of 11',
    title: '🥇 Gold, Silver & Platinum',
    desc: 'Switch between metals using these cards. Each shows your total weight and current estimated value based on your set prices.',
    arrow: 'down',
    preAction: () => { goToScreen('metals'); }
  },
  {
    screen: 'metals',
    elementId: 'metal-live-price',
    tag: 'Metals · Step 10 of 11',
    title: '✏️ Set Your Own Price',
    desc: 'Tap Edit next to this price to override it. You can set a base rate AND a specific price per purity — 22K vs 24K gold will differ.',
    arrow: 'down'
  },
  {
    screen: 'settings',
    elementId: 'fx-rates-list',
    tag: 'Settings · Step 11 of 11',
    title: '💱 FX Rate Overrides',
    desc: 'Every foreign currency in your data appears here. Tap ✏️ Set on any row to correct the rate — all your valuations update instantly.',
    arrow: 'up',
    preAction: () => { goToScreen('settings'); }
  }
];

let coachStep = 0;
let _coachResizeObs = null;

function startCoachTour() {
  coachStep = 0;
  showCoachStep(0);
}

function showCoachStep(idx) {
  if (idx < 0 || idx >= COACH_STEPS.length) { endCoachTour(); return; }
  coachStep = idx;
  const step = COACH_STEPS[idx];

  // Run any pre-action (screen switch, open menu etc)
  if (step.preAction) {
    try { step.preAction(); } catch(e) {}
  }

  // Small delay so screen renders before we measure
  setTimeout(() => _renderCoachStep(step, idx), step.preAction ? 320 : 60);
}

function _renderCoachStep(step, idx) {
  const targetEl = document.getElementById(step.elementId);
  const overlay  = document.getElementById('coach-overlay');
  const svg      = document.getElementById('coach-svg');
  const tooltip  = document.getElementById('coach-tooltip');
  const pulse    = document.getElementById('coach-pulse');
  if (!overlay || !svg || !tooltip) return;

  overlay.style.display = 'block';
  overlay.classList.add('active');

  const W = window.innerWidth;
  const H = window.innerHeight;

  // Get target rect — scroll it into view first
  let r = null;
  if (targetEl) {
    targetEl.scrollIntoView({ block: 'nearest', inline: 'nearest' });
    r = targetEl.getBoundingClientRect();
    // If rect is zero-size or fully off screen, treat as no target
    if (r.width < 2 || r.height < 2 || r.bottom < 0 || r.top > H) r = null;
  }

  if (!r) {
    _drawCoachNoTarget(step, idx);
    return;
  }

  const pad  = 10;
  const rx   = Math.max(0, r.left - pad);
  const ry   = Math.max(0, r.top  - pad);
  const rw   = Math.max(60, r.width  + pad * 2);
  const rh   = Math.max(44, r.height + pad * 2);
  const rrad = 12;

  // Draw SVG dim mask with cutout
  svg.innerHTML = `
    <defs>
      <mask id="cm">
        <rect width="${W}" height="${H}" fill="white"/>
        <rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" rx="${rrad}" fill="black"/>
      </mask>
    </defs>
    <rect width="${W}" height="${H}" fill="rgba(10,14,40,0.82)" mask="url(#cm)"/>
  `;

  // Pulse ring
  pulse.style.cssText = `
    display:block; left:${rx}px; top:${ry}px;
    width:${rw}px; height:${rh}px; border-radius:${rrad}px;
  `;

  // Build tooltip HTML
  const isLast = idx === COACH_STEPS.length - 1;
  tooltip.innerHTML = `
    <div class="coach-arrow ${step.arrow || 'down'}"></div>
    <div class="coach-step-tag">${step.tag}</div>
    <div class="coach-title">${step.title}</div>
    <div class="coach-desc">${step.desc}</div>
    <div class="coach-btn-row">
      ${idx > 0 ? `<button class="coach-prev-btn" onclick="showCoachStep(${idx-1})">‹ Back</button>` : ''}
      <button class="coach-next-btn" onclick="${isLast ? 'endCoachTour()' : `showCoachStep(${idx+1})`}">
        ${isLast ? '🎉 Done!' : 'Next →'}
      </button>
      ${!isLast ? `<button class="coach-skip-btn" onclick="endCoachTour()">Skip all</button>` : ''}
    </div>
    <div class="coach-progress">${idx + 1} / ${COACH_STEPS.length}</div>
  `;
  tooltip.style.display = 'block';
  // Ensure tooltip is always above SVG and interactive
  tooltip.style.zIndex  = '10000';
  tooltip.style.pointerEvents = 'all';

  // Position tooltip — measure height first
  const TW  = 268;
  const gap = 14;
  tooltip.style.left = '10px';
  tooltip.style.top  = '-9999px';
  const TH = tooltip.offsetHeight || 170;

  // Centre horizontally on target, clamped to screen edges
  let tx = rx + rw / 2 - TW / 2;
  tx = Math.max(10, Math.min(tx, W - TW - 10));

  // Prefer above, fallback below, fallback centre
  let ty, arrowDir;
  const spaceAbove = ry - gap;
  const spaceBelow = H - (ry + rh) - gap;

  if (spaceAbove >= TH + 10) {
    ty = ry - TH - gap;
    arrowDir = 'down';
  } else if (spaceBelow >= TH + 10) {
    ty = ry + rh + gap;
    arrowDir = 'up';
  } else {
    ty = Math.max(10, H / 2 - TH / 2);
    arrowDir = step.arrow || 'down';
  }

  // Clamp vertically so tooltip never hides under bottom nav
  ty = Math.max(8, Math.min(ty, H - TH - 70));

  const arrowEl = tooltip.querySelector('.coach-arrow');
  if (arrowEl) arrowEl.className = `coach-arrow ${arrowDir}`;

  tooltip.style.left = tx + 'px';
  tooltip.style.top  = ty + 'px';

  // Re-trigger pop animation
  tooltip.style.animation = 'none';
  tooltip.offsetHeight;
  tooltip.style.animation = 'coachPop 0.3s cubic-bezier(0.34,1.56,0.64,1) both';
}

function _drawCoachNoTarget(step, idx) {
  const overlay = document.getElementById('coach-overlay');
  const svg     = document.getElementById('coach-svg');
  const tooltip = document.getElementById('coach-tooltip');
  const pulse   = document.getElementById('coach-pulse');
  const W = window.innerWidth, H = window.innerHeight;
  if (svg) svg.innerHTML = `<rect width="${W}" height="${H}" fill="rgba(10,14,40,0.82)"/>`;
  if (pulse) pulse.style.display = 'none';
  if (overlay) { overlay.style.display = 'block'; overlay.classList.add('active'); }
  if (!tooltip) return;
  const isLast = idx === COACH_STEPS.length - 1;
  tooltip.innerHTML = `
    <div class="coach-step-tag">${step.tag}</div>
    <div class="coach-title">${step.title}</div>
    <div class="coach-desc">${step.desc}</div>
    <div class="coach-btn-row">
      ${idx > 0 ? `<button class="coach-prev-btn" onclick="showCoachStep(${idx-1})">‹ Back</button>` : ''}
      <button class="coach-next-btn" onclick="${isLast ? 'endCoachTour()' : `showCoachStep(${idx+1})`}">
        ${isLast ? '🎉 Done!' : 'Next →'}
      </button>
      ${!isLast ? `<button class="coach-skip-btn" onclick="endCoachTour()">Skip all</button>` : ''}
    </div>
    <div class="coach-progress">${idx + 1} / ${COACH_STEPS.length}</div>
  `;
  tooltip.style.display      = 'block';
  tooltip.style.zIndex       = '10000';
  tooltip.style.pointerEvents = 'all';
  const TW = 268;
  tooltip.style.left = Math.max(10, W/2 - TW/2) + 'px';
  tooltip.style.top  = '-9999px';
  const TH = tooltip.offsetHeight || 170;
  tooltip.style.top  = Math.max(10, H/2 - TH/2) + 'px';
  tooltip.style.animation = 'none';
  tooltip.offsetHeight;
  tooltip.style.animation = 'coachPop 0.3s cubic-bezier(0.34,1.56,0.64,1) both';
}

function endCoachTour() {
  const overlay = document.getElementById('coach-overlay');
  const pulse   = document.getElementById('coach-pulse');
  const tooltip = document.getElementById('coach-tooltip');
  const svg     = document.getElementById('coach-svg');
  // Clear SVG dim mask so nothing blocks touches even briefly
  if (svg)     svg.innerHTML = '';
  if (pulse)   { pulse.style.display = 'none'; }
  if (tooltip) { tooltip.style.display = 'none'; tooltip.innerHTML = ''; }
  if (overlay) {
    overlay.classList.remove('active');
    overlay.style.pointerEvents = 'none';
    overlay.style.display = 'none';
  }
  // Close fab menu if open
  try {
    const menu = document.getElementById('fab-menu');
    if (menu && menu.classList.contains('open')) {
      document.getElementById('fab-add-btn')?.click();
    }
  } catch(e) {}
  // Return to home
  switchScreen('home', document.querySelector('.nav-item:first-child'));
  showToast('🎯 Tour complete — you\'re ready!');
}

// ── INIT

// ══════════════════════════════════════════════════════
document.getElementById('topbar-month').textContent = getDisplayMonth(viewMonth);
document.getElementById('metal-date').value = localDateStr();
document.getElementById('inv-date').value = localDateStr();

// Apply stored theme
applyStoredTheme();

// Init period
selectedDay = localDateStr();
updatePeriodLabel();

// Render home
renderHome();

// Auto-snapshot previous month on first load if not captured yet
try {
  const prevDate = new Date(); prevDate.setMonth(prevDate.getMonth() - 1);
  const prevMk = prevDate.getFullYear() + '-' + String(prevDate.getMonth()+1).padStart(2,'0');
  const existing = getNWSnapshots().find(s => (s.month||s.date||'').startsWith(prevMk));
  if (!existing && data[prevMk]) {
    const tmpView = viewMonth;
    viewMonth = prevMk;
    autoSnapshot();
    viewMonth = tmpView;
  }
} catch(e) {}

// Show onboarding on first ever load
if (!localStorage.getItem(OB_SEEN_KEY)) {
  showOnboarding();
}

// PIN Lock: DISABLED — uncomment initLockScreen() below to re-enable
// initLockScreen();

// ══════════════════════════════════════════════════════
// FIREBASE SYNC ENGINE
// ══════════════════════════════════════════════════════

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCxM7UhAL7QDm1rlCRkn_upVxNwBXH5_U4",
  authDomain: "moneyfi-75929.firebaseapp.com",
  projectId: "moneyfi-75929",
  storageBucket: "moneyfi-75929.firebasestorage.app",
  messagingSenderId: "457378397297",
  appId: "1:457378397297:web:43944fe48ad28b219a2fd0"
};

// ── Init Firebase ──────────────────────────────────────
firebase.initializeApp(FIREBASE_CONFIG);
const _auth = firebase.auth();
const _db   = firebase.firestore();
window._fbDb = _db;
window._fbUser = null;

// ── Sync status UI ─────────────────────────────────────
function showSyncStatus(msg, color='#10B981', duration=2500) {
  const bar = document.getElementById('sync-status-bar');
  if (!bar) return;
  bar.textContent = msg;
  bar.style.background = color;
  bar.style.color = 'white';
  bar.style.display = 'block';
  clearTimeout(bar._hideTimer);
  if (duration > 0) {
    bar._hideTimer = setTimeout(() => { bar.style.display = 'none'; }, duration);
  }
}

// ── Family vs Personal data routing ──────────────────────────────────────
const FAMILY_EMAILS = [
  'pnraghukishore@gmail.com',
  'swathikishore12@gmail.com',
  'skanda.penujuri@gmail.com'
];
const FAMILY_DOC_ID = 'kishore-family';

function getDataRef(db, uid, email) {
  const isFamily = FAMILY_EMAILS.includes((email || '').toLowerCase());
  if (isFamily) {
    // Family members share one document
    return db.collection('families').doc(FAMILY_DOC_ID);
  } else {
    // Everyone else gets their own private document
    return db.collection('users').doc(uid);
  }
}

// ── Firebase Save: chunked to stay under 1MB Firestore limit ──────────────
let _saveTimer = null;
function firebaseSave() {
  if (!window._fbUser) return;
  // Debounce: wait 1.5s after last save call before writing to Firestore
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => _doFirebaseSave(), 1500);
}

function _doFirebaseSave() {
  if (!window._fbUser) return;
  const uid   = window._fbUser.uid;
  const email = window._fbUser.email;
  showSyncStatus('☁️ Saving...', '#3B9EFF', 0);

  // Split data into chunks to stay well under Firestore 1MB doc limit
  // Chunk 1: main data (transactions, budgets, goals, settings)
  // Chunk 2: heavy arrays (metals, NW accounts, investments)
  const chunk1 = {};
  const chunk2 = {};

  Object.keys(data).forEach(k => {
    const heavy = ['_metals','_nwAccounts','_realEstate'];
    if (heavy.includes(k)) chunk2[k] = data[k];
    else chunk1[k] = data[k];
  });

  const baseRef = getDataRef(_db, uid, email);
  const batch = _db.batch();
  batch.set(baseRef.collection('appData').doc('main'),
    { ...chunk1, _savedAt: firebase.firestore.FieldValue.serverTimestamp() });
  batch.set(baseRef.collection('appData').doc('assets'),
    { ...chunk2, _savedAt: firebase.firestore.FieldValue.serverTimestamp() });

  batch.commit()
    .then(() => showSyncStatus('✅ Synced', '#10B981', 2000))
    .catch(err => {
      console.error('Firebase save error:', err);
      showSyncStatus('⚠️ Sync failed — saved locally', '#F59E0B', 3000);
    });
}

// ── Firebase Load: merge chunks back into data ────────────────────────────
async function firebaseLoad(uid) {
  showSyncStatus('☁️ Loading your data...', '#3B9EFF', 0);
  const email = window._fbUser ? window._fbUser.email : '';
  try {
    const baseRef = getDataRef(_db, uid, email);
    const [mainSnap, assetsSnap] = await Promise.all([
      baseRef.collection('appData').doc('main').get(),
      baseRef.collection('appData').doc('assets').get()
    ]);

    const mainData   = mainSnap.exists   ? mainSnap.data()   : {};
    const assetsData = assetsSnap.exists ? assetsSnap.data() : {};

    // Remove Firestore metadata fields
    delete mainData._savedAt;
    delete assetsData._savedAt;

    const merged = { ...mainData, ...assetsData };

    if (Object.keys(merged).length > 0) {
      // Cloud data exists — merge with local (cloud wins for conflicts)
      data = { ...data, ...merged };
      // Migration note: stale INR override cleanup removed — user overrides are intentional
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      showSyncStatus('✅ Data loaded from cloud', '#10B981', 2500);
      setTimeout(runRecurringScheduler, 500);
    } else {
      // No cloud data yet — push local data to cloud
      showSyncStatus('☁️ First sync — uploading local data...', '#3B9EFF', 0);
      firebaseSave();
    }

    // Restore custom NW types
    (data._nwCustomTypes || []).forEach(c => {
      NW_TYPES[c.key] = { label: c.label, emoji: c.emoji||'🏦', color:'#6B7280', isLiab: c.isLiab||false };
    });

    // Re-render everything with cloud data
    applyStoredTheme();
    renderHome();
    populateDataMonthSelect && populateDataMonthSelect();

  } catch (err) {
    console.error('Firebase load error:', err);
    showSyncStatus('⚠️ Could not load cloud data — using local', '#F59E0B', 3000);
  }
}

// ── Real-time listener: update UI when another device saves ───────────────
let _unsubscribeListener = null;
function startRealtimeSync(uid) {
  if (_unsubscribeListener) _unsubscribeListener();
  const email = window._fbUser ? window._fbUser.email : '';
  const baseRef = getDataRef(_db, uid, email);
  const mainRef = baseRef.collection('appData').doc('main');
  _unsubscribeListener = mainRef.onSnapshot(snap => {
    if (!snap.exists || snap.metadata.hasPendingWrites) return;
    // Another device updated data — reload silently
    firebaseLoad(uid).then(() => {
      showSyncStatus('🔄 Updated from another device', '#8B5CF6', 2500);
    });
  }, err => console.warn('Realtime sync error:', err));
}

// ── Auth state handler ────────────────────────────────────────────────────
function signInWithGoogle() {
  const btn = document.getElementById('google-signin-btn');
  const statusEl = document.getElementById('login-status');
  if (btn) btn.disabled = true;
  if (statusEl) statusEl.textContent = 'Signing in...';

  const provider = new firebase.auth.GoogleAuthProvider();
  _auth.signInWithPopup(provider)
    .catch(err => {
      console.error('Sign in error:', err);
      if (btn) btn.disabled = false;
      if (statusEl) statusEl.textContent = 'Sign in failed — please try again';
    });
}

function signOut() {
  if (_unsubscribeListener) _unsubscribeListener();
  _auth.signOut().then(() => {
    window._fbUser = null;
    document.getElementById('screen-login').style.display = 'flex';
    showToast('👋 Signed out');
  });
}

// ── Auth state change ─────────────────────────────────────────────────────
_auth.onAuthStateChanged(async user => {
  const loginScreen = document.getElementById('screen-login');

  if (user) {
    // ── Allowlist check — only family members can access ──
    const ALLOWED_EMAILS = [
      'pnraghukishore@gmail.com',
      'swathikishore12@gmail.com',
      'skanda.penujuri@gmail.com',
      'suja81@gmail.com',
      'charlesakl@gmail.com',
      'narasimha.neo@gmail.com',
      'ping2rupesh@gmail.com',
      'ebooksofpnr@gmail.com',
      'pnrkiran@gmail.com'
    ];

    if (!ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
      // Not authorised — sign out and show access denied
      _auth.signOut();
      const loginScreen = document.getElementById('screen-login');
      if (loginScreen) {
        loginScreen.style.display = 'flex';
        const statusEl = document.getElementById('login-status');
        if (statusEl) {
          statusEl.innerHTML = `<span style="color:#EF4444;font-weight:800;">⛔ Access denied</span><br>
            <span style="color:#999;">${user.email} is not authorised.<br>Contact the app owner.</span>`;
        }
        const btn = document.getElementById('google-signin-btn');
        if (btn) btn.disabled = false;
      }
      return;
    }
    // ── End allowlist check ──

    // User is signed in
    window._fbUser = user;
    window._fbDb   = _db;

    // Hide login screen
    if (loginScreen) loginScreen.style.display = 'none';

    // Update user display in settings if element exists
    const userEl = document.getElementById('firebase-user-display');
    if (userEl) {
      userEl.textContent = user.displayName || user.email;
    }
    const userAvatar = document.getElementById('firebase-user-avatar');
    if (userAvatar && user.photoURL) {
      userAvatar.src = user.photoURL;
      userAvatar.style.display = 'block';
    }

    // Load data from cloud, then start real-time sync
    await firebaseLoad(user.uid);
    startRealtimeSync(user.uid);

  } else {
    // Not signed in — show login screen
    window._fbUser = null;
    if (loginScreen) loginScreen.style.display = 'flex';
    if (_unsubscribeListener) _unsubscribeListener();
  }
});

// ── Smart Linked Category Picker ─────────────────────────────────────────
let _linkedCatsSelected = [];

function initLinkedCatPicker(existingCats, budgetType) {
  // existingCats: array of strings already linked
  _linkedCatsSelected = existingCats ? [...existingCats] : [];
  renderLinkedChips();
  const search = document.getElementById('ebp-linked-search');
  if (search) search.value = '';
  syncLinkedCatsHidden();

  // Show context-aware hint
  const hint = document.getElementById('ebp-linked-cats-hint');
  if (hint) {
    if (budgetType === 'savings') {
      hint.innerHTML = '💡 Maps to <strong>Investing tab</strong> transactions — type a category like Stocks, Gold, Crypto';
    } else {
      hint.innerHTML = '💡 Maps to <strong>expense</strong> transactions — type a category like Groceries, FastFood';
    }
  }
}

function getAllAvailableCats(budgetType) {
  // For savings goals — prioritise investment + savings categories
  // For expense goals — prioritise expense categories
  const isSavings = budgetType === 'savings';
  const all = new Set();

  if (isSavings) {
    // Investment types first for savings goals
    ['investment','additional','income','expense'].forEach(t =>
      getCatsForType(t).forEach(c => all.add(c))
    );
    // Pull actual investment transactions used
    const mk = budgetViewMonth || getCurrentMonthKey();
    const monthData = data[mk] || {};
    (monthData.investments || []).forEach(tx => {
      if (tx.category)    all.add(tx.category);
      if (tx.investType)  all.add(tx.investType);
    });
  } else {
    // Expense types first for expense goals
    ['expense','additional','given','income'].forEach(t =>
      getCatsForType(t).forEach(c => all.add(c))
    );
  }

  // Also pull from all transactions ever used
  Object.keys(data).forEach(mk => {
    if (!mk.match(/^\d{4}-\d{2}$/)) return;
    const m = data[mk];
    ['expenses','investments','additional','income'].forEach(list => {
      (m[list] || []).forEach(tx => {
        if (tx.category) all.add(tx.category);
        if (tx.subCategory) all.add(tx.subCategory);
        if (tx.investType) all.add(tx.investType);
      });
    });
  });

  return [...all].sort((a,b) => a.localeCompare(b));
}

function filterLinkedCatSuggestions(query) {
  const dropdown = document.getElementById('ebp-linked-suggestions');
  if (!dropdown) return;

  // Pass current budget type so savings shows investment categories
  const budgetType = (typeof editingBudgetType !== 'undefined') ? editingBudgetType : 'expense';
  const all = getAllAvailableCats(budgetType);
  const q = query.trim().toLowerCase();
  const filtered = all.filter(c =>
    c.toLowerCase().includes(q) && !_linkedCatsSelected.includes(c)
  );

  const trimmed = query.trim();

  // Build suggestion rows
  const rows = filtered.map(c => `
    <div onclick="addLinkedCat('${c.replace(/'/g, "\'")}')"
      style="padding:10px 14px;font-size:0.85em;font-weight:700;cursor:pointer;
             color:var(--text-dark);border-bottom:1px solid #F5F5F5;transition:background 0.1s;"
      onmouseover="this.style.background='#FFF8E8'"
      onmouseout="this.style.background='white'">
      ${c}
    </div>
  `).join('');

  // If no match AND user typed something — show inline create option
  const alreadyExists = trimmed && getAllAvailableCats(budgetType).some(c => c.toLowerCase() === trimmed.toLowerCase());
  const createRow = trimmed && !alreadyExists ? `
    <div onclick="createAndAddLinkedCat('${trimmed.replace(/'/g, "\'")}')"
      style="padding:10px 14px;font-size:0.85em;font-weight:800;cursor:pointer;
             color:#10B981;border-top:${filtered.length>0?'1.5px solid #F0F0F0':'none'};
             display:flex;align-items:center;gap:8px;transition:background 0.1s;"
      onmouseover="this.style.background='#F0FBF3'"
      onmouseout="this.style.background='white'">
      <span style="background:#10B981;color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.9em;flex-shrink:0;">+</span>
      Create <strong style="margin-left:3px;">"${trimmed}"</strong> as new category
    </div>
  ` : '';

  if (!rows && !createRow) {
    dropdown.style.display = 'none';
    return;
  }

  dropdown.innerHTML = rows + createRow;
  dropdown.style.display = 'block';
}

// ── Create new category inline and add to picker + app ────────────────────
function createAndAddLinkedCat(catName) {
  const budgetType = (typeof editingBudgetType !== 'undefined') ? editingBudgetType : 'expense';
  const trimmed = catName.trim();
  if (!trimmed) return;

  if (budgetType === 'savings') {
    // Add to investment custom categories
    const cc = getCustomCats();
    if (!cc.investment) cc.investment = [...getCatsForType('investment')];
    if (!cc.investment.includes(trimmed)) {
      cc.investment.push(trimmed);
      data._customCats = cc;
    }

    // Add to Home Investing cards so it appears instantly
    const cards = getHomeInvCards();
    const alreadyCard = cards.find(c => c.key === trimmed);
    if (!alreadyCard) {
      // Pick a color from a palette based on name hash
      const palette = [
        {color:'#6366F1',bg:'#EEF2FF'},{color:'#EC4899',bg:'#FDF2F8'},
        {color:'#14B8A6',bg:'#F0FDFA'},{color:'#F97316',bg:'#FFF7ED'},
        {color:'#8B5CF6',bg:'#F5F3FF'},{color:'#0EA5E9',bg:'#F0F9FF'},
        {color:'#10B981',bg:'#ECFDF5'},{color:'#D97706',bg:'#FFFBEB'},
      ];
      const pick = palette[trimmed.charCodeAt(0) % palette.length];
      cards.push({
        key: trimmed,
        label: trimmed,
        icon: '💼',
        color: pick.color,
        bg: pick.bg,
        fieldTemplate: 'General',
        visible: true
      });
      saveHomeInvCards(cards);
    } else if (!alreadyCard.visible) {
      // Card exists but was hidden — make it visible
      alreadyCard.visible = true;
      saveHomeInvCards(cards);
    }

    // Re-render home investing tab instantly
    if (typeof renderHome === 'function') renderHome();

    showToast(`✅ "${trimmed}" added to Investing tab`);

  } else {
    // Expense — add to expense custom categories
    const cc = getCustomCats();
    if (!cc.expense) cc.expense = [...getCatsForType('expense')];
    if (!cc.expense.includes(trimmed)) {
      cc.expense.push(trimmed);
      data._customCats = cc;
    }

    // Add to Home Spending cards
    const spendCards = getHomeSpendCards();

    // Check if it already exists as a subcat of any existing card
    const existingCard = spendCards.find(c =>
      (c.subcats || []).some(s => s.toLowerCase() === trimmed.toLowerCase()) ||
      (c.label || '').toLowerCase() === trimmed.toLowerCase()
    );

    if (!existingCard) {
      // Create a new spending card for this category
      const palette = [
        {color:'#FF6B35',cls:'food'},  {color:'#4A9EFF',cls:'transport'},
        {color:'#FF4757',cls:'shopping'},{color:'#4ECDC4',cls:'health'},
        {color:'#FF6B9D',cls:'giving'},{color:'#7C3AED',cls:'other-cat'},
        {color:'#F59E0B',cls:'other-cat'},{color:'#64B5F6',cls:'other-cat'},
      ];
      const pick = palette[trimmed.charCodeAt(0) % palette.length];
      spendCards.push({
        key: trimmed.toLowerCase().replace(/\s+/g,'_'),
        label: trimmed,
        icon: '🏷️',
        color: pick.color,
        cls: pick.cls,
        subcats: [trimmed],
        visible: true
      });
      saveHomeSpendCards(spendCards);
      showToast(`✅ "${trimmed}" added to Spending tab`);
    } else {
      // Already mapped to a card — just confirm
      showToast(`✅ "${trimmed}" linked to "${existingCard.label}" on Spending tab`);
    }

    // Re-render home spending tab instantly
    if (typeof renderHome === 'function') renderHome();
  }

  save();

  // Now add to the picker chips
  addLinkedCat(trimmed);
}

function addLinkedCat(cat) {
  if (!_linkedCatsSelected.includes(cat)) {
    _linkedCatsSelected.push(cat);
    renderLinkedChips();
    syncLinkedCatsHidden();
  }
  const search = document.getElementById('ebp-linked-search');
  if (search) search.value = '';
  const dropdown = document.getElementById('ebp-linked-suggestions');
  if (dropdown) dropdown.style.display = 'none';
}

function removeLinkedCat(cat) {
  _linkedCatsSelected = _linkedCatsSelected.filter(c => c !== cat);
  renderLinkedChips();
  syncLinkedCatsHidden();
}

function renderLinkedChips() {
  const wrap = document.getElementById('ebp-linked-chips');
  if (!wrap) return;
  if (_linkedCatsSelected.length === 0) {
    wrap.innerHTML = '';
    wrap.style.marginBottom = '0';
    return;
  }
  wrap.style.marginBottom = '8px';
  wrap.innerHTML = _linkedCatsSelected.map(c => `
    <span style="display:inline-flex;align-items:center;gap:5px;
      background:var(--yellow-light,#FFF8DC);border:1.5px solid var(--yellow,#F5C842);
      border-radius:20px;padding:4px 10px 4px 12px;font-size:0.78em;font-weight:800;color:var(--text-dark);">
      ${c}
      <span onclick="removeLinkedCat('${c.replace(/'/g, "\'")}')"
        style="cursor:pointer;font-size:1em;color:#999;line-height:1;margin-left:2px;"
        onmouseover="this.style.color='#EF4444'" onmouseout="this.style.color='#999'">✕</span>
    </span>
  `).join('');
}

function syncLinkedCatsHidden() {
  const hidden = document.getElementById('ebp-linked-cats');
  if (hidden) hidden.value = _linkedCatsSelected.join(', ');
}

// Close suggestions when clicking outside
document.addEventListener('click', e => {
  const dropdown = document.getElementById('ebp-linked-suggestions');
  const search = document.getElementById('ebp-linked-search');
  if (dropdown && search && !search.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.style.display = 'none';
  }
});
// ── End Smart Linked Category Picker ──────────────────────────────────────

// ══════════════════════════════════════════════════════
// END FIREBASE SYNC ENGINE
// ══════════════════════════════════════════════════════

</script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('[MoneyFi] SW registered:', reg.scope))
          .catch(err => console.warn('[MoneyFi] SW failed:', err));
      });
    }
  </script>
</body>
</html
<!-- ═══════════════════════════════ LOGIN SCREEN ═══════════════════════════════ -->
<div id="screen-login" style="
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(145deg,#0F1B4C 0%,#1E2A6E 50%,#2D3F8F 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px;font-family:'Nunito',sans-serif;
">
  <!-- Logo -->
  <div style="margin-bottom:8px;font-size:3.5em;">💰</div>
  <div style="font-size:2em;font-weight:900;color:white;letter-spacing:-0.5px;margin-bottom:4px;">MoneyFi</div>
  <div style="font-size:0.85em;color:rgba(255,255,255,0.6);font-weight:600;margin-bottom:48px;letter-spacing:1px;text-transform:uppercase;">Personal Finance</div>

  <!-- Card -->
  <div style="
    background:white;border-radius:24px;padding:32px 28px;
    width:100%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.35);
    text-align:center;
  ">
    <div style="font-size:1.1em;font-weight:900;color:#1E2A6E;margin-bottom:6px;">Welcome back</div>
    <div style="font-size:0.82em;color:#888;font-weight:600;margin-bottom:24px;">Sign in to sync your data across all devices</div>

    <!-- Google Sign-In Button -->
    <button id="google-signin-btn" onclick="signInWithGoogle()" style="
      width:100%;padding:14px 20px;
      border:2px solid #E8E8E8;border-radius:14px;
      background:white;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:12px;
      font-size:0.95em;font-weight:800;color:#1E2A6E;
      transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.08);
    "
    onmouseover="this.style.background='#F8F9FF';this.style.borderColor='#1E2A6E'"
    onmouseout="this.style.background='white';this.style.borderColor='#E8E8E8'"
    >
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        <path fill="none" d="M0 0h48v48H0z"/>
      </svg>
      Continue with Google
    </button>

    <div style="margin-top:20px;padding-top:16px;border-top:1px solid #F0F0F0;">
      <div id="login-status" style="font-size:0.78em;color:#AAA;font-weight:600;">
        Securely synced with Firebase
      </div>
    </div>
  </div>

  <!-- Footer note -->
  <div style="margin-top:28px;font-size:0.74em;color:rgba(255,255,255,0.4);text-align:center;max-width:280px;line-height:1.5;">
    Your data is encrypted and stored in your personal Firebase account. No one else can access it.
  </div>
</div>
<!-- ══════════════════════════════════════════════════════════════════════════ -->

>
